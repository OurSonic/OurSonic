function UIManager(a,b,c){function t(b,d){n.visible=true;a.loading=true;a.SonicLevel=jQuery.parseJSON(b);var e;var f;if(!a.SonicLevel.TileChunks){a.SonicLevel.TileChunks=[]}if(!a.SonicLevel.TilePieces){a.SonicLevel.TilePieces=[]}if(!a.SonicLevel.TileData){a.SonicLevel.TileData=[]}if(!a.SonicLevel.Rings){a.SonicLevel.Rings={}}a.SonicLevel.curHeightMap=true;for(f=0;f<a.SonicLevel.heightMap1.length;f++){e=a.SonicLevel.heightMap1[f];a.SonicLevel.heightMap1[f]=a.SonicLevel.heightIndexes[e]}for(f=0;f<a.SonicLevel.heightMap2.length;f++){e=a.SonicLevel.heightMap2[f];a.SonicLevel.heightMap2[f]=a.SonicLevel.heightIndexes[e]}for(f=0;f<a.SonicLevel.TileChunks.length;f++){e=a.SonicLevel.TileChunks[f];e.__proto__=TileChunk.prototype;e.index=f}for(f=0;f<a.SonicLevel.TilePieces.length;f++){e=a.SonicLevel.TilePieces[f];e.__proto__=TilePiece.prototype;e.index=f}for(f=0;f<a.SonicLevel.TileData.length;f++){e=a.SonicLevel.TileData[f];e.__proto__=Tile.prototype;e.index=f}var g=function(){h.done=true;a.loading=false;q.tileChunk=a.SonicLevel.TileChunks[0];i.tilePiece=r.tilePiece=a.SonicLevel.TilePieces[0]};var h=a.inds={r:0,t:0,tp:0,tc:0,total:a.SonicLevel.TileChunks.length*2+a.SonicLevel.TilePieces.length*5+a.SonicLevel.TileData.length,done:false};l="preloading sprites";a.preLoadSprites(c,function(){h.r=1;g();l="level loaded"},function(a){l=a})}function m(a){var c;k.addControl(c=new Button(0,0,0,0,a,"10pt Arial","rgb(50,190,90)",function(){l="Downloading";OurSonic.SonicLevels.getLevel(a,function(c){l="loading";l=a;t(c,b)})}))}this.UIAreas=[];this.messages=[];var d=this.textFont="18pt sans-serrif ";var e=this.buttonFont="13pt Arial bold";b.font=d;var f=this.indexes={tpIndex:0,modifyIndex:0,modifyTPIndex:0};this.draw=function(a){a.save();var b=JSLINQ(this.UIAreas).OrderBy(function(a){return a.depth});for(var c=0;c<b.items.length;c++){var d=b.items[c];d.draw(a)}if(DEBUGs){for(var e=0;e<this.messages.length;e++){a.fillText(this.messages[e],10,25+e*30)}}a.restore()};this.onMouseScroll=function(a){var b=a.wheelDelta?a.wheelDelta/40:a.detail?-a.detail:0;for(var c=0;c<this.UIAreas.length;c++){var d=this.UIAreas[c];if(d.visible&&d.y<=a.y&&d.y+d.height>a.y&&d.x<=a.x&&d.x+d.width>a.x){a={x:a.x-d.x,y:a.y-d.y,delta:b};return d.scroll(a)}}return false};this.onClick=function(a){var b=_H.getCursorPosition(a);var c=null;var d;var e;for(e=0;e<this.UIAreas.length;e++){d=this.UIAreas[e];if(d.visible&&d.y<=b.y&&d.y+d.height>b.y&&d.x<=b.x&&d.x+d.width>b.x){c=d;var f={x:b.x-d.x,y:b.y-d.y};d.click(f)}}if(c){for(e=0;e<this.UIAreas.length;e++){d=this.UIAreas[e];if(c==d){d.depth=1}else{d.depth=0}}return true}return false};this.onMouseMove=function(a){var b=_H.getCursorPosition(a);var c=JSLINQ(this.UIAreas).OrderBy(function(a){return-a.depth});for(var d=0;d<c.items.length;d++){var e=c.items[d];if(e.dragging||e.visible&&e.y<=b.y&&e.y+e.height>b.y&&e.x<=b.x&&e.x+e.width>b.x){b={x:b.x-e.x,y:b.y-e.y};return e.mouseMove(b)}}return false};this.onMouseUp=function(a){var b=_H.getCursorPosition(a,true);for(var c=0;c<this.UIAreas.length;c++){var d=this.UIAreas[c];var e={x:b.x-d.x,y:b.y-d.y};d.mouseUp(e)}};var g=this.debuggerArea=new UiArea(650,40,200,240,this,true);g.visible=false;this.UIAreas.push(g);g.addControl(new TextArea(30,25,"Debugger",d,"blue"));g.addControl(new Button(40,60,60,22,"Stop",e,"rgb(50,150,50)",function(){a.windowLocation=_H.defaultWindowLocation(1);g.visible=false;h.visible=false;j.visible=true;n.visible=true;a.sonicToon=null}));g.addControl(new Button(40,95,90,22,"Hit Sonic",e,"rgb(50,150,50)",function(){a.sonicToon.hit()}));g.addControl(new Button(40,130,160,22,"Show Height Map",e,"rgb(50,150,50)",function(){if(this.text=="Show Height Map"){a.showHeightMap=true;this.text="Hide Height Map"}else{a.showHeightMap=false;this.text="Show Height Map"}}));g.addControl(new Button(40,160,160,22,"Switch Height Map",e,"rgb(50,150,50)",function(){a.SonicLevel.curHeightMap=!a.SonicLevel.curHeightMap}));g.addControl(new Button(40,190,160,22,"Debug Sonic",e,"rgb(50,150,50)",function(){if(this.text=="Debug Sonic"){a.sonicToon.debugging=true;this.text="Normal Sonic"}else{a.sonicToon.debugging=false;this.text="Debug Sonic"}}));var h=this.solidTileArea=new UiArea(40,450,430,400,this,true);h.visible=false;this.UIAreas.push(h);h.addControl(new TextArea(30,25,"Modify Solid Tile",d,"blue"));h.addControl(new Button(50,35,25,22,"<<",e,"rgb(50,150,50)",function(){if(f.tpIndex>0){i.tilePiece=a.SonicLevel.TilePieces[--f.tpIndex]}}));h.addControl(new Button(75,35,25,22,">>",e,"rgb(50,150,50)",function(){if(f.tpIndex<a.SonicLevel.TilePieces.length){i.tilePiece=a.SonicLevel.TilePieces[++f.tpIndex]}}));h.addControl(new Button(360,80,45,22,"Full",e,"rgb(50,150,50)",function(){for(var a=0;a<16;a++){i.tilePiece.heightMask.items[a]=16}this.sprites=[]}));h.addControl(new Button(200,35,180,22,"Modify Height Map",e,"rgb(50,150,50)",function(){i.state=(i.state+1)%3;switch(i.state){case 0:this.text="Modify Height Map";break;case 1:this.text="Modify Tile Direction";break;case 2:this.text="Modify Tile Colors";break}}));var i=this.modifyTilePieceArea=new TilePieceArea(30,70,{x:4*5,y:4*5},null,0);h.addControl(i);var j=this.levelInformation=new UiArea(500,440,420,360,this);j.visible=true;this.UIAreas.push(j);j.addControl(new TextArea(30,25,"Level Selector",d,"blue"));j.addControl(new TextArea(30,52,function(){return!l?"Level Not Saved":"Current Level: "+l},d,"black"));j.addControl(new Button(190,70,100,22,"Save Level",e,"rgb(50,150,50)",function(){if(l){OurSonic.SonicLevels.SaveLevelInformation(l,Base64.encode(_H.stringify(a.SonicLevel)),function(a){},function(a){alert("Failure: "+_H.stringify(a))})}else{OurSonic.SonicLevels.saveLevel(Base64.encode(_H.stringify(a.SonicLevel)),function(a){m(l)})}}));j.addControl(new Button(190,105,160,22,"Load Empty Level",e,"rgb(50,150,50)",function(){n.visible=true;o.visible=true;var c=0;var d=function(){var e=188;if(c==e){setTimeout(function(){alert(_H.stringify(a.SonicLevel));t(_H.stringify(a.SonicLevel),b);o.visible=false},500);return}setTimeout(d,100);_H.loadSprite("assets/TileChunks/Tile"+c++ +".png",function(b){o.text="Loading "+c+"/"+e;a.importChunkFromImage(b);if(c==e){a.inds={done:true}}})};setTimeout(d,100)}));var k;j.addControl(k=new ScrollBox(30,70,25,11,130,"rgb(50,60,127)"));var l;OurSonic.SonicLevels.getLevels(function(a){for(var b=0;b<a.length;b++){var c=a[b];m(c)}});var n=this.levelManagerArea=new UiArea(500,25,400,400,this);n.visible=false;this.UIAreas.push(n);n.addControl(new TextArea(30,25,"Level Manager",d,"blue"));var o;n.addControl(o=new TextArea(270,25,"Loading",d,"green"));o.visible=false;n.addControl(new Button(35,100,160,22,"Show Height Map",e,"rgb(50,150,50)",function(){if(this.text=="Show Height Map"){a.showHeightMap=true;this.text="Hide Height Map"}else{a.showHeightMap=false;this.text="Show Height Map"}}));n.addControl(new Button(200,150,160,22,"Place Chunks",e,"rgb(50,150,50)",function(){a.clickState=(a.clickState+1)%2;switch(a.clickState){case ClickState.PlaceChunk:this.text="Place Chunks";break;case ClickState.PlaceRing:this.text="Place Rings";break}}));n.addControl(new Button(200,180,160,22,"Switch Height Map",e,"rgb(50,150,50)",function(){a.SonicLevel.curHeightMap=!a.SonicLevel.curHeightMap}));n.addControl(new Button(35,150,160,22,"Modify Chunks",e,"rgb(50,150,50)",function(){p.visible=true}));n.addControl(new Button(35,150,160,22,"Modify Chunks",e,"rgb(50,150,50)",function(){p.visible=true}));n.addControl(new Button(35,175,160,22,"Modify Tile Pieces",e,"rgb(50,150,50)",function(){h.visible=true}));n.addControl(new Button(35,200,160,22,"Modify Tiles",e,"rgb(50,150,50)",function(){s.visible=true}));n.addControl(new Button(200,35,60,22,"Run",e,"rgb(50,150,50)",function(){n.visible=false;h.visible=false;j.visible=false;s.visible=false;p.visible=false;h.visible=false;g.visible=true;a.windowLocation=_H.defaultWindowLocation(0);a.sonicToon=new Sonic(a.SonicLevel,a.scale)}));var p=this.modifyTileChunkArea=new UiArea(900,450,400,400,this,true);p.visible=false;this.UIAreas.push(p);p.addControl(new TextArea(30,25,"Modify Tile Chunk",d,"blue"));var q=this.modifyTC=new TileChunkArea(30,70,{x:2,y:2},null,1);p.addControl(q);p.addControl(new Button(50,35,25,22,"<<",e,"rgb(50,150,50)",function(){if(f.modifyIndex>0){q.tileChunk=a.SonicLevel.TileChunks[--f.modifyIndex]}}));p.addControl(new Button(80,35,25,22,">>",e,"rgb(50,150,50)",function(){if(f.modifyIndex<a.SonicLevel.TileChunks.length){q.tileChunk=a.SonicLevel.TileChunks[++f.modifyIndex]}}));var r=this.modifyTP=new TilePieceArea(300,160,{x:2*3,y:2*3},null,3);p.addControl(r);p.addControl(new Button(300,100,25,22,"<<",e,"rgb(50,150,50)",function(){if(f.modifyTPIndex>0){r.tilePiece=q.setToTile=a.SonicLevel.TilePieces[--f.modifyTPIndex]}}));p.addControl(new Button(330,100,25,22,">>",e,"rgb(50,150,50)",function(){if(f.modifyTPIndex<a.SonicLevel.TilePieces.length){r.tilePiece=q.setToTile=a.SonicLevel.TilePieces[++f.modifyTPIndex]}}));var s=this.modifyTileArea=new UiArea(900,25,400,400,this,true);s.visible=false;this.UIAreas.push(s);s.addControl(new TextArea(30,25,"Modify Tile",d,"blue"))}function roundRect(a,b,c,d,e,f,g,h){if(typeof h=="undefined"){h=true}if(typeof f==="undefined"){f=5}a.beginPath();a.moveTo(b+f,c);a.lineTo(b+d-f,c);a.quadraticCurveTo(b+d,c,b+d,c+f);a.lineTo(b+d,c+e-f);a.quadraticCurveTo(b+d,c+e,b+d-f,c+e);a.lineTo(b+f,c+e);a.quadraticCurveTo(b,c+e,b,c+e-f);a.lineTo(b,c+f);a.quadraticCurveTo(b,c,b+f,c);a.closePath();if(h){a.stroke()}if(g){a.fill()}}function ScrollBox(a,b,c,d,e,f,g){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=a;this.y=b;this.itemWidth=e;this.visible=true;var h=14;this.width=e+h;this.visibleItems=d;this.itemHeight=c;this.backColor=f;this.height=d*c;this.parent=null;this.scrollOffset=0;this.scrollPosition=0;this.dragging=false;if(g){this.controls=g}else{this.controls=[]}this.scrolling=false;this.addControl=function(a){a.parent=this;this.controls.push(a);return a};this.onClick=function(a){if(!this.visible){return}for(var b=this.scrollOffset;b<this.controls.length;b++){var c=this.controls[b];if(c.y<=a.y&&c.y+c.height>a.y&&c.x<=a.x&&c.x+c.width>a.x){a.x-=c.x;a.y-=c.y;c.onClick(a);return false}}if(a.x>this.itemWidth&&a.x<this.itemWidth+h){if(this.scrollPosition>a.y){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}}this.dragging=true;return false};this.onMouseUp=function(a){if(!this.visible){return}this.dragging=false;for(var b=this.scrollOffset;b<this.controls.length;b++){var c=this.controls[b];if(c.y<=a.y&&c.y+c.height>a.y&&c.x<=a.x&&c.x+c.width>a.x){a.x-=c.x;a.y-=c.y;c.onMouseUp(a);return false}}if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(a){if(!this.visible){return}for(var b=0;b<this.controls.length;b++){var c=this.controls[b];if(c.y<=a.y&&c.y+c.height>a.y&&c.x<=a.x&&c.x+c.width>a.x){a.x-=c.x;a.y-=c.y;c.onMouseOver(a);break}}if(this.dragging&&a.x>this.itemWidth&&a.x<this.itemWidth+h){if(this.scrollPosition>a.y){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}}if(this.mouseOver){this.mouseOver()}};this.onScroll=function(a){if(!this.visible){return}if(a.delta>0){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}for(var b=0;b<this.controls.length;b++){var c=this.controls[b];if(c.y<=a.y&&c.y+c.height>a.y&&c.x<=a.x&&c.x+c.width>a.x){a.x-=c.x;a.y-=c.y;if(c.onScroll){c.onScroll(a)}return false}}if(this.scroll){this.scroll()}};this.draw=function(a){if(!this.visible){return}a.fillStyle=this.backColor;var b;a.fillStyle=this.backColor;a.lineWidth=1;a.strokeStyle="#333";roundRect(a,this.parent.x+this.x,this.parent.y+this.y,this.itemWidth+h+6,this.visibleItems*this.itemHeight,3,true,true);a.fillStyle="grey";a.lineWidth=1;a.strokeStyle="#444";a.fillRect(this.parent.x+this.x+this.itemWidth+2+2,this.parent.y+this.y+2,h,this.visibleItems*this.itemHeight-2);a.fillStyle="red";a.lineWidth=1;a.strokeStyle="#444";this.scrollPosition=(this.visibleItems*this.itemHeight-2)*this.scrollOffset/this.controls.length;a.fillRect(this.parent.x+this.x+this.itemWidth+2+2+2,this.parent.y+this.y+2+this.scrollPosition,h-2,5);var c=1;for(b=this.scrollOffset;b<Math.min(this.controls.length,this.scrollOffset+this.visibleItems);b++){this.controls[b].parent={x:this.parent.x+this.x,y:this.parent.y+this.y};this.controls[b].x=2;this.controls[b].y=c;this.controls[b].height=this.itemHeight;this.controls[b].width=this.itemWidth;c+=this.itemHeight;this.controls[b].draw(a)}};return this}function TileChunkArea(a,b,c,d,e){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=a;this.y=b;this.visible=true;this.scale=c;this.width=c.x*128;this.height=c.y*128;this.clicking=false;this.tileChunk=d;this.parent=null;this.state=e;this.setToTile=null;this.onClick=function(a){if(!this.visible){return}this.clicking=true};this.onMouseUp=function(a){if(!this.visible){return}if(this.clicking){if(this.setToTile!=null){this.tileChunk.tilesPieces[Math.floor(a.x/this.scale.x/16)+Math.floor(a.y/this.scale.y/16)*8]=sonicManager.SonicLevel.TilePieces.indexOf(this.setToTile);this.tileChunk.sprites=[]}}this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(a){if(this.clicking){};};this.draw=function(a){if(!this.visible){return}if(!this.tileChunk){return}this.tileChunk.draw(a,{x:this.parent.x+this.x,y:this.parent.y+this.y},this.scale,true)};return this}function TilePieceArea(a,b,c,d,e){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=a;this.y=b;this.visible=true;this.scale=c;this.width=c.x*16;this.height=c.y*17;this.clicking=false;this.tilePiece=d;this.parent=null;this.state=e;this.onClick=function(a){if(!this.visible){return}this.clicking=true;this.clickHandled=false};this.onMouseUp=function(a){if(!this.visible){return}if(this.tilePiece&&this.clicking&&!this.clickHandled){this.tilePiece.click(Math.floor(a.x/c.x),Math.floor(a.y/c.y),this.state)}this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(a){if(!this.tilePiece){return}if(this.clicking){this.clickHandled=true;this.tilePiece.click(Math.floor(a.x/c.x),Math.floor(a.y/c.y),this.state)}else{this.tilePiece.mouseOver(Math.floor(a.x/c.x),Math.floor(a.y/c.y))}};this.draw=function(a){if(!this.visible){return}if(!this.tilePiece){return}this.tilePiece.tag=true;this.tilePiece.draw(a,{x:this.parent.x+this.x,y:this.parent.y+this.y},this.scale,this.state,true);this.tilePiece.tag=false};return this}function Button(a,b,c,d,e,f,g,h,i,j){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=a;this.y=b;this.visible=true;this.width=c;this.height=d;this.text=e;this.font=f;this.clicking=false;this.click=h;this.mouseUp=i;this.mouseOver=j;this.color=g;this.parent=null;this.onClick=function(a){if(!this.visible){return}this.clicking=true};this.onMouseUp=function(a){if(!this.visible){return}if(this.clicking){if(this.click){this.click()}}this.clicking=false;if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(a){if(!this.visible){return}if(this.mouseOver){this.mouseOver()}};this.draw=function(a){if(!this.visible){return}a.fillStyle=this.color;a.strokeStyle="#DAC333";roundRect(a,this.parent.x+this.x,this.parent.y+this.y,this.width,this.height,5,true,true);a.fillStyle=this.clicking?"#FCA":"#334";if(a.font!=this.font){a.font=this.font}a.fillText(this.text,this.parent.x+this.x+(this.width/2-a.measureText(this.text).width/2),this.parent.y+this.y+this.height/3*2)};return this}function TextArea(a,b,c,d,e){this.forceDrawing=function(){if(this.text==this.oldText){return{redraw:false,clearCache:false}}this.oldText=this.text;return{redraw:false,clearCache:true}};this.x=a;this.oldText=c;this.y=b;this.visible=true;this.text=c;this.font=d;this.color=e;this.parent=null;this.onClick=function(a){return false};this.onMouseUp=function(a){if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(a){if(this.mouseOver){this.mouseOver()}};this.draw=function(a){if(!this.visible){return}var b=_H.isFunction(this.text)?this.text():this.text;if(a.font!=this.font){a.font=this.font}var c=a.measureText(b).width;var d=parseInt(a.font.split("pt")[0]);var e=3;a.strokeStyle=this.color;a.shadowColor="#FFF";a.shadowBlur=20;a.lineWidth=1.5;a.strokeText(b,this.parent.x+this.x,this.parent.y+this.y);a.strokeText(b,this.parent.x+this.x,this.parent.y+this.y);a.strokeText(b,this.parent.x+this.x,this.parent.y+this.y);a.strokeText(b,this.parent.x+this.x,this.parent.y+this.y);a.strokeText(b,this.parent.x+this.x,this.parent.y+this.y);a.shadowBlur=0};return this}function UiArea(a,b,c,d,e,f){this.x=a;this.y=b;this.manager=e;this.closable=f;this.width=c;this.height=d;this.depth=0;this.visible=true;this.dragging=false;this.controls=[];this.addControl=function(a){a.parent=this;this.controls.push(a);return a};var g=this;if(f){this.addControl(new Button(this.width-30,4,26,26,"X",this.manager.buttonFont,"Green",function(){g.visible=false}))}this.click=function(a){if(!this.visible){return}for(var b=0;b<this.controls.length;b++){var c=this.controls[b];if(c.visible&&c.y<=a.y&&c.y+c.height>a.y&&c.x<=a.x&&c.x+c.width>a.x){a.x-=c.x;a.y-=c.y;c.onClick(a);return false}}this.dragging={x:a.x,y:a.y}};this.mouseMove=function(a){if(!this.visible){return}if(!this.dragging){for(var b=0;b<this.controls.length;b++){var c=this.controls[b];if(c.visible&&c.y<=a.y&&c.y+c.height>a.y&&c.x<=a.x&&c.x+c.width>a.x){a.x-=c.x;a.y-=c.y;c.onMouseOver(a)}}return}this.x+=a.x-this.dragging.x;this.y+=a.y-this.dragging.y};this.mouseUp=function(a){if(!this.visible){return}for(var b=0;b<this.controls.length;b++){var c=this.controls[b];c.onMouseUp({x:a.x-c.x,y:a.y-c.y})}this.dragging=false};this.scroll=function(a){if(!this.visible){return}for(var b=0;b<this.controls.length;b++){var c=this.controls[b];if(c.visible&&c.y<=a.y&&c.y+c.height>a.y&&c.x<=a.x&&c.x+c.width>a.x){if(c.onScroll){a.x-=c.x;a.y-=c.y;c.onScroll(a);return false}}}};this.cachedDrawing=null;this.draw=function(a){if(!this.visible){return}var b;var c;var d;if(!this.cachedDrawing){var e=document.createElement("canvas");e.width=this.width+20;e.height=this.height+20;var f=e.getContext("2d");f.fillStyle="rgba(133,133,133,0.6)";f.lineWidth=9;f.strokeStyle="#333";var g=this.x;var h=this.y;this.x=10;this.y=10;roundRect(f,this.x,this.y,this.width,this.height,5,true,true);for(d=0;d<this.controls.length;d++){c=this.controls[d];b=c.forceDrawing();if(b.redraw){c.draw(f)}}this.x=g;this.y=h;this.cachedDrawing=_H.loadSprite(e.toDataURL("image/png"))}if(this.cachedDrawing.loaded){a.drawImage(this.cachedDrawing,Math.floor(this.x),Math.floor(this.y));for(d=0;d<this.controls.length;d++){c=this.controls[d];b=c.forceDrawing();if(!b.redraw){c.draw(a)}if(b.clearCache){this.cachedDrawing=null}}}else{a.fillStyle="rgba(133,133,133,0.6)";a.lineWidth=9;a.strokeStyle="#333";roundRect(a,this.x+10,this.y+10,this.width,this.height,5,true,true);for(d=0;d<this.controls.length;d++){c=this.controls[d];c.draw(a)}}};return this}function TilePiece(a,b){this.tiles=b;TilePiece.prototype.click=function(a,b,c){};TilePiece.prototype.mouseOver=function(a,b){};TilePiece.prototype.draw=function(a,b,c,d){var e;if(e=sonicManager.SpriteCache.tilePeices[d+" "+this.index+" "+c.y+" "+c.x]){if(e.loaded){a.drawImage(e,b.x,b.y)}}else{for(i=0;i<this.tiles.length;i++){var f=this.tiles[i];sonicManager.SonicLevel.TileData[f.TileIndex].draw(a,{x:b.x+i%2*8*c.x,y:b.y+Math.floor(i/2)*8*c.y},c,f.State,false,d)}}return true};TilePiece.prototype.equals=function(a){for(var b=0;b<this.tiles.length;b++){if(a[b]!=this.tiles[b]){return false}}return true}}function TileChunk(a){this.tilesPieces=a;this.hLayer=[];this.sprites=[];TileChunk.prototype.getTilePiece=function(a,b,c){return sonicManager.SonicLevel.TilePieces[this.tilesPieces[Math.floor(a/c.x/16)+Math.floor(b/c.y/16)*8]]};TileChunk.prototype.draw=function(a,b,c,d){var e;if(e=sonicManager.SpriteCache.tileChunks[d+" "+this.index+" "+c.y+" "+c.x]){if(e.loaded){a.drawImage(e,b.x,b.y)}}else{for(var f=0;f<this.tilesPieces.length;f++){if(this.hLayer[f]==d){sonicManager.SonicLevel.TilePieces[this.tilesPieces[f]].draw(a,{x:b.x+f%8*16*c.x,y:b.y+Math.floor(f/8)*16*c.y},c,d)}}}return true}}function Tile(a){this.colors=a;this.sprites=[];Tile.prototype.changeColor=function(a,b,c){this.colors[b*8+a]=c;this.sprites=[]};Tile.prototype.draw=function(a,b,c,d,e,f){for(var g=0;g<this.colors.length;g++){var h=sonicManager.SonicLevel.pallet[this.colors[g]];if(h=="000000"){continue}a.fillStyle="#"+h;switch(d){case 0:a.fillRect(b.x+g%8*c.x,b.y+Math.floor(g/8)*c.y,c.x,c.x);break;case 1:a.fillRect(b.x+(7-g%8)*c.x,b.y+Math.floor(g/8)*c.y,c.x,c.x);break;case 2:a.fillRect(b.x+g%8*c.x,b.y+(7-Math.floor(g/8))*c.y,c.x,c.x);break;case 3:a.fillRect(b.x+(7-g%8)*c.x,b.y+(7-Math.floor(g/8))*c.y,c.x,c.x);break}}if(e){a.strokeStyle="#DD0033";a.lineWidth=3;a.strokeRect(b.x,b.y,8*c.x,8*c.y)}};Tile.prototype.equals=function(a){for(var b=0;b<this.colors.length;b++){var c=a[b];var d=this.colors[b];if(c!=d){return false}}return true}}function SonicManager(a){var b=this.scale={x:2,y:2};this.windowLocation=_H.defaultWindowLocation(1);this.showHeightMap=false;this.goodRing=new Ring(false);this.activeRings=[];this.uiManager=new UIManager(this,a,this.scale);this.SonicLevel={Tiles:[],TilePieces:[],TileChunks:[],ChunkMap:[],Rings:{},curHeightMap:true};var c=new TileChunk+new TilePiece+new Tile+new HeightMask;this.SonicLevel.ChunkMap=[];this.clickState=ClickState.PlaceChunk;this.onClick=function(a){if(a.shiftKey){var c=this.SonicLevel.TileChunks[this.SonicLevel.ChunkMap[Math.floor(a.x/(128*b.x))+Math.floor(a.y/(128*b.y))*sonicManager.SonicLevel.LevelWidth]];var d=c.getTilePiece(a.x-Math.floor(a.x/(128*b.x))*128*b.x,a.y-Math.floor(a.y/(128*b.y))*128*b.y,b);if(d){this.uiManager.indexes.tpIndex=this.SonicLevel.TilePieces.indexOf(d);this.uiManager.modifyTilePieceArea.tilePiece=d;this.uiManager.solidTileArea.visible=true}}else{if(!a.button||a.button==0){switch(this.clickState){case ClickState.PlaceChunk:this.SonicLevel.ChunkMap[Math.floor(a.x/(128*b.x))+Math.floor(a.y/(128*b.y))*sonicManager.SonicLevel.LevelWidth]=this.uiManager.indexes.modifyIndex;break;case ClickState.PlaceRing:var e=Math.floor((a.x-Math.floor(a.x/(128*b.x))*128*b.x)/b.x);var f=Math.floor((a.y-Math.floor(a.y/(128*b.y))*128*b.y)/b.y);var g=Math.floor(e/16)+Math.floor(a.x/(128*b.x))*8;var h=Math.floor(f/16)+Math.floor(a.y/(128*b.y))*8;if(this.SonicLevel.Rings[h*8*sonicManager.SonicLevel.LevelWidth+g]){delete this.SonicLevel.Rings[h*8*sonicManager.SonicLevel.LevelWidth+g]}else{this.SonicLevel.Rings[h*8*sonicManager.SonicLevel.LevelWidth+g]={x:g,y:h}}break;default:}}}};this.tickCount=0;this.drawTickCount=0;this.tick=function(a){if(a.loading){return}if(a.sonicToon){a.tickCount++;a.sonicToon.tick(a.SonicLevel,b);if(a.sonicToon.y>128*sonicManager.SonicLevel.LevelHeight){a.sonicToon.y=0}if(a.sonicToon.x>128*sonicManager.SonicLevel.LevelWidth){a.sonicToon.x=0}}};this.draw=function(a){a.save();this.drawTickCount++;if(this.loading){a.fillStyle="white";a.fillText("Loading...   ",95,95);a.restore();return}if(this.sonicToon){a.beginPath();a.rect(0,0,this.windowLocation.width*b.x,this.windowLocation.height*b.x);a.clip();this.windowLocation.x=Math.floor(this.sonicToon.x-160);this.windowLocation.y=Math.floor(this.sonicToon.y-180)}if(this.windowLocation.x<0){this.windowLocation.x=0}if(this.windowLocation.y<0){this.windowLocation.y=0}if(this.windowLocation.x>128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width){this.windowLocation.x=128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width}if(this.windowLocation.y>128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height){this.windowLocation.y=128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height}for(var c=0;c<this.SonicLevel.ChunkMap.length;c++){if(!this.SonicLevel.TileChunks[this.SonicLevel.ChunkMap[c]]){continue}var d=c%sonicManager.SonicLevel.LevelWidth;var e=Math.floor(c/sonicManager.SonicLevel.LevelWidth);var f={x:d*128*b.x,y:e*128*b.y};if(f.x>=(this.windowLocation.x-128)*b.x&&f.y>=(this.windowLocation.y-128)*b.y&&f.x<=(this.windowLocation.x+128)*b.x+this.windowLocation.width*b.x&&f.y<=(this.windowLocation.y+128)*b.y+this.windowLocation.height*b.y){var g={x:f.x-this.windowLocation.x*b.x,y:f.y-this.windowLocation.y*b.x};this.SonicLevel.TileChunks[this.SonicLevel.ChunkMap[c]].draw(a,g,b,0);if(!this.sonicToon){a.strokeStyle="#DD0033";a.lineWidth=3;a.strokeRect(g.x,g.y,128*b.x,128*b.y)}}}for(var h in this.SonicLevel.Rings){var i=this.SonicLevel.Rings[h];if(this.sonicToon){if(!this.sonicToon.obtainedRing[h]){this.goodRing.draw(a,{x:i.x*16-this.windowLocation.x,y:i.y*16-this.windowLocation.y},b,true)}}else{this.goodRing.draw(a,{x:i.x*16-this.windowLocation.x,y:i.y*16-this.windowLocation.y},b,false)}}for(var j=this.activeRings.length-1;j>=0;j--){var k=this.activeRings[j];k.draw(a,{x:k.x-this.windowLocation.x,y:k.y-this.windowLocation.y},b);if(k.tickCount>256){_H.remove(this.activeRings,k)}}if(this.sonicToon){this.sonicToon.draw(a,b);if(this.windowLocation.x<0){this.windowLocation.x=0}if(this.windowLocation.y<0){this.windowLocation.y=0}if(this.windowLocation.x>128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width){this.windowLocation.x=128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width}if(this.windowLocation.y>128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height){this.windowLocation.y=128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height}}for(var c=0;c<this.SonicLevel.ChunkMap.length;c++){if(!this.SonicLevel.TileChunks[this.SonicLevel.ChunkMap[c]]){continue}var d=c%sonicManager.SonicLevel.LevelWidth;var e=Math.floor(c/sonicManager.SonicLevel.LevelWidth);var f={x:d*128*b.x,y:e*128*b.y};if(f.x>=(this.windowLocation.x-128)*b.x&&f.y>=(this.windowLocation.y-128)*b.y&&f.x<=(this.windowLocation.x+128)*b.x+this.windowLocation.width*b.x&&f.y<=(this.windowLocation.y+128)*b.y+this.windowLocation.height*b.y){var g={x:f.x-this.windowLocation.x*b.x,y:f.y-this.windowLocation.y*b.x};this.SonicLevel.TileChunks[this.SonicLevel.ChunkMap[c]].draw(a,g,b,1);if(!this.sonicToon){a.strokeStyle="#DD0033";a.lineWidth=3;a.strokeRect(g.x,g.y,128*b.x,128*b.y)}}}if(this.showHeightMap){for(var l=0;l<this.SonicLevel.LevelHeight*8;l++){for(var m=0;m<this.SonicLevel.LevelWidth*8;m++){var f={x:m*16*b.x,y:l*16*b.y};if(!(f.x>=(this.windowLocation.x-128)*b.x&&f.y>=(this.windowLocation.y-128)*b.y&&f.x<=(this.windowLocation.x+128)*b.x+this.windowLocation.width*b.x&&f.y<=(this.windowLocation.y+128)*b.y+this.windowLocation.height*b.y)){continue}var n=this.SonicLevel.curHeightMap?this.SonicLevel.heightMap1:this.SonicLevel.heightMap2;var o=n[m+l*this.SonicLevel.LevelWidth*8];if(o=="0000000000000000"){continue}if(o=="gggggggggggggggg"){a.fillStyle="rgba(24,98,235,0.6)";a.fillRect((m*16-this.windowLocation.x)*b.x,(l*16-this.windowLocation.y)*b.y,b.x*16,b.y*16);continue}for(var p=0;p<16;p++){var q=_H.parseNumber(o[p]);a.lineWidth=1;if(q>0){a.fillStyle="rgba(24,98,235,0.6)";a.fillRect((m*16+p-this.windowLocation.x)*b.x,(l*16+(16-q)-this.windowLocation.y)*b.y,b.x,b.y*q)}}}}}a.restore();if(this.sonicToon){this.sonicToon.drawUI(a,{x:0,y:0},b)}};this.importChunkFromImage=function(a){var b=_H.getImageData(a);if(b.length!=128*128*4){alert("Chunk size incorrect")}var c=this.SonicLevel.Tiles.length;var d=[];var e;var f;var g=[];var h=[];var i;for(var j=0;j<16;j++){for(var k=0;k<16;k++){var l=[];for(f=0;f<8;f++){for(e=0;e<8;e++){var m=(j*8+f)*128*4+(k*8+e)*4;l.push(_H.colorFromData(b,m))}}i=_H.compareTiles(this.SonicLevel.Tiles,d,l);if(i==-1){g.push(c+d.length);d.push(new Tile(l))}else{g.push(i)}}}var n;for(n=0;n<d.length;n++){this.SonicLevel.Tiles.push(d[n])}var o=[];var p=this.SonicLevel.TilePieces.length;for(f=0;f<8;f++){for(e=0;e<8;e++){var q=[g[f*2*16+e*2],g[f*2*16+(e*2+1)],g[(f*2+1)*16+e*2],g[(f*2+1)*16+(e*2+1)]];i=_H.compareTilePieces(this.SonicLevel.TilePieces,o,q);if(i==-1){h.push(p+o.length);o.push(new TilePiece(q))}else{h.push(i)}}}for(n=0;n<o.length;n++){this.SonicLevel.TilePieces.push(o[n])}var r=[];for(f=0;f<8;f++){for(e=0;e<8;e++){r.push(h[f*8+e])}}this.SonicLevel.TileChunks.push(new TileChunk(r))};this.SpriteCache={rings:[],tileChunks:[],tilePeices:[],tiles:[],sonicSprites:[]};this.preLoadSprites=function(a,b,c){var d=this.SpriteCache.rings;var e=0;var f=[];for(var g=0;g<4;g++){f[g]="assets/Sprites/ring"+g+".png";this.imageLength++}var h=this;for(var i=0;i<f.length;i++){var j=i*200;d[j]=_H.loadSprite(f[i],function(b){d[b.tag*200+a.x*100+a.y]=_H.scaleSprite(b,a,function(a){e=e+1;if(e==4){h.loadingStepOne()}})});d[j].tag=i}var k;var l={tps:0,tcs:0,ss:0};this.loadingStepOne=function(){c("preloading tiles");var b=function(){l.tps++;if(l.tps==h.SonicLevel.TilePieces.length*2){h.loadingStepTwo()}};for(var d=0;d<this.SonicLevel.TilePieces.length;d++){var e=_H.defaultCanvas(16*a.x,16*a.y);var f=e.context;f.clearRect(0,0,e.width,e.height);k=this.SonicLevel.TilePieces[d];k.draw(f,{x:0,y:0},a,0);var g=e.canvas.toDataURL("image/png");this.SpriteCache.tilePeices[0+" "+k.index+" "+a.y+" "+a.x]=_H.loadSprite(g,b);e=_H.defaultCanvas(16*a.x,16*a.y);f=e.context;f.clearRect(0,0,e.width,e.height);k.draw(f,{x:0,y:0},a,1);var g=e.canvas.toDataURL("image/png");this.SpriteCache.tilePeices[1+" "+k.index+" "+a.y+" "+a.x]=_H.loadSprite(g,b)}};this.loadingStepTwo=function(){c("preloading chunks");var b=function(){l.tcs++;if(l.tcs==h.SonicLevel.TileChunks.length*2){h.loadingStepThree()}};for(var d=0;d<this.SonicLevel.TileChunks.length;d++){var e=_H.defaultCanvas(128*a.x,128*a.y);var f=e.context;f.clearRect(0,0,e.width,e.height);k=this.SonicLevel.TileChunks[d];k.draw(f,{x:0,y:0},a,0);var g=e.canvas.toDataURL("image/png");this.SpriteCache.tileChunks[0+" "+k.index+" "+a.y+" "+a.x]=_H.loadSprite(g,b);e=_H.defaultCanvas(128*a.x,128*a.y);f=e.context;f.clearRect(0,0,e.width,e.height);k.draw(f,{x:0,y:0},a,1);var g=e.canvas.toDataURL("image/png");this.SpriteCache.tileChunks[1+" "+k.index+" "+a.y+" "+a.x]=_H.loadSprite(g,b)}};this.loadingStepThree=function(){c("preloading sonic");this.spriteLocations=[];this.imageLength=0;this.spriteLocations.normal="assets/Sprites/sonic.png";this.imageLength++;var d;for(d=0;d<4;d++){this.spriteLocations["fastrunning"+d]="assets/Sprites/fastrunning"+d+".png";this.imageLength++}for(d=0;d<8;d++){this.spriteLocations["running"+d]="assets/Sprites/running"+d+".png";this.imageLength++}for(d=0;d<4;d++){this.spriteLocations["breaking"+d]="assets/Sprites/breaking"+d+".png";this.imageLength++}for(d=0;d<5;d++){this.spriteLocations["balls"+d]="assets/Sprites/balls"+d+".png";this.imageLength++}for(d=0;d<2;d++){this.spriteLocations["duck"+d]="assets/Sprites/duck"+d+".png";this.imageLength++}for(d=0;d<2;d++){this.spriteLocations["hit"+d]="assets/Sprites/hit"+d+".png";this.imageLength++}for(d=0;d<6;d++){this.spriteLocations["spindash"+d]="assets/Sprites/spindash"+d+".png";this.imageLength++}for(d=0;d<7;d++){this.spriteLocations["spinsmoke"+d]="assets/Sprites/spinsmoke"+d+".png";this.imageLength++}for(d=0;d<4;d++){this.spriteLocations["haltsmoke"+d]="assets/Sprites/haltsmoke"+d+".png";this.imageLength++}var e=this.SpriteCache.sonicSprites;for(var f in this.spriteLocations){e[f]=_H.loadSprite(this.spriteLocations[f],function(c){e[c.tag+a.x+a.y]=_H.scaleSprite(c,a,function(a){l.ss++;if(l.ss==h.imageLength){if(b){b()}}})});e[f].tag=f}}}}function SonicEngine(a){function j(a){a.clearRect(0,0,b.canvasWidth,b.canvasHeight)}function i(a){switch(a.keyCode){case 38:case 87:if(c.sonicToon){c.sonicToon.releaseJump()}break;case 40:case 83:if(c.sonicToon){c.sonicToon.releaseCrouch()}break;case 37:case 65:if(c.sonicToon){c.sonicToon.releaseLeft()}break;case 39:case 68:if(c.sonicToon){c.sonicToon.releaseRight()}break}}function h(a){switch(a.keyCode){case 66:if(c.sonicToon){c.sonicToon.hit()}break;case 67:if(c.sonicToon){c.sonicToon.debug()}break;case 38:case 87:c.windowLocation.y-=128;if(c.sonicToon){c.sonicToon.pressJump()}break;case 40:case 83:c.windowLocation.y+=128;if(c.sonicToon){c.sonicToon.pressCrouch()}break;case 37:case 65:c.windowLocation.x-=128;if(c.sonicToon){c.sonicToon.pressLeft()}break;case 39:case 68:c.windowLocation.x+=128;if(c.sonicToon){c.sonicToon.pressRight()}break}}function g(a){a.preventDefault();if(c.uiManager.onMouseScroll(a)){return false}return a.preventDefault()&&false}function f(a){a.preventDefault();c.uiManager.onMouseUp(a)}function e(a){a.preventDefault();if(c.uiManager.onMouseMove(a)){return false}return false}function d(a){a.preventDefault();if(c.uiManager.onClick(a)){return false}if(c.onClick(a)){return false}return false}var b=this;this.canvas=$("#"+a);this.canvasItem=document.getElementById(a).getContext("2d");var c=window.sonicManager=new SonicManager(this.canvasItem);this.canvasWidth=0;this.canvasHeight=0;document.getElementById(a).addEventListener("DOMMouseScroll",g,false);document.getElementById(a).addEventListener("mousewheel",g,false);document.getElementById(a).addEventListener("touchmove",e);document.getElementById(a).addEventListener("touchstart",d);document.getElementById(a).addEventListener("touchend",f);document.getElementById(a).addEventListener("mousedown",d);document.getElementById(a).addEventListener("mouseup",f);document.getElementById(a).addEventListener("mousemove",e);$(document).keydown(h);$(document).keyup(i);b.resizeCanvas=function(){b.canvasWidth=$(window).width();b.canvasHeight=$(window).height();b.canvas.attr("width",b.canvasWidth);b.canvas.attr("height",b.canvasHeight)};b.draw=function(){requestAnimFrame(b.draw);j(b.canvasItem);c.draw(b.canvasItem);c.uiManager.draw(b.canvasItem)};$(window).resize(this.resizeCanvas);this.resizeCanvas();requestAnimFrame(b.draw);window.setInterval(c.tick,1e3/60,c)}function Sonic(a,b){this.x=280;this.y=130;this.obtainedRing=[];this.rings=0;this.angleInformation=[];this.heightInformation=[];this.debugging=false;this.jumping=false;this.crouching=false;this.holdingLeft=false;this.holdingRight=false;this.LevelWidth=0;this.xsp=0;this.ysp=0;this.sonicLastHitTick=0;this.sonicJustHitTick=0;this.acc=.046875;this.dec=.5;this.frc=.046875;this.rdec=.125;this.rfrc=.0234375;this.runningTick=0;this.jmp=-6.5;this.grv=.21875;this.air=.09375;this.runningDir=1;this.standStill=true;this.sonicLevel=a;this.state=SonicState.Ground;this.haltSmoke=[];this.facing=true;this.ticking=false;this.breaking=0;this.wasJumping=false;this.ducking=false;this.spinDash=false;this.myRec={};this.spinDashSpeed=0;this.angle=180;this.tick=function(){if(this.debugging){var a=10;if(this.holdingRight){this.x+=a}if(this.holdingLeft){this.x-=a}if(this.crouching){this.y+=a}if(this.jumping){this.y-=a}return}this.ticking=true;this.myRec={left:this.x-5,right:this.x+5,top:this.y-20,bottom:this.y+20};switch(this.state){case SonicState.Ground:if(this.justHit){this.justHit=false;this.sonicJustHitTick=sonicManager.drawTickCount;this.xsp=0}if(this.spinDash){this.spinDashSpeed-=Math.floor(this.spinDashSpeed/125)/256}if(this.wasJumping&&!this.jumping){this.wasJumping=false}if(Math.abs(this.xsp)<.5){this.rolling=false;this.currentlyBall=false}if(this.wasJumping&&this.jumping){}else{if(this.jumping){this.wasJumping=true;if(this.ducking){this.spinDash=true;this.spinDashSpeed+=2;if(this.spinDashSpeed>8){this.spinDashSpeed=8}this.spriteState="spindash0"}else{this.state=SonicState.Air;this.currentlyBall=true;this.ysp=this.jmp}}}if(this.holdingLeft&&this.standStill){this.facing=false;this.standStill=false;this.xsp-=this.acc;this.runningDir=-1;break}if(this.holdingRight&&this.standStill){this.facing=true;this.standStill=false;this.xsp+=this.acc;this.runningDir=1;break}if(this.holdingRight){this.facing=true;if(this.runningDir==1){if(this.rolling){}else{};}else{if(Math.abs(this.xsp)>4.5){this.facing=false;this.breaking=1;this.runningTick=0}this.runningDir=1}}else{if(this.holdingLeft){this.facing=false;if(this.runningDir==-1){}else{if(Math.abs(this.xsp)>4.5){this.facing=true;this.breaking=-1;this.runningTick=0}this.runningDir=-1}}else{this.ducking=false;if(this.crouching){if(Math.abs(this.xsp)>1.03125){this.rolling=true;this.currentlyBall=true}else{this.ducking=true}}else{if(this.spinDash){this.xsp=(8+Math.floor(this.spinDashSpeed)/2)*(this.facing?1:-1);this.spinDash=false;this.rolling=true;this.currentlyBall=true}}if(!this.rolling){this.xsp-=Math.min(Math.abs(this.xsp),this.frc)*(this.xsp>0?1:-1)}}}if(this.rolling){this.xsp-=Math.min(Math.abs(this.xsp),this.rfrc)*(this.xsp>0?1:-1)}break;case SonicState.Air:if(this.wasJumping){if(this.jumping){}else{if(this.ysp<0){if(this.ysp<-4){this.ysp=-4}}}}this.ysp+=this.justHit?.1875:this.grv;if(this.ysp<0&&this.ysp>-4){if(Math.abs(this.xsp)>.125){this.xsp*=.96875}}if(this.ysp>16){this.ysp=16}break}var b=6;if(this.holdingLeft){if(this.xsp>0){if(this.rolling){this.xsp-=this.rdec}else{this.xsp-=this.dec}}else{if(this.xsp>-b){if(!this.rolling){this.xsp-=this.acc}if(this.xsp<-b){this.xsp=-b}}}}else{if(this.holdingRight){if(this.xsp<0){if(this.rolling){this.xsp+=this.rdec}else{this.xsp+=this.dec}}else{if(this.xsp<b){if(!this.rolling){this.xsp+=this.acc}if(this.xsp>b){this.xsp=b}}}}}var c=Math.abs(this.xsp);j=parseInt(this.spriteState.substring(this.spriteState.length-1,this.spriteState.length));if(this.breaking>0){if(this.xsp>0||this.xsp==0||this.spriteState=="breaking3"){this.facing=false;this.breaking=0}}else{if(this.breaking<0){if(this.xsp<0||this.xsp==0||this.spriteState=="breaking3"){this.breaking=0;this.facing=true}}}if(this.justHit){if(this.spriteState.substring(0,this.spriteState.length-1)!="hit"){this.spriteState="hit0";this.runningTick=1}else{if(this.runningTick++%Math.floor(8-c)==0){this.spriteState="hit1"}}}else{if(c==0&&this.state==SonicState.Ground){this.runningDir=0;if(this.ducking){if(this.spinDash){if(this.spriteState.substring(0,this.spriteState.length-1)!="spindash"){this.spriteState="spindash0";this.runningTick=1}else{if(this.runningTick++%Math.floor(2-c)==0){this.spriteState="spindash"+(j+1)%6}}}else{if(this.spriteState.substring(0,this.spriteState.length-1)!="duck"){this.spriteState="duck0";this.runningTick=1}else{if(this.runningTick++%Math.floor(4-c)==0){this.spriteState="duck1"}}}}else{this.spriteState="normal";this.standStill=true;this.currentlyBall=false;this.rolling=false;this.runningTick=0}}else{if(this.breaking!=0){if(this.spriteState.substring(0,this.spriteState.length-1)!="breaking"){this.spriteState="breaking0";this.runningTick=1}else{if(this.runningTick++%7==0){this.spriteState="breaking"+(j+1)%4;if(j==0){this.haltSmoke.push({x:Math.floor(this.x),y:Math.floor(this.y)})}}}}else{if(this.currentlyBall){if(this.spriteState.substring(0,this.spriteState.length-1)!="balls"){this.spriteState="balls0";this.runningTick=1}else{if(this.runningTick++%Math.floor(8-c)==0){this.spriteState="balls"+(j+1)%5}}}else{if(c<6){if(this.spriteState.substring(0,this.spriteState.length-1)!="running"){this.spriteState="running0";this.runningTick=1}else{if(this.runningTick++%Math.floor(8-c)==0||Math.floor(8-c)==0){this.spriteState="running"+(j+1)%8}}}else{if(c>=6){if(this.spriteState.substring(0,this.spriteState.length-1)!="fastrunning"){this.spriteState="fastrunning0";this.runningTick=1}else{if(this.runningTick++%Math.ceil(8-c)==0||Math.floor(8-c)==0){this.spriteState="fastrunning"+(j+1)%4}}}}}}}}this.x+=this.xsp;this.y+=this.ysp;var d=Math.floor(this.x);var e=Math.floor(this.y);var f,g;if((f=this.checkCollisionLine(d-9,e+4,20,0))!=-1){if(f.pos<d){this.x=d=f.pos+11;this.xsp=0}else{this.x=d=f.pos-11;this.xsp=0}}if(sonicManager.tickCount%4==0){this.checkCollisionWithRing()}switch(this.state){case SonicState.Ground:if((f=this.checkCollisionLine(d-9,e,36,1))==-1&&(g=this.checkCollisionLine(d+9,e,36,1))==-1){this.state=SonicState.Air}else{if(!!f&&!!g){this.angle=f.angle;if(f.pos>g.pos){this.angle=f.angle;this.y=e=f.pos-19}else{this.angle=g.angle;this.y=e=g.pos-19}}else{if(f.pos>-1){this.angle=f.angle;this.y=e=f.pos-19}else{if(g.pos>-1){this.angle=g.angle;this.y=e=g.pos-19}}}}break;case SonicState.Air:if((f=this.checkCollisionLine(d-9,e,20,1))==-1&&(g=this.checkCollisionLine(d+9,e,20,1))==-1){this.state=SonicState.Air}else{if(f.pos>-1){if(this.y+20>=f.pos){this.angle=f.angle;this.y=e=f.pos-19;this.rolling=this.currentlyBall=false;this.state=SonicState.Ground;this.ysp=0}}else{if(g.pos>-1){if(this.y+20>=g.pos){this.angle=g.angle;this.y=e=g.pos-19;this.rolling=this.currentlyBall=false;this.state=SonicState.Ground;this.ysp=0}}}}if((f=this.checkCollisionLine(d-9,e,20,3))==-1&&(g=this.checkCollisionLine(d+9,e,20,3))==-1){}else{if(f.pos>-1){if(this.y+20>=f.pos){this.angle=f.angle;this.y=e=f.pos+20;this.ysp=0}}else{if(g.pos>-1){if(this.y+20>=g.pos){this.angle=g.angle;this.y=e=g.pos+20;this.ysp=0}}}}break}};this.debug=function(){this.debugging=!this.debugging;this.xsp=0;this.ysp=0;this.spriteState="normal"};this.hit=function(){if(sonicManager.drawTickCount-this.sonicJustHitTick<120){return}this.justHit=true;this.ysp=-4;this.xsp=2*-1;this.sonicLastHitTick=sonicManager.drawTickCount;var a=0;var b=101.25;var c=false;var d=4;while(a<this.rings){var e=new Ring(true);sonicManager.activeRings.push(e);e.x=this.x;e.y=this.y-10;e.ysp=-Math.sin(b)*d;e.xsp=Math.cos(b)*d;if(c){e.ysp*=-1;b+=22.5}c=!c;a++;if(a==16){d=2;b=101.25}}this.rings=0};this.checkCollisionWithRing=function(){var a=this.myRec;for(var c in sonicManager.SonicLevel.Rings){var d=sonicManager.SonicLevel.Rings[c];if(this.obtainedRing[c]){continue}var e=d.x*8*b.x;var f=d.y*8*b.y;if(_H.intersectRect(a,{left:e-8*b.x,right:e+8*b.x,top:f-8*b.y,bottom:f+8*b.y})){this.rings++;this.obtainedRing[c]=true}}};this.sensorA=0;this.checkCollisionLine=function(a,b,c,d){var e=b*this.LevelWidth+a;var f=this.LevelWidth;var g;var h;switch(d){case 0:for(g=0;g<c;g++){if(a+g<0||this.heightInformation[b*this.LevelWidth+(a+g)]){return{pos:a+g,angle:this.angleInformation[b*this.LevelWidth+(a+g)]}}}break;case 1:for(g=0,h=c*f;g<h;g+=f){if(this.heightInformation[e+g]){return{pos:b+g/f,angle:this.angleInformation[b*this.LevelWidth+(a+g)]}}}break;case 2:for(g=0;g<c;g++){if(a-g<0||this.heightInformation[this.heightInformation[b*this.LevelWidth+(a-g)]]){return{pos:a-g,angle:this.angleInformation[b*this.LevelWidth+(a+g)]}}}break;case 3:for(g=0,h=c*f;g<h;g+=f){if(this.heightInformation[e-g]){return{pos:b-g/f,angle:this.angleInformation[b*this.LevelWidth+(a+g)]}}}break}return-1};this.spriteState="normal";this.isLoading=function(){return this.imageLoaded[0]<this.imageLength};this.drawUI=function(a,b,c){a.font="13pt Arial bold";a.fillStyle="Blue";a.fillText("Rings: "+this.rings,b.x+30,b.y+45)};this.draw=function(a,b){var c=Math.floor(this.x);var d=Math.floor(this.y);var e;var f=sonicManager.drawTickCount-this.sonicJustHitTick;if(f<120){if(f%8<4){return}}if(e=sonicManager.SpriteCache.sonicSprites[this.spriteState+b.x+b.y]){if(e.loaded){a.save();var g=40-e.height/b.y;if(!this.facing){a.translate((c-15-sonicManager.windowLocation.x)*b.x+e.width,(d-20-sonicManager.windowLocation.y+g)*b.y);a.scale(-1,1);a.drawImage(e,0,0,e.width,e.height);if(this.spinDash){a.drawImage(sonicManager.SpriteCache.sonicSprites["spinsmoke"+Math.floor(sonicManager.drawTickCount%14/2)+b.x+b.y],-25*b.x,0,e.width,e.height)}}else{a.drawImage(e,(c-15-sonicManager.windowLocation.x)*b.x,(d-20-sonicManager.windowLocation.y+g)*b.y,e.width,e.height);if(this.spinDash){a.drawImage(sonicManager.SpriteCache.sonicSprites["spinsmoke"+Math.floor(sonicManager.drawTickCount%14/2)+b.x+b.y],(c-15-sonicManager.windowLocation.x-25)*b.x,(d-20-sonicManager.windowLocation.y+g)*b.y,e.width,e.height)}}a.restore();for(var h=0;h<this.haltSmoke.length;h++){var i=this.haltSmoke[h];a.drawImage(sonicManager.SpriteCache.sonicSprites["haltsmoke"+Math.floor(sonicManager.drawTickCount%(4*6)/6)+b.x+b.y],(i.x-sonicManager.windowLocation.x-25)*b.x,(i.y+12-sonicManager.windowLocation.y+g)*b.y);if(Math.floor((sonicManager.drawTickCount+6)%(4*6)/6)==0){this.haltSmoke.splice(h,1)}}}}else{if(e=sonicManager.SpriteCache.sonicSprites[this.spriteState]){if(e.loaded){sonicManager.SpriteCache.sonicSprites[this.spriteState+b.x+b.y]=_H.scaleSprite(e,b)}}else{sonicManager.SpriteCache.sonicSprites[this.spriteState]=_H.loadSprite(this.spriteLocations[this.spriteState])}}};this.runningDir=0;this.kill=function(){};this.pressJump=function(){if(!this.justHit){this.jumping=true}};this.pressCrouch=function(){if(!this.justHit){this.crouching=true}};this.pressLeft=function(){if(!this.justHit){this.holdingLeft=true}};this.pressRight=function(){if(!this.justHit){this.holdingRight=true}};this.releaseJump=function(){this.jumping=false};this.releaseCrouch=function(){this.crouching=false};this.releaseLeft=function(){this.holdingLeft=false};this.releaseRight=function(){this.holdingRight=false};this.buildHeightInfo=function(){var b=[];var c=[];b.length=a.ChunkMap.length*128*128;c.length=a.ChunkMap.length*128*128;this.LevelWidth=a.LevelWidth*128;for(var d=0;d<a.LevelHeight;d++){for(var e=0;e<a.LevelWidth;e++){var f=a.TileChunks[a.ChunkMap[d*a.LevelWidth+e]];for(var g=0;g<8;g++){for(var h=0;h<8;h++){var i=a.TilePieces[f.tilesPieces[g*8+h]];var j=sonicManager.SonicLevel.curHeightMap?sonicManager.SonicLevel.heightMap1:sonicManager.SonicLevel.heightMap2;var k=j[e*8+h+(d*8+g)*a.LevelWidth*8];for(var l=0;l<16;l++){for(var m=0;m<16;m++){var n=_H.parseNumber(k[m]);b[e*128+h*16+m+(d*128+g*16+l)*this.LevelWidth]=n>15-l}}}}}}this.heightInformation=b;this.angleInformation=c};this.buildHeightInfo(a)}function Ring(a){this.active=a;this.animationIndex=0;this.x=0;this.y=0;this.xsp=0;this.ysp=0;this.tickCount=0;this.draw=function(b,c,d){if(a){this.ysp+=.09375;this.x+=this.xsp;this.y+=this.ysp;if(this.x<sonicManager.windowLocation.x||this.y<sonicManager.windowLocation.y||this.x>sonicManager.windowLocation.x+sonicManager.windowLocation.width||this.y>sonicManager.windowLocation.y+sonicManager.windowLocation.height){this.tickCount=4294967295;return false}if(sonicManager.sonicToon.checkCollisionLine(Math.floor(this.x)+8,Math.floor(this.y)+8,16,1)!=-1){this.ysp*=-.75}if(sonicManager.sonicToon.checkCollisionLine(Math.floor(this.x)-8,Math.floor(this.y)+8,26,0)!=-1){this.xsp*=-.75}if(sonicManager.drawTickCount>sonicManager.sonicToon.sonicLastHitTick+64&&_H.intersectRect(sonicManager.sonicToon.myRec,{left:this.x-8*d.x,right:this.x+8*d.x,top:this.y-8*d.y,bottom:this.y+8*d.y})){this.tickCount=4294967295;sonicManager.sonicToon.rings++;return false}this.tickCount++}if(sonicManager.sonicToon){this.animationIndex=Math.floor(sonicManager.drawTickCount%((a?4:8)*4)/(a?4:8))}else{this.animationIndex=0}var e;if(sonicManager.SpriteCache.rings){e=sonicManager.SpriteCache.rings}else{alert("sprite fial");return}var f=e[this.animationIndex*200+d.y*100+d.x];if(!f){alert("sprite fail");return}if(f.loaded){b.drawImage(f,Math.floor(c.x*d.x),Math.floor(c.y*d.y))}else{return false}}}function LZWDecompressor(a){this.input=a;this.DecompressDictionary=function(){this.revhashtable=new Array;this.nextcode=0;for(var a=0;a<256;++a){this.revhashtable[this.nextcode++]=String.fromCharCode(a)}this.numBits=9;this.Size=function(){return this.nextcode};this.Insert=function(a){this.revhashtable[this.nextcode++]=a;var b=Math.log(this.nextcode+2)/Math.LN2;this.numBits=Math.ceil(b);return this.numBits};this.LookupIndex=function(a){return this.revhashtable[a]};this.ValSizeInBits=function(){return this.numBits}};this.decompress=function(a,b){if(b==0){return""}var c=new this.DecompressDictionary;var d=c.ValSizeInBits();var e=this.input.Read(d);var f=String.fromCharCode(e);var g=f;var h="";while((e=this.input.Read(d))!=null){if(e<c.Size()){h=c.LookupIndex(e)}else{h=g+g.charAt(0)}f+=h;d=c.Insert(g+h.charAt(0));g=h}return f}}function LZWCompressor(a){this.output=a;this.CompressDictionary=function(){this.hashtable=new Object;this.nextcode=0;for(var a=0;a<256;++a){var b=String.fromCharCode(a);this.hashtable[b]=this.nextcode++}this.Exists=function(a){return this.hashtable.hasOwnProperty(a)};this.Insert=function(a){var b=this.ValSizeInBits();this.hashtable[a]=this.nextcode++;return b};this.Lookup=function(a){return this.hashtable[a]};this.ValSizeInBits=function(){var a=Math.log(this.nextcode+1)/Math.LN2;return Math.ceil(a)}};this.compress=function(a){var b=a.length;if(b==0){return output.bytestream}var c=new this.CompressDictionary;var d=c.ValSizeInBits();var e="";for(var f=0;f<b;++f){var g=a.charAt(f);if(c.Exists(e+g)){e=e+g}else{d=c.Insert(e+g);this.output.Write(c.Lookup(e),d);e=g}}this.output.Write(c.Lookup(e),d)}}function InStream(a,b){this.bytestream=a;this.bitcount=b;this.offset=0;this.ReadBit=function(){var a=this.bytestream[this.offset>>>3]>>(this.offset&7);this.offset++;return a&1};this.Read=function(a){if(this.offset+a>this.bitcount){return null}var b=0;for(var c=0;c<a;++c){b|=this.ReadBit()<<c}return b}}function OutStream(){this.bytestream=new Array;this.offset=0;this.WriteBit=function(a){this.bytestream[this.offset>>>3]|=a<<(this.offset&7);this.offset++};this.Write=function(a,b){for(var c=0;c<b;++c){this.WriteBit(a>>>c&1)}}}function HeightMask(a,b,c){this.width=16;this.height=16;this.angle=b;this.items=c?c:[];this.rotationMode=a;for(var d=0;d<16;d++){this.items[d]=0}HeightMask.prototype.setItem=function(a,b){var c=0,d=0;switch(this.rotationMode){case RotationMode.Ground:c=a;d=b;break;case RotationMode.Right:c=b;d=a;break;case RotationMode.Ceiling:c=a;d=15-b;break;case RotationMode.Left:c=b;d=15-a;break;default:}this.items[c]=16-d};HeightMask.prototype.draw=function(a,b,c,d){if(d==3){return}for(var e=0;e<16;e++){for(var f=0;f<16;f++){var g=0,h=0;switch(this.rotationMode){case RotationMode.Ground:g=e;h=f;break;case RotationMode.Right:g=f;h=e;break;case RotationMode.Ceiling:g=e;h=15-f;break;case RotationMode.Left:g=15-f;h=e;break;default:}var i=b.x+g*c.x;var j=b.y+h*c.y;a.lineWidth=1;if(d<=0&&this.items[e]>=16-f){a.fillStyle="rgba(24,98,235,0.6)";a.fillRect(i,j,c.x,c.y)}else{if(d!=-1){a.lineWidth=1;a.strokeStyle="#0C3146";a.strokeRect(i,j,c.x,c.y)}}}}if(d==1){a.strokeStyle="#DC4146";a.lineWidth=4;a.moveTo(b.x+8*c.x,b.y+8*c.y);a.lineTo(b.x+8*c.x+Math.sin(this.angle*(Math.PI/180))*6*c.x,b.y+8*c.y+Math.cos(this.angle*(Math.PI/180))*6*c.y);a.stroke()}}}var Endian={BIG:0,LITTLE:1};var ZipConstants={LOCSIG:67324752,LOCHDR:30,LOCVER:4,LOCNAM:26,EXTSIG:134695760,EXTHDR:16,CENSIG:33639248,CENHDR:46,CENVER:6,CENNAM:28,CENOFF:42,ENDSIG:101010256,ENDHDR:22,ENDTOT:10,ENDOFF:16,STORED:0,DEFLATED:8};var Base64=function(a){var b=undefined;if(navigator.userAgent.toLowerCase().indexOf(" chrome/")>=0||navigator.userAgent.toLowerCase().indexOf(" firefox/")>=0||navigator.userAgent.toLowerCase().indexOf(" gecko/")>=0){b=function(){this.str="";this.length=0;this.append=function(a){this.str+=a;this.length+=a.length};this.prepend=function(a){this.str=a+this.str;this.length+=a.length};this.toString=function(){return this.str}}}else{b=function(){this.parts=[];this.length=0;this.append=function(a){this.parts.push(a);this.length+=a.length};this.prepend=function(a){this.parts.unshift(a);this.length+=a.length};this.toString=function(){return this.parts.join("")}}}var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var d=new b,e,f,g,h,i,j,k,l=0;while(l<a.length){e=a.charCodeAt(l++);f=a.charCodeAt(l++);g=a.charCodeAt(l++);h=e>>2;i=(e&3)<<4|f>>4;j=(f&15)<<2|g>>6;k=g&63;if(isNaN(f)){j=k=64}else{if(isNaN(g)){k=64}}d.append(c.charAt(h)+c.charAt(i)+c.charAt(j)+c.charAt(k))}return d.toString()};var BA=function(a,b){var c="",d=0,e=0,f=0;if(a){c=a||"";f=b!==undefined?b:f;d=a.length}var g=typeof a!="string"&&a!==undefined;var h=function(a){throw a};return{position:function(a){if(a){e=a}else{return e}},move:function(a){e+=a},bytesAvailable:function(){return d-e},length:function(){return d},endian:function(a){if(a){f=a}else{return f}},data:function(a){if(a){c=a||"";d=c.length;g=typeof a!="string"&&a!==undefined}else{return c}},readByte:function(){if(this.bytesAvailable()===0){h("readByte::End of stream!")}return g?c[e++]&255:c.charCodeAt(e++)&255},readByteAt:function(a){if(a<d){return g?c[a]&255:c.charCodeAt(a)&255}return h("readByteAt::End of stream")},writeByte:function(a){if(g){if(e<d){c[e]=a&255}else{c[c.length++]=a}e++;return}if(e<d){c=c.substr(0,e)+String.fromCharCode(a&255)+c.substring(e+1)}else{c+=String.fromCharCode(a&255);d+=1}e++},readBytes:function(a,b){if(b===undefined){var d=e;e+=a;if(g){var f="";for(var h=d;h<d+a;h++){f+=String.fromCharCode(c[h])}return f}else{return c.substr(d,a)}}if(g){var i="";for(var j=a;j<a+b;j++){i+=String.fromCharCode(c[j])}return i}return c.substr(a,b)},readUnsignedInt:function(){if(this.bytesAvailable()<4){throw"End of stream!"}var a=0,b=0;if(f==Endian.BIG){a=(e+=4)-4;if(g){b=(c[a]&255)<<24|(c[++a]&255)<<16|(c[++a]&255)<<8|c[++a]&255}else{b=(c.charCodeAt(a)&255)<<24|(c.charCodeAt(++a)&255)<<16|(c.charCodeAt(++a)&255)<<8|c.charCodeAt(++a)&255}}else{a=e+=4;if(g){b=(c[--a]&255)<<24|(c[--a]&255)<<16|(c[--a]&255)<<8|c[--a]&255}else{b=(c.charCodeAt(--a)&255)<<24|(c.charCodeAt(--a)&255)<<16|(c.charCodeAt(--a)&255)<<8|c.charCodeAt(--a)&255}}return b},readUnsignedShort:function(){if(this.bytesAvailable()<2){throw"End of stream!"}var a=0;if(f==Endian.BIG){a=(e+=2)-2;if(g){return(c[a]&255)<<8|c[++a]&255}else{return(c.charCodeAt(a)&255)<<8|c.charCodeAt(++a)&255}}else{a=e+=2;if(g){return(c[--a]&255)<<8|c[--a]&255}else{return(c.charCodeAt(--a)&255)<<8|c.charCodeAt(--a)&255}}},readShort:function(){if(this.bytesAvailable()<2){throw"End of stream!"}var a=0,b=0;if(f==Endian.BIG){a=(e+=2)-2;if(g){b=(c[a]&255)<<8|c[++a]&255}else{b=(c.charCodeAt(a)&255)<<8|c.charCodeAt(++a)&255}}else{a=e+=2;if(g){b=(c[--a]&255)<<8|c[--a]&255}else{b=(c.charCodeAt(--a)&255)<<8|c.charCodeAt(--a)&255}}return b>=32768?b-65536:b},readUTFBytes:function(a){a=a||0;var b="";for(var c=0;c<a;c++){b+=String.fromCharCode(this.readByte())}return b}}};var Inflater=function(){function v(){var a=new Array,d=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],e=p(5)+257,f=p(5)+1,g=p(4)+4;if(e>b||f>c){throw"dynamic block code description: too many length or distance codes"}for(var h=0;h<g;h++){a[d[h]]=p(3)}for(;h<19;h++){a[d[h]]=0}var i=q(n,a,19);if(i!==0){throw"dynamic block code description: code lengths codes incomplete"}h=0;while(h<e+f){var j=r(n),k;if(j<16){a[h++]=j}else{k=0;if(j==16){if(h===0){throw"dynamic block code description: repeat lengths with no first length"}k=a[h-1];j=3+p(2)}else{if(j==17){j=3+p(3)}else{j=11+p(7)}}if(h+j>e+f){throw"dynamic block code description: repeat more than specified lengths"}while(j--){a[h++]=k}}}i=q(n,a,e);if(i<0||i>0&&e-n.count[0]!=1){throw"dynamic block code description: invalid literal/length code lengths"}i=q(o,a.slice(e),f);if(i<0||i>0&&f-o.count[0]!=1){throw"dynamic block code description: invalid distance code lengths"}return i}function u(){var a=new Array;for(var b=0;b<144;b++){a[b]=8}for(;b<256;b++){a[b]=9}for(;b<280;b++){a[b]=7}for(;b<e;b++){a[b]=8}q(n,a,e);for(b=0;b<c;b++){a[b]=5}q(o,a,c)}function t(a){l=0;m=0;if(k+4>j.length()){throw"available inflate data did not terminate"}var b=j[k++];b|=j[k++]<<8;if(j[k++]!=(~b&255)||j[k++]!=(~b>>8&255)){throw"stored block length did not match one's complement"}if(k+b>j.length()){throw"available inflate data did not terminate"}while(b--){a[a.length]=j[k++]}}function s(a){do{var b=r(n);if(b<0){return b}if(b<256){a.position(a.length());a.writeByte(b)}else{if(b>256){b-=257;if(b>=29){throw"invalid literal/length or distance code in fixed or dynamic block"}var c=f[b]+p(g[b]);b=r(o);if(b<0){return b}var d=h[b]+p(i[b]);if(d>a.length()){throw"distance is too far back in fixed or dynamic block"}a.position(a.length());while(c--){a.writeByte(a.readByteAt(a.length()-d))}}}}while(b!=256);return 0}function r(b){var c=0,d=0,e=0;for(var f=1;f<=a;f++){c|=p(1);var g=b.count[f];if(c<d+g){return b.symbol[e+(c-d)]}e+=g;d+=g;d<<=1;c<<=1}return-9}function q(b,c,d){var e=new Array;for(var f=0;f<=a;f++){b.count[f]=0}for(var g=0;g<d;g++){b.count[c[g]]++}if(b.count[0]==d){return 0}var h=1;for(f=1;f<=a;f++){h<<=1;h-=b.count[f];if(h<0){return h}}e[1]=0;for(f=1;f<a;f++){e[f+1]=e[f]+b.count[f]}for(g=0;g<d;g++){if(c[g]!==0){b.symbol[e[c[g]]++]=g}}return h}function p(a){var b=l;while(m<a){if(k==j.length()){throw"available inflate data did not terminate"}b|=j.readByteAt(k++)<<m;m+=8}l=b>>a;m-=a;return b&(1<<a)-1}var a=15,b=286,c=30,d=316,e=288,f=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],g=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],h=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],i=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],j=undefined,k=0,l=0,m=0,n=undefined,o=undefined;return{setInput:function(a){j=a;j.endian(Endian.LITTLE);j.position(0)},inflate:function(a){k=l=m=0;var b=0;do{var c=p(1);var d=p(2);if(d===0){t(a)}else{if(d==3){throw"invalid block type (type == 3)"}else{n={count:new Array(0),symbol:new Array(0)};o={count:new Array(0),symbol:new Array(0)};if(d==1){u()}else{if(d==2){b=v()}}if(b!==0){return b}b=s(a)}}if(b!==0){break}}while(!c);return b}}};var ZipEntry=function(a){var b=a,c=0,d=0,e=0,f=0;return{name:function(){return b},time:function(a){var b;if(a){b=new Date(time);c=(b.fullYear-1980&127)<<25|b.month+1<<21|b.day<<16|b.hours<<11|b.minutes<<5|b.seconds>>1}else{b=new Date((c>>25&127)+1980,(c>>21&15)-1,c>>16&31,c>>11&31,c>>5&63,(c&31)<<1);return b.getTime()}},size:0,compressedSize:0,crc:0,method:0,extra:undefined,comment:"",isDirectory:function(){return b.charAt(b.length-1)=="/"}}};var ZipFile=function(a){function h(){var a=b.length()-ZipConstants.ENDHDR;var c=Math.max(0,a-65535);for(a;a>=c;a--){b.position(a);if(b.readByte()!=80){continue}b.position(a);if(b.readUnsignedInt()==101010256){return a}}throw"findEND::Invalid zip"}function g(){var a=new BA;a.endian(Endian.LITTLE);a.data(b.readBytes(h(),ZipConstants.ENDHDR));a.position(ZipConstants.ENDTOT);c=new Array(a.readUnsignedShort());a.position(ZipConstants.ENDOFF);b.position(a.readUnsignedInt())}function f(){g();d={};e={};for(var a=0;a<c.length;a++){var f=new BA(b.readBytes(ZipConstants.CENHDR),Endian.LITTLE);if(f.readUnsignedInt()!=ZipConstants.CENSIG){throw"readEntries::Invalid CEN header (bad signature)"}f.position(28);var h=f.readUnsignedShort();if(h===0){throw"missing entry name"}var i=new ZipEntry(b.readUTFBytes(h));h=f.readUnsignedShort();i.extra=new BA;if(h>0){i.extra.data(b.readBytes(h))}b.move(f.readUnsignedShort());f.position(6);i.version=f.readUnsignedShort();i.flag=f.readUnsignedShort();if((i.flag&1)==1){throw"readEntries::Encrypted ZIP entry not supported"}i.method=f.readUnsignedShort();i.dostime=f.readUnsignedInt();i.crc=f.readUnsignedInt();i.compressedSize=f.readUnsignedInt();i.size=f.readUnsignedInt();c[a]=i;d[i.name()]=i;f.position(42);e[i.name()]=f.readUnsignedInt()}}var b=undefined,c=[],d={},e={};b=new BA(a.data(),Endian.LITTLE);f();return{entries:function(){return c},size:function(){return c.length},getEntry:function(a){return d[a]},getInput:function(a){b.position(e[a.name()]+30-2);var c=b.readShort();b.move(a.name().length+c);var d=new BA;if(a.compressedSize>0){d.data(b.readBytes(a.compressedSize))}switch(a.method){case 0:return d;break;case 8:var f=new BA;var g=new Inflater;g.setInput(d);g.inflate(f);f.position(0);return f;break;default:throw"zipEntry::getInput::Invalid compression method"}}}};var ZipLoader=function(zipURL){function _utf8_decode(a){if(a.charCodeAt(0)==239&&a.charCodeAt(1)==187&&a.charCodeAt(2)==191){a=a.substr(3);var b="";var c=0;var d=c1=c2=0;while(c<a.length){d=a.charCodeAt(c);if(d<128){b+=String.fromCharCode(d);c++}else{if(d>191&&d<224){c2=a.charCodeAt(c+1);b+=String.fromCharCode((d&31)<<6|c2&63);c+=2}else{c2=a.charCodeAt(c+1);c3=a.charCodeAt(c+2);b+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63);c+=3}}}return b}return a}function getFileExtension(a){return/[.]/.exec(a)&&/[^.]+$/.exec(a)[0]||""}function appendChild(a,b){if(null===a.canHaveChildren||a.canHaveChildren){a.appendChild(document.createTextNode(b))}else{a.text=b}}function getZipEntry(a,b){if(ZIP_ENTRY_REG.test(b)){var c=ZIP_ENTRY_REG.exec(b);var d=c[1];var e=c[2];var f=new ZipFile(a.getInput(a.getEntry(d)));return getZipEntry(f,e)}else{var g=a.getEntry(b);if(g){return a.getInput(g)}else{throw"Requested file was not found in the archive"}}}function dataFromZip(a){if(a&&_entryUrl){data=getZipEntry(a,_entryUrl)}}function loadComplete(a){if(isCompleteProcessRequired){var b=new ZipFile(new BA(a,Endian.LITTLE));ZIP_CACHE[_zipUrl]=b;dataFromZip(b)}}function loadBinaryResource(a){var b=getXMLHttpObj();b.open("GET",a,false);if(!b.overrideMimeType){var c='<script type="text/vbscript">\n<!--\nFunction BinaryToArray(Binary)\n  Dim i\n  ReDim byteArray(LenB(Binary))\n  For i = 1 To LenB(Binary)\n    byteArray(i-1) = AscB(MidB(Binary, i, 1))\n  Next\n  BinaryToArray = byteArray\nEnd Function\n-->\n</script>';document.write(c);b.setRequestHeader("Accept-Charset","x-user-defined");b.send();var d=BinaryToArray(b.responseBody).toArray();loadComplete(d)}else{b.overrideMimeType("text/plain; charset=x-user-defined");b.send();loadComplete(b.responseText)}}function getXMLHttpObj(){if(typeof XMLHttpRequest!="undefined"){return new XMLHttpRequest}var a=["Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.4.0","Msxml2.XMLHTTP.3.0","Msxml2.XMLHTTP","Microsoft.XMLHTTP"],b;for(b=0;b<a.length;b++){try{return new ActiveXObject(a[b])}catch(c){}}return null}function isIE(){return navigator.userAgent.match(/MSIE/)!==null}var ZIP_CACHE={},ZIP_FILE_REG=new RegExp(".*?.zip$","i"),ZIP_ENTRY_REG=new RegExp("(.*?.zip)://(.*$)","i"),_zipUrl=zipURL,_entryUrl="",_entryDataFormat="",isCompleteProcessRequired=true,data=undefined;if(_zipUrl){loadBinaryResource(_zipUrl)}return{load:function(a){isCompleteProcessRequired=false;switch(true){case ZIP_ENTRY_REG.test(a):var b=ZIP_ENTRY_REG.exec(a);_zipUrl=b[1];_entryUrl=b[2];var c=ZIP_CACHE[_zipUrl];if(c){dataFromZip(c)}else{isCompleteProcessRequired=true;loadBinaryResource(a)}break;case ZIP_FILE_REG.test(a):isCompleteProcessRequired=true;_zipUrl=a;_entryDataFormat="Text";loadBinaryResource(a);break;default:loadBinaryResource(a);break}if(data){data.position(0);return _utf8_decode(data.readBytes(0,data.length()))}else{return""}},loadImage:function(a){var b=this.load(a);if(b){var c="data:";switch(getFileExtension(a).toLowerCase()){case"gif":c+="image/gif;base64,";break;case"png":c+="image/png;base64,";break;case"jpg":case"jpeg":c+="image/jpeg;base64,";break}c+=Base64(b)}return c},loadCSS:function(a){var b=_utf8_decode(this.load(a));if(b){var c=document.getElementsByTagName("head")[0];var d=document.createElement("style");d.type="text/css";d.media="screen";if(d.styleSheet){d.styleSheet.cssText=b}else{d.appendChild(document.createTextNode(b))}c.appendChild(d)}},loadScript:function(url,encoding){var data=_utf8_decode(this.load(url));if(data){var fileRef=window.document.createElement("script");fileRef.setAttribute("type","text/javascript");fileRef.setAttribute("charset",encoding);if(isIE()){eval(data)}else{var head=document.getElementsByTagName("head")[0]||document.documentElement;head.insertBefore(fileRef,head.firstChild);appendChild(fileRef,data)}}}}};window._H={loadSprite:function(a,b){var c=new Image;c.onload=function(){c.loaded=true;if(b){b(c)}};c.src=a;return c},defaultWindowLocation:function(a){switch(a){case 0:return{x:0,y:0,width:320,height:240};case 1:return{x:0,y:0,width:900,height:240*2}}return null},defaultCanvas:function(a,b){var c=document.createElement("canvas");c.width=a;c.height=b;var d=c.getContext("2d");d.width=a;d.height=b;return{canvas:c,context:d}},intersectRect:function(a,b){return!(b.left>a.right||b.right<a.left||b.top>a.bottom||b.bottom<a.top)},remove:function(a,b){var c=-1;while((c=a.indexOf(b))>-1){a.splice(c,1)}},getShortsFromInt:function(a,b){var c=-1;while((c=a.indexOf(b))>-1){a.splice(c,1)}},scaleSprite:function(a,b,c){var d=_H.getImageData(a);var e=[];for(var f=0;f<d.length;f+=4){e.push(_H.colorObjectFromData(d,f))}var g=this.defaultCanvas().context.createImageData(a.width*b.x,a.height*b.y);_H.setDataFromColors(g.data,e,b,a.width,{r:0,g:0,b:0});return _H.loadSprite(_H.getBase64Image(g),c)},getCursorPosition:function(a,b){if(a.targetTouches&&a.targetTouches.length>0){a=a.targetTouches[0]}if(a.pageX!=null&&a.pageY!=null){return{x:a.pageX,y:a.pageY}}if(a.x!=null&&a.y!=null){return{x:a.x,y:a.y}}return{x:a.clientX,y:a.clientY}},colorFromData:function(a,b){var c=a[b];var d=a[b+1];var e=a[b+2];var f=c.toString(16);var g=d.toString(16);var h=e.toString(16);return"#"+(f.length==1?"0"+f:f)+(g.length==1?"0"+g:g)+(h.length==1?"0"+h:h)},colorObjectFromData:function(a,b){var c=a[b];var d=a[b+1];var e=a[b+2];return{r:c,g:d,b:e}},parseNumber:function(a){switch(a){case"0":return 0;case"1":return 1;case"2":return 2;case"3":return 3;case"4":return 4;case"5":return 5;case"6":return 6;case"7":return 7;case"8":return 8;case"9":return 9;case"a":return 10;case"b":return 11;case"c":return 12;case"d":return 13;case"e":return 14;case"f":return 15;case"g":return 16}},setDataFromColors:function(a,b,c,d,e){for(var f=0;f<b.length;f++){var g=f%d;var h=Math.floor(f/d);var i=b[f];var j=false;if(e){if(i.r==e.r&&i.g==e.g&&i.b==e.b){j=true}}for(var k=0;k<c.x;k++){for(var l=0;l<c.y;l++){var m=g*c.x+k;var n=h*c.y+l;var o=(m+n*c.x*d)*4;if(j){a[o+0]=0;a[o+1]=0;a[o+2]=0;a[o+3]=0;continue}a[o]=i.r;a[o+1]=i.g;a[o+2]=i.b;a[o+3]=255}}}},getImageData:function(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;var c=b.getContext("2d");c.drawImage(a,0,0);var d=c.getImageData(0,0,a.width,a.height);return d.data},getBase64Image:function(a){var b=document.createElement("canvas");b.width=a.width;b.height=a.height;var c=b.getContext("2d");c.putImageData(a,0,0);var d=b.toDataURL("image/png");return d},isFunction:function(a){var b={};return a&&b.toString.call(a)=="[object Function]"},detect:function(a,b){for(var c in a){if(typeof a[c]=="object"){if(b[a[c]]){alert("circ")}b[a[c]]=true;this.detect(a[c],b)}}},stringify:function(a,b){return JSON.stringify(a,function(a,b){if(a=="imageData"){return undefined}if(a=="oldScale"){return undefined}if(a=="sprite"){return undefined}if(a=="sprites"){return undefined}if(a=="index"){return undefined}if(a=="_style"){return undefined}else{return b}});if(b>0){return""}if(!b){b=0}var c=typeof a;if(c!="object"||a===null){if(c=="string"){a='"'+a+'"'}return String(a)}else{var d,e,f=[],g=a&&a.constructor==Array;for(d in a){e=a[d];c=typeof e;if(c=="string"){e='"'+e+'"'}else{if(c=="object"&&e!==null){e=stringify(e,b+1)}}f.push((g?"":'"'+d+'":')+String(e))}return(g?"[":"{")+String(f)+(g?"]":"}")}},compareTiles:function(a,b,c){var d;for(d=0;d<a.length;d++){if(a[d].equals(c)){return d}}for(d=0;d<b.length;d++){if(b[d].equals(c)){return a.length+d}}return-1},compareTilePieces:function(a,b,c){var d;for(d=0;d<a.length;d++){if(a[d].equals(c)){return d}}for(d=0;d<b.length;d++){if(b[d].equals(c)){return a.length+d}}return-1}};window.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b="";var c,d,e,f,g,h,i;var j=0;a=Base64._utf8_encode(a);while(j<a.length){c=a.charCodeAt(j++);d=a.charCodeAt(j++);e=a.charCodeAt(j++);f=c>>2;g=(c&3)<<4|d>>4;h=(d&15)<<2|e>>6;i=e&63;if(isNaN(d)){h=i=64}else{if(isNaN(e)){i=64}}b=b+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h)+this._keyStr.charAt(i)}return b},decode:function(a){var b="";var c,d,e;var f,g,h,i;var j=0;a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(j<a.length){f=this._keyStr.indexOf(a.charAt(j++));g=this._keyStr.indexOf(a.charAt(j++));h=this._keyStr.indexOf(a.charAt(j++));i=this._keyStr.indexOf(a.charAt(j++));c=f<<2|g>>4;d=(g&15)<<4|h>>2;e=(h&3)<<6|i;b=b+String.fromCharCode(c);if(h!=64){b=b+String.fromCharCode(d)}if(i!=64){b=b+String.fromCharCode(e)}}b=Base64._utf8_decode(b);return b},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");var b="";for(var c=0;c<a.length;c++){var d=a.charCodeAt(c);if(d<128){b+=String.fromCharCode(d)}else{if(d>127&&d<2048){b+=String.fromCharCode(d>>6|192);b+=String.fromCharCode(d&63|128)}else{b+=String.fromCharCode(d>>12|224);b+=String.fromCharCode(d>>6&63|128);b+=String.fromCharCode(d&63|128)}}}return b},_utf8_decode:function(a){var b="";var c=0;var d=c1=c2=0;while(c<a.length){d=a.charCodeAt(c);if(d<128){b+=String.fromCharCode(d);c++}else{if(d>191&&d<224){c2=a.charCodeAt(c+1);b+=String.fromCharCode((d&31)<<6|c2&63);c+=2}else{c2=a.charCodeAt(c+1);c3=a.charCodeAt(c+2);b+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63);c+=3}}}return b}};(function(a){(this.JSON||(JSON={})).hpack=function(b,c){if(3<c){var d=JSON.hbest(b),e=a[d];a=[]}else{var f=Array.prototype.indexOf||function(a){for(var b=this.length,c=0;c<b;++c){if(this[c]===a){return c}}return-1},g=[],e=[g],h=b[0],i=0,j=0,k;for(var l in h){g[i++]=l}k=i;i=0;for(var m=b.length,d=0;d<m;++d){for(var n=b[d],o=[],p=0;p<k;++p){o[p]=n[g[p]]}e[++i]=o}++i;if(0<c){for(o=e[1],p=0;p<k;++p){if(typeof o[p]!="number"){g[p]=[g[p],h=[]];h.indexOf=f;for(d=1;d<i;++d){var q=e[d][p],r=h.indexOf(q);e[d][p]=r<0?h.push(q)-1:r}}}}if(2<c){for(p=0;p<k;++p){if(g[p]instanceof Array){for(o=g[p][1],q=[],h=[],j=0,d=1;d<i;++d){q[j]=o[h[j]=e[d][p]];++j}if(JSON.stringify(q).length<JSON.stringify(h.concat(o)).length){for(j=0,d=1;d<i;++d){e[d][p]=q[j];++j}g[p]=g[p][0]}}}}else{if(1<c){m-=Math.floor(m/2);for(p=0;p<k;++p){if(g[p]instanceof Array){if(m<(h=g[p][1]).length){for(d=1;d<i;++d){var q=e[d][p];e[d][p]=h[q]}g[p]=g[p][0]}}}}}if(0<c){for(p=0;p<k;++p){if(g[p]instanceof Array){g.splice(p,1,g[p][0],g[p][1]);++k;++p}}}}return e};JSON.hunpack=function(a){for(var b=[],c=[],d=a[0],e=d.length,f=a.length,g=-1,h=-1,i=0,j=0,k,l;i<e;++i){c[++h]=d[i];if(typeof d[i+1]=="object"){++i;for(k=1;k<f;++k){l=a[k];l[j]=d[i][l[j]]}}++j}for(i=0,e=c.length;i<e;++i){c[i]='o["'.concat(c[i].replace('"',"\\x22"),'"]=a[',i,"];")}var m=Function("o,a",c.join("")+"return o;");for(k=1;k<f;++k){b[++g]=m({},a[k])}return b};JSON.hclone=function(a){for(var b=[],c=0,d=a.length;c<d;++c){b[c]=a[c].slice(0)}return b};JSON.hbest=function(b){for(var c=0,d=0,e=0,f=0;c<4;++c){a[c]=JSON.hpack(b,c);e=JSON.stringify(a[c]).length;if(f===0){f=e}else{if(e<f){f=e;d=c}}}return d}})([]);(function(){JSLINQ=window.JSLINQ=function(a){return new JSLINQ.fn.init(a)};JSLINQ.fn=JSLINQ.prototype={init:function(a){this.items=a},jslinq:"2.10",ToArray:function(){return this.items},Where:function(a){var b;var c=new Array;for(var d=0;d<this.items.length;d++){if(a(this.items[d],d)){c[c.length]=this.items[d]}}return new JSLINQ(c)},Select:function(a){var b;var c=new Array;for(var d=0;d<this.items.length;d++){if(a(this.items[d])){c[c.length]=a(this.items[d])}}return new JSLINQ(c)},OrderBy:function(a){var b=new Array;for(var c=0;c<this.items.length;c++){b[b.length]=this.items[c]}return new JSLINQ(b.sort(function(b,c){var d=a(b);var e=a(c);return d<e?-1:d>e?1:0}))},OrderByDescending:function(a){var b=new Array;for(var c=0;c<this.items.length;c++){b[b.length]=this.items[c]}return new JSLINQ(b.sort(function(b,c){var d=a(c);var e=a(b);return d<e?-1:d>e?1:0}))},SelectMany:function(a){var b=new Array;for(var c=0;c<this.items.length;c++){b=b.concat(a(this.items[c]))}return new JSLINQ(b)},Count:function(a){if(a==null){return this.items.length}else{return this.Where(a).items.length}},Distinct:function(a){var b;var c=new Object;var d=new Array;for(var e=0;e<this.items.length;e++){b=a(this.items[e]);if(c[b]==null){c[b]=true;d[d.length]=b}}c=null;return new JSLINQ(d)},Any:function(a){for(var b=0;b<this.items.length;b++){if(a(this.items[b],b)){return true}}return false},All:function(a){for(var b=0;b<this.items.length;b++){if(!a(this.items[b],b)){return false}}return true},Reverse:function(){var a=new Array;for(var b=this.items.length-1;b>-1;b--){a[a.length]=this.items[b]}return new JSLINQ(a)},First:function(a){if(a!=null){return this.Where(a).First()}else{if(this.items.length>0){return this.items[0]}else{return null}}},Last:function(a){if(a!=null){return this.Where(a).Last()}else{if(this.items.length>0){return this.items[this.items.length-1]}else{return null}}},ElementAt:function(a){return this.items[a]},Concat:function(a){var b=a.items||a;return new JSLINQ(this.items.concat(b))},Intersect:function(a,b){var c;if(b!=undefined){c=b}else{c=function(a,b,c,d){return a==c}}var d=a.items||a;var e=new Array;for(var f=0;f<this.items.length;f++){for(var g=0;g<d.length;g++){if(c(this.items[f],f,d[g],g)){e[e.length]=this.items[f]}}}return new JSLINQ(e)},DefaultIfEmpty:function(a){if(this.items.length==0){return a}return this},ElementAtOrDefault:function(a,b){if(a>=0&&a<this.items.length){return this.items[a]}return b},FirstOrDefault:function(a){return this.First()||a},LastOrDefault:function(a){return this.Last()||a}};JSLINQ.fn.init.prototype=JSLINQ.fn})();jQuery.fn.rotate=function(a,b){var c=this.get(0);if(!b){c.angle=((c.angle==undefined?0:c.angle)+a)%360}else{c.angle=a}var d;if(c.angle>=0){d=Math.PI*c.angle/180}else{d=Math.PI*(360+c.angle)/180}var e=Math.cos(d);var f=Math.sin(d);if(document.all&&!window.opera){var g=document.createElement("img");g.src=c.src;g.height=c.height;g.width=c.width;g.style.filter="progid:DXImageTransform.Microsoft.Matrix(M11="+e+",M12="+ -f+",M21="+f+",M22="+e+",SizingMethod='auto expand')"}else{var g=document.createElement("canvas");if(!c.oImage){g.oImage=new Image;g.oImage.src=c.src}else{g.oImage=c.oImage}g.style.width=g.width=Math.abs(e*g.oImage.width)+Math.abs(f*g.oImage.height);g.style.height=g.height=Math.abs(e*g.oImage.height)+Math.abs(f*g.oImage.width);var h=g.getContext("2d");h.save();if(d<=Math.PI/2){h.translate(f*g.oImage.height,0)}else{if(d<=Math.PI){h.translate(g.width,-e*g.oImage.height)}else{if(d<=1.5*Math.PI){h.translate(-e*g.oImage.width,g.height)}else{h.translate(0,-f*g.oImage.width)}}}h.rotate(d);h.drawImage(g.oImage,0,0,g.oImage.width,g.oImage.height);h.restore()}g.id=c.id;g.angle=c.angle;c.parentNode.replaceChild(g,c)};jQuery.fn.rotateRight=function(a){this.rotate(a==undefined?90:a)};jQuery.fn.rotateLeft=function(a){this.rotate(a==undefined?-90:-a)};SonicState={Air:0,Ground:1};DEBUGs=true;window.requestAnimFrame=function(a){if(window.requestAnimationFrame){return window.requestAnimationFrame(a)}if(window.webkitRequestAnimationFrame){return window.webkitRequestAnimationFrame(a)}if(window.mozRequestAnimationFrame){return window.mozRequestAnimationFrame(a)}if(window.oRequestAnimationFrame){return window.oRequestAnimationFrame(a)}if(window.msRequestAnimationFrame){return window.msRequestAnimationFrame(a)}window.setTimeout(a,1e3/60)};ClickState={PlaceChunk:0,PlaceRing:1};var Stats=function(){var a,b,c=0,d=0,e=Date.now(),f=e,g=e,h=0,i=1e3,j=0,k,l,m,n=[[16,16,48],[0,255,255]],o=0,p=1e3,q=0,r,s,t,u=[[16,48,16],[0,255,0]];a=document.createElement("div");a.style.cursor="pointer";a.style.width="80px";a.style.opacity="0.9";a.style.zIndex="10001";a.addEventListener("mousedown",function(a){a.preventDefault();c=(c+1)%2;0==c?(k.style.display="block",r.style.display="none"):(k.style.display="none",r.style.display="block")},!1);k=document.createElement("div");k.style.textAlign="left";k.style.lineHeight="1.2em";k.style.backgroundColor="rgb("+Math.floor(n[0][0]/2)+","+Math.floor(n[0][1]/2)+","+Math.floor(n[0][2]/2)+")";k.style.padding="0 0 3px 3px";a.appendChild(k);l=document.createElement("div");l.style.fontFamily="Helvetica, Arial, sans-serif";l.style.fontSize="9px";l.style.color="rgb("+n[1][0]+","+n[1][1]+","+n[1][2]+")";l.style.fontWeight="bold";l.innerHTML="FPS";k.appendChild(l);m=document.createElement("div");m.style.position="relative";m.style.width="74px";m.style.height="30px";m.style.backgroundColor="rgb("+n[1][0]+","+n[1][1]+","+n[1][2]+")";for(k.appendChild(m);74>m.children.length;){b=document.createElement("span"),b.style.width="1px",b.style.height="30px",b.style.cssFloat="left",b.style.backgroundColor="rgb("+n[0][0]+","+n[0][1]+","+n[0][2]+")",m.appendChild(b)}r=document.createElement("div");r.style.textAlign="left";r.style.lineHeight="1.2em";r.style.backgroundColor="rgb("+Math.floor(u[0][0]/2)+","+Math.floor(u[0][1]/2)+","+Math.floor(u[0][2]/2)+")";r.style.padding="0 0 3px 3px";r.style.display="none";a.appendChild(r);s=document.createElement("div");s.style.fontFamily="Helvetica, Arial, sans-serif";s.style.fontSize="9px";s.style.color="rgb("+u[1][0]+","+u[1][1]+","+u[1][2]+")";s.style.fontWeight="bold";s.innerHTML="MS";r.appendChild(s);t=document.createElement("div");t.style.position="relative";t.style.width="74px";t.style.height="30px";t.style.backgroundColor="rgb("+u[1][0]+","+u[1][1]+","+u[1][2]+")";for(r.appendChild(t);74>t.children.length;){b=document.createElement("span"),b.style.width="1px",b.style.height=30*Math.random()+"px",b.style.cssFloat="left",b.style.backgroundColor="rgb("+u[0][0]+","+u[0][1]+","+u[0][2]+")",t.appendChild(b)}return{getDomElement:function(){return a},getFps:function(){return h},getFpsMin:function(){return i},getFpsMax:function(){return j},getMs:function(){return o},getMsMin:function(){return p},getMsMax:function(){return q},update:function(){e=Date.now();o=e-f;p=Math.min(p,o);q=Math.max(q,o);s.textContent=o+" MS ("+p+"-"+q+")";var a=Math.min(30,30-30*(o/200));t.appendChild(t.firstChild).style.height=a+"px";f=e;d++;if(e>g+1e3){h=Math.round(1e3*d/(e-g)),i=Math.min(i,h),j=Math.max(j,h),l.textContent=h+" FPS ("+i+"-"+j+")",a=Math.min(30,30-30*(h/100)),m.appendChild(m.firstChild).style.height=a+"px",g=e,d=0}}}};RotationMode={Ground:134,Right:224,Ceiling:314,Left:44};