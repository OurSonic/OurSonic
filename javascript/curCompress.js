function HeightMask(a,b){this.width=16;this.height=16;this.angle=a;this.items=b?b:[];HeightMask.prototype.setItem=function(f,g,e){var c=0,d=0;switch(e){case RotationMode.Floor:c=f;d=g;break;case RotationMode.RightWall:c=g;d=f;break;case RotationMode.Ceiling:c=f;d=15-g;break;case RotationMode.LeftWall:c=g;d=15-f;break;default:}this.items[c]=16-d};HeightMask.prototype.draw=function(e,j,k,m,o,q,l){e.save();if(o){j.x=-j.x-16*k.x;e.scale(-1,1)}if(q){j.y=-j.y-16*k.y;e.scale(1,-1)}var f;if((f=sonicManager.SpriteCache.heightMaps[this.index])){if(f.loaded){e.drawImage(f,j.x,j.y)}}else{if(l>0){for(var n=0;n<16;n++){var g=0,h=0;var p=16-this.items[n];g=n;h=p;var c=j.x+(g*k.x);var d=j.y+(h*k.y);e.lineWidth=1;e.fillStyle=HeightMask.colors[l];e.fillRect(c,d,k.x,k.y*this.items[n])}}}if(m==1){e.strokeStyle="#DC4146";e.lineWidth=4;e.moveTo(j.x+8*k.x,j.y+8*k.y);e.lineTo(j.x+8*k.x+_H.sin((this.angle))*6*k.x,j.y+8*k.y+_H.cos((this.angle))*6*k.y);e.stroke()}e.restore()}}HeightMask.colors=["rgba(24,98,235,0.6)","rgba(255,98,235,0.6)","rgba(24,218,235,0.6)","rgba(24,98,235,0.6)"];window._H={floor:function(a){if(a>0){return ~~a}return Math.floor(a)},min:function(a,b){return a>b?b:a},max:function(a,b){return a<b?b:a},xor:function(a,b){return(a&&!b)||(!a&&b)},loadSprite:function(c,a){var b=new Image();b.onload=function(){b.loaded=true;if(a){a(b)}};b.src=c;return b},fixAngle:function(a){var b=Math.floor((256-a)*1.4062)%360;var c=360-b;return _H.degtorad(c)},degtorad:function(a){return a*Math.PI/180},sign:function(a){return a==0?0:(a<0?-1:1)},defaultWindowLocation:function(a){switch(a){case 0:return{x:0,y:0,width:320,height:240,intersects:_H.intersects};case 1:return{x:0,y:0,width:900,height:240*2,intersects:_H.intersects}}return null},ObjectParse:function(a){switch(a.ID){case 1:return new MonitorObject(a);break;case 7:return new SpringObject(a);break}return new LevelObject(a)},intersects:function(a){if(this.x<a.X&&this.x+this.width>a.X&&this.y<a.Y&&this.y+this.height>a.Y){return true}return false},defaultCanvas:function(d,c){var a=document.createElement("canvas");a.width=d;a.height=c;var b=a.getContext("2d");b.width=d;b.height=c;return{canvas:a,context:b}},intersectRect:function(a,b){return !(b.left>a.right||b.right<a.left||b.top>a.bottom||b.bottom<a.top)},remove:function(a,b){var c=-1;while((c=a.indexOf(b))>-1){a.splice(c,1)}},getShortsFromInt:function(a,b){var c=-1;while((c=a.indexOf(b))>-1){a.splice(c,1)}},scaleSprite:function(j,h,b){var e=_H.getImageData(j);var a=[];for(var g=0;g<e.length;g+=4){a.push(_H.colorObjectFromData(e,g))}var c=this.defaultCanvas().context.createImageData(j.width*h.x,j.height*h.y);_H.setDataFromColors(c.data,a,h,j.width,{r:0,g:0,b:0});return _H.loadSprite(_H.getBase64Image(c),b)},getCursorPosition:function(a,b){if(a.targetTouches&&a.targetTouches.length>0){a=a.targetTouches[0]}if(a.pageX!=null&&a.pageY!=null){return{x:a.pageX,y:a.pageY}}if(a.x!=null&&a.y!=null){return{x:a.x,y:a.y}}return{x:a.clientX,y:a.clientY}},colorFromData:function(j,h){var l=j[h];var k=j[h+1];var f=j[h+2];var e=l.toString(16);var d=k.toString(16);var a=f.toString(16);return"#"+(e.length==1?"0"+e:e)+(d.length==1?"0"+d:d)+(a.length==1?"0"+a:a)},colorObjectFromData:function(e,d){var h=e[d];var f=e[d+1];var a=e[d+2];return{r:h,g:f,b:a}},parseNumber:function(a){switch(a){case"0":return 0;case"1":return 1;case"2":return 2;case"3":return 3;case"4":return 4;case"5":return 5;case"6":return 6;case"7":return 7;case"8":return 8;case"9":return 9;case"a":return 10;case"b":return 11;case"c":return 12;case"d":return 13;case"e":return 14;case"f":return 15;case"g":return 16}return -1},setDataFromColors:function(f,b,p,r,q){for(var l=0;l<b.length;l++){var d=(l%r);var e=_H.floor(l/r);var h=b[l];var m=false;if(q){if(h.r==q.r&&h.g==q.g&&h.b==q.b){m=true}}for(var n=0;n<p.x;n++){for(var o=0;o<p.y;o++){var s=(d*p.x+n);var t=(e*p.y+o);var a=(s+t*(p.x*r))*4;if(m){f[a+0]=0;f[a+1]=0;f[a+2]=0;f[a+3]=0;continue}f[a]=h.r;f[a+1]=h.g;f[a+2]=h.b;f[a+3]=255}}}},getImageData:function(d){var a=document.createElement("canvas");a.width=d.width;a.height=d.height;var b=a.getContext("2d");b.drawImage(d,0,0);var c=b.getImageData(0,0,d.width,d.height);return c.data},getBase64Image:function(c){var a=document.createElement("canvas");a.width=c.width;a.height=c.height;var b=a.getContext("2d");b.putImageData(c,0,0);var d=a.toDataURL("image/png");return d},isFunction:function(a){var b={};return a&&b.toString.call(a)=="[object Function]"},detect:function(c,a){for(var b in c){if(typeof(c[b])=="object"){if(a[c[b]]){alert("circ")}a[c[b]]=true;this.detect(c[b],a)}}},stringify:function(e,b){return JSON.stringify(e,function(h,j){if(h=="imageData"){return undefined}if(h=="oldScale"){return undefined}if(h=="sprite"){return undefined}if(h=="sprites"){return undefined}if(h=="index"){return undefined}if(h=="_style"){return undefined}else{return j}});if(b>0){return""}if(!b){b=0}var f=typeof(e);if(f!="object"||e===null){if(f=="string"){e='"'+e+'"'}return String(e)}else{var d,g,c=[],a=(e&&e.constructor==Array);for(d in e){g=e[d];f=typeof(g);if(f=="string"){g='"'+g+'"'}else{if(f=="object"&&g!==null){g=stringify(g,b+1)}}c.push((a?"":'"'+d+'":')+String(g))}return(a?"[":"{")+String(c)+(a?"]":"}")}},sin:function(a){return cos_table[(a+64)&255]},cos:function(a){return cos_table[(a)&255]}};window.cos_table=[1,0.9997,0.9988,0.99729,0.99518,0.99248,0.98918,0.98528,0.9807900000000001,0.9757,0.97003,0.96378,0.95694,0.94953,0.94154,0.93299,0.92388,0.91421,0.90399,0.89322,0.88192,0.87009,0.85773,0.84485,0.83147,0.81758,0.80321,0.78835,0.77301,0.7572100000000001,0.74095,0.72425,0.70711,0.68954,0.6715600000000001,0.65317,0.63439,0.6152300000000001,0.5957,0.57581,0.55557,0.535,0.5141,0.4929,0.4714,0.44961,0.42755,0.40524,0.38268,0.3599,0.33689,0.31368,0.29028,0.26671,0.24298,0.2191,0.19509,0.17096,0.14673,0.12241,0.09802,0.07356,0.04907,0.02454,0,-0.02454,-0.04907,-0.07356,-0.09802,-0.12241,-0.14673,-0.17096,-0.19509,-0.2191,-0.24298,-0.26671,-0.29028,-0.31368,-0.33689,-0.3599,-0.38268,-0.40524,-0.42755,-0.44961,-0.4714,-0.4929,-0.5141,-0.535,-0.55557,-0.57581,-0.5957,-0.6152300000000001,-0.63439,-0.65317,-0.6715600000000001,-0.68954,-0.70711,-0.72425,-0.74095,-0.7572100000000001,-0.77301,-0.78835,-0.80321,-0.81758,-0.83147,-0.84485,-0.85773,-0.87009,-0.88192,-0.89322,-0.90399,-0.91421,-0.92388,-0.93299,-0.94154,-0.94953,-0.95694,-0.96378,-0.97003,-0.9757,-0.9807900000000001,-0.98528,-0.98918,-0.99248,-0.99518,-0.99729,-0.9988,-0.9997,-1,-0.9997,-0.9988,-0.99729,-0.99518,-0.99248,-0.98918,-0.98528,-0.9807900000000001,-0.9757,-0.97003,-0.96378,-0.95694,-0.94953,-0.94154,-0.93299,-0.92388,-0.91421,-0.90399,-0.89322,-0.88192,-0.87009,-0.85773,-0.84485,-0.83147,-0.81758,-0.80321,-0.78835,-0.77301,-0.7572100000000001,-0.74095,-0.72425,-0.70711,-0.68954,-0.6715600000000001,-0.65317,-0.63439,-0.6152300000000001,-0.5957,-0.57581,-0.55557,-0.535,-0.5141,-0.4929,-0.4714,-0.44961,-0.42756,-0.40524,-0.38268,-0.3599,-0.33689,-0.31368,-0.29028,-0.26671,-0.24298,-0.2191,-0.19509,-0.17096,-0.14673,-0.12241,-0.09802,-0.07356,-0.04907,-0.02454,-0,0.02454,0.04907,0.07356,0.09802,0.12241,0.14673,0.17096,0.19509,0.2191,0.24298,0.26671,0.29028,0.31368,0.33689,0.3599,0.38268,0.40524,0.42756,0.44961,0.4714,0.4929,0.5141,0.535,0.55557,0.57581,0.5957,0.6152300000000001,0.63439,0.65317,0.6715600000000001,0.68954,0.70711,0.72425,0.74095,0.7572100000000001,0.77301,0.78835,0.80321,0.81758,0.83147,0.84485,0.85773,0.87009,0.88192,0.89322,0.90399,0.91421,0.92388,0.93299,0.94154,0.94953,0.95694,0.96378,0.97003,0.9757,0.9807900000000001,0.98528,0.98918,0.99248,0.99518,0.99729,0.9988,0.9997];var base64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");var base64inv={};for(var i=0;i<base64chars.length;i++){base64inv[base64chars[i]]=i}window.decodeNumeric=function(f){f=f.replace(new RegExp("[^"+base64chars.join("")+"=]","g"),"");var d=(f.charAt(f.length-1)=="="?(f.charAt(f.length-2)=="="?"AA":"A"):"");var e=[];f=f.substr(0,f.length-d.length)+d;for(var a=0;a<f.length;a+=4){var b=(base64inv[f.charAt(a)]<<18)+(base64inv[f.charAt(a+1)]<<12)+(base64inv[f.charAt(a+2)]<<6)+base64inv[f.charAt(a+3)];e.push((b>>>16)&255);e.push((b>>>8)&255);e.push(b&255)}return e.slice(0,e.length-1)};window.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(j){var k="";var a,b,c,d,e,f,g;var h=0;j=Base64._utf8_encode(j);while(h<j.length){a=j.charCodeAt(h++);b=j.charCodeAt(h++);c=j.charCodeAt(h++);d=a>>2;e=((a&3)<<4)|(b>>4);f=((b&15)<<2)|(c>>6);g=c&63;if(isNaN(b)){f=g=64}else{if(isNaN(c)){g=64}}k=k+this._keyStr.charAt(d)+this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)}return k},decode:function(j){var k="";var a,b,c;var d,e,f,g;var h=0;j=j.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(h<j.length){d=this._keyStr.indexOf(j.charAt(h++));e=this._keyStr.indexOf(j.charAt(h++));f=this._keyStr.indexOf(j.charAt(h++));g=this._keyStr.indexOf(j.charAt(h++));a=(d<<2)|(e>>4);b=((e&15)<<4)|(f>>2);c=((f&3)<<6)|g;k=k+String.fromCharCode(a);if(f!=64){k=k+String.fromCharCode(b)}if(g!=64){k=k+String.fromCharCode(c)}}k=Base64._utf8_decode(k);return k},_utf8_encode:function(d){d=d.replace(/\r\n/g,"\n");var e="";for(var b=0;b<d.length;b++){var a=d.charCodeAt(b);if(a<128){e+=String.fromCharCode(a)}else{if((a>127)&&(a<2048)){e+=String.fromCharCode((a>>6)|192);e+=String.fromCharCode((a&63)|128)}else{e+=String.fromCharCode((a>>12)|224);e+=String.fromCharCode(((a>>6)&63)|128);e+=String.fromCharCode((a&63)|128)}}}return e},_utf8_decode:function(e){var d="";var b=0;var a=c1=c2=0;while(b<e.length){a=e.charCodeAt(b);if(a<128){d+=String.fromCharCode(a);b++}else{if((a>191)&&(a<224)){c2=e.charCodeAt(b+1);d+=String.fromCharCode(((a&31)<<6)|(c2&63));b+=2}else{c2=e.charCodeAt(b+1);c3=e.charCodeAt(b+2);d+=String.fromCharCode(((a&15)<<12)|((c2&63)<<6)|(c3&63));b+=3}}}return d}};function OutStream(){this.bytestream=new Array();this.offset=0;this.WriteBit=function(a){this.bytestream[this.offset>>>3]|=a<<(this.offset&7);this.offset++};this.Write=function(c,b){for(var a=0;a<b;++a){this.WriteBit((c>>>a)&1)}}}function InStream(b,a){this.bytestream=b;this.bitcount=a;this.offset=0;this.ReadBit=function(){var c=this.bytestream[this.offset>>>3]>>(this.offset&7);this.offset++;return c&1};this.Read=function(d){if((this.offset+d)>this.bitcount){return null}var e=0;for(var c=0;c<d;++c){e|=this.ReadBit()<<c}return e}}function LZWCompressor(a){this.output=a;this.CompressDictionary=function(){this.hashtable=new Object();this.nextcode=0;for(var b=0;b<256;++b){var c=String.fromCharCode(b);this.hashtable[c]=this.nextcode++}this.Exists=function(d){return(this.hashtable.hasOwnProperty(d))};this.Insert=function(e){var d=this.ValSizeInBits();this.hashtable[e]=this.nextcode++;return d};this.Lookup=function(d){return(this.hashtable[d])};this.ValSizeInBits=function(){var d=Math.log(this.nextcode+1)/Math.LN2;return Math.ceil(d)}};this.compress=function(h){var f=h.length;if(f==0){return output.bytestream}var d=new this.CompressDictionary();var g=d.ValSizeInBits();var j="";for(var e=0;e<f;++e){var b=h.charAt(e);if(d.Exists(j+b)){j=j+b}else{g=d.Insert(j+b);this.output.Write(d.Lookup(j),g);j=b}}this.output.Write(d.Lookup(j),g)}}function LZWDecompressor(a){this.input=a;this.DecompressDictionary=function(){this.revhashtable=new Array();this.nextcode=0;for(var b=0;b<256;++b){this.revhashtable[this.nextcode++]=String.fromCharCode(b)}this.numBits=9;this.Size=function(){return(this.nextcode)};this.Insert=function(d){this.revhashtable[this.nextcode++]=d;var c=Math.log(this.nextcode+2)/Math.LN2;this.numBits=Math.ceil(c);return this.numBits};this.LookupIndex=function(c){return this.revhashtable[c]};this.ValSizeInBits=function(){return this.numBits}};this.decompress=function(c,b){if(b==0){return""}var d=new this.DecompressDictionary();var g=d.ValSizeInBits();var f=this.input.Read(g);var h=String.fromCharCode(f);var j=h;var e="";while((f=this.input.Read(g))!=null){if(f<d.Size()){e=d.LookupIndex(f)}else{e=j+j.charAt(0)}h+=e;g=d.Insert(j+e.charAt(0));j=e}return h}}var broken=_H.loadSprite("assets/Sprites/broken.png");function LevelObject(a){this.ObjectData=a;this.sprites=[];LevelObject.prototype.getRect=function(){return{left:0,right:0,top:0,bottom:0}};LevelObject.prototype.collide=function(){};LevelObject.prototype.draw=function(b,c,d){if(this.sprites[0]&&this.sprites[0].loaded){b.drawImage(this.sprites[0],(c.x-this.sprites[0].width/2)*d.x,(c.y-this.sprites[0].height/2)*d.y,this.sprites[0].width*d.x,this.sprites[0].height*d.y)}else{b.drawImage(broken,(c.x-broken.width/2)*d.x,(c.y-broken.height/2)*d.y,broken.width*d.x,broken.height*d.y)}}}var monitor=_H.loadSprite("assets/Sprites/monitorEmpty.png");var monitorBroken=_H.loadSprite("assets/Sprites/monitorBroken.png");function MonitorObject(b){this.ObjectData=b;this.sprites=[];var a="assets/Sprites/monitor";switch(this.ObjectData.SubType){case 1:this.sprites.push(_H.loadSprite(a+"SonicOneUp.png"));break;case 2:this.sprites.push(_H.loadSprite(a+"Death.png"));break;case 3:this.sprites.push(_H.loadSprite(a+"Ring.png"));break;case 4:this.sprites.push(_H.loadSprite(a+"SpeedShoe.png"));break;case 5:this.sprites.push(_H.loadSprite(a+"Flame.png"));break;case 6:this.sprites.push(_H.loadSprite(a+"Electric.png"));break;case 7:this.sprites.push(_H.loadSprite(a+"Bubble.png"));break;case 8:this.sprites.push(_H.loadSprite(a+"Stars.png"));break}MonitorObject.prototype.getRect=function(){var c=this.ObjectData.X-monitor.width/2;var d=this.ObjectData.Y-monitor.height/2;return{left:c,top:d,right:c+monitor.width,bottom:d+monitor.height}};MonitorObject.prototype.collide=function(){if(sonicManager.sonicToon.ysp==0){sonicManager.sonicToon.gsp=0;sonicManager.sonicToon.xsp=0;return}if(this.ObjectData.SubType==10){return}switch(this.ObjectData.SubType){case 1:sonicManager.sonicToon.Lives=1;break;case 2:sonicManager.sonicToon.hit();break;case 3:sonicManager.sonicToon.rings+=10;break;case 4:sonicManager.sonicToon.rings+=20;break;case 5:sonicManager.sonicToon.rings+=30;break;case 6:sonicManager.sonicToon.rings+=40;break;case 7:sonicManager.sonicToon.rings+=50;break;case 8:sonicManager.sonicToon.rings+=60;break}if(sonicManager.sonicToon.ysp>0){sonicManager.sonicToon.ysp*=-1}else{sonicManager.sonicToon.ysp*=1}this.ObjectData.SubType=10};MonitorObject.prototype.draw=function(c,d,e){if(this.sprites[0]&&this.sprites[0].loaded){if(this.ObjectData.SubType==10){c.drawImage(monitorBroken,(d.x-monitorBroken.width/2)*e.x,(d.y)*e.y,monitorBroken.width*e.x,monitorBroken.height*e.y)}else{c.drawImage(monitor,(d.x-monitor.width/2)*e.x,(d.y-monitor.height/2)*e.y,monitor.width*e.x,monitor.height*e.y);if(sonicManager.sonicToon){if(!(sonicManager.drawTickCount%6==0||sonicManager.drawTickCount%6==1)){c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}else{c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}}}}function SpringObject(b){this.ObjectData=b;this.sprites=[];var a="assets/Sprites/monitor";switch(this.ObjectData.SubType){case 1:this.sprites.push(_H.loadSprite(a+"SonicOneUp.png"));break;case 2:this.sprites.push(_H.loadSprite(a+"Death.png"));break;case 3:this.sprites.push(_H.loadSprite(a+"Ring.png"));break;case 4:this.sprites.push(_H.loadSprite(a+"SpeedShoe.png"));break;case 5:this.sprites.push(_H.loadSprite(a+"Flame.png"));break;case 6:this.sprites.push(_H.loadSprite(a+"Electric.png"));break;case 7:this.sprites.push(_H.loadSprite(a+"Bubble.png"));break;case 8:this.sprites.push(_H.loadSprite(a+"Stars.png"));break}SpringObject.prototype.getRect=function(){var c=this.ObjectData.X-monitor.width/2;var d=this.ObjectData.Y-monitor.height/2;return{left:c,top:d,right:c+monitor.width,bottom:d+monitor.height}};SpringObject.prototype.collide=function(){if(sonicManager.sonicToon.ysp==0){sonicManager.sonicToon.gsp=0;sonicManager.sonicToon.xsp=0;return}if(this.ObjectData.SubType==10){return}switch(this.ObjectData.SubType){case 1:sonicManager.sonicToon.Lives=1;break;case 2:sonicManager.sonicToon.hit();break;case 3:sonicManager.sonicToon.rings+=10;break;case 4:sonicManager.sonicToon.rings+=20;break;case 5:sonicManager.sonicToon.rings+=30;break;case 6:sonicManager.sonicToon.rings+=40;break;case 7:sonicManager.sonicToon.rings+=50;break;case 8:sonicManager.sonicToon.rings+=60;break}if(sonicManager.sonicToon.ysp>0){sonicManager.sonicToon.ysp*=-1}else{sonicManager.sonicToon.ysp*=1}this.ObjectData.SubType=10};SpringObject.prototype.draw=function(c,d,e){if(this.sprites[0]&&this.sprites[0].loaded){if(this.ObjectData.SubType==10){c.drawImage(monitorBroken,(d.x-monitorBroken.width/2)*e.x,(d.y)*e.y,monitorBroken.width*e.x,monitorBroken.height*e.y)}else{c.drawImage(monitor,(d.x-monitor.width/2)*e.x,(d.y-monitor.height/2)*e.y,monitor.width*e.x,monitor.height*e.y);if(sonicManager.sonicToon){if(!(sonicManager.drawTickCount%6==0||sonicManager.drawTickCount%6==1)){c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}else{c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}}}}(function(){JSLINQ=window.JSLINQ=function(a){return new JSLINQ.fn.init(a)};JSLINQ.fn=JSLINQ.prototype={init:function(a){this.items=a},jslinq:"2.10",ToArray:function(){return this.items},Where:function(a){var c;var d=new Array();for(var b=0;b<this.items.length;b++){if(a(this.items[b],b)){d[d.length]=this.items[b]}}return new JSLINQ(d)},Select:function(a){var c;var d=new Array();for(var b=0;b<this.items.length;b++){if(a(this.items[b])){d[d.length]=a(this.items[b])}}return new JSLINQ(d)},OrderBy:function(a){var c=new Array();for(var b=0;b<this.items.length;b++){c[c.length]=this.items[b]}return new JSLINQ(c.sort(function(d,e){var f=a(d);var g=a(e);return((f<g)?-1:((f>g)?1:0))}))},OrderByDescending:function(a){var c=new Array();for(var b=0;b<this.items.length;b++){c[c.length]=this.items[b]}return new JSLINQ(c.sort(function(d,e){var f=a(e);var g=a(d);return((f<g)?-1:((f>g)?1:0))}))},SelectMany:function(a){var c=new Array();for(var b=0;b<this.items.length;b++){c=c.concat(a(this.items[b]))}return new JSLINQ(c)},Count:function(a){if(a==null){return this.items.length}else{return this.Where(a).items.length}},Distinct:function(a){var d;var b=new Object();var e=new Array();for(var c=0;c<this.items.length;c++){d=a(this.items[c]);if(b[d]==null){b[d]=true;e[e.length]=d}}b=null;return new JSLINQ(e)},Any:function(a){for(var b=0;b<this.items.length;b++){if(a(this.items[b],b)){return true}}return false},All:function(a){for(var b=0;b<this.items.length;b++){if(!a(this.items[b],b)){return false}}return true},Reverse:function(){var b=new Array();for(var a=this.items.length-1;a>-1;a--){b[b.length]=this.items[a]}return new JSLINQ(b)},First:function(a){if(a!=null){return this.Where(a).First()}else{if(this.items.length>0){return this.items[0]}else{return null}}},Last:function(a){if(a!=null){return this.Where(a).Last()}else{if(this.items.length>0){return this.items[this.items.length-1]}else{return null}}},ElementAt:function(a){return this.items[a]},Concat:function(b){var a=b.items||b;return new JSLINQ(this.items.concat(a))},Intersect:function(j,e){var f;if(e!=undefined){f=e}else{f=function(k,a,l,b){return k==l}}var h=j.items||j;var g=new Array();for(var c=0;c<this.items.length;c++){for(var d=0;d<h.length;d++){if(f(this.items[c],c,h[d],d)){g[g.length]=this.items[c]}}}return new JSLINQ(g)},DefaultIfEmpty:function(a){if(this.items.length==0){return a}return this},ElementAtOrDefault:function(b,a){if(b>=0&&b<this.items.length){return this.items[b]}return a},FirstOrDefault:function(a){return this.First()||a},LastOrDefault:function(a){return this.Last()||a}};JSLINQ.fn.init.prototype=JSLINQ.fn})();jQuery.fn.rotate=function(a,h){var e=this.get(0);if(!h){e.angle=((e.angle==undefined?0:e.angle)+a)%360}else{e.angle=a}if(e.angle>=0){var f=Math.PI*e.angle/180}else{var f=Math.PI*(360+e.angle)/180}var d=Math.cos(f);var g=Math.sin(f);if(document.all&&!window.opera){var b=document.createElement("img");b.src=e.src;b.height=e.height;b.width=e.width;b.style.filter="progid:DXImageTransform.Microsoft.Matrix(M11="+d+",M12="+(-g)+",M21="+g+",M22="+d+",SizingMethod='auto expand')"}else{var b=document.createElement("canvas");if(!e.oImage){b.oImage=new Image();b.oImage.src=e.src}else{b.oImage=e.oImage}b.style.width=b.width=Math.abs(d*b.oImage.width)+Math.abs(g*b.oImage.height);b.style.height=b.height=Math.abs(d*b.oImage.height)+Math.abs(g*b.oImage.width);var c=b.getContext("2d");c.save();if(f<=Math.PI/2){c.translate(g*b.oImage.height,0)}else{if(f<=Math.PI){c.translate(b.width,-d*b.oImage.height)}else{if(f<=1.5*Math.PI){c.translate(-d*b.oImage.width,b.height)}else{c.translate(0,-g*b.oImage.width)}}}c.rotate(f);c.drawImage(b.oImage,0,0,b.oImage.width,b.oImage.height);c.restore()}b.id=e.id;b.angle=e.angle;e.parentNode.replaceChild(b,e)};jQuery.fn.rotateRight=function(a){this.rotate(a==undefined?90:a)};jQuery.fn.rotateLeft=function(a){this.rotate(a==undefined?-90:-a)};function ParallaxBG(a,c){var d=this;var b=a;ParallaxBG.prototype.click=function(e,f){this.slots[f].rotateSpeed=e/this.width*2};ParallaxBG.prototype.onBar=function(j,k){var h=3*c.x;var e=this.slots[k].rotateSpeed;if(j>((this.width*e/2)-h)&&j<((this.width*e/2)+h)){var g={top:0,bottom:0};for(var f=k-1;f>=0;f--){if(this.slots[f].rotateSpeed!=e){g.top=f;break}}for(var f=k+1;f<this.height;f++){if(this.slots[f].rotateSpeed!=e){g.bottom=f;break}}return g}return null};ParallaxBG.prototype.cache=function(n){var p=(this.width*n.x);var f=sonicManager.windowLocation.height*n.y;var o=[];var e=_H.defaultCanvas();var k=this.slots[0].rotateSpeed;var j=0;var m={x:0,y:0};for(var g=0;g<this.slots.length;g++){if(k!=this.slots[g].rotateSpeed){k=this.slots[g].rotateSpeed;o[j]=(_H.loadSprite(e.canvas.toDataURL("image/png")));e=_H.defaultCanvas();j=g}var l={x:m.x,y:m.y+(g-j)*n.y};this.slots[g].draw(e.context,l,n)}o[j]=(_H.loadSprite(e.canvas.toDataURL("image/png")));this.sprites=o};ParallaxBG.prototype.init=function(m){var n=this.width;var e=this.height;this.slots=[];this.slots.length=e;for(var o=0;o<e;o++){this.slots[o]=new ParallaxBGSlot()}var k=_H.defaultCanvas(n,e);var g=_H.defaultCanvas(n,1);k.context.drawImage(this.sprite,0,0);for(var f=0;f<e;f++){var l=k.context.getImageData(0,f,n,1);g.context.putImageData(l,0,0);this.slots[f].sprite=(_H.loadSprite(g.canvas.toDataURL("image/png")))}for(var o=0;o<e;o++){this.slots[o].load(m)}};ParallaxBG.prototype.drawUI=function(e,j,l){if(this.sprite&&this.sprite.loaded){e.drawImage(this.sprite,j.x,j.y)}if(this.slots){var g=this.slots[0].rotateSpeed;var h=0;for(var f=0;f<this.slots.length;f++){if(g==this.slots[f].rotateSpeed){continue}var k=Math.floor(255/2/g);e.fillStyle="rgba("+k+",57,43,0.4)";e.fillRect(j.x,j.y+h*l.y,this.width*l.x,l.y*(f-h));e.strokeStyle="rgba("+k+",57,43,1)";e.lineWidth=3;e.strokeRect(j.x,j.y+h*l.y,this.width*l.x,l.y*(f-h));var m=3*l.x;e.fillRect(j.x+(this.width*g/2)-m,j.y+h*l.y,m*2,l.y*(f-h));h=f;g=this.slots[f].rotateSpeed}var k=Math.floor(255/2/g);e.fillStyle="rgba("+k+",57,43,0.4)";e.fillRect(j.x,j.y+h*l.y,this.width*l.x,l.y*(f-h));e.strokeStyle="rgba("+k+",57,43,1)";e.lineWidth=3;e.strokeRect(j.x,j.y+h*l.y,this.width*l.x,l.y*(f-h));var m=3*l.x;e.fillStyle="rgba("+k+",57,43,1)";e.fillRect(j.x+(this.width*g/2)-m,j.y+h*l.y,m*2,l.y*(f-h))}};ParallaxBG.prototype.draw=function(e,l,m,j){var n=(this.width*m.x);var f=sonicManager.windowLocation.height*m.y;for(var g in this.sprites){var k={x:l.x+(Math.floor(j*this.slots[g].rotateSpeed)),y:l.y+g*m.y};if(k.y>sonicManager.windowLocation.y*m.y||k.y<f+sonicManager.windowLocation.y*m.y){if(k.x>sonicManager.windowLocation.width||k.x+n<0){continue}if(this.sprite&&this.sprite.loaded){e.drawImage(this.sprite,k.x,k.y,this.sprite.width,this.sprite.height)}}}};d.width=b.width;d.height=b.height;d.sprite=b;d.sprite.loaded=true;d.init(c)}function ParallaxBGSlot(){this.sprite=null;this.rotateSpeed=1;ParallaxBGSlot.prototype.draw=function(a,b,c){if(this.sprite&&this.sprite.loaded){a.drawImage(this.sprite,b.x,b.y,this.sprite.width,this.sprite.height)}};ParallaxBGSlot.prototype.drawUI=function(a,b,c){if(this.sprite&&this.sprite.loaded){a.drawImage(this.sprite,b.x,b.y,this.sprite.width,this.sprite.height)}};ParallaxBGSlot.prototype.load=function(a){}}function Ring(a){this.active=a;this.animationIndex=0;this.x=0;this.y=0;this.xsp=0;this.ysp=0;this.tickCount=0;this.draw=function(b,c,d){if(a){this.ysp+=0.09375;this.x+=this.xsp;this.y+=this.ysp;if(this.x<sonicManager.windowLocation.x||this.y<sonicManager.windowLocation.y||this.x>sonicManager.windowLocation.x+sonicManager.windowLocation.width||this.y>sonicManager.windowLocation.y+sonicManager.windowLocation.height){this.tickCount=4294967295;return false}if(sonicManager.sonicToon.checkCollisionLine(_H.floor(this.x)+8,_H.floor(this.y)+8,16,1)!=-1){this.ysp*=-0.75}if(sonicManager.sonicToon.checkCollisionLine(_H.floor(this.x)-8,_H.floor(this.y)+8,26,0)!=-1){this.xsp*=-0.75}if(sonicManager.drawTickCount>sonicManager.sonicToon.sonicLastHitTick+64&&_H.intersectRect(sonicManager.sonicToon.myRec,{left:this.x-8*d.x,right:this.x+8*d.x,top:this.y-8*d.y,bottom:this.y+8*d.y})){this.tickCount=4294967295;sonicManager.sonicToon.rings++;return false}this.tickCount++}if(sonicManager.sonicToon){this.animationIndex=_H.floor((sonicManager.drawTickCount%((a?4:8)*4))/(a?4:8))}else{this.animationIndex=0}var e;if(sonicManager.SpriteCache.rings){e=sonicManager.SpriteCache.rings}else{return}var f=e[this.animationIndex*200+d.y*100+d.x];if(!f){return}if(f.loaded){b.drawImage(f,_H.floor((c.x-8)*d.x),_H.floor((c.y-8)*d.y))}else{return false}}}function Sonic(d,c){this.x=d.StartPositions[0].X;this.y=d.StartPositions[0].Y;this.obtainedRing=[];this.rings=0;this.debugging=false;this.jumping=false;this.crouching=false;this.holdingLeft=false;this.holdingRight=false;this.holdingUp=false;this.LevelWidth=0;this.xsp=0;this.ysp=0;this.sonicLastHitTick=0;this.sonicJustHitTick=0;this.acc=0.046875;this.dec=0.5;this.frc=0.046875;this.gsp=0;this.rdec=0.125;this.rfrc=0.0234375;this.runningTick=0;this.slp=0.125;this.slpRollingUp=0.078125;this.slpRollingDown=0.3125;this.jmp=-6.5;this.grv=0.21875;this.air=0.09375;this.sonicLevel=d;this.inAir=false;this.wasInAir=false;this.holdingJump=false;this.haltSmoke=[];this.sensorManager=new SensorManager(sonicManager);this.hlock=0;this.mode=RotationMode.Floor;this.facing=true;this.ticking=false;this.breaking=0;this.ducking=false;this.spinDash=false;this.myRec={};this.spinDashSpeed=0;this.angle=255;var b;this.sensorManager.createVerticalSensor("a",-9,0,36);this.sensorManager.createVerticalSensor("b",9,0,36);this.sensorManager.createVerticalSensor("c",-9,0,-20);this.sensorManager.createVerticalSensor("d",9,0,-20);this.sensorManager.createHorizontalSensor("m1",4,0,-12);this.sensorManager.createHorizontalSensor("m2",4,0,12);this.updateMode=function(){if(this.angle<32||this.angle>224){this.mode=RotationMode.Floor}else{if(this.angle>32&&this.angle<96){this.mode=RotationMode.LeftWall}else{if(this.angle>96&&this.angle<160){this.mode=RotationMode.Ceiling}else{if(this.angle>160&&this.angle<224){this.mode=RotationMode.RightWall}}}}this.myRec={left:this.x-5,right:this.x+5,top:this.y-20,bottom:this.y+20}};this.effectPhysics=function(){var f=6;if(!this.jumping){if(!this.inAir&&this.wasJumping){this.wasJumping=false}}if(!this.inAir&&this.wasInAir){this.wasInAir=false;if(this.angle>=240||this.angle<=15){this.gsp=this.xsp}else{if((this.angle>=224&&this.angle<=239)||(this.angle>=16&&this.angle<=31)){this.gsp=this.ysp}else{if((this.angle>=192&&this.angle<=223)){this.gsp=-this.ysp}else{if((this.angle>=32&&this.angle<=63)){this.gsp=this.ysp}}}}this.xsp=0;this.ysp=0}if(!this.inAir&&!this.rolling){if(!this.holdingLeft&&!this.holdingRight){this.gsp-=Math.min(Math.abs(this.gsp),this.frc)*(this.gsp>0?1:-1)}b=_H.sign(this.gsp);this.gsp+=this.slp*-_H.sin(this.angle);if(b!=_H.sign(this.gsp)&&b!=0){this.hlock=30}if(this.holdingRight&&!this.holdingLeft){this.facing=true;if(this.gsp>=0){this.gsp+=this.acc;if(this.gsp>f){this.gsp=f}}else{this.gsp+=this.dec;if(Math.abs(this.gsp)>4.5){this.facing=false;this.breaking=1;this.runningTick=0}}}if(this.holdingLeft&&!this.holdingRight){this.facing=false;if(this.gsp<=0){this.gsp-=this.acc;if(this.gsp<-f){this.gsp=-f}}else{this.gsp-=this.dec;if(Math.abs(this.gsp)>4.5){this.facing=true;this.breaking=-1;this.runningTick=0}}}}this.ducking=false;if(this.crouching){if(Math.abs(this.gsp)>1.03125){this.rolling=true;this.currentlyBall=true}else{this.ducking=true}}else{if(this.spinDash){this.gsp=(8+_H.floor(this.spinDashSpeed)/2)*(this.facing?1:-1);this.spinDash=false;this.rolling=true;this.currentlyBall=true}}if(!this.isAir&&this.rolling){if(this.holdingLeft){if(this.gsp>0){if(this.rolling){this.gsp=_H.max(0,this.gsp-this.rdec)}}}if(this.holdingRight){if(this.gsp<0){if(this.rolling){this.gsp=_H.min(0,this.gsp+this.rdec)}}}this.gsp-=Math.min(Math.abs(this.gsp),this.rfrc)*(this.gsp>0?1:-1);b=_H.sign(this.gsp);var e=_H.sin(this.angle);if((e>0)!=(this.gsp>0)){this.gsp+=-this.slpRollingUp*e}else{this.gsp+=-this.slpRollingDown*e}if(b!=_H.sign(this.gsp)&&b!=0){this.hlock=30}}if(!this.inAir){this.xsp=this.gsp*_H.cos(this.angle);this.ysp=this.gsp*-_H.sin(this.angle);if(Math.abs(this.gsp)<2.5&&this.angle>=64&&this.angle<=192){if(this.mode==RotationMode.RightWall){this.x+=5}else{if(this.mode==RotationMode.LeftWall){this.x-=4}}this.angle=0;this.updateMode();this.hlock=30}}if(this.inAir){if(this.holdingRight&&!this.holdingLeft){this.facing=true;if(this.xsp>=0){this.xsp+=this.air;if(this.xsp>f){this.xsp=f}}else{this.xsp-=this.air}}if(this.holdingLeft&&!this.holdingRight){this.facing=false;if(this.xsp<=0){this.xsp-=this.air;if(this.xsp<-f){this.xsp=-f}}else{this.xsp+=this.air}}if(this.wasInAir){if(this.jumping){}else{}}this.ysp+=this.justHit?0.1875:this.grv;if(this.ysp<0&&this.ysp>-4){if(Math.abs(this.xsp)>0.125){this.xsp*=0.96875}}if(this.ysp>16){this.ysp=16}}if(this.wasInAir&&this.jumping){}else{if(this.jumping&&!this.wasJumping){this.wasJumping=true;if(this.ducking){this.spinDash=true;this.spinDashSpeed+=2;if(this.spinDashSpeed>8){this.spinDashSpeed=8}this.spriteState="spindash0"}else{this.wasInAir=true;this.inAir=true;this.currentlyBall=true;this.xsp=this.jmp*_H.sin(this.angle)+this.gsp*_H.cos(this.angle);this.ysp=this.jmp*_H.cos(this.angle)}}}if(this.xsp>0&&this.xsp<0.008){this.gsp=0;this.xsp=0}if(this.xsp<0&&this.xsp>-0.008){this.gsp=0;this.xsp=0}this.x+=this.xsp;this.y+=this.ysp};this.tick=function(){if(this.debugging){var g=15;if(this.holdingRight){this.x+=g}if(this.holdingLeft){this.x-=g}if(this.crouching){this.y+=g}if(this.holdingUp){this.y-=g}return}this.updateMode();if(this.hlock>0){this.hlock--;this.holdingRight=false;this.holdingLeft=false}this.effectPhysics();this.updateSprite();var h=_H.floor(this.x);var j=_H.floor(this.y);this.sensorManager.check(this);var o=this.sensorManager.getResult("m1");var p=this.sensorManager.getResult("m2");switch(this.mode){case RotationMode.Floor:if(o!=-1){this.x=h=o.value+12;this.gsp=0;if(this.inAir){this.xsp=0}}if(p!=-1){this.x=h=p.value-12;this.gsp=0;if(this.inAir){this.xsp=0}}break;case RotationMode.LeftWall:if(o!=-1){this.y=j=o.value-12;if(this.inAir){this.xsp=0}}if(p!=-1){this.y=j=p.value+12;this.gsp=0;if(this.inAir){this.xsp=0}}break;case RotationMode.Ceiling:if(o!=-1){this.x=h=o.value+12;this.gsp=0}if(p!=-1){this.x=h=p.value-12;this.gsp=0}if(this.inAir){this.xsp=0}break;case RotationMode.RightWall:if(o!=-1){this.y=j=o.value-12;this.gsp=0}if(p!=-1){this.y=j=p.value+12;this.gsp=0}if(this.inAir){this.xsp=0}break}this.sensorManager.check(this);var k=this.sensorManager.getResult("a");var l=this.sensorManager.getResult("b");if(sonicManager.tickCount%4==0){this.checkCollisionWithRing();this.checkCollisionWithObjects()}if(this.inAir){this.angle=255}if(!this.inAir){if(k==-1&&l==-1){this.inAir=true;this.wasInAir=true}else{this.justHit=false;switch(this.mode){case RotationMode.Floor:if(k.value>=0&&l.value>=0){this.angle=k.angle;if(k.value<l.value){this.angle=k.angle;this.y=j=k.value-20}else{this.angle=l.angle;this.y=j=l.value-20}}else{if(k.value>-1){this.angle=k.angle;this.y=j=k.value-20}else{if(l.value>-1){this.angle=l.angle;this.y=j=l.value-20}}}break;case RotationMode.LeftWall:if(k.value>=0&&l.value>=0){if(k.value<l.value){this.angle=k.angle;this.x=h=k.value+20}else{this.angle=l.angle;this.x=h=l.value+20}}else{if(k.value>-1){this.angle=k.angle;this.x=h=k.value+20}else{if(l.value>-1){this.angle=l.angle;this.x=h=l.value+20}}}break;case RotationMode.Ceiling:if(k.value>=0&&l.value>=0){if(k.value<l.value){this.angle=k.angle;this.y=j=k.value-20}else{this.angle=l.angle;this.y=j=l.value-20}}else{if(k.value>-1){this.angle=k.angle;this.y=j=k.value-20}else{if(l.value>-1){this.angle=l.angle;this.y=j=l.value-20}}}break;case RotationMode.RightWall:if(k.value>=0&&l.value>=0){if(k.value<l.value){this.angle=k.angle;this.x=h=k.value-20}else{this.angle=l.angle;this.x=h=l.value-20}}else{if(k.value>-1){this.angle=k.angle;this.x=h=k.value-20}else{if(l.value>-1){this.angle=l.angle;this.x=h=l.value-20}}}break}}this.updateMode()}else{if(k==-1&&l==-1){this.inAir=true;this.wasInAir=true}else{if(k.value>=0&&l.value>=0){if(k.value<l.value){if(this.y+(20)>=k.value){this.angle=k.angle;this.y=j=k.value-20;this.rolling=this.currentlyBall=false;this.inAir=false}}else{if(l.value>-1){if(this.y+(20)>=l.value){this.angle=l.angle;this.y=j=l.value-20;this.rolling=this.currentlyBall=false;this.inAir=false}}}}else{if(k.value>-1){if(this.y+(20)>=k.value){this.angle=k.angle;this.y=j=k.value-20;this.rolling=this.currentlyBall=false;this.inAir=false}}else{if(l.value>-1){if(this.y+(20)>=l.value){this.angle=l.angle;this.y=j=l.value-20;this.rolling=this.currentlyBall=false;this.inAir=false}}}}}this.updateMode();var f=sonicManager.SpriteCache.sonicSprites[this.spriteState+c.x+c.y];var e=f.height/c.y/2;this.sensorManager.check(this);var m=this.sensorManager.getResult("c");var n=this.sensorManager.getResult("d");if((m==-1&&n==-1)){}else{if(m.value>=0&&n.value>=0){this.angle=m.angle;if(m.value<n.value){if(this.y+(e)>=m.value){if(this.ysp<0){this.angle=m.angle;this.y=j=m.value+e;this.ysp=0}}}else{if(this.y+(e)>=n.value){if(this.ysp<0){this.angle=n.angle;this.y=j=n.value+e;this.ysp=0}}}}else{if(m.value>-1){if(this.y+(e)>=m.value){if(this.ysp<0){this.angle=m.angle;this.y=j=m.value+e;this.ysp=0}}}else{if(n.value>-1){if(this.y+(e)>=n.value){if(this.ysp<0){this.angle=n.angle;this.y=j=n.value+e;this.ysp=0}}}}}this.updateMode()}}};this.debug=function(){this.debugging=!this.debugging;this.xsp=0;this.gsp=0;this.ysp=0;this.spriteState="normal"};this.hit=function(){if(sonicManager.drawTickCount-this.sonicJustHitTick<120){return}this.justHit=true;this.ysp=-4;this.xsp=2*(-1);this.sonicLastHitTick=sonicManager.drawTickCount;var j=0;var e=101.25;var f=false;var h=4;while(j<this.rings){var g=new Ring(true);sonicManager.activeRings.push(g);g.x=this.x;g.y=this.y-10;g.ysp=-Math.sin(e)*h;g.xsp=Math.cos(e)*h;if(f){g.ysp*=-1;e+=22.5}f=!f;j++;if(j==16){h=2;e=101.25}}this.rings=0};this.checkCollisionWithRing=function(){var g=this.myRec;for(var j in sonicManager.SonicLevel.Rings){var h=sonicManager.SonicLevel.Rings[j];if(this.obtainedRing[j]){continue}var e=h.X;var f=h.Y;if(_H.intersectRect(g,{left:e-8,right:e+8,top:f-8,bottom:f+8})){this.rings++;this.obtainedRing[j]=true}}};this.checkCollisionWithObjects=function(){var g=this.myRec;for(var j in sonicManager.SonicLevel.Objects){var h=sonicManager.SonicLevel.Objects[j];var e=h.X;var f=h.Y;if(_H.intersectRect(g,h.getRect())){h.collide()}}};this.sensorA=0;this.checkCollisionLine=function(h,j,f,e){var g=this.checkCollisionLineWrap(h,j,f,e);if(g!=-1&&g.angle==null){g=this.checkCollisionLineWrap(h,j,f,e)}if(g.angle==255){if(this.mode==RotationMode.Floor){}else{if(this.mode==RotationMode.LeftWall){g.angle=Math.floor(256/4*1)}else{if(this.mode==RotationMode.Ceiling){g.angle=Math.floor(256/4*2)}else{if(this.mode==RotationMode.RightWall){g.angle=Math.floor(256/4*3)}}}}}return g};this.checkCollisionLineWrap=function(t,u,q,n){var g=_H.floor(t/128);var h=_H.floor(u/128);var s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[g][h]];var l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;var j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;var e=t-g*128;var f=u-h*128;var o=128;var p;var r;var k=0;switch(n){case 0:if(t+q>sonicManager.SonicLevel.LevelWidth*128){return{pos:sonicManager.SonicLevel.LevelWidth*128-20,angle:null}}for(p=0;p<q;p++){if(e+p>=128){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[g+1][h]];l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;e-=128}if(t+p>this.LevelWidth||l[(e+p)][f]>=2){return{pos:t+p,angle:j[_H.floor((e+p)/16)][_H.floor((f)/16)]}}}break;case 1:if(u+q>sonicManager.SonicLevel.LevelHeight*128){return{pos:sonicManager.SonicLevel.LevelHeight*128-20,angle:null}}for(p=0;p<q;p+=1){if(f+k>=128){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[g][(h+1)]];l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;f-=128}if(l[e][f+p]>=1){return{pos:u+p,angle:j[_H.floor((e)/16)][_H.floor((f+k)/16)]}}k++}break;case 2:if(t-q<0){return{pos:0+20,angle:null}}for(p=0;p<q;p++){if(e-p<0){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[(g-1),h]];l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;e+=128}if(t-p<0||l[(e-p)][f]>=2){return{pos:t-p,angle:j[_H.floor((e-p)/16)][_H.floor((f)/16)]}}}break;case 3:if(u-q<0){return{pos:20,angle:null}}for(p=0;p<q;p+=1){if(f-k<0){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[g][(h-1)]];l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;f+=128}if(l[e][f-p]>=2){return{pos:u-p,angle:j[_H.floor((e)/16)][_H.floor((f-k)/16)]}}k++}break}return -1};this.spriteState="normal";this.isLoading=function(){return this.imageLoaded[0]<this.imageLength};this.drawUI=function(e,f,g){e.font="13pt Arial bold";e.fillStyle="White";e.fillText("Rings: "+this.rings,f.x+90,f.y+45);e.fillText("Angle: "+this.angle.toString(16),f.x+90,f.y+75);e.fillText("Position: "+_H.floor(this.x)+", "+_H.floor(this.y),f.x+90,f.y+105);e.fillText("Speed: g: "+this.gsp.toFixed(3)+" x:"+this.xsp.toFixed(3)+" y:"+this.ysp.toFixed(3),f.x+90,f.y+135);e.fillText("Mode: "+a(this.mode),f.x+90,f.y+185);if(this.inAir){e.fillText("Air ",f.x+220,f.y+45)}};function a(e){switch(e){case RotationMode.Floor:return"Floor";case RotationMode.Ceiling:return"Ceiling";case RotationMode.RightWall:return"Right Wall";case RotationMode.LeftWall:return"Left Wall"}}this.draw=function(e,m){var g=_H.floor(this.x);var h=_H.floor(this.y);var f;var l=sonicManager.drawTickCount-this.sonicJustHitTick;if(l<120){if(l%8<4){return}}if(f=sonicManager.SpriteCache.sonicSprites[this.spriteState+m.x+m.y]){if(f.loaded){e.save();var n=(40-(f.height/m.y))/2;e.translate(((g-sonicManager.windowLocation.x)*m.x),((h-sonicManager.windowLocation.y+n)*m.y));if(!this.facing){e.scale(-1,1);if(!this.currentlyBall){e.rotate(-_H.fixAngle(this.angle))}e.drawImage(f,-f.width/2,-f.height/2);if(this.spinDash){e.drawImage(sonicManager.SpriteCache.sonicSprites[("spinsmoke"+_H.floor((sonicManager.drawTickCount%14)/2))+m.x+m.y],(-f.width/2)-25*m.x,-f.height/2+(n*m.y)-15,f.width,f.height)}}else{if(!this.currentlyBall){e.rotate(_H.fixAngle(this.angle))}e.drawImage(f,-f.width/2,-f.height/2);if(this.spinDash){e.drawImage(sonicManager.SpriteCache.sonicSprites[("spinsmoke"+_H.floor((sonicManager.drawTickCount%14)/2))+m.x+m.y],(-f.width/2)-25*m.x,-f.height/2+(n*m.y)-15,f.width,f.height)}}e.restore();for(var j=0;j<this.haltSmoke.length;j++){var k=this.haltSmoke[j];e.drawImage(sonicManager.SpriteCache.sonicSprites[("haltsmoke"+_H.floor((sonicManager.drawTickCount%(4*6))/6))+m.x+m.y],((k.x-sonicManager.windowLocation.x-25)*m.x),((k.y+12-sonicManager.windowLocation.y+n)*m.y));if(_H.floor(((sonicManager.drawTickCount+6)%(4*6))/6)==0){this.haltSmoke.splice(j,1)}}}}else{if(f=sonicManager.SpriteCache.sonicSprites[this.spriteState]){if(f.loaded){sonicManager.SpriteCache.sonicSprites[this.spriteState+m.x+m.y]=_H.scaleSprite(f,m)}}else{sonicManager.SpriteCache.sonicSprites[this.spriteState]=_H.loadSprite(this.spriteLocations[this.spriteState])}}};this.kill=function(){};this.pressJump=function(){if(this.debugging||!this.justHit){this.jumping=true}};this.pressUp=function(){if(this.debugging||!this.justHit){this.holdingUp=true}};this.pressCrouch=function(){if(this.debugging||!this.justHit){this.crouching=true}};this.pressLeft=function(){if(this.debugging||!this.justHit){this.holdingLeft=true}};this.pressRight=function(){if(this.debugging||!this.justHit){this.holdingRight=true}};this.releaseJump=function(){this.jumping=false};this.releaseUp=function(){this.holdingUp=false};this.releaseCrouch=function(){this.crouching=false};this.releaseLeft=function(){this.holdingLeft=false};this.releaseRight=function(){this.holdingRight=false};this.buildHeightInfo=function(){this.LevelWidth=d.LevelWidth*128;for(var u=0;u<d.Chunks.length;u++){var m=d.Chunks[u];var n;var o=m.heightBlocks1=[];var p=m.heightBlocks2=[];var k=m.angleMap1=[];var l=m.angleMap2=[];p.length=o.length=128;k.length=l.length=8;for(var g=0;g<128;g++){o[g]=[];p[g]=[];k[g]=[];l[g]=[];l[g].length=k[g].length=8;p[g].length=o[g].length=128}for(var j=0;j<8;j++){for(var h=0;h<8;h++){var w=m.tilePieces[h][j];k[h][j]=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes1[w.Block]];l[h][j]=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes2[w.Block]];if(w.XFlip){if(w.YFlip){k[h][j]=(k[h][j]+(127-k[h][j])*2)%255;l[h][j]=(l[h][j]+(127-l[h][j])*2)%255;k[h][j]=(255-k[h][j])%255;l[h][j]=(255-l[h][j])%255}else{k[h][j]=(255-k[h][j])%255;l[h][j]=(255-l[h][j])%255}}else{if(w.YFlip){k[h][j]=(k[h][j]+(127-k[h][j])*2)%255;l[h][j]=(l[h][j]+(127-l[h][j])*2)%255}else{k[h][j]=(k[h][j]);l[h][j]=(l[h][j])}}var e;var f;var q=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes1[w.Block]];var r=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes2[w.Block]];var v;if(q==0||q==1){v=q==0?0:w.Solid1;for(f=0;f<16;f++){for(e=0;e<16;e++){o[(h*16+e)][(j*16+f)]=v}}}else{q=q.items}if(r==0||r==1){v=r==0?0:w.Solid2;for(f=0;f<16;f++){for(e=0;e<16;e++){p[(h*16+e)][(j*16+f)]=v}}}else{r=r.items}for(f=0;f<16;f++){for(e=0;e<16;e++){var s=0,t=0;if(w.XFlip){if(w.YFlip){s=15-e;t=15-f}else{s=15-e;t=f}}else{if(w.YFlip){s=e;t=15-f}else{s=e;t=f}}if(!(q==0||q==1)){switch(w.Solid1){case 0:o[(h*16+s)][(j*16+t)]=false;break;case 1:case 2:case 3:o[(h*16+s)][(j*16+t)]=(q[e]>16-f)?w.Solid1:0;break}}if(!(r==0||r==1)){switch(w.Solid2){case 0:p[(h*16+s)][(j*16+t)]=false;break;case 1:case 2:case 3:p[(h*16+s)][(j*16+t)]=(r[e]>16-f)?w.Solid2:0;break}}}}}}}};this.updateSprite=function(){var e=Math.abs(this.gsp);var f=parseInt(this.spriteState.substring(this.spriteState.length-1,this.spriteState.length));if(this.breaking>0){if(this.gsp>0||this.gsp==0||this.spriteState=="breaking3"){this.facing=false;this.breaking=0}}else{if(this.breaking<0){if(this.gsp<0||this.gsp==0||this.spriteState=="breaking3"){this.breaking=0;this.facing=true}}}if(this.justHit){if(this.spriteState.substring(0,this.spriteState.length-1)!="hit"){this.spriteState="hit0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(8-e))==0){this.spriteState="hit1"}}}else{if(this.spinDash){if(this.spriteState.substring(0,this.spriteState.length-1)!="spindash"){this.spriteState="spindash0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(2-e))==0){this.spriteState="spindash"+((f+1)%6)}}}else{if(e==0&&this.inAir==false){if(this.ducking){if(this.spriteState.substring(0,this.spriteState.length-1)!="duck"){this.spriteState="duck0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(4-e))==0){this.spriteState="duck1"}}}else{if(this.holdingUp){if(this.spriteState.substring(0,this.spriteState.length-1)!="lookingup"){this.spriteState="lookingup0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(4-e))==0){this.spriteState="lookingup1"}}}else{this.spriteState="normal";this.currentlyBall=false;this.rolling=false;this.runningTick=0}}}else{if(this.breaking!=0){if(this.spriteState.substring(0,this.spriteState.length-1)!="breaking"){this.spriteState="breaking0";this.runningTick=1}else{if((this.runningTick++)%(7)==0){this.spriteState="breaking"+((f+1)%4);if(f==0){this.haltSmoke.push({x:_H.floor(this.x),y:_H.floor(this.y)})}}}}else{if(this.currentlyBall){if(this.spriteState.substring(0,this.spriteState.length-1)!="balls"){this.spriteState="balls0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(8-e))==0){this.spriteState="balls"+((f+1)%5)}}}else{if(e<6){if(this.spriteState.substring(0,this.spriteState.length-1)!="running"){this.spriteState="running0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(8-e))==0||(_H.floor(8-e)==0)){this.spriteState="running"+((f+1)%8)}}}else{if(e>=6){if(this.spriteState.substring(0,this.spriteState.length-1)!="fastrunning"){this.spriteState="fastrunning0";this.runningTick=1}else{if(((this.runningTick++)%(Math.ceil(8-e))==0)||(_H.floor(8-e)==0)){this.spriteState="fastrunning"+((f+1)%4)}}}}}}}}}};this.buildHeightInfo(d)}Sensor=function(b,c,d,e,a){this.x1=b;this.y1=d;this.x2=c;this.y2=e;this.manager=a;this.check=function(f){var g;var h=_H.floor(f.x);var j=_H.floor(f.y);switch(f.mode){case RotationMode.Floor:g=this.checkCollisionLineWrap(h+this.x1,h+this.x2,j+this.y1,j+this.y2);break;case RotationMode.LeftWall:g=this.checkCollisionLineWrap(h-this.y1,h-this.y2,j+this.x1,j+this.x2);break;case RotationMode.Ceiling:g=this.checkCollisionLineWrap(h-this.x1,h-this.x2,j-this.y1,j-this.y2);break;case RotationMode.RightWall:g=this.checkCollisionLineWrap(h+this.y1,h+this.y2,j-this.x1,j-this.x2);break}if(g!=-1){if(g.angle==255||g.angle==0){if(f.mode==RotationMode.Floor){g.angle=255}}if(f.mode==RotationMode.LeftWall){g.angle=(255+g.angle-Math.floor(256/4*3))%255}else{if(f.mode==RotationMode.Ceiling){g.angle=(255+g.angle-Math.floor(256/8*2))%255}else{if(f.mode==RotationMode.RightWall){g.angle=(255+g.angle-Math.floor(256/8*1))%255}}}}return g};this.checkCollisionLineWrap=function(q,r,s,t){var h=_H.floor(q/128);var j=_H.floor(s/128);var p=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[h][j]];var m=sonicManager.SonicLevel.curHeightMap?p.heightBlocks1:p.heightBlocks2;var k=sonicManager.SonicLevel.curHeightMap?p.angleMap1:p.angleMap2;var f=q-h*128;var g=s-j*128;var n;var l=0;var o;if(s==t){if(Math.max(q,r)>sonicManager.SonicLevel.LevelWidth*128){return{value:sonicManager.SonicLevel.LevelWidth*128-20,angle:255}}if(q<r){o=r-q;for(n=0;n<o;n++){if(f+n>=128){p=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[h+1][j]];m=sonicManager.SonicLevel.curHeightMap?p.heightBlocks1:p.heightBlocks2;k=sonicManager.SonicLevel.curHeightMap?p.angleMap1:p.angleMap2;f-=128}if(q+n>this.LevelWidth||m[(f+n)][g]>=2){return{value:q+n,angle:k[_H.floor((f+n)/16)][_H.floor((g)/16)]}}}}else{o=q-r;for(n=0;n<o;n++){if(f-n<0){p=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[h-1][j]];m=sonicManager.SonicLevel.curHeightMap?p.heightBlocks1:p.heightBlocks2;k=sonicManager.SonicLevel.curHeightMap?p.angleMap1:p.angleMap2;f+=128}if(q-n>this.LevelWidth||m[(f-n)][g]>=2){return{value:q-n,angle:k[_H.floor((f-n)/16)][_H.floor((g)/16)]}}}}}else{if(Math.max(s,t)>sonicManager.SonicLevel.LevelHeight*128){return{value:sonicManager.SonicLevel.LevelHeight*128-20,angle:255}}if(s<t){o=t-s;for(n=0;n<o;n++){if(g+n>=128){p=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[h][(j+1)]];m=sonicManager.SonicLevel.curHeightMap?p.heightBlocks1:p.heightBlocks2;k=sonicManager.SonicLevel.curHeightMap?p.angleMap1:p.angleMap2;g-=128}if(m[f][g+n]>=1){return{value:s+n,angle:k[_H.floor((f)/16)][_H.floor((g+n)/16)]}}}}else{o=s-t;for(n=0;n<o;n++){if(g-n<0){p=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[h][(j-1)]];m=sonicManager.SonicLevel.curHeightMap?p.heightBlocks1:p.heightBlocks2;k=sonicManager.SonicLevel.curHeightMap?p.angleMap1:p.angleMap2;g+=128}if(m[f][g-n]>=1){return{value:s-n,angle:k[_H.floor((f)/16)][_H.floor((g-n)/16)]}}}}}return -1};this.draw=function(f,h,g){var j=_H.floor(g.x);var k=_H.floor(g.y);f.strokeStyle="#ffffff";f.lineWidth=4;switch(g.mode){case RotationMode.Floor:f.moveTo((j+this.x1)*h.x,(k+this.y1)*h.y);f.lineTo((j+this.x2)*h.x,(k+this.y2)*h.y);break;case RotationMode.LeftWall:f.moveTo((j-this.y1)*h.x,(k+this.x1)*h.y);f.lineTo((j-this.y2)*h.x,(k+this.x2)*h.y);break;case RotationMode.Ceiling:f.moveTo((j-this.x1)*h.x,(k-this.y1)*h.y);f.lineTo((j-this.x2)*h.x,(k-this.y2)*h.y);break;case RotationMode.RightWall:f.moveTo((j+this.y1)*h.x,(k-this.x1)*h.y);f.lineTo((j+this.y2)*h.x,(k-this.x2)*h.y);break}f.stroke()}};SensorManager=function(a){this.sonicManager=a;this.sensors=[];this.sensorResults=[];this.check=function(b){var d=false;for(var c in this.sensors){this.sensorResults[c]=this.sensors[c].check(b);d=d||(this.sensorResults[c]!=-1)}return d};this.draw=function(b,e,c){for(var d in this.sensors){this.sensors[d].draw(b,e,c)}};this.getResult=function(b){return this.sensorResults[b]};this.addSensor=function(b,c){this.sensors[b]=(c);this.sensorResults[b]=false;return c};this.createHorizontalSensor=function(b,e,c,d){return this.addSensor(b,new Sensor(c,d,e,e,this))};this.createVerticalSensor=function(b,c,d,e){return this.addSensor(b,new Sensor(c,c,d,e,this))}};DEBUGs=true;window.requestAnimFrame=(function(a){if(window.requestAnimationFrame){return window.requestAnimationFrame(a)}if(window.webkitRequestAnimationFrame){return window.webkitRequestAnimationFrame(a)}if(window.mozRequestAnimationFrame){return window.mozRequestAnimationFrame(a)}if(window.oRequestAnimationFrame){return window.oRequestAnimationFrame(a)}if(window.msRequestAnimationFrame){return window.msRequestAnimationFrame(a)}window.setTimeout(a,1000/60)});function SonicEngine(c){var k=this;this.canvas=$("#"+c);this.canvasItem=document.getElementById(c).getContext("2d");var j=window.sonicManager=new SonicManager(this.canvasItem);this.canvasWidth=0;this.canvasHeight=0;document.getElementById(c).addEventListener("DOMMouseScroll",h,false);document.getElementById(c).addEventListener("mousewheel",h,false);document.getElementById(c).addEventListener("touchmove",a);document.getElementById(c).addEventListener("touchstart",d);document.getElementById(c).addEventListener("touchend",b);document.getElementById(c).addEventListener("mousedown",d);document.getElementById(c).addEventListener("mouseup",b);document.getElementById(c).addEventListener("mousemove",a);$(document).keydown(f);$(document).keyup(g);function d(l){l.preventDefault();if(j.uiManager.onClick(l)){return false}if(j.onClick(l)){return false}return false}function a(l){l.preventDefault();if(j.uiManager.onMouseMove(l)){return false}return false}function b(l){l.preventDefault();j.uiManager.onMouseUp(l)}function h(l){l.preventDefault();if(j.uiManager.onMouseScroll(l)){return false}return l.preventDefault()&&false}function f(l){switch(l.keyCode){case 66:if(j.sonicToon){j.sonicToon.hit()}break;case 67:if(j.sonicToon){j.sonicToon.debug()}break;case 68:j.SonicLevel.curHeightMap=!j.SonicLevel.curHeightMap;break;case 38:case 87:if(j.sonicToon){j.sonicToon.pressUp()}else{j.windowLocation.y-=128}break;case 32:if(j.sonicToon){j.sonicToon.pressJump()}break;case 40:case 83:if(j.sonicToon){j.sonicToon.pressCrouch()}else{j.windowLocation.y+=128}break;case 37:case 65:j.windowLocation.x-=128;if(j.sonicToon){j.sonicToon.pressLeft()}else{j.windowLocation.x-=128}break;case 39:case 68:j.windowLocation.x+=128;if(j.sonicToon){j.sonicToon.pressRight()}else{j.windowLocation.x+=128}break}}function g(l){switch(l.keyCode){case 38:case 87:if(j.sonicToon){j.sonicToon.releaseUp()}break;case 32:if(j.sonicToon){j.sonicToon.releaseJump()}break;case 40:case 83:if(j.sonicToon){j.sonicToon.releaseCrouch()}break;case 37:case 65:if(j.sonicToon){j.sonicToon.releaseLeft()}break;case 39:case 68:if(j.sonicToon){j.sonicToon.releaseRight()}break}}k.resizeCanvas=function(){k.canvasWidth=$(window).width();k.canvasHeight=$(window).height();k.canvas.attr("width",k.canvasWidth);k.canvas.attr("height",k.canvasHeight)};function e(l){l.clearRect(0,0,k.canvasWidth,k.canvasHeight)}k.draw=function(){requestAnimFrame(k.draw);e(k.canvasItem);j.draw(k.canvasItem);j.uiManager.draw(k.canvasItem)};$(window).resize(this.resizeCanvas);this.resizeCanvas();requestAnimFrame(k.draw);window.setInterval(j.tick,1000/60,j)}function SonicManager(b){var c=this.scale={x:2,y:2};this.windowLocation=_H.defaultWindowLocation(1);this.showHeightMap=false;this.goodRing=new Ring(false);this.activeRings=[];this.background=null;this.uiManager=new UIManager(this,b,this.scale);this.SonicLevel={Tiles:[],Blocks:[],Chunks:[],ChunkMap:[[]],Rings:{},curHeightMap:true,LevelWidth:0,LevelHeight:0};var a=new TileChunk()+new TilePiece()+new Tile()+new HeightMask();this.SonicLevel.ChunkMap=[[]];this.clickState=ClickState.PlaceChunk;this.onClick=function(f){return;if(f.shiftKey){var d=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[_H.floor(f.x/(128*c.x)),_H.floor(f.y/(128*c.y))]];var l=d.getTilePiece((f.x-_H.floor(f.x/(128*c.x))*(128*c.x)),(f.y-_H.floor(f.y/(128*c.y))*(128*c.y)),c);if(l){this.uiManager.indexes.tpIndex=this.SonicLevel.Blocks.indexOf(l);this.uiManager.modifyTilePieceArea.tilePiece=l;this.uiManager.solidTileArea.visible=true}}else{if(!f.button||f.button==0){switch(this.clickState){case ClickState.PlaceChunk:this.SonicLevel.ChunkMap[_H.floor(f.x/(128*c.x)),_H.floor(f.y/(128*c.y))]=this.uiManager.indexes.modifyIndex;break;case ClickState.PlaceRing:var j=_H.floor((f.x-_H.floor(f.x/(128*c.x))*(128*c.x))/(c.x));var k=_H.floor((f.y-_H.floor(f.y/(128*c.y))*(128*c.y))/(c.y));var h=(_H.floor(j/16))+(_H.floor(f.x/(128*c.x)))*8;var g=(_H.floor(k/16))+(_H.floor(f.y/(128*c.y)))*8;if(this.SonicLevel.Rings[g*8*sonicManager.SonicLevel.LevelWidth+h]){delete this.SonicLevel.Rings[g*8*sonicManager.SonicLevel.LevelWidth+h]}else{this.SonicLevel.Rings[g*8*sonicManager.SonicLevel.LevelWidth+h]={x:h,y:g}}break;default:}}}};this.tickCount=0;this.drawTickCount=0;this.tick=function(d){if(d.loading){return}if(d.sonicToon){d.tickCount++;d.sonicToon.ticking=true;try{d.sonicToon.tick(d.SonicLevel,c)}finally{d.sonicToon.ticking=false}if(d.sonicToon.y>128*sonicManager.SonicLevel.LevelHeight){d.sonicToon.y=0}if(d.sonicToon.x>128*sonicManager.SonicLevel.LevelWidth){d.sonicToon.x=0}}};this.screenOffset={x:b.canvas.width/2-this.windowLocation.width*c.x/2,y:b.canvas.height/2-this.windowLocation.height*c.y/2};this.draw=function(k){k.save();this.drawTickCount++;if((this.spriteLoader&&!this.spriteLoader.tick())||this.loading){k.fillStyle="white";k.fillText("Loading...   ",95,95);k.restore();return}this.screenOffset={x:k.canvas.width/2-this.windowLocation.width*c.x/2,y:k.canvas.height/2-this.windowLocation.height*c.y/2};if(this.sonicToon){if(this.sonicToon.ticking){while(true){if(!this.sonicToon.ticking){break}}}k.translate(this.screenOffset.x,this.screenOffset.y);k.fillStyle="#000000";k.fillRect(0,0,this.windowLocation.width*c.x,this.windowLocation.height*c.x);k.beginPath();k.rect(0,0,this.windowLocation.width*c.x,this.windowLocation.height*c.x);k.clip();this.windowLocation.x=_H.floor(this.sonicToon.x-160);this.windowLocation.y=_H.floor(this.sonicToon.y-180);var E=_H.floor(this.windowLocation.x/c.x);if(this.background){this.background.draw(k,{x:-_H.floor(this.windowLocation.x/2)*c.x,y:-(_H.floor(this.windowLocation.y/4))*c.y},c,E)}}if(this.windowLocation.x<0){this.windowLocation.x=0}if(this.windowLocation.y<0){this.windowLocation.y=0}if(this.windowLocation.x>128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width){this.windowLocation.x=128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width}if(this.windowLocation.y>128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height){this.windowLocation.y=128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height}var w=[];for(var s=-128;s<this.windowLocation.width;s+=128){for(var h=-128;h<this.windowLocation.height;h+=128){w.push({x:s,y:h})}}if(this.SonicLevel.Chunks&&this.SonicLevel.Chunks.length>0){for(var v in w){var F=(this.windowLocation.x+w[v].x+128)/128;var G=(this.windowLocation.y+w[v].y+128)/128;var e=_H.floor(F);var g=_H.floor(G);if(e<0||g<0){continue}var m=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[e][g]];if(!m){continue}var x={x:e*128*c.x,y:g*128*c.y};var y={x:x.x-this.windowLocation.x*c.x,y:x.y-this.windowLocation.y*c.x};m.draw(k,y,c,false);if(!this.sonicToon){k.strokeStyle="#DD0033";k.lineWidth=3;k.strokeRect(y.x,y.y,128*c.x,128*c.y)}}for(var B in this.SonicLevel.Rings){var A=this.SonicLevel.Rings[B];if(this.sonicToon){if(!this.sonicToon.obtainedRing[B]){if(this.windowLocation.intersects(A)){this.goodRing.draw(k,{x:(A.X)-this.windowLocation.x,y:(A.Y)-this.windowLocation.y},c,true)}}}else{if(this.windowLocation.intersects(A)){this.goodRing.draw(k,{x:(A.X)-this.windowLocation.x,y:(A.Y)-this.windowLocation.y},c,false)}}}for(var t=0;t<sonicManager.SonicLevel.Objects.length;t++){var u=sonicManager.SonicLevel.Objects[t];if(this.sonicToon){if(this.windowLocation.intersects({X:u.ObjectData.X,Y:u.ObjectData.Y})){u.draw(k,{x:(u.ObjectData.X)-this.windowLocation.x,y:(u.ObjectData.Y)-this.windowLocation.y},c,true)}}else{if(this.windowLocation.intersects({X:u.ObjectData.X,Y:u.ObjectData.Y})){u.draw(k,{x:(u.ObjectData.X)-this.windowLocation.x,y:(u.ObjectData.Y)-this.windowLocation.y},c,false)}}}for(var s=this.activeRings.length-1;s>=0;s--){var j=this.activeRings[s];j.draw(k,{x:j.x-this.windowLocation.x,y:j.y-this.windowLocation.y},c);if(j.tickCount>256){_H.remove(this.activeRings,j)}}if(this.sonicToon){this.sonicToon.draw(k,c);if(this.windowLocation.x<0){this.windowLocation.x=0}if(this.windowLocation.y<0){this.windowLocation.y=0}if(this.windowLocation.x>128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width){this.windowLocation.x=128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width}if(this.windowLocation.y>128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height){this.windowLocation.y=128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height}}for(var v in w){var F=(this.windowLocation.x+w[v].x+128)/128;var G=(this.windowLocation.y+w[v].y+128)/128;var e=_H.floor(F);var g=_H.floor(G);if(e<0||g<0){continue}var m=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[e][g]];if(!m){continue}var x={x:e*128*c.x,y:g*128*c.y};var y={x:x.x-this.windowLocation.x*c.x,y:x.y-this.windowLocation.y*c.x};m.draw(k,y,c,true);if(!this.sonicToon){k.strokeStyle="#DD0033";k.lineWidth=3;k.strokeRect(y.x,y.y,128*c.x,128*c.y)}if(this.showHeightMap){var n;if((n=sonicManager.SpriteCache.heightMapChunks[(this.SonicLevel.curHeightMap?1:2)+" "+m.index+" "+c.y+" "+c.x])){if(n.loaded){k.drawImage(n,y.x,y.y)}}else{var q=this.SonicLevel.curHeightMap?sonicManager.SonicLevel.CollisionIndexes1:sonicManager.SonicLevel.CollisionIndexes2;for(var f=0;f<8;f++){for(var d=0;d<8;d++){var C=m.tilePieces[d][f];var p=sonicManager.SonicLevel.HeightMaps[q[C.Block]];if(p==0){continue}if(p==1){k.fillStyle="rgba(24,98,235,0.6)";k.fillRect(y.x+(d*16)*c.x,y.y+(f*16)*c.y,c.x*16,c.y*16);continue}var z={x:y.x+(d*16)*c.x,y:y.y+(f*16)*c.y};p.draw(k,z,c,-1,C.XFlip,C.YFlip,this.SonicLevel.curHeightMap?C.Solid1:C.Solid2);if(false&&md[d][f]!=null){var D=md[d][f];z.x+=16*c.x/2;z.y+=16*c.y/2;k.moveTo(z.x,z.y);k.lineTo(z.x+_H.sin((D))*10*c.x,z.y+_H.cos((D))*10*c.y);k.strokeStyle="#D141FF";k.lineWidth=4;k.stroke()}}}}}if(!this.sonicToon){k.strokeStyle="#DD0033";k.lineWidth=3;k.strokeRect(y.x,y.y,128*c.x,128*c.y)}}}k.restore();if(this.sonicToon){this.sonicToon.drawUI(k,{x:this.screenOffset.x,y:this.screenOffset.y},c)}};this.spriteLoader=null;this.SpriteCache={rings:[],tileChunks:[],tilePeices:[],tiles:[],sonicSprites:[],heightMaps:[],heightMapChunks:[]};this.preLoadSprites=function(p,f,w){this.SpriteCache={rings:[],tileChunks:[],tilePeices:[],tiles:[],sonicSprites:[],heightMaps:[],heightMapChunks:[]};var e=this.SpriteCache.rings;var l=0;var t=[];for(var m=0;m<4;m++){t[m]="assets/Sprites/ring"+m+".png";this.imageLength++}var v=this;var o;var h={sprites:0,tps:0,tcs:0,ss:0,hms:0,hmc:0,tls:0,px:0};var q=this.spriteLoader=new SpriteLoader(f,w);var u=q.addStep("Sprites",function(k,j){var x=k*200;e[x]=_H.loadSprite(t[k],function(y){e[y.tag*200+p.x*100+p.y]=_H.scaleSprite(y,p,function(z){j()})});e[x].tag=k},function(){h.sprites=h.sprites+1;if(h.sprites==4){return true}return false});for(var g=0;g<t.length;g++){q.addIterationToStep(u,g)}var v=this;var s=1;var d=q.addStep("Chunk Maps",function(H,E){var A=_H.defaultCanvas(128*p.x,128*p.y);var C=A.context;C.clearRect(0,0,A.width,A.height);o=v.SonicLevel.Chunks[H];o.draw(C,{x:0,y:0},p,false);var F=A.canvas.toDataURL("image/png");v.SpriteCache.tileChunks[false+" "+o.index+" "+p.y+" "+p.x]=_H.loadSprite(F,function(k){h.tcs++;E()});A=_H.defaultCanvas(128*p.x,128*p.y);C=A.context;C.clearRect(0,0,A.width,A.height);if(!o.onlyBackground()){o.draw(C,{x:0,y:0},p,true);var F=A.canvas.toDataURL("image/png");v.SpriteCache.tileChunks[true+" "+o.index+" "+p.y+" "+p.x]=_H.loadSprite(F,function(k){h.tcs++;E()})}else{v.SpriteCache.tileChunks[true+" "+o.index+" "+p.y+" "+p.x]=1;h.tcs++;E()}var J={x:0,y:0};A=_H.defaultCanvas(128*p.x,128*p.y);C=A.context;C.clearRect(0,0,A.width,A.height);var B=_H.defaultCanvas(128*p.x,128*p.y);var D=B.context;D.clearRect(0,0,B.width,B.height);for(var z=0;z<8;z++){for(var y=0;y<8;y++){var L=o.tilePieces[y][z];var I=sonicManager.SonicLevel.CollisionIndexes1[L.Block];var G=sonicManager.SonicLevel.HeightMaps[I];if(G==0){continue}var j=y;var x=z;if(G==1){if(L.Solid1>0){C.fillStyle=HeightMask.colors[L.Solid1]}C.fillRect(J.x+(j*16)*p.x,J.y+(x*16)*p.y,p.x*16,p.y*16);continue}var K={x:J.x+(j*16)*p.x,y:J.y+(x*16)*p.y};G.draw(C,K,p,-1,L.XFlip,L.YFlip,L.Solid1);G=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes2[L.Block]];if(G==0){continue}if(G==1){if(L.Solid2>0){C.fillStyle=HeightMask.colors[L.Solid2]}D.fillRect(J.x+(j*16)*p.x,J.y+(x*16)*p.y,p.x*16,p.y*16);continue}var K={x:J.x+(j*16)*p.x,y:J.y+(x*16)*p.y};G.draw(D,K,p,-1,L.XFlip,L.YFlip,L.Solid2)}}var F=A.canvas.toDataURL("image/png");v.SpriteCache.heightMapChunks[1+" "+o.index+" "+p.y+" "+p.x]=_H.loadSprite(F,function(k){h.hmc++;E()});F=B.canvas.toDataURL("image/png");v.SpriteCache.heightMapChunks[2+" "+o.index+" "+p.y+" "+p.x]=_H.loadSprite(F,function(k){h.hmc++;E()})},function(){if(h.tcs>=v.SonicLevel.Chunks.length*2/s&&h.hmc>=v.SonicLevel.Chunks.length*2/s){return true}return false});for(var n=0;n<this.SonicLevel.Chunks.length;n++){q.addIterationToStep(d,n)}var r=q.addStep("Sonic Sprites",function(x,k){var j=v.SpriteCache.sonicSprites;j[x]=_H.loadSprite(v.spriteLocations[x],function(y){j[y.tag+p.x+p.y]=_H.scaleSprite(y,p,k)});j[x].tag=x},function(){h.ss++;if(h.ss==v.imageLength){return true}return false});v.spriteLocations=[];v.imageLength=0;v.spriteLocations.normal="assets/Sprites/sonic.png";q.addIterationToStep(r,"normal");v.imageLength++;var m;for(m=0;m<4;m++){v.spriteLocations["fastrunning"+m]="assets/Sprites/fastrunning"+m+".png";v.imageLength++;q.addIterationToStep(r,"fastrunning"+m)}for(m=0;m<8;m++){v.spriteLocations["running"+m]="assets/Sprites/running"+m+".png";v.imageLength++;q.addIterationToStep(r,"running"+m)}for(m=0;m<4;m++){v.spriteLocations["breaking"+m]="assets/Sprites/breaking"+m+".png";v.imageLength++;q.addIterationToStep(r,"breaking"+m)}for(m=0;m<5;m++){v.spriteLocations["balls"+m]="assets/Sprites/balls"+m+".png";v.imageLength++;q.addIterationToStep(r,"balls"+m)}for(m=0;m<2;m++){v.spriteLocations["duck"+m]="assets/Sprites/duck"+m+".png";v.imageLength++;q.addIterationToStep(r,"duck"+m)}for(m=0;m<2;m++){v.spriteLocations["hit"+m]="assets/Sprites/hit"+m+".png";v.imageLength++;q.addIterationToStep(r,"hit"+m)}for(m=0;m<6;m++){v.spriteLocations["spindash"+m]="assets/Sprites/spindash"+m+".png";v.imageLength++;q.addIterationToStep(r,"spindash"+m)}for(m=0;m<7;m++){v.spriteLocations["spinsmoke"+m]="assets/Sprites/spinsmoke"+m+".png";v.imageLength++;q.addIterationToStep(r,"spinsmoke"+m)}for(m=0;m<4;m++){v.spriteLocations["haltsmoke"+m]="assets/Sprites/haltsmoke"+m+".png";v.imageLength++;q.addIterationToStep(r,"haltsmoke"+m)}for(m=0;m<2;m++){v.spriteLocations["lookingup"+m]="assets/Sprites/lookingup"+m+".png";v.imageLength++;q.addIterationToStep(r,"lookingup"+m)}}}ClickState={PlaceChunk:0,PlaceRing:1};function SpriteLoader(a,c){var b=this;this.stepIndex=0;this.steps=[];this.done=false;this.tickIndex=0;this.tick=function(){if(this.stepIndex==this.steps.length){if(!this.done){this.done=true;a()}return true}var d=this.steps[this.stepIndex];if(!d){return true}if(b.tickIndex%5==0){c("Caching: "+d.title+" "+Math.floor(((b.tickIndex/d.iterations.length)*100))+"%")}if(d.iterations.length>this.tickIndex){d.method(d.iterations[this.tickIndex++],function(){if(d.finish()){b.stepIndex++;b.tickIndex=0}})}return false};this.addStep=function(f,d,e){this.steps.push({title:f,method:d,finish:e,iterations:[]});return this.steps.length-1};this.addIterationToStep=function(e,d){this.steps[e].iterations.push(d)}}var Stats=function(){var C,v,M=0,N=0,D=Date.now(),P=D,O=D,G=0,I=1000,J=0,z,E,A,w=[[16,16,48],[0,255,255]],H=0,K=1000,L=0,y,F,B,x=[[16,48,16],[0,255,0]];C=document.createElement("div");C.style.cursor="pointer";C.style.width="80px";C.style.opacity="0.9";C.style.zIndex="10001";C.addEventListener("mousedown",function(b){b.preventDefault();M=(M+1)%2;0==M?(z.style.display="block",y.style.display="none"):(z.style.display="none",y.style.display="block")},!1);z=document.createElement("div");z.style.textAlign="left";z.style.lineHeight="1.2em";z.style.backgroundColor="rgb("+_H.floor(w[0][0]/2)+","+_H.floor(w[0][1]/2)+","+_H.floor(w[0][2]/2)+")";z.style.padding="0 0 3px 3px";C.appendChild(z);E=document.createElement("div");E.style.fontFamily="Helvetica, Arial, sans-serif";E.style.fontSize="9px";E.style.color="rgb("+w[1][0]+","+w[1][1]+","+w[1][2]+")";E.style.fontWeight="bold";E.innerHTML="FPS";z.appendChild(E);A=document.createElement("div");A.style.position="relative";A.style.width="74px";A.style.height="30px";A.style.backgroundColor="rgb("+w[1][0]+","+w[1][1]+","+w[1][2]+")";for(z.appendChild(A);74>A.children.length;){v=document.createElement("span"),v.style.width="1px",v.style.height="30px",v.style.cssFloat="left",v.style.backgroundColor="rgb("+w[0][0]+","+w[0][1]+","+w[0][2]+")",A.appendChild(v)}y=document.createElement("div");y.style.textAlign="left";y.style.lineHeight="1.2em";y.style.backgroundColor="rgb("+_H.floor(x[0][0]/2)+","+_H.floor(x[0][1]/2)+","+_H.floor(x[0][2]/2)+")";y.style.padding="0 0 3px 3px";y.style.display="none";C.appendChild(y);F=document.createElement("div");F.style.fontFamily="Helvetica, Arial, sans-serif";F.style.fontSize="9px";F.style.color="rgb("+x[1][0]+","+x[1][1]+","+x[1][2]+")";F.style.fontWeight="bold";F.innerHTML="MS";y.appendChild(F);B=document.createElement("div");B.style.position="relative";B.style.width="74px";B.style.height="30px";B.style.backgroundColor="rgb("+x[1][0]+","+x[1][1]+","+x[1][2]+")";for(y.appendChild(B);74>B.children.length;){v=document.createElement("span"),v.style.width="1px",v.style.height=30*Math.random()+"px",v.style.cssFloat="left",v.style.backgroundColor="rgb("+x[0][0]+","+x[0][1]+","+x[0][2]+")",B.appendChild(v)}return{getDomElement:function(){return C},getFps:function(){return G},getFpsMin:function(){return I},getFpsMax:function(){return J},getMs:function(){return H},getMsMin:function(){return K},getMsMax:function(){return L},update:function(){D=Date.now();H=D-P;K=Math.min(K,H);L=Math.max(L,H);F.textContent=H+" MS ("+K+"-"+L+")";var b=Math.min(30,30-30*(H/200));B.appendChild(B.firstChild).style.height=b+"px";P=D;N++;if(D>O+1000){G=Math.round(1000*N/(D-O)),I=Math.min(I,G),J=Math.max(J,G),E.textContent=G+" FPS ("+I+"-"+J+")",b=Math.min(30,30-30*(G/100)),A.appendChild(A.firstChild).style.height=b+"px",O=D,N=0}}}};function Tile(a){this.colors=a;this.sprites=[];Tile.prototype.changeColor=function(c,d,b){this.colors[c][d]=b;this.sprites=[]};Tile.prototype.draw=function(b,p,q,r,s,o,k){var e;if((e=sonicManager.SpriteCache.tiles[this.index+""+r+""+s])){b.putImageData(e,p.x,p.y)}else{b.save();var n={x:p.x,y:p.y};if(r){p.x=-p.x-this.colors.length*q.x;b.scale(-1,1)}if(s){p.y=-p.y-this.colors.length*q.y;b.scale(1,-1)}for(var g=0;g<this.colors.length;g++){for(var h=0;h<this.colors[g].length;h++){var f=this.colors[g][h];if(f==0){continue}var l=sonicManager.SonicLevel.Palette[o][f];if(b.fillStyle!="#"+l){b.fillStyle="#"+l}b.fillRect(p.x+((g))*q.x,p.y+(h)*q.y,q.x,q.y)}}b.restore();var c=this.colors.length*q.x;var d=this.colors.length*q.y;sonicManager.SpriteCache.tiles[this.index+""+r+""+s]=b.getImageData(n.x,n.y,c,d)}}}function TileChunk(a){this.tilePieces=a;this.hLayer=[[]];this.sprites=[];TileChunk.prototype.getTilePiece=function(c,d,b){return sonicManager.SonicLevel.Blocks[this.tilePieces[_H.floor((c/b.x/16))][_H.floor((d/b.y/16))]]};TileChunk.prototype.onlyBackground=function(){for(var b=0;b<this.tilePieces.length;b++){for(var c=0;c<this.tilePieces[b].length;c++){var e=this.tilePieces[b][c];var d=sonicManager.SonicLevel.Blocks[e.Block];if(d){if(!d.onlyBackground()){return false}}}}return true};TileChunk.prototype.draw=function(b,h,l,f){var c;if((c=sonicManager.SpriteCache.tileChunks[f+" "+this.index+" "+l.y+" "+l.x])){if(c==1){return}if(c.loaded){b.drawImage(c,h.x,h.y)}}else{for(var d=0;d<this.tilePieces.length;d++){for(var e=0;e<this.tilePieces[d].length;e++){var k=this.tilePieces[d][e];var g=sonicManager.SonicLevel.Blocks[k.Block];if(g){g.draw(b,{x:h.x+d*16*l.x,y:h.y+e*16*l.y},l,f,k.XFlip,k.YFlip)}}}}return true}}function TileItem(){TileItem.prototype.draw=function(){}}function TilePiece(a,b){this.tiles=b;TilePiece.prototype.click=function(d,e,c){};TilePiece.prototype.mouseOver=function(c,d){};TilePiece.prototype.onlyBackground=function(){for(var c=0;c<this.tiles.length;c++){var d=this.tiles[c];if(sonicManager.SonicLevel.Tiles[d.Tile]){if(d.Priority==true){return false}}}return true};TilePiece.prototype.draw=function(c,j,k,g,l,m){var d;if(l){if(m){d=[3,2,1,0]}else{d=[1,0,3,2]}}else{if(m){d=[2,3,0,1]}else{d=[0,1,2,3]}}var e;if((e=sonicManager.SpriteCache.tilePeices[g+" "+this.index+" "+k.y+" "+k.x])){if(e.loaded){c.drawImage(e,j.x,j.y)}}else{for(var f=0;f<this.tiles.length;f++){var h=this.tiles[f];if(sonicManager.SonicLevel.Tiles[h.Tile]){if(h.Priority==g){sonicManager.SonicLevel.Tiles[h.Tile].draw(c,{x:j.x+(d[f]%2)*8*k.x,y:j.y+_H.floor(d[f]/2)*8*k.y},k,_H.xor(l,h.XFlip),_H.xor(m,h.YFlip),h.Palette,false,g)}}}}return true};TilePiece.prototype.equals=function(d){for(var c=0;c<this.tiles.length;c++){if(d[c]!=this.tiles[c]){return false}}return true}}RotationMode={Floor:134,RightWall:224,Ceiling:314,LeftWall:44};function UiArea(f,g,e,b,c,a){this.x=f;this.y=g;this.manager=c;this.closable=a;this.width=e;this.height=b;this.depth=0;this.visible=true;this.dragging=false;this.controls=[];this.addControl=function(h){h.parent=this;this.controls.push(h);return h};var d=this;if(a){this.addControl(new Button(this.width-30,4,26,26,"X",this.manager.buttonFont,"Green",function(){d.visible=false}))}this.click=function(j){if(!this.visible){return}for(var k=0;k<this.controls.length;k++){var h=this.controls[k];if(h.visible&&h.y<=j.y&&h.y+h.height>j.y&&h.x<=j.x&&h.x+h.width>j.x){j.x-=h.x;j.y-=h.y;h.onClick(j);return false}}this.dragging={x:j.x,y:j.y}};this.mouseMove=function(j){if(!this.visible){return}if(!this.dragging){for(var k=0;k<this.controls.length;k++){var h=this.controls[k];if(h.visible&&h.y<=j.y&&h.y+h.height>j.y&&h.x<=j.x&&h.x+h.width>j.x){j.x-=h.x;j.y-=h.y;h.onMouseOver(j)}}return}this.x+=j.x-this.dragging.x;this.y+=j.y-this.dragging.y};this.mouseUp=function(j){if(!this.visible){return}for(var k=0;k<this.controls.length;k++){var h=this.controls[k];h.onMouseUp({x:j.x-h.x,y:j.y-h.y})}this.dragging=false};this.scroll=function(j){if(!this.visible){return}for(var k=0;k<this.controls.length;k++){var h=this.controls[k];if(h.visible&&h.y<=j.y&&h.y+h.height>j.y&&h.x<=j.x&&h.x+h.width>j.x){if(h.onScroll){j.x-=h.x;j.y-=h.y;h.onScroll(j);return false}}}};this.cachedDrawing=null;this.draw=function(l){if(!this.visible){return}var o;var q;var p;if(!this.cachedDrawing){var m=document.createElement("canvas");m.width=this.width+20;m.height=this.height+20;var n=m.getContext("2d");n.fillStyle="rgba(133,133,133,0.6)";n.lineWidth=9;n.strokeStyle="#333";var h=this.x;var k=this.y;this.x=10;this.y=10;roundRect(n,this.x,this.y,this.width,this.height,5,true,true);for(p=0;p<this.controls.length;p++){q=this.controls[p];o=q.forceDrawing();if(o.redraw){q.draw(n)}}this.x=h;this.y=k;this.cachedDrawing=_H.loadSprite(m.toDataURL("image/png"))}if(this.cachedDrawing.loaded){l.drawImage(this.cachedDrawing,_H.floor(this.x),_H.floor(this.y));if(this.cachedDrawing.width!=this.width+20||this.cachedDrawing.height!=this.height+20){this.cachedDrawing=null}l.save();l.translate(10,10);for(p=0;p<this.controls.length;p++){q=this.controls[p];o=q.forceDrawing();if(!o.redraw){q.draw(l)}if(o.clearCache){this.cachedDrawing=null}}l.restore()}else{l.fillStyle="rgba(133,133,133,0.6)";l.lineWidth=9;l.strokeStyle="#333";l.save();l.translate(10,10);roundRect(l,this.x,this.y,this.width,this.height,5,true,true);for(p=0;p<this.controls.length;p++){q=this.controls[p];q.draw(l)}l.restore()}};return this}function TextArea(d,e,c,b,a){this.forceDrawing=function(){if((_H.isFunction(this.text)?this.text():this.text)==this.oldText){return{redraw:true,clearCache:false}}this.oldText=_H.isFunction(this.text)?this.text():this.text;return{redraw:true,clearCache:true}};this.x=d;this.oldText="";this.y=e;this.visible=true;this.text=c;this.font=b;this.color=a;this.parent=null;this.onClick=function(f){return false};this.onMouseUp=function(f){if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(f){if(this.mouseOver){this.mouseOver()}};this.draw=function(f){if(!this.visible){return}var k=_H.isFunction(this.text)?this.text():this.text;if(f.font!=this.font){f.font=this.font}var l=f.measureText(k).width;var g=parseInt(f.font.split("pt")[0]);var j=3;f.strokeStyle=this.color;f.shadowColor="#FFF";f.shadowBlur=20;f.lineWidth=1.5;f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.shadowBlur=0};return this}function Button(j,k,h,d,g,c,b,a,f,e){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=j;this.y=k;this.visible=true;this.width=h;this.height=d;this.text=g;this.font=c;this.clicking=false;this.click=a;this.mouseUp=f;this.mouseOver=e;this.color=b;this.parent=null;this.onClick=function(l){if(!this.visible){return}this.clicking=true};this.onMouseUp=function(l){if(!this.visible){return}if(this.clicking){if(this.click){this.click()}}this.clicking=false;if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(l){if(!this.visible){return}if(this.mouseOver){this.mouseOver()}};this.draw=function(l){if(!this.visible){return}l.fillStyle=this.color;l.strokeStyle="#DAC333";l.lineWidth=2;roundRect(l,this.parent.x+this.x,this.parent.y+this.y,this.width,this.height,5,true,true);l.fillStyle=this.clicking?"#FCA":"#334";if(l.font!=this.font){l.font=this.font}l.fillText(this.text,this.parent.x+this.x+((this.width/2)-(l.measureText(this.text).width/2)),this.parent.y+this.y+(this.height/3)*2)};return this}function TilePieceArea(d,e,a,c,b){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=d;this.y=e;this.visible=true;this.scale=a;this.width=a.x*16;this.height=a.y*17;this.clicking=false;this.tilePiece=c;this.parent=null;this.state=b;this.onClick=function(f){if(!this.visible){return}this.clicking=true;this.clickHandled=false};this.onMouseUp=function(f){if(!this.visible){return}if(this.tilePiece&&this.clicking&&!this.clickHandled){this.tilePiece.click(_H.floor(f.x/a.x),_H.floor(f.y/a.y),this.state)}this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(f){if(!this.tilePiece){return}if(this.clicking){this.clickHandled=true;this.tilePiece.click(_H.floor(f.x/a.x),_H.floor(f.y/a.y),this.state)}else{this.tilePiece.mouseOver(_H.floor(f.x/a.x),_H.floor(f.y/a.y))}};this.draw=function(f){if(!this.visible){return}if(!this.tilePiece){return}this.tilePiece.tag=true;this.tilePiece.draw(f,{x:this.parent.x+this.x,y:this.parent.y+this.y},this.scale,this.state,true);this.tilePiece.tag=false};return this}function TileBGEditArea(b,c,a){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=b;this.y=c;this.visible=true;this.clicking=false;this.parallaxBG=a;this.parent=null;this.lowestClickedY=-1;this.highestClickedY=-1;this.onClick=function(f){if(!this.visible){return}this.clicking=true;this.parallaxBG=sonicManager.background;if(f.x>0&&f.y>0&&f.y<this.parallaxBG.height&&f.x<this.parallaxBG.width){var d;if((d=this.parallaxBG.onBar(f.x,f.y))){this.lowestClickedY=d.top;this.highestClickedY=d.bottom}else{this.lowestClickedY=f.y;this.highestClickedY=f.y}}this.clickHandled=false};this.onMouseUp=function(d){if(!this.visible){return}this.parallaxBG=sonicManager.background;this.highestClickedY=-1;this.lowestClickedY=-1;this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(d){if(!this.clicking){return}this.parallaxBG=sonicManager.background;if(d.x>0&&d.y>0&&d.y<this.parallaxBG.height&&d.x<this.parallaxBG.width){if(d.y>this.highestClickedY){this.highestClickedY=d.y}if(d.y<this.lowestClickedY){this.lowestClickedY=d.y}for(var f=this.lowestClickedY;f<this.highestClickedY;f++){this.parallaxBG.click(d.x,f)}}return false};this.draw=function(d){if(!this.visible){return}this.parallaxBG=sonicManager.background;if(!this.parallaxBG){return}this.width=this.parallaxBG.width;this.height=this.parallaxBG.height;this.parent.width=this.width+70;this.parent.height=this.height+50;var e={x:1,y:1};this.parallaxBG.drawUI(d,{x:this.parent.x+this.x,y:this.parent.y+this.y},e)};return this}function TileChunkArea(d,e,a,c,b){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=d;this.y=e;this.visible=true;this.scale=a;this.width=a.x*128;this.height=a.y*128;this.clicking=false;this.tileChunk=c;this.parent=null;this.state=b;this.setToTile=null;this.onClick=function(f){if(!this.visible){return}this.clicking=true};this.onMouseUp=function(f){if(!this.visible){return}if(this.clicking){if(this.setToTile!=null){this.tileChunk.tilePieces[((_H.floor(f.x/this.scale.x/16)))][(_H.floor(f.y/this.scale.y/16))]=sonicManager.SonicLevel.Blocks.indexOf(this.setToTile);this.tileChunk.sprites=[]}}this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(f){if(this.clicking){}};this.draw=function(f){if(!this.visible){return}if(!this.tileChunk){return}this.tileChunk.draw(f,{x:this.parent.x+this.x,y:this.parent.y+this.y},this.scale,true)};return this}function ScrollBox(g,h,c,f,d,a,b){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=g;this.y=h;this.itemWidth=d;this.visible=true;var e=14;this.width=d+e;this.visibleItems=f;this.itemHeight=c;this.backColor=a;this.height=f*c;this.parent=null;this.scrollOffset=0;this.scrollPosition=0;this.dragging=false;if(b){this.controls=b}else{this.controls=[]}this.scrolling=false;this.addControl=function(j){j.parent=this;this.controls.push(j);return j};this.onClick=function(k){if(!this.visible){return}for(var l=this.scrollOffset;l<this.controls.length;l++){var j=this.controls[l];if(j.y<=k.y&&j.y+j.height>k.y&&j.x<=k.x&&j.x+j.width>k.x){k.x-=j.x;k.y-=j.y;j.onClick(k);return false}}if(k.x>this.itemWidth&&k.x<this.itemWidth+e){if(this.scrollPosition>k.y){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}}this.dragging=true;return false};this.onMouseUp=function(k){if(!this.visible){return}this.dragging=false;for(var l=this.scrollOffset;l<this.controls.length;l++){var j=this.controls[l];if(j.y<=k.y&&j.y+j.height>k.y&&j.x<=k.x&&j.x+j.width>k.x){k.x-=j.x;k.y-=j.y;j.onMouseUp(k);return false}}if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(k){if(!this.visible){return}for(var l=0;l<this.controls.length;l++){var j=this.controls[l];if(j.y<=k.y&&j.y+j.height>k.y&&j.x<=k.x&&j.x+j.width>k.x){k.x-=j.x;k.y-=j.y;j.onMouseOver(k);break}}if(this.dragging&&k.x>this.itemWidth&&k.x<this.itemWidth+e){if(this.scrollPosition>k.y){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}}if(this.mouseOver){this.mouseOver()}};this.onScroll=function(k){if(!this.visible){return}if(k.delta>0){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}for(var l=0;l<this.controls.length;l++){var j=this.controls[l];if(j.y<=k.y&&j.y+j.height>k.y&&j.x<=k.x&&j.x+j.width>k.x){k.x-=j.x;k.y-=j.y;if(j.onScroll){j.onScroll(k)}return false}}if(this.scroll){this.scroll()}};this.draw=function(j){if(!this.visible){return}j.fillStyle=this.backColor;var l;j.fillStyle=this.backColor;j.lineWidth=1;j.strokeStyle="#333";roundRect(j,this.parent.x+this.x,this.parent.y+this.y,this.itemWidth+e+6,this.visibleItems*this.itemHeight,3,true,true);j.fillStyle="grey";j.lineWidth=1;j.strokeStyle="#444";j.fillRect(this.parent.x+this.x+this.itemWidth+2+2,this.parent.y+this.y+2,e,this.visibleItems*this.itemHeight-2);j.fillStyle="red";j.lineWidth=1;j.strokeStyle="#444";this.scrollPosition=(this.visibleItems*this.itemHeight-2)*this.scrollOffset/this.controls.length;j.fillRect(this.parent.x+this.x+this.itemWidth+2+2+2,this.parent.y+this.y+2+(this.scrollPosition),e-2,5);var k=1;for(l=this.scrollOffset;l<Math.min(this.controls.length,this.scrollOffset+this.visibleItems);l++){this.controls[l].parent={x:this.parent.x+this.x,y:this.parent.y+this.y};this.controls[l].x=2;this.controls[l].y=k;this.controls[l].height=this.itemHeight;this.controls[l].width=this.itemWidth;k+=this.itemHeight;this.controls[l].draw(j)}};return this}function roundRect(a,g,h,f,c,d,b,e){if(typeof e=="undefined"){e=true}if(typeof d==="undefined"){d=5}a.beginPath();a.moveTo(g+d,h);a.lineTo(g+f-d,h);a.quadraticCurveTo(g+f,h,g+f,h+d);a.lineTo(g+f,h+c-d);a.quadraticCurveTo(g+f,h+c,g+f-d,h+c);a.lineTo(g+d,h+c);a.quadraticCurveTo(g,h+c,g,h+c-d);a.lineTo(g,h+d);a.quadraticCurveTo(g,h,g+d,h);a.closePath();if(e){a.stroke()}if(b){a.fill()}}function UIManager(u,m,s){this.UIAreas=[];this.messages=[];var w=this.textFont="18pt sans-serrif ";var c=this.buttonFont="13pt Arial bold";m.font=w;var g=this.indexes={tpIndex:0,modifyIndex:0,modifyTPIndex:0};this.dragger=new Dragger(function(x,y){u.windowLocation.x+=x;u.windowLocation.y+=y});this.draw=function(y){this.dragger.tick();y.save();var z=JSLINQ(this.UIAreas).OrderBy(function(C){return C.depth});for(var B=0;B<z.items.length;B++){var x=z.items[B];x.draw(y)}if(DEBUGs){for(var A=0;A<this.messages.length;A++){y.fillText(this.messages[A],10,25+A*30)}}y.restore()};this.onMouseScroll=function(z){var y=z.wheelDelta?z.wheelDelta/40:z.detail?-z.detail:0;for(var A=0;A<this.UIAreas.length;A++){var x=this.UIAreas[A];if(x.visible&&x.y<=z.y&&x.y+x.height>z.y&&x.x<=z.x&&x.x+x.width>z.x){z={x:z.x-x.x-10,y:z.y-x.y-10,delta:y};return x.scroll(z)}}return false};this.onClick=function(A){var y=_H.getCursorPosition(A);y.x-=10;y.y-=10;var C=null;var x;var D;var z=JSLINQ(this.UIAreas).OrderBy(function(E){return -E.depth});for(var D=0;D<z.items.length;D++){var x=z.items[D];if(x.visible&&x.y<=y.y&&x.y+x.height>y.y&&x.x<=y.x&&x.x+x.width>y.x){C=x;var B={x:y.x-x.x,y:y.y-x.y};x.click(B);break}}if(C){for(D=0;D<this.UIAreas.length;D++){x=this.UIAreas[D];if(C==x){x.depth=1}else{x.depth=0}}return true}this.dragger.click(A);return false};this.onMouseMove=function(A){var y=_H.getCursorPosition(A);y.x-=10;y.y-=10;var z=JSLINQ(this.UIAreas).OrderBy(function(C){return -C.depth});for(var B=0;B<z.items.length;B++){var x=z.items[B];if(x.dragging||(x.visible&&x.y<=y.y&&x.y+x.height>y.y&&x.x<=y.x&&x.x+x.width>y.x)){y={x:y.x-x.x,y:y.y-x.y};return x.mouseMove(y)}}this.dragger.mouseMove(A);return false};this.onMouseUp=function(z){var y=_H.getCursorPosition(z,true);y.x-=10;y.y-=10;for(var B=0;B<this.UIAreas.length;B++){var x=this.UIAreas[B];var A={x:y.x-x.x,y:y.y-x.y};x.mouseUp(A)}this.dragger.mouseUp(z)};var f=this.debuggerArea=new UiArea(1347,95,200,240,this,true);f.visible=false;this.UIAreas.push(f);f.addControl(new TextArea(30,25,"Debugger",w,"blue"));f.addControl(new Button(40,60,60,22,"Stop",c,"rgb(50,150,50)",function(){u.windowLocation=_H.defaultWindowLocation(1);f.visible=false;t.visible=false;h.visible=true;j.visible=true;u.sonicToon=null}));f.addControl(new Button(40,95,90,22,"Hit Sonic",c,"rgb(50,150,50)",function(){u.sonicToon.hit()}));f.addControl(new Button(40,130,160,22,"Show Height Map",c,"rgb(50,150,50)",function(){if(this.text=="Show Height Map"){u.showHeightMap=true;this.text="Hide Height Map"}else{u.showHeightMap=false;this.text="Show Height Map"}}));f.addControl(new Button(40,160,160,22,"Switch Height Map",c,"rgb(50,150,50)",function(){u.SonicLevel.curHeightMap=!u.SonicLevel.curHeightMap}));f.addControl(new Button(40,190,160,22,"Debug Sonic",c,"rgb(50,150,50)",function(){if(this.text=="Debug Sonic"){u.sonicToon.debugging=true;this.text="Normal Sonic"}else{u.sonicToon.debugging=false;this.text="Debug Sonic"}}));var t=this.solidTileArea=new UiArea(40,450,430,400,this,true);t.visible=false;this.UIAreas.push(t);t.addControl(new TextArea(30,25,"Modify Solid Tile",w,"blue"));t.addControl(new Button(50,35,25,22,"<<",c,"rgb(50,150,50)",function(){if(g.tpIndex>0){q.tilePiece=u.SonicLevel.Blocks[--g.tpIndex]}}));t.addControl(new Button(75,35,25,22,">>",c,"rgb(50,150,50)",function(){if(g.tpIndex<u.SonicLevel.Blocks.length){q.tilePiece=u.SonicLevel.Blocks[++g.tpIndex]}}));t.addControl(new Button(360,80,45,22,"Full",c,"rgb(50,150,50)",function(){for(var x=0;x<16;x++){q.tilePiece.heightMask.items[x]=16}this.sprites=[]}));t.addControl(new Button(200,35,180,22,"Modify Height Map",c,"rgb(50,150,50)",function(){q.state=(q.state+1)%3;switch(q.state){case 0:this.text="Modify Height Map";break;case 1:this.text="Modify Tile Direction";break;case 2:this.text="Modify Tile Colors";break}}));var q=this.modifyTilePieceArea=new TilePieceArea(30,70,{x:4*5,y:4*5},null,0);t.addControl(q);var b=this.bgEditor=new UiArea(100,440,420,360,this,true);b.visible=false;this.UIAreas.push(b);b.addControl(new TextArea(30,25,"BG Editor",w,"blue"));b.addControl(new TileBGEditArea(60,35));var h=this.levelInformation=new UiArea(70,70,470,360,this);h.visible=true;this.UIAreas.push(h);h.addControl(new TextArea(30,25,"Level Selector",w,"blue"));h.addControl(new TextArea(30,52,function(){return !e?"Level Not Saved":(e)},w,"black"));h.addControl(new Button(250,70,100,22,"Save Level",c,"rgb(50,150,50)",function(){if(e){OurSonic.SonicLevels.SaveLevelInformation(e,Base64.encode(_H.stringify(u.SonicLevel)),function(x){},function(x){alert("Failure: "+_H.stringify(x))})}else{OurSonic.SonicLevels.saveLevel(Base64.encode(_H.stringify(u.SonicLevel)),function(x){a(e)})}}));var v;h.addControl(v=new Button(250,105,160,22,"Load Empty Level",c,"rgb(50,150,50)",function(){j.visible=true;l.visible=true;var x=0;var y=function(){var z=188;if(x==z){setTimeout(function(){alert(_H.stringify(u.SonicLevel));k(_H.stringify(u.SonicLevel),m);l.visible=false},500);return}setTimeout(y,100);_H.loadSprite("assets/Chunks/Tile"+x+++".png",function(A){l.text="Loading "+x+"/"+z;u.importChunkFromImage(A);if(x==z){u.inds={done:true}}})};setTimeout(y,100)}));v.visible=false;var d;h.addControl(d=new ScrollBox(30,70,25,11,190,"rgb(50,60,127)"));var e;OurSonic.SonicLevels.getLevels(function(z){for(var x=0;x<z.length;x++){var y=z[x];a(y)}});function a(y){var x;d.addControl(x=new Button(0,0,0,0,y,"10pt Arial","rgb(50,190,90)",function(){e="Downloading";OurSonic.SonicLevels.getLevel(y,function(z){e="loading";e=y;k(z,m)})}))}var j=this.levelManagerArea=new UiArea(500,25,400,400,this);j.visible=false;this.UIAreas.push(j);j.addControl(new TextArea(30,25,"Level Manager",w,"blue"));var l;j.addControl(l=new TextArea(270,25,"Loading",w,"green"));l.visible=false;j.addControl(new Button(35,100,160,22,"Show Height Map",c,"rgb(50,150,50)",function(){if(this.text=="Show Height Map"){u.showHeightMap=true;this.text="Hide Height Map"}else{u.showHeightMap=false;this.text="Show Height Map"}}));j.addControl(new Button(200,150,160,22,"Place Chunks",c,"rgb(50,150,50)",function(){u.clickState=(u.clickState+1)%2;switch(u.clickState){case ClickState.PlaceChunk:this.text="Place Chunks";break;case ClickState.PlaceRing:this.text="Place Rings";break}}));j.addControl(new Button(200,180,160,22,"Switch Height Map",c,"rgb(50,150,50)",function(){u.SonicLevel.curHeightMap=!u.SonicLevel.curHeightMap}));j.addControl(new Button(35,150,160,22,"Modify Chunks",c,"rgb(50,150,50)",function(){p.visible=true}));j.addControl(new Button(35,150,160,22,"Modify Chunks",c,"rgb(50,150,50)",function(){p.visible=true}));j.addControl(new Button(35,175,160,22,"Modify Tile Pieces",c,"rgb(50,150,50)",function(){t.visible=true}));j.addControl(new Button(35,200,160,22,"Modify Tiles",c,"rgb(50,150,50)",function(){o.visible=true}));j.addControl(new Button(35,240,160,22,"Modify Background",c,"rgb(50,150,50)",function(){b.visible=true}));j.addControl(new Button(200,35,60,22,"Run",c,"rgb(50,150,50)",function(){j.visible=false;t.visible=false;h.visible=false;o.visible=false;p.visible=false;t.visible=false;f.visible=true;if(u.background){u.background.cache(u.scale)}u.windowLocation=_H.defaultWindowLocation(0);u.sonicToon=new Sonic(u.SonicLevel,u.scale);u.sonicToon.obtainedRing=[]}));var p=this.modifyTileChunkArea=new UiArea(900,450,400,400,this,true);p.visible=false;this.UIAreas.push(p);p.addControl(new TextArea(30,25,"Modify Tile Chunk",w,"blue"));var n=this.modifyTC=new TileChunkArea(30,70,{x:2,y:2},null,1);p.addControl(n);p.addControl(new Button(50,35,25,22,"<<",c,"rgb(50,150,50)",function(){if(g.modifyIndex>0){n.tileChunk=u.SonicLevel.Chunks[--g.modifyIndex]}}));p.addControl(new Button(80,35,25,22,">>",c,"rgb(50,150,50)",function(){if(g.modifyIndex<u.SonicLevel.Chunks.length){n.tileChunk=u.SonicLevel.Chunks[++g.modifyIndex]}}));var r=this.modifyTP=new TilePieceArea(300,160,{x:2*3,y:2*3},null,3);p.addControl(r);p.addControl(new Button(300,100,25,22,"<<",c,"rgb(50,150,50)",function(){if(g.modifyTPIndex>0){r.tilePiece=n.setToTile=u.SonicLevel.Blocks[--g.modifyTPIndex]}}));p.addControl(new Button(330,100,25,22,">>",c,"rgb(50,150,50)",function(){if(g.modifyTPIndex<u.SonicLevel.Blocks.length){r.tilePiece=n.setToTile=u.SonicLevel.Blocks[++g.modifyTPIndex]}}));var o=this.modifyTileArea=new UiArea(900,25,400,400,this,true);o.visible=false;this.UIAreas.push(o);o.addControl(new TextArea(30,25,"Modify Tile",w,"blue"));function k(G,I){u.loading=true;u.SonicLevel=jQuery.parseJSON(G);var z;var C;if(!u.SonicLevel.Chunks){u.SonicLevel.Chunks=[]}if(!u.SonicLevel.Blocks){u.SonicLevel.Blocks=[]}if(!u.SonicLevel.Tiles){u.SonicLevel.Tiles=[]}if(!u.SonicLevel.Rings){u.SonicLevel.Rings=[]}u.SonicLevel.LevelWidth=u.SonicLevel.ForegroundWidth;u.SonicLevel.LevelHeight=u.SonicLevel.ForegroundHeight;var J=decodeNumeric(u.SonicLevel.Foreground);u.SonicLevel.ChunkMap=[];u.SonicLevel.ChunkMap.length=u.SonicLevel.ForegroundWidth;for(var O=0;O<u.SonicLevel.ForegroundWidth;O++){u.SonicLevel.ChunkMap[O]=[];u.SonicLevel.ChunkMap[O].length=u.SonicLevel.ForegroundHeight;for(var P=0;P<u.SonicLevel.ForegroundHeight;P++){u.SonicLevel.ChunkMap[O][P]=J[O+P*u.SonicLevel.ForegroundWidth]}}var J=decodeNumeric(u.SonicLevel.Background);u.SonicLevel.BGChunkMap=[];u.SonicLevel.BGChunkMap.length=u.SonicLevel.BackgroundWidth;for(var O=0;O<u.SonicLevel.BackgroundWidth;O++){u.SonicLevel.BGChunkMap[O]=[];u.SonicLevel.BGChunkMap[O].length=u.SonicLevel.BackgroundHeight;for(var P=0;P<u.SonicLevel.BackgroundHeight;P++){u.SonicLevel.BGChunkMap[O][P]=J[O+P*u.SonicLevel.BackgroundWidth]}}for(var F=0;F<u.SonicLevel.Objects.length;F++){var M=u.SonicLevel.Objects[F];u.SonicLevel.Objects[F]=_H.ObjectParse(M)}u.SonicLevel.curHeightMap=true;for(C=0;C<u.SonicLevel.Tiles.length;C++){z=u.SonicLevel.Tiles[C];u.SonicLevel.Tiles[C]=decodeNumeric(z);var K=[];for(var F=0;F<u.SonicLevel.Tiles[C].length;F++){var R=u.SonicLevel.Tiles[C][F];K.push(R>>4);K.push(R&15)}u.SonicLevel.Tiles[C]={colors:K};var Q=u.SonicLevel.Tiles[C];var J=[];J.length=8;for(var M=0;M<8;M++){J[M]=[];J[M].length=8}for(var L=0;L<Q.colors.length;L++){J[L%8][_H.floor(L/8)]=Q.colors[L]}Q.colors=J;Q.__proto__=Tile.prototype;Q.index=C}for(C=0;C<u.SonicLevel.Blocks.length;C++){z=u.SonicLevel.Blocks[C];var K={};K.__proto__=TilePiece.prototype;K.index=C;K.tiles=[];for(var N=0;N<z.length;N++){K.tiles.push(z[N]);z[N].__proto__=TileItem.prototype}u.SonicLevel.Blocks[C]=K}var E;for(var B=0;B<u.SonicLevel.HeightMaps.length;B++){var x=true;var y=true;for(var H=0;H<u.SonicLevel.HeightMaps[B].length;H++){if(x&&u.SonicLevel.HeightMaps[B][H]!=0){x=false}if(y&&u.SonicLevel.HeightMaps[B][H]!=16){y=false}}if(x){u.SonicLevel.HeightMaps[B]=0}else{if(y){u.SonicLevel.HeightMaps[B]=1}else{u.SonicLevel.HeightMaps[B]=new HeightMask(0,u.SonicLevel.HeightMaps[B])}}}u.SonicLevel.Angles=decodeNumeric(u.SonicLevel.Angles);u.SonicLevel.CollisionIndexes1=decodeNumeric(u.SonicLevel.CollisionIndexes1);u.SonicLevel.CollisionIndexes2=decodeNumeric(u.SonicLevel.CollisionIndexes2);var D;for(C=0;C<u.SonicLevel.Chunks.length;C++){z=u.SonicLevel.Chunks[C];var K={};K.__proto__=TileChunk.prototype;K.index=C;K.tilePieces=[];K.tilePieces.length=8;for(var B=0;B<8;B++){K.tilePieces[B]=[];K.tilePieces[B].length=8}for(var N=0;N<z.length;N++){K.tilePieces[N%8][_H.floor(N/8)]=(z[N])}u.SonicLevel.Chunks[C]=K}var A=function(){j.visible=true;u.loading=false;n.tileChunk=u.SonicLevel.Chunks[0];q.tilePiece=r.tilePiece=u.SonicLevel.Blocks[0]};e="preloading sprites";u.preLoadSprites(s,function(){A();e="level loaded"},function(S){e=S})}}function Dragger(a){this.lastPos=null;this.xsp=0;this.ysp=0;this.lag=1;this.click=function(b){this.lastPos={x:b.x,y:b.y}};this.mouseUp=function(b){this.lastPos=null};this.mouseMove=function(b){if(!this.lastPos){return}this.xsp+=(this.lastPos.x-b.x)*0.4;this.ysp+=(this.lastPos.y-b.y)*0.4;this.xsp=(this.xsp>0?1:-1)*Math.min(Math.abs(this.xsp),30);this.ysp=(this.ysp>0?1:-1)*Math.min(Math.abs(this.ysp),30);this.lastPos={x:b.x,y:b.y}};this.tick=function(){a(this.xsp,this.ysp);if(this.xsp>0){this.xsp-=this.lag}else{this.xsp+=this.lag}if(this.ysp>0){this.ysp-=this.lag}else{this.ysp+=this.lag}if(Math.abs(this.xsp)<=this.lag){this.xsp=0}if(Math.abs(this.ysp)<=this.lag){this.ysp=0}}};