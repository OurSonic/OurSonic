function HeightMask(a,b){this.width=16;this.height=16;this.angle=a;this.items=b?b:[];HeightMask.prototype.setItem=function(f,g,e){var c=0,d=0;switch(e){case RotationMode.Floor:c=f;d=g;break;case RotationMode.RightWall:c=g;d=f;break;case RotationMode.Ceiling:c=f;d=15-g;break;case RotationMode.LeftWall:c=g;d=15-f;break;default:}this.items[c]=16-d};HeightMask.prototype.drawUI=function(e,h,j,l,n,p,k){if(k>0){for(var m=0;m<16;m++){for(var o=0;o<16;o++){var f=0,g=0;if(n){if(p){f=15-m;g=15-o}else{f=15-m;g=o}}else{if(p){f=m;g=15-o}else{f=m;g=o}}var c=h.x+(f*j.x);var d=h.y+(g*j.y);e.lineWidth=1;if(l<=0&&Math.abs(this.items[m])>=16-o&&k>0){e.fillStyle=HeightMask.colors[k];e.fillRect(c,d,j.x,j.y)}else{if(l!=-1){e.lineWidth=1;e.strokeStyle="#0C3146";e.strokeRect(c,d,j.x,j.y)}}}}}};HeightMask.prototype.draw=function(e,k,l,n,p,r,m){_H.save(e);var j={x:k.x,y:k.y};if(p){k.x=-k.x-16*l.x;e.scale(-1,1)}if(r){k.y=-k.y-16*l.y;e.scale(1,-1)}var f;if((f=sonicManager.SpriteCache.heightMaps[this.index])){if(f.loaded){e.drawImage(f,k.x,k.y)}}else{if(m>0){for(var o=0;o<16;o++){var g=0,h=0;var q=16-Math.abs(this.items[o]);g=o;h=q;var c=k.x+(g*l.x);var d=k.y+(h*l.y);e.lineWidth=1;e.fillStyle=HeightMask.colors[m];e.fillRect(c,d,l.x,l.y*this.items[o])}}}_H.restore(e);k.x=j.x;k.y=j.y}}HeightMask.colors=["rgba(24,98,235,0.6)","rgba(255,98,235,0.6)","rgba(24,218,235,0.6)","rgba(24,98,235,0.6)"];window._H={save:function(a){if(window.StateCount==undefined){window.StateCount=0}window.StateCount++;a.save()},restore:function(a){window.StateCount--;a.restore()},floor:function(a){if(a>0){return ~~a}return Math.floor(a)},min:function(a,b){return a>b?b:a},max:function(a,b){return a<b?b:a},xor:function(a,b){return(a&&!b)||(!a&&b)},loadSprite:function(c,a){var b=new Image();b.onload=function(){b.loaded=true;if(a){a(b)}};b.src=c;return b},fixAngle:function(a){var b=Math.floor((256-a)*1.4062)%360;var c=360-b;return _H.degtorad(c)},degtorad:function(a){return a*Math.PI/180},sign:function(a){return a==0?0:(a<0?-1:1)},defaultWindowLocation:function(c,a,b){switch(c){case 0:return{x:0,y:0,width:320,height:240,intersects:_H.intersects};case 1:var d=0;var e=0;if(sonicManager.SonicLevel&&sonicManager.SonicLevel.StartPositions&&sonicManager.SonicLevel.StartPositions[0]){d=sonicManager.SonicLevel.StartPositions[0].X*128*2;e=sonicManager.SonicLevel.StartPositions[0].Y-128*2}return{x:d,y:e,width:a.canvas.width/b.x,height:a.canvas.height/b.y,intersects:_H.intersects}}return null},ObjectParse:function(a){switch(a.ID){case 1:return new MonitorObject(a);break;case 2:return new CollisionSwitcherObject(a);break;case 7:return new SpringObject(a);break}return new LevelObject(a)},intersects:function(a){if(this.width==undefined||this.height==undefined||this.x==undefined||this.y==undefined||a.Y==undefined||a.X==undefined){alert("")}if(this.x<a.X&&this.x+this.width>a.X&&this.y<a.Y&&this.y+this.height>a.Y){return true}return false},intersects2:function(b,a){if(b.width==undefined||b.height==undefined||b.x==undefined||b.y==undefined||a.Y==undefined||a.X==undefined){alert("")}if(b.x<a.X&&b.x+b.width>a.X&&b.y<a.Y&&b.y+b.height>a.Y){return true}return false},defaultCanvas:function(d,c){var a=document.createElement("canvas");a.width=d;a.height=c;var b=a.getContext("2d");b.width=d;b.height=c;return{canvas:a,context:b}},intersectRect:function(a,b){return !(b.x>a.x+a.width||b.x+b.width<a.x||b.y>a.y+a.height||b.y+b.height<a.y)},remove:function(a,b){var c=-1;while((c=a.indexOf(b))>-1){a.splice(c,1)}},getShortsFromInt:function(a,b){var c=-1;while((c=a.indexOf(b))>-1){a.splice(c,1)}},scaleSprite:function(j,h,b){var e=_H.getImageData(j);var a=[];for(var g=0;g<e.length;g+=4){a.push(_H.colorObjectFromData(e,g))}var c=this.defaultCanvas().context.createImageData(j.width*h.x,j.height*h.y);_H.setDataFromColors(c.data,a,h,j.width,{r:0,g:0,b:0});return _H.loadSprite(_H.getBase64Image(c),b)},getCursorPosition:function(a,b){if(a.targetTouches&&a.targetTouches.length>0){a=a.targetTouches[0]}if(a.pageX!=null&&a.pageY!=null){return{x:a.pageX,y:a.pageY}}if(a.x!=null&&a.y!=null){return{x:a.x,y:a.y}}return{x:a.clientX,y:a.clientY}},colorFromData:function(j,h){var l=j[h];var k=j[h+1];var f=j[h+2];var e=l.toString(16);var d=k.toString(16);var a=f.toString(16);return"#"+(e.length==1?"0"+e:e)+(d.length==1?"0"+d:d)+(a.length==1?"0"+a:a)},colorObjectFromData:function(e,d){var h=e[d];var f=e[d+1];var a=e[d+2];return{r:h,g:f,b:a}},parseNumber:function(a){switch(a){case"0":return 0;case"1":return 1;case"2":return 2;case"3":return 3;case"4":return 4;case"5":return 5;case"6":return 6;case"7":return 7;case"8":return 8;case"9":return 9;case"a":return 10;case"b":return 11;case"c":return 12;case"d":return 13;case"e":return 14;case"f":return 15;case"g":return 16}return -1},setDataFromColors:function(f,b,p,r,q){for(var l=0;l<b.length;l++){var d=(l%r);var e=_H.floor(l/r);var h=b[l];var m=false;if(q){if(h.r==q.r&&h.g==q.g&&h.b==q.b){m=true}}for(var n=0;n<p.x;n++){for(var o=0;o<p.y;o++){var s=(d*p.x+n);var t=(e*p.y+o);var a=(s+t*(p.x*r))*4;if(m){f[a+0]=0;f[a+1]=0;f[a+2]=0;f[a+3]=0;continue}f[a]=h.r;f[a+1]=h.g;f[a+2]=h.b;f[a+3]=255}}}},getImageData:function(d){var a=document.createElement("canvas");a.width=d.width;a.height=d.height;var b=a.getContext("2d");b.drawImage(d,0,0);var c=b.getImageData(0,0,d.width,d.height);return c.data},getBase64Image:function(c){var a=document.createElement("canvas");a.width=c.width;a.height=c.height;var b=a.getContext("2d");b.putImageData(c,0,0);var d=a.toDataURL("image/png");return d},isFunction:function(a){var b={};return a&&b.toString.call(a)=="[object Function]"},detect:function(c,a){for(var b in c){if(typeof(c[b])=="object"){if(a[c[b]]){alert("circ")}a[c[b]]=true;this.detect(c[b],a)}}},stringify:function(e,b){return JSON.stringify(e,function(h,j){if(h=="imageData"){return undefined}if(h=="oldScale"){return undefined}if(h=="sprite"){return undefined}if(h=="sprites"){return undefined}if(h=="index"){return undefined}if(h=="_style"){return undefined}else{return j}});if(b>0){return""}if(!b){b=0}var f=typeof(e);if(f!="object"||e===null){if(f=="string"){e='"'+e+'"'}return String(e)}else{var d,g,c=[],a=(e&&e.constructor==Array);for(d in e){g=e[d];f=typeof(g);if(f=="string"){g='"'+g+'"'}else{if(f=="object"&&g!==null){g=stringify(g,b+1)}}c.push((a?"":'"'+d+'":')+String(g))}return(a?"[":"{")+String(c)+(a?"]":"}")}},sin:function(a){return cos_table[(a+64)&255]},cos:function(a){return cos_table[(a)&255]}};window.cos_table=[1,0.9997,0.9988,0.99729,0.99518,0.99248,0.98918,0.98528,0.9807900000000001,0.9757,0.97003,0.96378,0.95694,0.94953,0.94154,0.93299,0.92388,0.91421,0.90399,0.89322,0.88192,0.87009,0.85773,0.84485,0.83147,0.81758,0.80321,0.78835,0.77301,0.7572100000000001,0.74095,0.72425,0.70711,0.68954,0.6715600000000001,0.65317,0.63439,0.6152300000000001,0.5957,0.57581,0.55557,0.535,0.5141,0.4929,0.4714,0.44961,0.42755,0.40524,0.38268,0.3599,0.33689,0.31368,0.29028,0.26671,0.24298,0.2191,0.19509,0.17096,0.14673,0.12241,0.09802,0.07356,0.04907,0.02454,0,-0.02454,-0.04907,-0.07356,-0.09802,-0.12241,-0.14673,-0.17096,-0.19509,-0.2191,-0.24298,-0.26671,-0.29028,-0.31368,-0.33689,-0.3599,-0.38268,-0.40524,-0.42755,-0.44961,-0.4714,-0.4929,-0.5141,-0.535,-0.55557,-0.57581,-0.5957,-0.6152300000000001,-0.63439,-0.65317,-0.6715600000000001,-0.68954,-0.70711,-0.72425,-0.74095,-0.7572100000000001,-0.77301,-0.78835,-0.80321,-0.81758,-0.83147,-0.84485,-0.85773,-0.87009,-0.88192,-0.89322,-0.90399,-0.91421,-0.92388,-0.93299,-0.94154,-0.94953,-0.95694,-0.96378,-0.97003,-0.9757,-0.9807900000000001,-0.98528,-0.98918,-0.99248,-0.99518,-0.99729,-0.9988,-0.9997,-1,-0.9997,-0.9988,-0.99729,-0.99518,-0.99248,-0.98918,-0.98528,-0.9807900000000001,-0.9757,-0.97003,-0.96378,-0.95694,-0.94953,-0.94154,-0.93299,-0.92388,-0.91421,-0.90399,-0.89322,-0.88192,-0.87009,-0.85773,-0.84485,-0.83147,-0.81758,-0.80321,-0.78835,-0.77301,-0.7572100000000001,-0.74095,-0.72425,-0.70711,-0.68954,-0.6715600000000001,-0.65317,-0.63439,-0.6152300000000001,-0.5957,-0.57581,-0.55557,-0.535,-0.5141,-0.4929,-0.4714,-0.44961,-0.42756,-0.40524,-0.38268,-0.3599,-0.33689,-0.31368,-0.29028,-0.26671,-0.24298,-0.2191,-0.19509,-0.17096,-0.14673,-0.12241,-0.09802,-0.07356,-0.04907,-0.02454,-0,0.02454,0.04907,0.07356,0.09802,0.12241,0.14673,0.17096,0.19509,0.2191,0.24298,0.26671,0.29028,0.31368,0.33689,0.3599,0.38268,0.40524,0.42756,0.44961,0.4714,0.4929,0.5141,0.535,0.55557,0.57581,0.5957,0.6152300000000001,0.63439,0.65317,0.6715600000000001,0.68954,0.70711,0.72425,0.74095,0.7572100000000001,0.77301,0.78835,0.80321,0.81758,0.83147,0.84485,0.85773,0.87009,0.88192,0.89322,0.90399,0.91421,0.92388,0.93299,0.94154,0.94953,0.95694,0.96378,0.97003,0.9757,0.9807900000000001,0.98528,0.98918,0.99248,0.99518,0.99729,0.9988,0.9997];var base64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");var base64inv={};for(var i=0;i<base64chars.length;i++){base64inv[base64chars[i]]=i}window.decodeNumeric=function(f){f=f.replace(new RegExp("[^"+base64chars.join("")+"=]","g"),"");var d=(f.charAt(f.length-1)=="="?(f.charAt(f.length-2)=="="?"AA":"A"):"");var e=[];f=f.substr(0,f.length-d.length)+d;for(var a=0;a<f.length;a+=4){var b=(base64inv[f.charAt(a)]<<18)+(base64inv[f.charAt(a+1)]<<12)+(base64inv[f.charAt(a+2)]<<6)+base64inv[f.charAt(a+3)];e.push((b>>>16)&255);e.push((b>>>8)&255);e.push(b&255)}return e.slice(0,e.length-1)};window.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(j){var k="";var a,b,c,d,e,f,g;var h=0;j=Base64._utf8_encode(j);while(h<j.length){a=j.charCodeAt(h++);b=j.charCodeAt(h++);c=j.charCodeAt(h++);d=a>>2;e=((a&3)<<4)|(b>>4);f=((b&15)<<2)|(c>>6);g=c&63;if(isNaN(b)){f=g=64}else{if(isNaN(c)){g=64}}k=k+this._keyStr.charAt(d)+this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)}return k},decode:function(j){var k="";var a,b,c;var d,e,f,g;var h=0;j=j.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(h<j.length){d=this._keyStr.indexOf(j.charAt(h++));e=this._keyStr.indexOf(j.charAt(h++));f=this._keyStr.indexOf(j.charAt(h++));g=this._keyStr.indexOf(j.charAt(h++));a=(d<<2)|(e>>4);b=((e&15)<<4)|(f>>2);c=((f&3)<<6)|g;k=k+String.fromCharCode(a);if(f!=64){k=k+String.fromCharCode(b)}if(g!=64){k=k+String.fromCharCode(c)}}k=Base64._utf8_decode(k);return k},_utf8_encode:function(d){d=d.replace(/\r\n/g,"\n");var e="";for(var b=0;b<d.length;b++){var a=d.charCodeAt(b);if(a<128){e+=String.fromCharCode(a)}else{if((a>127)&&(a<2048)){e+=String.fromCharCode((a>>6)|192);e+=String.fromCharCode((a&63)|128)}else{e+=String.fromCharCode((a>>12)|224);e+=String.fromCharCode(((a>>6)&63)|128);e+=String.fromCharCode((a&63)|128)}}}return e},_utf8_decode:function(e){var d="";var b=0;var a=c1=c2=0;while(b<e.length){a=e.charCodeAt(b);if(a<128){d+=String.fromCharCode(a);b++}else{if((a>191)&&(a<224)){c2=e.charCodeAt(b+1);d+=String.fromCharCode(((a&31)<<6)|(c2&63));b+=2}else{c2=e.charCodeAt(b+1);c3=e.charCodeAt(b+2);d+=String.fromCharCode(((a&15)<<12)|((c2&63)<<6)|(c3&63));b+=3}}}return d}};function OutStream(){this.bytestream=new Array();this.offset=0;this.WriteBit=function(a){this.bytestream[this.offset>>>3]|=a<<(this.offset&7);this.offset++};this.Write=function(c,b){for(var a=0;a<b;++a){this.WriteBit((c>>>a)&1)}}}function InStream(b,a){this.bytestream=b;this.bitcount=a;this.offset=0;this.ReadBit=function(){var c=this.bytestream[this.offset>>>3]>>(this.offset&7);this.offset++;return c&1};this.Read=function(d){if((this.offset+d)>this.bitcount){return null}var e=0;for(var c=0;c<d;++c){e|=this.ReadBit()<<c}return e}}function LZWCompressor(a){this.output=a;this.CompressDictionary=function(){this.hashtable=new Object();this.nextcode=0;for(var b=0;b<256;++b){var c=String.fromCharCode(b);this.hashtable[c]=this.nextcode++}this.Exists=function(d){return(this.hashtable.hasOwnProperty(d))};this.Insert=function(e){var d=this.ValSizeInBits();this.hashtable[e]=this.nextcode++;return d};this.Lookup=function(d){return(this.hashtable[d])};this.ValSizeInBits=function(){var d=Math.log(this.nextcode+1)/Math.LN2;return Math.ceil(d)}};this.compress=function(h){var f=h.length;if(f==0){return output.bytestream}var d=new this.CompressDictionary();var g=d.ValSizeInBits();var j="";for(var e=0;e<f;++e){var b=h.charAt(e);if(d.Exists(j+b)){j=j+b}else{g=d.Insert(j+b);this.output.Write(d.Lookup(j),g);j=b}}this.output.Write(d.Lookup(j),g)}}function LZWDecompressor(a){this.input=a;this.DecompressDictionary=function(){this.revhashtable=new Array();this.nextcode=0;for(var b=0;b<256;++b){this.revhashtable[this.nextcode++]=String.fromCharCode(b)}this.numBits=9;this.Size=function(){return(this.nextcode)};this.Insert=function(d){this.revhashtable[this.nextcode++]=d;var c=Math.log(this.nextcode+2)/Math.LN2;this.numBits=Math.ceil(c);return this.numBits};this.LookupIndex=function(c){return this.revhashtable[c]};this.ValSizeInBits=function(){return this.numBits}};this.decompress=function(c,b){if(b==0){return""}var d=new this.DecompressDictionary();var g=d.ValSizeInBits();var f=this.input.Read(g);var h=String.fromCharCode(f);var j=h;var e="";while((f=this.input.Read(g))!=null){if(f<d.Size()){e=d.LookupIndex(f)}else{e=j+j.charAt(0)}h+=e;g=d.Insert(j+e.charAt(0));j=e}return h}}var broken=_H.loadSprite("assets/Sprites/broken.png");function LevelObject(a){this.ObjectData=a;this.sprites=[];this.Width=30;this.Height=30;LevelObject.prototype.getRect=function(){var d=this.ObjectData.X-monitor.width/2;var e=this.ObjectData.Y-monitor.height/2;var c=this.Width;var b=this.Height;return{x:d,y:e,width:c,height:b}};LevelObject.prototype.collide=function(){};LevelObject.prototype.draw=function(b,c,d){if(this.sprites[0]&&this.sprites[0].loaded){b.drawImage(this.sprites[0],(c.x-this.sprites[0].width/2)*d.x,(c.y-this.sprites[0].height/2)*d.y,this.sprites[0].width*d.x,this.sprites[0].height*d.y)}else{b.drawImage(broken,(c.x-broken.width/2)*d.x,(c.y-broken.height/2)*d.y,broken.width*d.x,broken.height*d.y)}}}var monitor=_H.loadSprite("assets/Sprites/monitorEmpty.png");var monitorBroken=_H.loadSprite("assets/Sprites/monitorBroken.png");function CollisionSwitcherObject(a){this.ObjectData=a;this.sprites=[];this.Width=10;this.Height=70;CollisionSwitcherObject.prototype.getRect=function(){var b=this.ObjectData.X-this.Width/2;var c=this.ObjectData.Y-this.Height/2;return{x:b,y:c,width:this.Width,height:this.Height}};CollisionSwitcherObject.prototype.collide=function(){if(sonicManager.sonicToon.xsp>0){sonicManager.SonicLevel.curHeightMap=true}else{sonicManager.SonicLevel.curHeightMap=false}};CollisionSwitcherObject.prototype.draw=function(b,c,d){}}function MonitorObject(b){this.ObjectData=b;this.sprites=[];var a="assets/Sprites/monitor";switch(this.ObjectData.SubType){case 1:this.sprites.push(_H.loadSprite(a+"SonicOneUp.png"));break;case 2:this.sprites.push(_H.loadSprite(a+"Death.png"));break;case 3:this.sprites.push(_H.loadSprite(a+"Ring.png"));break;case 4:this.sprites.push(_H.loadSprite(a+"SpeedShoe.png"));break;case 5:this.sprites.push(_H.loadSprite(a+"Flame.png"));break;case 6:this.sprites.push(_H.loadSprite(a+"Electric.png"));break;case 7:this.sprites.push(_H.loadSprite(a+"Bubble.png"));break;case 8:this.sprites.push(_H.loadSprite(a+"Stars.png"));break}MonitorObject.prototype.getRect=function(){var c=this.ObjectData.X-monitor.width/2;var d=this.ObjectData.Y-monitor.height/2;return{x:c,y:d,width:monitor.width,height:monitor.height}};MonitorObject.prototype.collide=function(){if(sonicManager.sonicToon.ysp==0){sonicManager.sonicToon.gsp=0;sonicManager.sonicToon.xsp=0;return}if(this.ObjectData.SubType==10){return}switch(this.ObjectData.SubType){case 1:sonicManager.sonicToon.Lives=1;break;case 2:sonicManager.sonicToon.hit();break;case 3:sonicManager.sonicToon.rings+=10;break;case 4:sonicManager.sonicToon.rings+=20;break;case 5:sonicManager.sonicToon.rings+=30;break;case 6:sonicManager.sonicToon.rings+=40;break;case 7:sonicManager.sonicToon.rings+=50;break;case 8:sonicManager.sonicToon.rings+=60;break}if(sonicManager.sonicToon.ysp>0){sonicManager.sonicToon.ysp*=-1}else{sonicManager.sonicToon.ysp*=1}this.ObjectData.SubType=10};MonitorObject.prototype.draw=function(c,d,e){if(this.sprites[0]&&this.sprites[0].loaded){if(this.ObjectData.SubType==10){c.drawImage(monitorBroken,(d.x-monitorBroken.width/2)*e.x,(d.y)*e.y,monitorBroken.width*e.x,monitorBroken.height*e.y)}else{c.drawImage(monitor,(d.x-monitor.width/2)*e.x,(d.y-monitor.height/2)*e.y,monitor.width*e.x,monitor.height*e.y);if(sonicManager.sonicToon){if(!(sonicManager.drawTickCount%6==0||sonicManager.drawTickCount%6==1)){c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}else{c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}}}}function SpringObject(b){this.ObjectData=b;this.sprites=[];var a="assets/Sprites/monitor";switch(this.ObjectData.SubType){case 1:this.sprites.push(_H.loadSprite(a+"SonicOneUp.png"));break;case 2:this.sprites.push(_H.loadSprite(a+"Death.png"));break;case 3:this.sprites.push(_H.loadSprite(a+"Ring.png"));break;case 4:this.sprites.push(_H.loadSprite(a+"SpeedShoe.png"));break;case 5:this.sprites.push(_H.loadSprite(a+"Flame.png"));break;case 6:this.sprites.push(_H.loadSprite(a+"Electric.png"));break;case 7:this.sprites.push(_H.loadSprite(a+"Bubble.png"));break;case 8:this.sprites.push(_H.loadSprite(a+"Stars.png"));break}SpringObject.prototype.getRect=function(){var c=this.ObjectData.X-monitor.width/2;var d=this.ObjectData.Y-monitor.height/2;return{x:c,y:d,width:monitor.width,height:monitor.height}};SpringObject.prototype.collide=function(){if(sonicManager.sonicToon.ysp==0){sonicManager.sonicToon.gsp=0;sonicManager.sonicToon.xsp=0;return}if(this.ObjectData.SubType==10){return}switch(this.ObjectData.SubType){case 1:sonicManager.sonicToon.Lives=1;break;case 2:sonicManager.sonicToon.hit();break;case 3:sonicManager.sonicToon.rings+=10;break;case 4:sonicManager.sonicToon.rings+=20;break;case 5:sonicManager.sonicToon.rings+=30;break;case 6:sonicManager.sonicToon.rings+=40;break;case 7:sonicManager.sonicToon.rings+=50;break;case 8:sonicManager.sonicToon.rings+=60;break}if(sonicManager.sonicToon.ysp>0){sonicManager.sonicToon.ysp*=-1}else{sonicManager.sonicToon.ysp*=1}this.ObjectData.SubType=10};SpringObject.prototype.draw=function(c,d,e){if(this.sprites[0]&&this.sprites[0].loaded){if(this.ObjectData.SubType==10){c.drawImage(monitorBroken,(d.x-monitorBroken.width/2)*e.x,(d.y)*e.y,monitorBroken.width*e.x,monitorBroken.height*e.y)}else{c.drawImage(monitor,(d.x-monitor.width/2)*e.x,(d.y-monitor.height/2)*e.y,monitor.width*e.x,monitor.height*e.y);if(sonicManager.sonicToon){if(!(sonicManager.drawTickCount%6==0||sonicManager.drawTickCount%6==1)){c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}else{c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}}}}(function(){JSLINQ=window.JSLINQ=function(a){return new JSLINQ.fn.init(a)};JSLINQ.fn=JSLINQ.prototype={init:function(a){this.items=a},jslinq:"2.10",ToArray:function(){return this.items},Where:function(a){var c;var d=new Array();for(var b=0;b<this.items.length;b++){if(a(this.items[b],b)){d[d.length]=this.items[b]}}return new JSLINQ(d)},Select:function(a){var c;var d=new Array();for(var b=0;b<this.items.length;b++){if(a(this.items[b])){d[d.length]=a(this.items[b])}}return new JSLINQ(d)},OrderBy:function(a){var c=new Array();for(var b=0;b<this.items.length;b++){c[c.length]=this.items[b]}return new JSLINQ(c.sort(function(d,e){var f=a(d);var g=a(e);return((f<g)?-1:((f>g)?1:0))}))},OrderByDescending:function(a){var c=new Array();for(var b=0;b<this.items.length;b++){c[c.length]=this.items[b]}return new JSLINQ(c.sort(function(d,e){var f=a(e);var g=a(d);return((f<g)?-1:((f>g)?1:0))}))},SelectMany:function(a){var c=new Array();for(var b=0;b<this.items.length;b++){c=c.concat(a(this.items[b]))}return new JSLINQ(c)},Count:function(a){if(a==null){return this.items.length}else{return this.Where(a).items.length}},Distinct:function(a){var d;var b=new Object();var e=new Array();for(var c=0;c<this.items.length;c++){d=a(this.items[c]);if(b[d]==null){b[d]=true;e[e.length]=d}}b=null;return new JSLINQ(e)},Any:function(a){for(var b=0;b<this.items.length;b++){if(a(this.items[b],b)){return true}}return false},All:function(a){for(var b=0;b<this.items.length;b++){if(!a(this.items[b],b)){return false}}return true},Reverse:function(){var b=new Array();for(var a=this.items.length-1;a>-1;a--){b[b.length]=this.items[a]}return new JSLINQ(b)},First:function(a){if(a!=null){return this.Where(a).First()}else{if(this.items.length>0){return this.items[0]}else{return null}}},Last:function(a){if(a!=null){return this.Where(a).Last()}else{if(this.items.length>0){return this.items[this.items.length-1]}else{return null}}},ElementAt:function(a){return this.items[a]},Concat:function(b){var a=b.items||b;return new JSLINQ(this.items.concat(a))},Intersect:function(j,e){var f;if(e!=undefined){f=e}else{f=function(k,a,l,b){return k==l}}var h=j.items||j;var g=new Array();for(var c=0;c<this.items.length;c++){for(var d=0;d<h.length;d++){if(f(this.items[c],c,h[d],d)){g[g.length]=this.items[c]}}}return new JSLINQ(g)},DefaultIfEmpty:function(a){if(this.items.length==0){return a}return this},ElementAtOrDefault:function(b,a){if(b>=0&&b<this.items.length){return this.items[b]}return a},FirstOrDefault:function(a){return this.First()||a},LastOrDefault:function(a){return this.Last()||a}};JSLINQ.fn.init.prototype=JSLINQ.fn})();jQuery.fn.rotate=function(a,h){var e=this.get(0);if(!h){e.angle=((e.angle==undefined?0:e.angle)+a)%360}else{e.angle=a}if(e.angle>=0){var f=Math.PI*e.angle/180}else{var f=Math.PI*(360+e.angle)/180}var d=Math.cos(f);var g=Math.sin(f);if(document.all&&!window.opera){var b=document.createElement("img");b.src=e.src;b.height=e.height;b.width=e.width;b.style.filter="progid:DXImageTransform.Microsoft.Matrix(M11="+d+",M12="+(-g)+",M21="+g+",M22="+d+",SizingMethod='auto expand')"}else{var b=document.createElement("canvas");if(!e.oImage){b.oImage=new Image();b.oImage.src=e.src}else{b.oImage=e.oImage}b.style.width=b.width=Math.abs(d*b.oImage.width)+Math.abs(g*b.oImage.height);b.style.height=b.height=Math.abs(d*b.oImage.height)+Math.abs(g*b.oImage.width);var c=b.getContext("2d");_H.save(c);if(f<=Math.PI/2){c.translate(g*b.oImage.height,0)}else{if(f<=Math.PI){c.translate(b.width,-d*b.oImage.height)}else{if(f<=1.5*Math.PI){c.translate(-d*b.oImage.width,b.height)}else{c.translate(0,-g*b.oImage.width)}}}c.rotate(f);c.drawImage(b.oImage,0,0,b.oImage.width,b.oImage.height);_H.restore(c)}b.id=e.id;b.angle=e.angle;e.parentNode.replaceChild(b,e)};jQuery.fn.rotateRight=function(a){this.rotate(a==undefined?90:a)};jQuery.fn.rotateLeft=function(a){this.rotate(a==undefined?-90:-a)};function ParallaxBG(a,c){var d=this;var b=a;ParallaxBG.prototype.click=function(e,f){this.slots[f].rotateSpeed=e/this.width*2};ParallaxBG.prototype.onBar=function(j,k){var h=3*c.x;var e=this.slots[k].rotateSpeed;if(j>((this.width*e/2)-h)&&j<((this.width*e/2)+h)){var g={top:0,bottom:0};for(var f=k-1;f>=0;f--){if(this.slots[f].rotateSpeed!=e){g.top=f;break}}for(var f=k+1;f<this.height;f++){if(this.slots[f].rotateSpeed!=e){g.bottom=f;break}}return g}return null};ParallaxBG.prototype.cache=function(n){var p=(this.width*n.x);var f=sonicManager.windowLocation.height*n.y;var o=[];var e=_H.defaultCanvas();var k=this.slots[0].rotateSpeed;var j=0;var m={x:0,y:0};for(var g=0;g<this.slots.length;g++){if(k!=this.slots[g].rotateSpeed){k=this.slots[g].rotateSpeed;o[j]=(_H.loadSprite(e.canvas.toDataURL("image/png")));e=_H.defaultCanvas();j=g}var l={x:m.x,y:m.y+(g-j)*n.y};this.slots[g].draw(e.context,l,n)}o[j]=(_H.loadSprite(e.canvas.toDataURL("image/png")));this.sprites=o};ParallaxBG.prototype.init=function(m){var n=this.width;var e=this.height;this.slots=[];this.slots.length=e;for(var o=0;o<e;o++){this.slots[o]=new ParallaxBGSlot()}var k=_H.defaultCanvas(n,e);var g=_H.defaultCanvas(n,1);k.context.drawImage(this.sprite,0,0);for(var f=0;f<e;f++){var l=k.context.getImageData(0,f,n,1);g.context.putImageData(l,0,0);this.slots[f].sprite=(_H.loadSprite(g.canvas.toDataURL("image/png")))}for(var o=0;o<e;o++){this.slots[o].load(m)}};ParallaxBG.prototype.drawUI=function(e,j,l){if(this.sprite&&this.sprite.loaded){e.drawImage(this.sprite,j.x,j.y)}if(this.slots){var g=this.slots[0].rotateSpeed;var h=0;for(var f=0;f<this.slots.length;f++){if(g==this.slots[f].rotateSpeed){continue}var k=Math.floor(255/2/g);e.fillStyle="rgba("+k+",57,43,0.4)";e.fillRect(j.x,j.y+h*l.y,this.width*l.x,l.y*(f-h));e.strokeStyle="rgba("+k+",57,43,1)";e.lineWidth=3;e.strokeRect(j.x,j.y+h*l.y,this.width*l.x,l.y*(f-h));var m=3*l.x;e.fillRect(j.x+(this.width*g/2)-m,j.y+h*l.y,m*2,l.y*(f-h));h=f;g=this.slots[f].rotateSpeed}var k=Math.floor(255/2/g);e.fillStyle="rgba("+k+",57,43,0.4)";e.fillRect(j.x,j.y+h*l.y,this.width*l.x,l.y*(f-h));e.strokeStyle="rgba("+k+",57,43,1)";e.lineWidth=3;e.strokeRect(j.x,j.y+h*l.y,this.width*l.x,l.y*(f-h));var m=3*l.x;e.fillStyle="rgba("+k+",57,43,1)";e.fillRect(j.x+(this.width*g/2)-m,j.y+h*l.y,m*2,l.y*(f-h))}};ParallaxBG.prototype.draw=function(e,l,m,j){var n=(this.width*m.x);var f=sonicManager.windowLocation.height*m.y;for(var g in this.sprites){var k={x:l.x+(Math.floor(j*this.slots[g].rotateSpeed)),y:l.y+g*m.y};if(k.y>sonicManager.windowLocation.y*m.y||k.y<f+sonicManager.windowLocation.y*m.y){if(k.x>sonicManager.windowLocation.width||k.x+n<0){continue}if(this.sprite&&this.sprite.loaded){e.drawImage(this.sprite,k.x,k.y,this.sprite.width,this.sprite.height)}}}};d.width=b.width;d.height=b.height;d.sprite=b;d.sprite.loaded=true;d.init(c)}function ParallaxBGSlot(){this.sprite=null;this.rotateSpeed=1;ParallaxBGSlot.prototype.draw=function(a,b,c){if(this.sprite&&this.sprite.loaded){a.drawImage(this.sprite,b.x,b.y,this.sprite.width,this.sprite.height)}};ParallaxBGSlot.prototype.drawUI=function(a,b,c){if(this.sprite&&this.sprite.loaded){a.drawImage(this.sprite,b.x,b.y,this.sprite.width,this.sprite.height)}};ParallaxBGSlot.prototype.load=function(a){}}function Ring(a){this.active=a;this.animationIndex=0;this.x=0;this.y=0;this.xsp=0;this.ysp=0;this.tickCount=0;this.draw=function(b,c,d){if(a){this.ysp+=0.09375;this.x+=this.xsp;this.y+=this.ysp;if(this.x<sonicManager.windowLocation.x||this.y<sonicManager.windowLocation.y||this.x>sonicManager.windowLocation.x+sonicManager.windowLocation.width||this.y>sonicManager.windowLocation.y+sonicManager.windowLocation.height){this.tickCount=4294967295;return false}if(sonicManager.sonicToon.checkCollisionLine(_H.floor(this.x)+8,_H.floor(this.y)+8,16,1)!=-1){this.ysp*=-0.75}if(sonicManager.sonicToon.checkCollisionLine(_H.floor(this.x)-8,_H.floor(this.y)+8,26,0)!=-1){this.xsp*=-0.75}if(sonicManager.drawTickCount>sonicManager.sonicToon.sonicLastHitTick+64&&_H.intersectRect(sonicManager.sonicToon.myRec,{x:this.x-8*d.x,width:8*2*d.x,y:this.y-8*d.y,height:2*8*d.y})){this.tickCount=4294967295;sonicManager.sonicToon.rings++;return false}this.tickCount++}if(sonicManager.sonicToon){this.animationIndex=_H.floor((sonicManager.drawTickCount%((a?4:8)*4))/(a?4:8))}else{this.animationIndex=0}var e;if(sonicManager.SpriteCache.rings){e=sonicManager.SpriteCache.rings}else{return}var f=e[this.animationIndex*200+d.y*100+d.x];if(!f){return}if(f.loaded){b.drawImage(f,_H.floor((c.x-8)*d.x),_H.floor((c.y-8)*d.y))}else{return false}}}function Sonic(d,c){this.x=d.StartPositions[0].X;this.y=d.StartPositions[0].Y;this.obtainedRing=[];this.rings=0;this.debugging=false;this.jumping=false;this.crouching=false;this.holdingLeft=false;this.holdingRight=false;this.holdingUp=false;this.LevelWidth=0;this.xsp=0;this.ysp=0;this.sonicLastHitTick=0;this.sonicJustHitTick=0;this.acc=0.046875;this.dec=0.5;this.frc=0.046875;this.gsp=0;this.rdec=0.125;this.rfrc=0.0234375;this.runningTick=0;this.slp=0.125;this.slpRollingUp=0.078125;this.slpRollingDown=0.3125;this.jmp=-6.5;this.grv=0.21875;this.air=0.09375;this.sonicLevel=d;this.inAir=false;this.wasInAir=false;this.holdingJump=false;this.haltSmoke=[];this.sensorManager=new SensorManager(sonicManager);this.hlock=0;this.mode=RotationMode.Floor;this.facing=true;this.ticking=false;this.breaking=0;this.ducking=false;this.spinDash=false;this.myRec={};this.spinDashSpeed=0;this.angle=255;var b;this.sensorManager.createVerticalSensor("a",-9,0,36,"#F202F2");this.sensorManager.createVerticalSensor("b",9,0,36,"#02C2F2");this.sensorManager.createVerticalSensor("c",-9,0,-20,"#2D2C21");this.sensorManager.createVerticalSensor("d",9,0,-20,"#C242822");this.sensorManager.createHorizontalSensor("m1",4,0,-12,"#212C2E");this.sensorManager.createHorizontalSensor("m2",4,0,12,"#22Ffc1");this.updateMode=function(){if(this.angle==240){this.angle=15}if(this.angle<32||this.angle>222){this.mode=RotationMode.Floor}else{if(this.angle>=32&&this.angle<86){this.mode=RotationMode.LeftWall}else{if(this.angle>=86&&this.angle<161){this.mode=RotationMode.Ceiling}else{if(this.angle>161&&this.angle<222){this.mode=RotationMode.RightWall}}}}this.myRec={x:this.x-5,width:5*2,y:this.y-20,height:20*2}};this.effectPhysics=function(){var f=6;if(!this.jumping){if(!this.inAir&&this.wasJumping){this.wasJumping=false}}if(this.inAir&&!this.wasInAir){this.wasInAir=true;if((this.angle>=112&&this.angle<=144)){this.xsp=this.gsp}}if(!this.inAir&&this.wasInAir){this.wasInAir=false;if((this.angle>=240||this.angle<=15)){this.gsp=this.xsp}else{if((this.angle>=224&&this.angle<=239)||(this.angle>=16&&this.angle<=31)){this.gsp=this.ysp}else{if((this.angle>=192&&this.angle<=223)){this.gsp=-this.ysp}else{if((this.angle>=32&&this.angle<=63)){this.gsp=this.ysp}}}}this.xsp=0;this.ysp=0}if(!this.inAir&&!this.rolling){if(!this.holdingLeft&&!this.holdingRight){this.gsp-=Math.min(Math.abs(this.gsp),this.frc)*(this.gsp>0?1:-1)}b=_H.sign(this.gsp);this.gsp+=this.slp*-_H.sin(this.angle);if(b!=_H.sign(this.gsp)&&b!=0){this.hlock=30}if(this.holdingRight&&!this.holdingLeft){this.facing=true;if(this.gsp>=0){this.gsp+=this.acc;if(this.gsp>f){this.gsp=f}}else{this.gsp+=this.dec;if(Math.abs(this.gsp)>4.5){this.facing=false;this.breaking=1;this.runningTick=0}}}if(this.holdingLeft&&!this.holdingRight){this.facing=false;if(this.gsp<=0){this.gsp-=this.acc;if(this.gsp<-f){this.gsp=-f}}else{this.gsp-=this.dec;if(Math.abs(this.gsp)>4.5){this.facing=true;this.breaking=-1;this.runningTick=0}}}}this.ducking=false;if(this.crouching){if(Math.abs(this.gsp)>1.03125){this.rolling=true;this.currentlyBall=true}else{this.ducking=true}}else{if(this.spinDash){this.gsp=(8+_H.floor(this.spinDashSpeed)/2)*(this.facing?1:-1);this.spinDash=false;this.rolling=true;this.currentlyBall=true}}if(!this.inAir&&this.rolling){if(this.holdingLeft){if(this.gsp>0){if(this.rolling){this.gsp=_H.max(0,this.gsp-this.rdec)}}}if(this.holdingRight){if(this.gsp<0){if(this.rolling){this.gsp=_H.min(0,this.gsp+this.rdec)}}}this.gsp-=Math.min(Math.abs(this.gsp),this.rfrc)*(this.gsp>0?1:-1);b=_H.sign(this.gsp);var e=_H.sin(this.angle);if((e>0)==(this.gsp>0)){this.gsp+=-this.slpRollingUp*e}else{this.gsp+=-this.slpRollingDown*e}if(b!=_H.sign(this.gsp)&&b!=0){this.hlock=30}if(Math.abs(this.gsp)<0.53125){this.rolling=false;this.currentlyBall=false}}if(!this.inAir){this.xsp=this.gsp*_H.cos(this.angle);this.ysp=this.gsp*-_H.sin(this.angle);if(Math.abs(this.gsp)<2.5&&this.mode!=RotationMode.Floor){if(this.mode==RotationMode.RightWall){this.x-=0}else{if(this.mode==RotationMode.LeftWall){this.x+=0}else{if(this.mode==RotationMode.Ceiling){this.y+=20}}}this.mode=RotationMode.Floor;this.angle=255;this.updateMode();this.hlock=30}}if(this.inAir){if(this.holdingRight&&!this.holdingLeft){this.facing=true;if(this.xsp>=0){this.xsp+=this.air;if(this.xsp>f){this.xsp=f}}else{this.xsp+=this.air}}if(this.holdingLeft&&!this.holdingRight){this.facing=false;if(this.xsp<=0){this.xsp-=this.air;if(this.xsp<-f){this.xsp=-f}}else{this.xsp-=this.air}}if(this.wasInAir){if(this.jumping){}else{}}this.ysp+=this.justHit?0.1875:this.grv;if(this.ysp<0&&this.ysp>-4){if(Math.abs(this.xsp)>0.125){this.xsp*=0.96875}}if(this.ysp>16){this.ysp=16}}if(this.wasInAir&&this.jumping){}else{if(this.jumping&&!this.wasJumping){this.wasJumping=true;if(this.ducking){this.spinDash=true;this.spinDashSpeed+=2;if(this.spinDashSpeed>8){this.spinDashSpeed=8}this.spriteState="spindash0"}else{this.inAir=true;this.currentlyBall=true;this.xsp=this.jmp*_H.sin(this.angle)+this.gsp*_H.cos(this.angle);this.ysp=this.jmp*_H.cos(this.angle)}}}if(this.xsp>0&&this.xsp<0.008){this.gsp=0;this.xsp=0}if(this.xsp<0&&this.xsp>-0.008){this.gsp=0;this.xsp=0}this.x+=this.xsp;this.y+=this.ysp};this.tick=function(){if(this.debugging){var g=15;if(this.holdingRight){this.x+=g}if(this.holdingLeft){this.x-=g}if(this.crouching){this.y+=g}if(this.holdingUp){this.y-=g}return}this.updateMode();if(this.hlock>0){this.hlock--;this.holdingRight=false;this.holdingLeft=false}if(this.inAir){this.angle=255;this.mode=RotationMode.Floor}this.effectPhysics();this.updateSprite();var h=_H.floor(this.x);var j=_H.floor(this.y);this.sensorManager.check(this);var o=this.sensorManager.getResult("m1");var p=this.sensorManager.getResult("m2");switch(this.mode){case RotationMode.Floor:if(o!=-1){this.x=h=o.value+12;this.gsp=0;if(this.inAir){this.xsp=0}}if(p!=-1){this.x=h=p.value-12;this.gsp=0;if(this.inAir){this.xsp=0}}break;case RotationMode.LeftWall:if(o!=-1){this.y=j=o.value-12;if(this.inAir){this.xsp=0}}if(p!=-1){this.y=j=p.value+12;this.gsp=0;if(this.inAir){this.xsp=0}}break;case RotationMode.Ceiling:if(o!=-1){this.x=h=o.value+12;this.gsp=0;if(this.inAir){this.xsp=0}}if(p!=-1){this.x=h=p.value-12;this.gsp=0;if(this.inAir){this.xsp=0}}break;case RotationMode.RightWall:if(o!=-1){this.y=j=o.value-12;this.gsp=0;if(this.inAir){this.xsp=0}}if(p!=-1){this.y=j=p.value+12;this.gsp=0;if(this.inAir){this.xsp=0}}break}this.sensorManager.check(this);var k=this.sensorManager.getResult("a");var l=this.sensorManager.getResult("b");this.checkCollisionWithRing();this.checkCollisionWithObjects();if(!this.inAir){if(k==-1&&l==-1){this.inAir=true}else{this.justHit=false;switch(this.mode){case RotationMode.Floor:if(k.value>=0&&l.value>=0){if(k.value<l.value){k.chosen=true;this.angle=k.angle;this.y=j=k.value-20}else{l.chosen=true;this.angle=l.angle;this.y=j=l.value-20}}else{if(k.value>-1){k.chosen=true;this.angle=k.angle;this.y=j=k.value-20}else{if(l.value>-1){l.chosen=true;this.angle=l.angle;this.y=j=l.value-20}}}break;case RotationMode.LeftWall:if(k.value>=0&&l.value>=0){if(k.value>l.value){k.chosen=true;this.angle=k.angle;this.x=h=k.value+20}else{l.chosen=true;this.angle=l.angle;this.x=h=l.value+20}}else{if(k.value>-1){k.chosen=true;this.angle=k.angle;this.x=h=k.value+20}else{if(l.value>-1){l.chosen=true;this.angle=l.angle;this.x=h=l.value+20}}}break;case RotationMode.Ceiling:if(k.value>=0&&l.value>=0){if(k.value>l.value){k.chosen=true;this.angle=k.angle;this.y=j=k.value+20}else{l.chosen=true;this.angle=l.angle;this.y=j=l.value+20}}else{if(k.value>-1){k.chosen=true;this.angle=k.angle;this.y=j=k.value+20}else{if(l.value>-1){l.chosen=true;this.angle=l.angle;this.y=j=l.value+20}}}break;case RotationMode.RightWall:if(k.value>=0&&l.value>=0){if(k.value<l.value){k.chosen=true;this.angle=k.angle;this.x=h=k.value-20}else{l.chosen=true;this.angle=l.angle;this.x=h=l.value-20}}else{if(k.value>-1){k.chosen=true;this.angle=k.angle;this.x=h=k.value-20}else{if(l.value>-1){l.chosen=true;this.angle=l.angle;this.x=h=l.value-20}}}break}}this.updateMode()}else{if(k==-1&&l==-1){this.inAir=true}else{if(k.value>=0&&l.value>=0){if(k.value<l.value){if(this.y+(20)>=k.value){this.angle=k.angle;this.y=j=k.value-20;this.rolling=this.currentlyBall=false;this.inAir=false}}else{if(l.value>-1){if(this.y+(20)>=l.value){this.angle=l.angle;this.y=j=l.value-20;this.rolling=this.currentlyBall=false;this.inAir=false}}}}else{if(k.value>-1){if(this.y+(20)>=k.value){this.angle=k.angle;this.y=j=k.value-20;this.rolling=this.currentlyBall=false;this.inAir=false}}else{if(l.value>-1){if(this.y+(20)>=l.value){this.angle=l.angle;this.y=j=l.value-20;this.rolling=this.currentlyBall=false;this.inAir=false}}}}}this.updateMode();var f=sonicManager.SpriteCache.sonicSprites[this.spriteState+c.x+c.y];var e=f.height/c.y/2;this.sensorManager.check(this);var m=this.sensorManager.getResult("c");var n=this.sensorManager.getResult("d");if((m==-1&&n==-1)){}else{if(m.value>=0&&n.value>=0){this.angle=m.angle;if(m.value<n.value){if(this.y+(e)>=m.value){if(this.ysp<0){this.angle=m.angle;this.y=j=m.value+e;this.ysp=0}}}else{if(this.y+(e)>=n.value){if(this.ysp<0){this.angle=n.angle;this.y=j=n.value+e;this.ysp=0}}}}else{if(m.value>-1){if(this.y+(e)>=m.value){if(this.ysp<0){this.angle=m.angle;this.y=j=m.value+e;this.ysp=0}}}else{if(n.value>-1){if(this.y+(e)>=n.value){if(this.ysp<0){this.angle=n.angle;this.y=j=n.value+e;this.ysp=0}}}}}this.updateMode()}}};this.debug=function(){this.debugging=!this.debugging;this.xsp=0;this.gsp=0;this.ysp=0;this.spriteState="normal"};this.hit=function(){if(sonicManager.drawTickCount-this.sonicJustHitTick<120){return}this.justHit=true;this.ysp=-4;this.xsp=2*(-1);this.sonicLastHitTick=sonicManager.drawTickCount;var j=0;var e=101.25;var f=false;var h=4;while(j<this.rings){var g=new Ring(true);sonicManager.activeRings.push(g);g.x=this.x;g.y=this.y-10;g.ysp=-Math.sin(e)*h;g.xsp=Math.cos(e)*h;if(f){g.ysp*=-1;e+=22.5}f=!f;j++;if(j==16){h=2;e=101.25}}this.rings=0};this.checkCollisionWithRing=function(){var g=this.myRec;for(var j in sonicManager.SonicLevel.Rings){var h=sonicManager.SonicLevel.Rings[j];if(this.obtainedRing[j]){continue}var e=h.X;var f=h.Y;if(_H.intersectRect(g,{x:e-8,width:8*2,y:f-8,height:8*2})){this.rings++;this.obtainedRing[j]=true}}};this.checkCollisionWithObjects=function(){var g=this.myRec;for(var j in sonicManager.SonicLevel.Objects){var h=sonicManager.SonicLevel.Objects[j];var e=h.X;var f=h.Y;if(_H.intersectRect(g,h.getRect())){h.collide()}}};this.sensorA=0;this.checkCollisionLine=function(h,j,f,e){var g=this.checkCollisionLineWrap(h,j,f,e);if(g!=-1&&g.angle==null){g=this.checkCollisionLineWrap(h,j,f,e)}if(g.angle==255){if(this.mode==RotationMode.Floor){}else{if(this.mode==RotationMode.LeftWall){}else{if(this.mode==RotationMode.Ceiling){}else{if(this.mode==RotationMode.RightWall){}}}}}return g};this.checkCollisionLineWrap=function(t,u,q,n){var g=_H.floor(t/128);var h=_H.floor(u/128);var s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[g][h]];var l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;var j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;var e=t-g*128;var f=u-h*128;var o=128;var p;var r;var k=0;switch(n){case 0:if(t+q>sonicManager.SonicLevel.LevelWidth*128){return{pos:sonicManager.SonicLevel.LevelWidth*128-20,angle:null}}for(p=0;p<q;p++){if(e+p>=128){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[g+1][h]];l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;e-=128}if(t+p>this.LevelWidth||l[(e+p)][f]>=2){return{pos:t+p,angle:j[_H.floor((e+p)/16)][_H.floor((f)/16)]}}}break;case 1:if(u+q>sonicManager.SonicLevel.LevelHeight*128){return{pos:sonicManager.SonicLevel.LevelHeight*128-20,angle:null}}for(p=0;p<q;p+=1){if(f+k>=128){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[g][(h+1)]];l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;f-=128}if(l[e][f+p]>=1){return{pos:u+p,angle:j[_H.floor((e)/16)][_H.floor((f+k)/16)]}}k++}break;case 2:if(t-q<0){return{pos:0+20,angle:null}}for(p=0;p<q;p++){if(e-p<0){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[(g-1),h]];l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;e+=128}if(t-p<0||l[(e-p)][f]>=2){return{pos:t-p,angle:j[_H.floor((e-p)/16)][_H.floor((f)/16)]}}}break;case 3:if(u-q<0){return{pos:20,angle:null}}for(p=0;p<q;p+=1){if(f-k<0){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[g][(h-1)]];l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;f+=128}if(l[e][f-p]>=2){return{pos:u-p,angle:j[_H.floor((e)/16)][_H.floor((f-k)/16)]}}k++}break}return -1};this.spriteState="normal";this.isLoading=function(){return this.imageLoaded[0]<this.imageLength};this.drawUI=function(e,f,g){e.font="13pt Arial bold";e.fillStyle="White";e.fillText("Rings: "+this.rings,f.x+90,f.y+45);e.fillText("Angle: "+this.angle.toString(16),f.x+90,f.y+75);e.fillText("Position: "+_H.floor(this.x)+", "+_H.floor(this.y),f.x+90,f.y+105);e.fillText("Speed: g: "+this.gsp.toFixed(3)+" x:"+this.xsp.toFixed(3)+" y:"+this.ysp.toFixed(3),f.x+90,f.y+135);e.fillText("Mode: "+a(this.mode),f.x+90,f.y+165);if(this.inAir){e.fillText("Air ",f.x+220,f.y+45)}if(this.hlock>0){e.fillText("HLock: "+this.hlock,f.x+90,f.y+195)}};function a(e){switch(e){case RotationMode.Floor:return"Floor";case RotationMode.Ceiling:return"Ceiling";case RotationMode.RightWall:return"Right Wall";case RotationMode.LeftWall:return"Left Wall"}}this.draw=function(e,o){var g=_H.floor(this.x);var h=_H.floor(this.y);var f;var l=sonicManager.drawTickCount-this.sonicJustHitTick;if(l<120){if(l%8<4){return}}if(f=sonicManager.SpriteCache.sonicSprites[this.spriteState+o.x+o.y]){if(f.loaded){_H.save(e);var p=0;var q=0;if(f.height!=40*o.x){switch(this.mode){case RotationMode.Floor:var m=0;q=(40-((f.height+m)/o.y))/2;break;case RotationMode.LeftWall:var m=15;p=-(40-((f.height+m)/o.x))/2;break;case RotationMode.Ceiling:var m=8;q=-(40-((f.height+m)/o.y))/2;break;case RotationMode.RightWall:var m=20;p=(40-((f.height+m)/o.x))/2;break}}e.translate((g-sonicManager.windowLocation.x+p+p)*o.x,((h-sonicManager.windowLocation.y+q)*o.y));if(!this.facing){e.scale(-1,1);if(!this.currentlyBall){e.rotate(-_H.fixAngle(this.angle))}e.drawImage(f,-f.width/2,-f.height/2);if(this.spinDash){e.drawImage(sonicManager.SpriteCache.sonicSprites[("spinsmoke"+_H.floor((sonicManager.drawTickCount%14)/2))+o.x+o.y],(-f.width/2)-25*o.x,-f.height/2+(q*o.y)-14,f.width,f.height)}}else{if(!this.currentlyBall){e.rotate(_H.fixAngle(this.angle))}e.drawImage(f,-f.width/2,-f.height/2);if(this.spinDash){e.drawImage(sonicManager.SpriteCache.sonicSprites[("spinsmoke"+_H.floor((sonicManager.drawTickCount%14)/2))+o.x+o.y],(-f.width/2)-25*o.x,-f.height/2+(q*o.y)-14,f.width,f.height)}}_H.restore(e);if(sonicManager.showHeightMap){this.sensorManager.draw(e,o,this)}for(var j=0;j<this.haltSmoke.length;j++){var k=this.haltSmoke[j];e.drawImage(sonicManager.SpriteCache.sonicSprites[("haltsmoke"+_H.floor((sonicManager.drawTickCount%(4*6))/6))+o.x+o.y],((k.x-sonicManager.windowLocation.x-25)*o.x),((k.y+12-sonicManager.windowLocation.y+q)*o.y));if(_H.floor(((sonicManager.drawTickCount+6)%(4*6))/6)==0){this.haltSmoke.splice(j,1)}}}}else{if(f=sonicManager.SpriteCache.sonicSprites[this.spriteState]){if(f.loaded){sonicManager.SpriteCache.sonicSprites[this.spriteState+o.x+o.y]=_H.scaleSprite(f,o)}}else{sonicManager.SpriteCache.sonicSprites[this.spriteState]=_H.loadSprite(this.spriteLocations[this.spriteState])}}};this.kill=function(){};this.pressJump=function(){if(this.debugging||!this.justHit){this.jumping=true}};this.pressUp=function(){if(this.debugging||!this.justHit){this.holdingUp=true}};this.pressCrouch=function(){if(this.debugging||!this.justHit){this.crouching=true}};this.pressLeft=function(){if(this.debugging||!this.justHit){this.holdingLeft=true}};this.pressRight=function(){if(this.debugging||!this.justHit){this.holdingRight=true}};this.releaseJump=function(){this.jumping=false};this.releaseUp=function(){this.holdingUp=false};this.releaseCrouch=function(){this.crouching=false};this.releaseLeft=function(){this.holdingLeft=false};this.releaseRight=function(){this.holdingRight=false};this.buildHeightInfo=function(){this.LevelWidth=d.LevelWidth*128;for(var u=0;u<d.Chunks.length;u++){var m=d.Chunks[u];var n;var o=m.heightBlocks1=[];var p=m.heightBlocks2=[];var k=m.angleMap1=[];var l=m.angleMap2=[];p.length=o.length=128;k.length=l.length=8;for(var g=0;g<128;g++){o[g]=[];p[g]=[];k[g]=[];l[g]=[];l[g].length=k[g].length=8;p[g].length=o[g].length=128}for(var j=0;j<8;j++){for(var h=0;h<8;h++){var w=m.tilePieces[h][j];k[h][j]=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes1[w.Block]];l[h][j]=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes2[w.Block]];if(k[h][j]==1){k[h][j]=0}if(l[h][j]==1){l[h][j]=0}if(!(k[h][j]==0||k[h][j]==255||k[h][j]==1)){if(w.XFlip){if(w.YFlip){k[h][j]=191-k[h][j]+192;l[h][j]=191-l[h][j]+192;k[h][j]=127-k[h][j]+128;l[h][j]=127-l[h][j]+128}else{k[h][j]=127-k[h][j]+128;l[h][j]=127-l[h][j]+128}}else{if(w.YFlip){k[h][j]=191-k[h][j]+192;l[h][j]=191-l[h][j]+192}else{k[h][j]=(k[h][j]);l[h][j]=(l[h][j])}}}var e;var f;var q=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes1[w.Block]];var r=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes2[w.Block]];var v;if(q==0||q==1){v=q==0?0:w.Solid1;for(f=0;f<16;f++){for(e=0;e<16;e++){o[(h*16+e)][(j*16+f)]=v}}}else{q=q.items}if(r==0||r==1){v=r==0?0:w.Solid2;for(f=0;f<16;f++){for(e=0;e<16;e++){p[(h*16+e)][(j*16+f)]=v}}}else{r=r.items}for(f=0;f<16;f++){for(e=0;e<16;e++){var s=0,t=0;if(w.XFlip){if(w.YFlip){s=15-e;t=15-f}else{s=15-e;t=f}}else{if(w.YFlip){s=e;t=15-f}else{s=e;t=f}}if(!(q==0||q==1)){switch(w.Solid1){case 0:o[(h*16+s)][(j*16+t)]=false;break;case 1:case 2:case 3:o[(h*16+s)][(j*16+t)]=(Math.abs(q[e])>16-f)?w.Solid1:0;break}}if(!(r==0||r==1)){switch(w.Solid2){case 0:p[(h*16+s)][(j*16+t)]=false;break;case 1:case 2:case 3:p[(h*16+s)][(j*16+t)]=(Math.abs(r[e])>16-f)?w.Solid2:0;break}}}}}}}};this.updateSprite=function(){var e=Math.abs(this.gsp);var f=parseInt(this.spriteState.substring(this.spriteState.length-1,this.spriteState.length));if(this.breaking>0){if(this.gsp>0||this.gsp==0||this.spriteState=="breaking3"){this.facing=false;this.breaking=0}}else{if(this.breaking<0){if(this.gsp<0||this.gsp==0||this.spriteState=="breaking3"){this.breaking=0;this.facing=true}}}if(this.justHit){if(this.spriteState.substring(0,this.spriteState.length-1)!="hit"){this.spriteState="hit0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(8-e))==0){this.spriteState="hit1"}}}else{if(this.spinDash){if(this.spriteState.substring(0,this.spriteState.length-1)!="spindash"){this.spriteState="spindash0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(2-e))==0){this.spriteState="spindash"+((f+1)%6)}}}else{if(e==0&&this.inAir==false){if(this.ducking){if(this.spriteState.substring(0,this.spriteState.length-1)!="duck"){this.spriteState="duck0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(4-e))==0){this.spriteState="duck1"}}}else{if(this.holdingUp){if(this.spriteState.substring(0,this.spriteState.length-1)!="lookingup"){this.spriteState="lookingup0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(4-e))==0){this.spriteState="lookingup1"}}}else{this.spriteState="normal";this.currentlyBall=false;this.rolling=false;this.runningTick=0}}}else{if(this.breaking!=0){if(this.spriteState.substring(0,this.spriteState.length-1)!="breaking"){this.spriteState="breaking0";this.runningTick=1}else{if((this.runningTick++)%(7)==0){this.spriteState="breaking"+((f+1)%4);if(f==0){this.haltSmoke.push({x:_H.floor(this.x),y:_H.floor(this.y)})}}}}else{if(this.currentlyBall){if(this.spriteState.substring(0,this.spriteState.length-1)!="balls"){this.spriteState="balls0";this.runningTick=1}else{if(((this.runningTick++)%(_H.floor(8-e))==0)||(8-e<1)){this.spriteState="balls"+((f+1)%5)}}}else{if(e<6){if(this.spriteState.substring(0,this.spriteState.length-1)!="running"){this.spriteState="running0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(8-e))==0||(_H.floor(8-e)==0)){this.spriteState="running"+((f+1)%8)}}}else{if(e>=6){if(this.spriteState.substring(0,this.spriteState.length-1)!="fastrunning"){this.spriteState="fastrunning0";this.runningTick=1}else{if(((this.runningTick++)%(Math.ceil(8-e))==0)||(_H.floor(8-e)==0)){this.spriteState="fastrunning"+((f+1)%4)}}}}}}}}}};this.buildHeightInfo(d)}Sensor=function(c,d,e,f,b,a){this.x1=c;this.y1=e;this.x2=d;this.y2=f;this.color=a;this.manager=b;this.check=function(g){var h;var j=_H.floor(g.x);var k=_H.floor(g.y);switch(g.mode){case RotationMode.Floor:h=this.checkCollisionLineWrap(j+this.x1,j+this.x2,k+this.y1,k+this.y2);break;case RotationMode.LeftWall:h=this.checkCollisionLineWrap(j-this.y1,j-this.y2,k+this.x1,k+this.x2);break;case RotationMode.Ceiling:h=this.checkCollisionLineWrap(j-this.x1,j-this.x2,k-this.y1,k-this.y2);break;case RotationMode.RightWall:h=this.checkCollisionLineWrap(j+this.y1,j+this.y2,k-this.x1,k-this.x2);break}if(h!=-1){if(h.angle==255||h.angle==0||h.angle==1){if(g.mode==RotationMode.Floor){h.angle=255}if(g.mode==RotationMode.LeftWall){h.angle=64}if(g.mode==RotationMode.Ceiling){h.angle=128}if(g.mode==RotationMode.RightWall){h.angle=192}}}return h};this.checkCollisionLineWrap=function(r,s,t,u){var j=_H.floor(r/128);var k=_H.floor(t/128);var q=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[j][k]];var n=sonicManager.SonicLevel.curHeightMap?q.heightBlocks1:q.heightBlocks2;var l=sonicManager.SonicLevel.curHeightMap?q.angleMap1:q.angleMap2;var g=r-j*128;var h=t-k*128;var o;var m=0;var p;if(t==u){if(Math.max(r,s)>sonicManager.SonicLevel.LevelWidth*128){return{value:sonicManager.SonicLevel.LevelWidth*128-20,angle:255}}if(r<s){p=s-r;for(o=0;o<p;o++){if(g+o>=128){q=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[j+1][k]];n=sonicManager.SonicLevel.curHeightMap?q.heightBlocks1:q.heightBlocks2;l=sonicManager.SonicLevel.curHeightMap?q.angleMap1:q.angleMap2;g-=128}if(r+o>this.LevelWidth||n[(g+o)][h]>=2){return{value:r+o,angle:l[_H.floor((g+o)/16)][_H.floor((h)/16)]}}}}else{p=r-s;for(o=0;o<p;o++){if(g-o<0){q=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[j-1][k]];n=sonicManager.SonicLevel.curHeightMap?q.heightBlocks1:q.heightBlocks2;l=sonicManager.SonicLevel.curHeightMap?q.angleMap1:q.angleMap2;g+=128}if(r-o>this.LevelWidth||n[(g-o)][h]>=2){return{value:r-o,angle:l[_H.floor((g-o)/16)][_H.floor((h)/16)]}}}}}else{if(Math.max(t,u)>sonicManager.SonicLevel.LevelHeight*128){return{value:sonicManager.SonicLevel.LevelHeight*128-20,angle:255}}if(t<u){p=u-t;for(o=0;o<p;o++){if(h+o>=128){q=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[j][(k+1)]];n=sonicManager.SonicLevel.curHeightMap?q.heightBlocks1:q.heightBlocks2;l=sonicManager.SonicLevel.curHeightMap?q.angleMap1:q.angleMap2;h-=128}if(n[g][h+o]>=1){return{value:t+o,angle:l[_H.floor((g)/16)][_H.floor((h+o)/16)]}}}}else{p=t-u;for(o=0;o<p;o++){if(h-o<0){q=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[j][(k-1)]];n=sonicManager.SonicLevel.curHeightMap?q.heightBlocks1:q.heightBlocks2;l=sonicManager.SonicLevel.curHeightMap?q.angleMap1:q.angleMap2;h+=128}if(n[g][h-o]>=1){return{value:t-o,angle:l[_H.floor((g)/16)][_H.floor((h-o)/16)]}}}}}return -1};this.draw=function(g,j,h,k){var l=_H.floor(h.x)-sonicManager.windowLocation.x;var m=_H.floor(h.y)-sonicManager.windowLocation.y;g.beginPath();if(k&&k.chosen){g.strokeStyle="#FFF76D";g.lineWidth=4}else{g.strokeStyle=this.color;g.lineWidth=2}switch(h.mode){case RotationMode.Floor:g.moveTo((l+this.x1)*j.x,(m+this.y1)*j.y);g.lineTo((l+this.x2)*j.x,(m+this.y2)*j.y);break;case RotationMode.LeftWall:g.moveTo((l-this.y1)*j.x,(m+this.x1)*j.y);g.lineTo((l-this.y2)*j.x,(m+this.x2)*j.y);break;case RotationMode.Ceiling:g.moveTo((l-this.x1)*j.x,(m-this.y1)*j.y);g.lineTo((l-this.x2)*j.x,(m-this.y2)*j.y);break;case RotationMode.RightWall:g.moveTo((l+this.y1)*j.x,(m-this.x1)*j.y);g.lineTo((l+this.y2)*j.x,(m-this.x2)*j.y);break}g.closePath();g.stroke()}};SensorManager=function(a){this.sonicManager=a;this.sensors=[];this.sensorResults=[];this.check=function(b){var d=false;for(var c in this.sensors){this.sensorResults[c]=this.sensors[c].check(b);d=d||(this.sensorResults[c]!=-1)}return d};this.draw=function(b,e,c){for(var d in this.sensors){this.sensors[d].draw(b,e,c,this.sensorResults[d])}};this.getResult=function(b){return this.sensorResults[b]};this.addSensor=function(b,c){this.sensors[b]=(c);this.sensorResults[b]=false;return c};this.createHorizontalSensor=function(c,f,d,e,b){return this.addSensor(c,new Sensor(d,e,f,f,this,b))};this.createVerticalSensor=function(c,d,e,f,b){return this.addSensor(c,new Sensor(d,d,e,f,this,b))}};DEBUGs=true;window.requestAnimFrame=(function(a){if(window.requestAnimationFrame){return window.requestAnimationFrame(a)}if(window.webkitRequestAnimationFrame){return window.webkitRequestAnimationFrame(a)}if(window.mozRequestAnimationFrame){return window.mozRequestAnimationFrame(a)}if(window.oRequestAnimationFrame){return window.oRequestAnimationFrame(a)}if(window.msRequestAnimationFrame){return window.msRequestAnimationFrame(a)}window.setTimeout(a,1000/60)});function SonicEngine(c){var k=this;this.canvas=$("#"+c);this.canvasItem=document.getElementById(c).getContext("2d");this.canvasWidth=0;this.canvasHeight=0;document.getElementById(c).addEventListener("DOMMouseScroll",h,false);document.getElementById(c).addEventListener("mousewheel",h,false);document.getElementById(c).addEventListener("touchmove",a);document.getElementById(c).addEventListener("touchstart",d);document.getElementById(c).addEventListener("touchend",b);document.getElementById(c).addEventListener("mousedown",d);document.getElementById(c).addEventListener("mouseup",b);document.getElementById(c).addEventListener("mousemove",a);$(document).keydown(f);$(document).keyup(g);function d(l){l.preventDefault();if(j.uiManager.onClick(l)){return false}if(j.onClick(l)){return false}j.uiManager.dragger.click(l);return false}function a(l){l.preventDefault();if(j.uiManager.onMouseMove(l)){return false}return false}function b(l){l.preventDefault();j.uiManager.onMouseUp(l)}function h(l){l.preventDefault();if(j.uiManager.onMouseScroll(l)){return false}return l.preventDefault()&&false}function f(l){switch(l.keyCode){case 66:if(j.sonicToon){j.sonicToon.hit()}break;case 67:if(j.sonicToon){j.sonicToon.debug()}break;case 69:j.SonicLevel.curHeightMap=!j.SonicLevel.curHeightMap;break;case 70:j.showHeightMap=!j.showHeightMap;break;case 38:case 87:if(j.sonicToon){j.sonicToon.pressUp()}else{j.windowLocation.y-=128}break;case 32:if(j.sonicToon){j.sonicToon.pressJump()}break;case 40:case 83:if(j.sonicToon){j.sonicToon.pressCrouch()}else{j.windowLocation.y+=128}break;case 37:case 65:j.windowLocation.x-=128;if(j.sonicToon){j.sonicToon.pressLeft()}else{j.windowLocation.x-=128}break;case 39:case 68:j.windowLocation.x+=128;if(j.sonicToon){j.sonicToon.pressRight()}else{j.windowLocation.x+=128}break}}function g(l){switch(l.keyCode){case 38:case 87:if(j.sonicToon){j.sonicToon.releaseUp()}break;case 32:if(j.sonicToon){j.sonicToon.releaseJump()}break;case 40:case 83:if(j.sonicToon){j.sonicToon.releaseCrouch()}break;case 37:case 65:if(j.sonicToon){j.sonicToon.releaseLeft()}break;case 39:case 68:if(j.sonicToon){j.sonicToon.releaseRight()}break}}k.resizeCanvas=function(){k.canvasWidth=$(window).width();k.canvasHeight=$(window).height();window.sonicManager.windowLocation=_H.defaultWindowLocation(window.sonicManager.sonicToon?0:1,k.canvasItem,window.sonicManager.scale);k.canvas.attr("width",k.canvasWidth);k.canvas.attr("height",k.canvasHeight)};function e(l){l.clearRect(0,0,k.canvasWidth,k.canvasHeight)}k.draw=function(){requestAnimFrame(k.draw);e(k.canvasItem);j.draw(k.canvasItem);j.uiManager.draw(k.canvasItem)};$(window).resize(this.resizeCanvas);var j=window.sonicManager=new SonicManager(this.canvasItem,this.resizeCanvas);this.resizeCanvas();requestAnimFrame(k.draw);window.setInterval(j.tick,1000/60,j)}function SonicManager(b,c){var d=this.scale={x:2,y:2};window.sonicManager=this;this.windowLocation=_H.defaultWindowLocation(1,b,d);this.showHeightMap=false;this.goodRing=new Ring(false);this.activeRings=[];this.forceResize=c;this.background=null;this.uiManager=new UIManager(this,b,this.scale);this.SonicLevel={Tiles:[],Blocks:[],Chunks:[],ChunkMap:[[]],Rings:{},curHeightMap:true,LevelWidth:0,LevelHeight:0};this.containsAnimatedTile=function(h){for(var g=0;g<sonicManager.SonicLevel.Animations.length;g++){var e=sonicManager.SonicLevel.Animations[g];var f=e.AnimationTileIndex;var j=e.NumberOfTiles;if(h>=f&&h<f+j){return e}}return undefined};var a=new TileChunk()+new TilePiece()+new Tile()+new HeightMask();this.SonicLevel.ChunkMap=[[]];this.clickState=ClickState.Dragging;this.onClick=function(g){g={x:g.x/d.x+this.windowLocation.x,y:g.y/d.y+this.windowLocation.y};if(!g.button||g.button==0){switch(this.clickState){case ClickState.Dragging:return false;break;case ClickState.PlaceChunk:var h,j;h=_H.floor(g.x/(128));j=_H.floor(g.y/(128));var f=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[h][j]];var n=f.getBlock((g.x-h*(128)),(g.y-j*(128)));if(n){var p=f.getTilePiece((g.x-h*(128)),(g.y-j*(128)));this.uiManager.indexes.tpIndex=this.SonicLevel.Blocks.indexOf(n);this.uiManager.modifyTilePieceArea.tilePiece=n;this.uiManager.solidTileArea.visible=true;this.uiManager.modifyTilePieceArea.tpc=p}return true;break;case ClickState.PlaceRing:var h=_H.floor((g.x));var j=_H.floor((g.y));this.SonicLevel.Rings.push({X:h,Y:j});return true;break;case ClickState.PlaceObject:var h=_H.floor((g.x));var j=_H.floor((g.y));for(var k=0;k<sonicManager.SonicLevel.Objects.length;k++){var m=sonicManager.SonicLevel.Objects[k];if(_H.intersects2(m.getRect(),{X:h,Y:j})){alert(_H.stringify(m))}}return true;break;default:}}return false};this.tickCount=0;this.drawTickCount=0;this.tick=function(f){if(f.loading){return}if(f.sonicToon){f.tickCount++;f.sonicToon.ticking=true;try{f.sonicToon.tick(f.SonicLevel,d)}catch(e){alert(_H.stringify(e))}finally{f.sonicToon.ticking=false}if(f.sonicToon.y>128*sonicManager.SonicLevel.LevelHeight){f.sonicToon.y=0}if(f.sonicToon.x>128*sonicManager.SonicLevel.LevelWidth){f.sonicToon.x=0}}};this.screenOffset={x:b.canvas.width/2-this.windowLocation.width*d.x/2,y:b.canvas.height/2-this.windowLocation.height*d.y/2};this.draw=function(j){_H.save(j);this.drawTickCount++;if((this.spriteLoader&&!this.spriteLoader.tick())||this.loading){j.fillStyle="white";j.fillText("Loading...   ",95,95);_H.restore(j);return}this.screenOffset={x:j.canvas.width/2-this.windowLocation.width*d.x/2,y:j.canvas.height/2-this.windowLocation.height*d.y/2};if(this.sonicToon){if(this.sonicToon.ticking){while(true){if(!this.sonicToon.ticking){break}}}j.translate(this.screenOffset.x,this.screenOffset.y);j.fillStyle="#000000";j.fillRect(0,0,this.windowLocation.width*d.x,this.windowLocation.height*d.x);j.beginPath();j.rect(0,0,this.windowLocation.width*d.x,this.windowLocation.height*d.x);j.clip();this.windowLocation.x=_H.floor(this.sonicToon.x-160);this.windowLocation.y=_H.floor(this.sonicToon.y-180);var D=_H.floor(this.windowLocation.x/d.x);if(this.background){this.background.draw(j,{x:-_H.floor(this.windowLocation.x/2)*d.x,y:-(_H.floor(this.windowLocation.y/4))*d.y},d,D)}}if(this.windowLocation.x<0){this.windowLocation.x=0}if(this.windowLocation.y<0){this.windowLocation.y=0}if(this.windowLocation.x>128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width){this.windowLocation.x=128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width}if(this.windowLocation.y>128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height){this.windowLocation.y=128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height}var y=[];for(var t=-1;t<this.windowLocation.width/128;t+=1){for(var g=-1;g<this.windowLocation.height/128;g+=1){y.push({x:t,y:g})}}if(this.SonicLevel.Chunks&&this.SonicLevel.Chunks.length>0){var m=this.SonicLevel.AnimatedChunks;for(var u=0;u<m.length;u++){m[u].animatedTick()}var q=_H.floor((this.windowLocation.x+128)/128);var s=_H.floor((this.windowLocation.y+128)/128);for(var x in y){var e=q+y[x].x;var f=s+y[x].y;if(e<0||f<0||e>=this.SonicLevel.LevelWidth||f>=this.SonicLevel.LevelHeight){continue}var n=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[e][f]];if(!n){continue}var z={x:e*128*d.x,y:f*128*d.y};var A={x:z.x-this.windowLocation.x*d.x,y:z.y-this.windowLocation.y*d.x};n.draw(j,A,d,false);if(!this.sonicToon){j.strokeStyle="#DD0033";j.lineWidth=3;j.strokeRect(A.x,A.y,128*d.x,128*d.y)}}for(var C in this.SonicLevel.Rings){var B=this.SonicLevel.Rings[C];if(this.sonicToon){if(!this.sonicToon.obtainedRing[C]){if(this.windowLocation.intersects(B)){this.goodRing.draw(j,{x:(B.X)-this.windowLocation.x,y:(B.Y)-this.windowLocation.y},d,true)}}}else{if(this.windowLocation.intersects(B)){this.goodRing.draw(j,{x:(B.X)-this.windowLocation.x,y:(B.Y)-this.windowLocation.y},d,false)}}}for(var v=0;v<sonicManager.SonicLevel.Objects.length;v++){var w=sonicManager.SonicLevel.Objects[v];if(this.sonicToon){if(this.windowLocation.intersects({X:w.ObjectData.X,Y:w.ObjectData.Y})){w.draw(j,{x:(w.ObjectData.X)-this.windowLocation.x,y:(w.ObjectData.Y)-this.windowLocation.y},d,true)}}else{if(this.windowLocation.intersects({X:w.ObjectData.X,Y:w.ObjectData.Y})){w.draw(j,{x:(w.ObjectData.X)-this.windowLocation.x,y:(w.ObjectData.Y)-this.windowLocation.y},d,false)}}}for(var t=this.activeRings.length-1;t>=0;t--){var h=this.activeRings[t];h.draw(j,{x:h.x-this.windowLocation.x,y:h.y-this.windowLocation.y},d);if(h.tickCount>256){_H.remove(this.activeRings,h)}}if(this.sonicToon){this.sonicToon.draw(j,d);if(this.windowLocation.x<0){this.windowLocation.x=0}if(this.windowLocation.y<0){this.windowLocation.y=0}if(this.windowLocation.x>128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width){this.windowLocation.x=128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width}if(this.windowLocation.y>128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height){this.windowLocation.y=128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height}}for(var x in y){var e=q+y[x].x;var f=s+y[x].y;if(e<0||f<0||e>=this.SonicLevel.LevelWidth||f>=this.SonicLevel.LevelHeight){continue}var n=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[e][f]];if(!n){continue}var z={x:e*128*d.x,y:f*128*d.y};var A={x:z.x-this.windowLocation.x*d.x,y:z.y-this.windowLocation.y*d.x};n.draw(j,A,d,true);if(!this.sonicToon){j.strokeStyle="#DD0033";j.lineWidth=3;j.strokeRect(A.x,A.y,128*d.x,128*d.y)}if(this.showHeightMap){var p;if((p=sonicManager.SpriteCache.heightMapChunks[(this.SonicLevel.curHeightMap?1:2)+" "+n.index+" "+d.y+" "+d.x])){if(p.loaded){j.drawImage(p,A.x,A.y)}}}if(!this.sonicToon){j.strokeStyle="#DD0033";j.lineWidth=3;j.strokeRect(A.x,A.y,128*d.x,128*d.y)}}}_H.restore(j);if(this.sonicToon){this.sonicToon.drawUI(j,{x:this.screenOffset.x,y:this.screenOffset.y},d)}};this.spriteLoader=null;this.SpriteCache={rings:[],tileChunks:[],tilePeices:[],tiles:[],sonicSprites:[],heightMaps:[],heightMapChunks:[]};this.preLoadSprites=function(r,g,y){this.SpriteCache={rings:[],tileChunks:[],tilePeices:[],tiles:[],sonicSprites:[],heightMaps:[],heightMapChunks:[]};var f=this.SpriteCache.rings;var m=0;var v=[];for(var n=0;n<4;n++){v[n]="assets/Sprites/ring"+n+".png";this.imageLength++}var x=this;var p;var l={sprites:0,tps:0,tcs:0,ss:0,hms:0,hmc:0,tls:0,px:0,aes:0};var s=this.spriteLoader=new SpriteLoader(g,y);var w=s.addStep("Sprites",function(k,j){var z=k*200;f[z]=_H.loadSprite(v[k],function(A){f[A.tag*200+r.x*100+r.y]=_H.scaleSprite(A,r,function(B){j()})});f[z].tag=k},function(){l.sprites=l.sprites+1;if(l.sprites==4){return true}return false},false);for(var h=0;h<v.length;h++){s.addIterationToStep(w,h)}var x=this;var u=1;var q=0;var e=s.addStep("Chunk Maps",function(L,H){var D=_H.defaultCanvas(128*r.x,128*r.y);var F=D.context;F.clearRect(0,0,D.width,D.height);p=x.SonicLevel.Chunks[L];p.draw(F,{x:0,y:0},r,false);var I=D.canvas.toDataURL("image/png");x.SpriteCache.tileChunks[false+" "+p.index+" "+r.y+" "+r.x+" -"]=_H.loadSprite(I,function(k){l.tcs++;H()});D=_H.defaultCanvas(128*r.x,128*r.y);F=D.context;F.clearRect(0,0,D.width,D.height);if(!p.onlyBackground()){p.draw(F,{x:0,y:0},r,true);var I=D.canvas.toDataURL("image/png");x.SpriteCache.tileChunks[true+" "+p.index+" "+r.y+" "+r.x+" -"]=_H.loadSprite(I,function(k){l.tcs++;H()})}else{x.SpriteCache.tileChunks[true+" "+p.index+" "+r.y+" "+r.x+" -"]=1;l.tcs++;H()}if(p.animated){sonicManager.drawTickCount=0;sonicManager.CACHING=false;for(var C=0;C<p.animated.Frames.length;C++){var J=p.animated.Frames[C];D=_H.defaultCanvas(128*r.x,128*r.y);F=D.context;F.clearRect(0,0,D.width,D.height);p.draw(F,{x:0,y:0},r,true,C);var I=D.canvas.toDataURL("image/png");x.SpriteCache.tileChunks[true+" "+p.index+" "+r.y+" "+r.x+" "+C]=_H.loadSprite(I,function(k){});D=_H.defaultCanvas(128*r.x,128*r.y);F=D.context;F.clearRect(0,0,D.width,D.height);p.draw(F,{x:0,y:0},r,false,C);var I=D.canvas.toDataURL("image/png");x.SpriteCache.tileChunks[false+" "+p.index+" "+r.y+" "+r.x+" "+C]=_H.loadSprite(I,function(k){})}sonicManager.CACHING=true}var M={x:0,y:0};D=_H.defaultCanvas(128*r.x,128*r.y);F=D.context;F.clearRect(0,0,D.width,D.height);var E=_H.defaultCanvas(128*r.x,128*r.y);var G=E.context;G.clearRect(0,0,E.width,E.height);for(var B=0;B<8;B++){for(var A=0;A<8;A++){var O=p.tilePieces[A][B];var K=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes1[O.Block]];var j=A;var z=B;var N={x:M.x+(j*16)*r.x,y:M.y+(z*16)*r.y};if(K==0){}else{if(K==1){if(O.Solid1>0){F.fillStyle=HeightMask.colors[O.Solid1];F.fillRect(M.x+(j*16)*r.x,M.y+(z*16)*r.y,r.x*16,r.y*16)}}else{K.draw(F,N,r,-1,O.XFlip,O.YFlip,O.Solid1);var P=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes1[O.Block]];N.x+=16*r.x/2;N.y+=16*r.y/2;F.strokeStyle="#DDD";F.font="18pt courier ";F.shadowColor="";F.shadowBlur=0;F.lineWidth=1}}K=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes2[O.Block]];if(K==0){continue}if(K==1){if(O.Solid2>0){G.fillStyle=HeightMask.colors[O.Solid2];G.fillRect(M.x+(j*16)*r.x,M.y+(z*16)*r.y,r.x*16,r.y*16)}continue}K.draw(G,N,r,-1,O.XFlip,O.YFlip,O.Solid2);P=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes2[O.Block]];N.x+=16*r.x/2;N.y+=16*r.y/2;G.strokeStyle="#DDD";G.font="18pt courier ";G.shadowColor="";G.shadowBlur=0;G.lineWidth=1}}var I=D.canvas.toDataURL("image/png");x.SpriteCache.heightMapChunks[1+" "+p.index+" "+r.y+" "+r.x]=_H.loadSprite(I,function(k){l.hmc++;H()});I=E.canvas.toDataURL("image/png");x.SpriteCache.heightMapChunks[2+" "+p.index+" "+r.y+" "+r.x]=_H.loadSprite(I,function(k){l.hmc++;H()})},function(){if(l.tcs>=x.SonicLevel.Chunks.length*2/u&&l.hmc>=x.SonicLevel.Chunks.length*2/u){return true}return false},false);for(var o=0;o<this.SonicLevel.Chunks.length;o++){s.addIterationToStep(e,o)}var t=s.addStep("Sonic Sprites",function(z,k){var j=x.SpriteCache.sonicSprites;j[z]=_H.loadSprite(x.spriteLocations[z],function(A){j[A.tag+r.x+r.y]=_H.scaleSprite(A,r,k)});j[z].tag=z},function(){l.ss++;if(l.ss==x.imageLength){return true}return false},false);x.spriteLocations=[];x.imageLength=0;x.spriteLocations.normal="assets/Sprites/sonic.png";s.addIterationToStep(t,"normal");x.imageLength++;var n;for(n=0;n<4;n++){x.spriteLocations["fastrunning"+n]="assets/Sprites/fastrunning"+n+".png";x.imageLength++;s.addIterationToStep(t,"fastrunning"+n)}for(n=0;n<8;n++){x.spriteLocations["running"+n]="assets/Sprites/running"+n+".png";x.imageLength++;s.addIterationToStep(t,"running"+n)}for(n=0;n<4;n++){x.spriteLocations["breaking"+n]="assets/Sprites/breaking"+n+".png";x.imageLength++;s.addIterationToStep(t,"breaking"+n)}for(n=0;n<5;n++){x.spriteLocations["balls"+n]="assets/Sprites/balls"+n+".png";x.imageLength++;s.addIterationToStep(t,"balls"+n)}for(n=0;n<2;n++){x.spriteLocations["duck"+n]="assets/Sprites/duck"+n+".png";x.imageLength++;s.addIterationToStep(t,"duck"+n)}for(n=0;n<2;n++){x.spriteLocations["hit"+n]="assets/Sprites/hit"+n+".png";x.imageLength++;s.addIterationToStep(t,"hit"+n)}for(n=0;n<6;n++){x.spriteLocations["spindash"+n]="assets/Sprites/spindash"+n+".png";x.imageLength++;s.addIterationToStep(t,"spindash"+n)}for(n=0;n<7;n++){x.spriteLocations["spinsmoke"+n]="assets/Sprites/spinsmoke"+n+".png";x.imageLength++;s.addIterationToStep(t,"spinsmoke"+n)}for(n=0;n<4;n++){x.spriteLocations["haltsmoke"+n]="assets/Sprites/haltsmoke"+n+".png";x.imageLength++;s.addIterationToStep(t,"haltsmoke"+n)}for(n=0;n<2;n++){x.spriteLocations["lookingup"+n]="assets/Sprites/lookingup"+n+".png";x.imageLength++;s.addIterationToStep(t,"lookingup"+n)}}}ClickState={Dragging:0,PlaceChunk:1,PlaceRing:2,PlaceObject:3};function SpriteLoader(a,c){var b=this;this.stepIndex=0;this.steps=[];this.done=false;this.tickIndex=0;this.tick=function(){if(this.stepIndex==this.steps.length){if(!this.done){this.done=true;a()}return true}var d=this.steps[this.stepIndex];if(!d){return true}if(b.tickIndex%_H.floor(d.iterations.length/12)==0){c("Caching: "+d.title+" "+Math.floor(((b.tickIndex/d.iterations.length)*100))+"%")}if(d.iterations.length>this.tickIndex){d.method(d.iterations[this.tickIndex++],function(){if(d.finish()){b.stepIndex++;b.tickIndex=0}})}return false};this.addStep=function(g,e,f,d){if(d){return -1}this.steps.push({title:g,method:e,finish:f,iterations:[]});return this.steps.length-1};this.addIterationToStep=function(e,d){if(e==-1){return}this.steps[e].iterations.push(d)}}var Stats=function(){var C,v,M=0,N=0,D=Date.now(),P=D,O=D,G=0,I=1000,J=0,z,E,A,w=[[16,16,48],[0,255,255]],H=0,K=1000,L=0,y,F,B,x=[[16,48,16],[0,255,0]];C=document.createElement("div");C.style.cursor="pointer";C.style.width="80px";C.style.opacity="0.9";C.style.zIndex="10001";C.addEventListener("mousedown",function(b){b.preventDefault();M=(M+1)%2;0==M?(z.style.display="block",y.style.display="none"):(z.style.display="none",y.style.display="block")},!1);z=document.createElement("div");z.style.textAlign="left";z.style.lineHeight="1.2em";z.style.backgroundColor="rgb("+_H.floor(w[0][0]/2)+","+_H.floor(w[0][1]/2)+","+_H.floor(w[0][2]/2)+")";z.style.padding="0 0 3px 3px";C.appendChild(z);E=document.createElement("div");E.style.fontFamily="Helvetica, Arial, sans-serif";E.style.fontSize="9px";E.style.color="rgb("+w[1][0]+","+w[1][1]+","+w[1][2]+")";E.style.fontWeight="bold";E.innerHTML="FPS";z.appendChild(E);A=document.createElement("div");A.style.position="relative";A.style.width="74px";A.style.height="30px";A.style.backgroundColor="rgb("+w[1][0]+","+w[1][1]+","+w[1][2]+")";for(z.appendChild(A);74>A.children.length;){v=document.createElement("span"),v.style.width="1px",v.style.height="30px",v.style.cssFloat="left",v.style.backgroundColor="rgb("+w[0][0]+","+w[0][1]+","+w[0][2]+")",A.appendChild(v)}y=document.createElement("div");y.style.textAlign="left";y.style.lineHeight="1.2em";y.style.backgroundColor="rgb("+_H.floor(x[0][0]/2)+","+_H.floor(x[0][1]/2)+","+_H.floor(x[0][2]/2)+")";y.style.padding="0 0 3px 3px";y.style.display="none";C.appendChild(y);F=document.createElement("div");F.style.fontFamily="Helvetica, Arial, sans-serif";F.style.fontSize="9px";F.style.color="rgb("+x[1][0]+","+x[1][1]+","+x[1][2]+")";F.style.fontWeight="bold";F.innerHTML="MS";y.appendChild(F);B=document.createElement("div");B.style.position="relative";B.style.width="74px";B.style.height="30px";B.style.backgroundColor="rgb("+x[1][0]+","+x[1][1]+","+x[1][2]+")";for(y.appendChild(B);74>B.children.length;){v=document.createElement("span"),v.style.width="1px",v.style.height=30*Math.random()+"px",v.style.cssFloat="left",v.style.backgroundColor="rgb("+x[0][0]+","+x[0][1]+","+x[0][2]+")",B.appendChild(v)}return{getDomElement:function(){return C},getFps:function(){return G},getFpsMin:function(){return I},getFpsMax:function(){return J},getMs:function(){return H},getMsMin:function(){return K},getMsMax:function(){return L},update:function(){D=Date.now();H=D-P;K=Math.min(K,H);L=Math.max(L,H);F.textContent=H+" MS ("+K+"-"+L+")";var b=Math.min(30,30-30*(H/200));B.appendChild(B.firstChild).style.height=b+"px";P=D;N++;if(D>O+1000){G=Math.round(1000*N/(D-O)),I=Math.min(I,G),J=Math.max(J,G),E.textContent=G+" FPS ("+I+"-"+J+")",b=Math.min(30,30-30*(G/100)),A.appendChild(A.firstChild).style.height=b+"px",O=D,N=0}}}};function Tile(a){this.colors=a;this.sprites=[];Tile.prototype.changeColor=function(c,d,b){this.colors[c][d]=b;this.sprites=[]};Tile.prototype.checkGood=function(e,n,o,q,r,m,k,c){if(this.index[0]!="A"){for(var h=0;h<sonicManager.SonicLevel.Animations.length;h++){var b=sonicManager.SonicLevel.Animations[h];var d=b.AnimationTileIndex;var l=b.NumberOfTiles;if(this.index>=d&&this.index<d+l){if(sonicManager.CACHING){return true}var j=c||((_H.floor(sonicManager.drawTickCount%(b.Frames.length*10)/10)));var g=b.Frames[j];if(!g){continue}var f=sonicManager.SonicLevel.AnimatedFiles[b.AnimationFile];var p=f[g.StartingTileIndex+(this.index-d)];if(p){if(e.fillStyle!="rbga(255,255,255,255)"){e.fillStyle="rbga(255,255,255,255)"}p.draw(e,n,o,q,r,m,k,c);return true}}}}return false};Tile.prototype.drawUI=function(b,h,k,l,n,g){for(var d=0;d<this.colors.length;d++){for(var e=0;e<this.colors[d].length;e++){var c=this.colors[d][e];if(c==0){continue}var f=sonicManager.SonicLevel.Palette[g][c];if(b.fillStyle!="#"+f){b.fillStyle="#"+f}if(l){if(n){b.fillRect(h.x+(7-(d))*k.x,h.y+(7-e)*k.y,k.x,k.y)}else{b.fillRect(h.x+(7-(d))*k.x,h.y+(e)*k.y,k.x,k.y)}}else{if(n){b.fillRect(h.x+((d))*k.x,h.y+(7-e)*k.y,k.x,k.y)}else{b.fillRect(h.x+((d))*k.x,h.y+(e)*k.y,k.x,k.y)}}}}};Tile.prototype.draw=function(c,q,r,s,t,p,l,b){if(this.checkGood(c,q,r,s,t,p,l,b)){return}var f;if((f=sonicManager.SpriteCache.tiles[this.index+" "+s+" "+t+" "+p+" "+r.y+" "+r.x])){if(this.index[0]!="A"){c.putImageData(f,q.x,q.y)}else{c.drawImage(f,q.x,q.y)}}else{if(q.x<0||q.y<0){return}_H.save(c);var o={x:q.x,y:q.y};if(s){q.x=-q.x-this.colors.length*r.x;c.scale(-1,1)}if(t){q.y=-q.y-this.colors.length*r.y;c.scale(1,-1)}for(var h=0;h<this.colors.length;h++){for(var k=0;k<this.colors[h].length;k++){var g=this.colors[h][k];if(g==0){continue}var n=sonicManager.SonicLevel.Palette[p][g];if(c.fillStyle!="#"+n){c.fillStyle="#"+n}c.fillRect(q.x+((h))*r.x,q.y+(k)*r.y,r.x,r.y)}}_H.restore(c);q.x=o.x;q.y=o.y;var d=this.colors.length*r.x;var e=this.colors.length*r.y;if(this.index[0]!="A"){sonicManager.SpriteCache.tiles[this.index+" "+s+" "+t+" "+p+" "+r.y+" "+r.x]=c.getImageData(o.x,o.y,d,e)}else{}}}}function TileChunk(a){this.tilePieces=a;this.hLayer=[[]];this.sprites=[];TileChunk.prototype.getTilePiece=function(b,c){return this.tilePieces[_H.floor((b/16))][_H.floor((c/16))]};TileChunk.prototype.getBlock=function(b,c){return sonicManager.SonicLevel.Blocks[this.tilePieces[_H.floor((b/16))][_H.floor((c/16))].Block]};TileChunk.prototype.onlyBackground=function(){for(var b=0;b<this.tilePieces.length;b++){for(var c=0;c<this.tilePieces[b].length;c++){var e=this.tilePieces[b][c];var d=sonicManager.SonicLevel.Blocks[e.Block];if(d){if(!d.onlyBackground()){return false}}}}return true};this.lastAnimatedFrame=0;this.lastAnimatedIndex=0;TileChunk.prototype.animatedTick=function(){if(this.lastAnimatedFrame==undefined){this.lastAnimatedFrame=0;this.lastAnimatedIndex=0}if(this.animated.Frames[this.lastAnimatedIndex].Ticks==0||(sonicManager.drawTickCount-this.lastAnimatedFrame)>=2){this.lastAnimatedFrame=sonicManager.drawTickCount;this.lastAnimatedIndex=(this.lastAnimatedIndex+1)%this.animated.Frames.length}};TileChunk.prototype.draw=function(c,k,m,g,b){if(g==1&&b==undefined&&this.animated!=undefined){b=this.lastAnimatedIndex}var d;if((d=sonicManager.SpriteCache.tileChunks[g+" "+this.index+" "+m.y+" "+m.x+" "+((b!=undefined)?b:"-")])){if(d==1){return}if(d.loaded){c.drawImage(d,k.x,k.y)}}else{for(var e=0;e<this.tilePieces.length;e++){for(var f=0;f<this.tilePieces[e].length;f++){var l=this.tilePieces[e][f];var h=sonicManager.SonicLevel.Blocks[l.Block];if(h){h.draw(c,{x:k.x+e*16*m.x,y:k.y+f*16*m.y},m,g,l.XFlip,l.YFlip,this.animated,b)}}}}return true}}function TileItem(){TileItem.prototype.draw=function(){}}function TilePiece(a,b){this.tiles=b;TilePiece.prototype.click=function(d,e,c){};TilePiece.prototype.mouseOver=function(c,d){};TilePiece.prototype.onlyBackground=function(){for(var c=0;c<this.tiles.length;c++){var d=this.tiles[c];if(sonicManager.SonicLevel.Tiles[d.Tile]){if(d.Priority==true){return false}}}return true};TilePiece.prototype.drawUI=function(c,g,h,j,k){var d;if(j){if(k){d=[3,2,1,0]}else{d=[1,0,3,2]}}else{if(k){d=[2,3,0,1]}else{d=[0,1,2,3]}}for(var e=0;e<this.tiles.length;e++){var f=this.tiles[e];if(sonicManager.SonicLevel.Tiles[f.Tile]){sonicManager.SonicLevel.Tiles[f.Tile].drawUI(c,{x:g.x+(d[e]%2)*8*h.x,y:g.y+_H.floor(d[e]/2)*8*h.y},h,_H.xor(j,f.XFlip),_H.xor(k,f.YFlip),f.Palette)}}return true};TilePiece.prototype.draw=function(e,l,m,j,n,o,c,d){var f;if(n){if(o){f=[3,2,1,0]}else{f=[1,0,3,2]}}else{if(o){f=[2,3,0,1]}else{f=[0,1,2,3]}}var g;if((g=sonicManager.SpriteCache.tilePeices[j+" "+this.index+" "+m.y+" "+m.x])){if(g.loaded){e.drawImage(g,l.x,l.y)}}else{for(var h=0;h<this.tiles.length;h++){var k=this.tiles[h];if(sonicManager.SonicLevel.Tiles[k.Tile]){if(k.Priority==j){sonicManager.SonicLevel.Tiles[k.Tile].draw(e,{x:l.x+(f[h]%2)*8*m.x,y:l.y+_H.floor(f[h]/2)*8*m.y},m,_H.xor(n,k.XFlip),_H.xor(o,k.YFlip),k.Palette,j,d)}}}}return true};TilePiece.prototype.equals=function(d){for(var c=0;c<this.tiles.length;c++){if(d[c]!=this.tiles[c]){return false}}return true}}RotationMode={Floor:134,RightWall:224,Ceiling:314,LeftWall:44};function UiArea(f,g,e,b,c,a){this.x=f;this.y=g;this.manager=c;this.closable=a;this.width=e;this.height=b;this.depth=0;this.visible=true;this.dragging=false;this.controls=[];this.addControl=function(h){h.parent=this;this.controls.push(h);return h};var d=this;if(a){this.addControl(new Button(this.width-30,4,26,26,"X",this.manager.buttonFont,"Green",function(){d.visible=false}))}this.click=function(j){if(!this.visible){return}for(var k=0;k<this.controls.length;k++){var h=this.controls[k];if(h.visible&&h.y<=j.y&&h.y+h.height>j.y&&h.x<=j.x&&h.x+h.width>j.x){j.x-=h.x;j.y-=h.y;h.onClick(j);return false}}this.dragging={x:j.x,y:j.y}};this.mouseMove=function(j){if(!this.visible){return}if(!this.dragging){for(var k=0;k<this.controls.length;k++){var h=this.controls[k];if(h.visible&&h.y<=j.y&&h.y+h.height>j.y&&h.x<=j.x&&h.x+h.width>j.x){j.x-=h.x;j.y-=h.y;h.onMouseOver(j)}}return}this.x+=j.x-this.dragging.x;this.y+=j.y-this.dragging.y};this.mouseUp=function(j){if(!this.visible){return}for(var k=0;k<this.controls.length;k++){var h=this.controls[k];h.onMouseUp({x:j.x-h.x,y:j.y-h.y})}this.dragging=false};this.scroll=function(j){if(!this.visible){return}for(var k=0;k<this.controls.length;k++){var h=this.controls[k];if(h.visible&&h.y<=j.y&&h.y+h.height>j.y&&h.x<=j.x&&h.x+h.width>j.x){if(h.onScroll){j.x-=h.x;j.y-=h.y;h.onScroll(j);return false}}}};this.cachedDrawing=null;this.draw=function(l){if(!this.visible){return}var o;var q;var p;if(!this.cachedDrawing){var m=document.createElement("canvas");m.width=this.width+20;m.height=this.height+20;var n=m.getContext("2d");n.fillStyle="rgba(133,133,133,0.6)";n.lineWidth=9;n.strokeStyle="#333";var h=this.x;var k=this.y;this.x=10;this.y=10;roundRect(n,this.x,this.y,this.width,this.height,5,true,true);for(p=0;p<this.controls.length;p++){q=this.controls[p];o=q.forceDrawing();if(o.redraw){q.draw(n)}}this.x=h;this.y=k;this.cachedDrawing=_H.loadSprite(m.toDataURL("image/png"))}if(this.cachedDrawing.loaded){l.drawImage(this.cachedDrawing,_H.floor(this.x),_H.floor(this.y));if(this.cachedDrawing.width!=this.width+20||this.cachedDrawing.height!=this.height+20){this.cachedDrawing=null}_H.save(l);l.translate(10,10);for(p=0;p<this.controls.length;p++){q=this.controls[p];o=q.forceDrawing();if(!o.redraw){q.draw(l)}if(o.clearCache){this.cachedDrawing=null}}_H.restore(l)}else{l.fillStyle="rgba(133,133,133,0.6)";l.lineWidth=9;l.strokeStyle="#333";_H.save(l);l.translate(10,10);roundRect(l,this.x,this.y,this.width,this.height,5,true,true);for(p=0;p<this.controls.length;p++){q=this.controls[p];q.draw(l)}_H.restore(l)}};return this}function TextArea(d,e,c,b,a){this.forceDrawing=function(){if((_H.isFunction(this.text)?this.text():this.text)==this.oldText){return{redraw:true,clearCache:false}}this.oldText=_H.isFunction(this.text)?this.text():this.text;return{redraw:true,clearCache:true}};this.x=d;this.oldText="";this.y=e;this.visible=true;this.text=c;this.font=b;this.color=a;this.parent=null;this.onClick=function(f){return false};this.onMouseUp=function(f){if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(f){if(this.mouseOver){this.mouseOver()}};this.draw=function(f){if(!this.visible){return}var k=_H.isFunction(this.text)?this.text():this.text;if(f.font!=this.font){f.font=this.font}var l=f.measureText(k).width;var g=parseInt(f.font.split("pt")[0]);var j=3;f.strokeStyle=this.color;f.shadowColor="#FFF";f.shadowBlur=20;f.lineWidth=1.5;f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.shadowBlur=0};return this}function Button(j,k,h,d,g,c,b,a,f,e){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=j;this.y=k;this.visible=true;this.width=h;this.height=d;this.text=g;this.font=c;this.clicking=false;this.click=a;this.mouseUp=f;this.mouseOver=e;this.color=b;this.parent=null;this.onClick=function(l){if(!this.visible){return}this.clicking=true};this.onMouseUp=function(l){if(!this.visible){return}if(this.clicking){if(this.click){this.click()}}this.clicking=false;if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(l){if(!this.visible){return}if(this.mouseOver){this.mouseOver()}};this.draw=function(l){if(!this.visible){return}l.fillStyle=this.color;l.strokeStyle="#DAC333";l.lineWidth=2;roundRect(l,this.parent.x+this.x,this.parent.y+this.y,this.width,this.height,5,true,true);l.fillStyle=this.clicking?"#FCA":"#334";if(l.font!=this.font){l.font=this.font}l.fillText(this.text,this.parent.x+this.x+((this.width/2)-(l.measureText(this.text).width/2)),this.parent.y+this.y+(this.height/3)*2)};return this}function TilePieceArea(d,e,a,c,b){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=d;this.y=e;this.visible=true;this.scale=a;this.width=a.x*16;this.height=a.y*17;this.clicking=false;this.tilePiece=c;this.parent=null;this.state=b;this.onClick=function(f){if(!this.visible){return}this.clicking=true;this.clickHandled=false};this.onMouseUp=function(f){if(!this.visible){return}if(this.tilePiece&&this.clicking&&!this.clickHandled){this.tilePiece.click(_H.floor(f.x/a.x),_H.floor(f.y/a.y),this.state)}this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(f){if(!this.tilePiece){return}if(this.clicking){this.clickHandled=true;this.tilePiece.click(_H.floor(f.x/a.x),_H.floor(f.y/a.y),this.state)}else{this.tilePiece.mouseOver(_H.floor(f.x/a.x),_H.floor(f.y/a.y))}};this.draw=function(f){if(!this.visible){return}if(!this.tilePiece){return}this.tilePiece.tag=true;var h={x:this.parent.x+this.x,y:this.parent.y+this.y};this.tilePiece.drawUI(f,h,this.scale,this.tpc.XFlip,this.tpc.YFlip);if(sonicManager.showHeightMap){var g=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes1[this.tpc.Block]];if(g!=0&&g!=1){g.drawUI(f,h,this.scale,0,this.tpc.XFlip,this.tpc.YFlip,this.tpc.Solid1)}}this.tilePiece.tag=false};return this}function TileBGEditArea(b,c,a){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=b;this.y=c;this.visible=true;this.clicking=false;this.parallaxBG=a;this.parent=null;this.lowestClickedY=-1;this.highestClickedY=-1;this.onClick=function(f){if(!this.visible){return}this.clicking=true;this.parallaxBG=sonicManager.background;if(f.x>0&&f.y>0&&f.y<this.parallaxBG.height&&f.x<this.parallaxBG.width){var d;if((d=this.parallaxBG.onBar(f.x,f.y))){this.lowestClickedY=d.top;this.highestClickedY=d.bottom}else{this.lowestClickedY=f.y;this.highestClickedY=f.y}}this.clickHandled=false};this.onMouseUp=function(d){if(!this.visible){return}this.parallaxBG=sonicManager.background;this.highestClickedY=-1;this.lowestClickedY=-1;this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(d){if(!this.clicking){return}this.parallaxBG=sonicManager.background;if(d.x>0&&d.y>0&&d.y<this.parallaxBG.height&&d.x<this.parallaxBG.width){if(d.y>this.highestClickedY){this.highestClickedY=d.y}if(d.y<this.lowestClickedY){this.lowestClickedY=d.y}for(var f=this.lowestClickedY;f<this.highestClickedY;f++){this.parallaxBG.click(d.x,f)}}return false};this.draw=function(d){if(!this.visible){return}this.parallaxBG=sonicManager.background;if(!this.parallaxBG){return}this.width=this.parallaxBG.width;this.height=this.parallaxBG.height;this.parent.width=this.width+70;this.parent.height=this.height+50;var e={x:1,y:1};this.parallaxBG.drawUI(d,{x:this.parent.x+this.x,y:this.parent.y+this.y},e)};return this}function TileChunkArea(d,e,a,c,b){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=d;this.y=e;this.visible=true;this.scale=a;this.width=a.x*128;this.height=a.y*128;this.clicking=false;this.tileChunk=c;this.parent=null;this.state=b;this.setToTile=null;this.onClick=function(f){if(!this.visible){return}this.clicking=true};this.onMouseUp=function(f){if(!this.visible){return}if(this.clicking){if(this.setToTile!=null){this.tileChunk.tilePieces[((_H.floor(f.x/this.scale.x/16)))][(_H.floor(f.y/this.scale.y/16))]=sonicManager.SonicLevel.Blocks.indexOf(this.setToTile);this.tileChunk.sprites=[]}}this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(f){if(this.clicking){}};this.draw=function(f){if(!this.visible){return}if(!this.tileChunk){return}this.tileChunk.draw(f,{x:this.parent.x+this.x,y:this.parent.y+this.y},this.scale,true)};return this}function ScrollBox(g,h,c,f,d,a,b){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=g;this.y=h;this.itemWidth=d;this.visible=true;var e=14;this.width=d+e;this.visibleItems=f;this.itemHeight=c;this.backColor=a;this.height=f*c;this.parent=null;this.scrollOffset=0;this.scrollPosition=0;this.dragging=false;if(b){this.controls=b}else{this.controls=[]}this.scrolling=false;this.addControl=function(j){j.parent=this;this.controls.push(j);return j};this.onClick=function(k){if(!this.visible){return}for(var l=this.scrollOffset;l<this.controls.length;l++){var j=this.controls[l];if(j.y<=k.y&&j.y+j.height>k.y&&j.x<=k.x&&j.x+j.width>k.x){k.x-=j.x;k.y-=j.y;j.onClick(k);return false}}if(k.x>this.itemWidth&&k.x<this.itemWidth+e){if(this.scrollPosition>k.y){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}}this.dragging=true;return false};this.onMouseUp=function(k){if(!this.visible){return}this.dragging=false;for(var l=this.scrollOffset;l<this.controls.length;l++){var j=this.controls[l];if(j.y<=k.y&&j.y+j.height>k.y&&j.x<=k.x&&j.x+j.width>k.x){k.x-=j.x;k.y-=j.y;j.onMouseUp(k);return false}}if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(k){if(!this.visible){return}for(var l=0;l<this.controls.length;l++){var j=this.controls[l];if(j.y<=k.y&&j.y+j.height>k.y&&j.x<=k.x&&j.x+j.width>k.x){k.x-=j.x;k.y-=j.y;j.onMouseOver(k);break}}if(this.dragging&&k.x>this.itemWidth&&k.x<this.itemWidth+e){if(this.scrollPosition>k.y){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}}if(this.mouseOver){this.mouseOver()}};this.onScroll=function(k){if(!this.visible){return}if(k.delta>0){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}for(var l=0;l<this.controls.length;l++){var j=this.controls[l];if(j.y<=k.y&&j.y+j.height>k.y&&j.x<=k.x&&j.x+j.width>k.x){k.x-=j.x;k.y-=j.y;if(j.onScroll){j.onScroll(k)}return false}}if(this.scroll){this.scroll()}};this.draw=function(j){if(!this.visible){return}j.fillStyle=this.backColor;var l;j.fillStyle=this.backColor;j.lineWidth=1;j.strokeStyle="#333";roundRect(j,this.parent.x+this.x,this.parent.y+this.y,this.itemWidth+e+6,this.visibleItems*this.itemHeight,3,true,true);j.fillStyle="grey";j.lineWidth=1;j.strokeStyle="#444";j.fillRect(this.parent.x+this.x+this.itemWidth+2+2,this.parent.y+this.y+2,e,this.visibleItems*this.itemHeight-2);j.fillStyle="red";j.lineWidth=1;j.strokeStyle="#444";this.scrollPosition=(this.visibleItems*this.itemHeight-2)*this.scrollOffset/this.controls.length;j.fillRect(this.parent.x+this.x+this.itemWidth+2+2+2,this.parent.y+this.y+2+(this.scrollPosition),e-2,5);var k=1;for(l=this.scrollOffset;l<Math.min(this.controls.length,this.scrollOffset+this.visibleItems);l++){this.controls[l].parent={x:this.parent.x+this.x,y:this.parent.y+this.y};this.controls[l].x=2;this.controls[l].y=k;this.controls[l].height=this.itemHeight;this.controls[l].width=this.itemWidth;k+=this.itemHeight;this.controls[l].draw(j)}};return this}function roundRect(a,g,h,f,c,d,b,e){if(typeof e=="undefined"){e=true}if(typeof d==="undefined"){d=5}a.beginPath();a.moveTo(g+d,h);a.lineTo(g+f-d,h);a.quadraticCurveTo(g+f,h,g+f,h+d);a.lineTo(g+f,h+c-d);a.quadraticCurveTo(g+f,h+c,g+f-d,h+c);a.lineTo(g+d,h+c);a.quadraticCurveTo(g,h+c,g,h+c-d);a.lineTo(g,h+d);a.quadraticCurveTo(g,h,g+d,h);a.closePath();if(e){a.stroke()}if(b){a.fill()}}function UIManager(u,m,s){this.UIAreas=[];this.messages=[];var w=this.textFont="18pt sans-serrif ";var c=this.buttonFont="13pt Arial bold";m.font=w;var g=this.indexes={tpIndex:0,modifyIndex:0,modifyTPIndex:0};this.dragger=new Dragger(function(x,y){u.windowLocation.x+=x;u.windowLocation.y+=y});this.draw=function(y){this.dragger.tick();_H.save(y);var z=JSLINQ(this.UIAreas).OrderBy(function(C){return C.depth});for(var B=0;B<z.items.length;B++){var x=z.items[B];x.draw(y)}if(DEBUGs){for(var A=0;A<this.messages.length;A++){y.fillText(this.messages[A],10,25+A*30)}}_H.restore(y)};this.onMouseScroll=function(z){var y=z.wheelDelta?z.wheelDelta/40:z.detail?-z.detail:0;for(var A=0;A<this.UIAreas.length;A++){var x=this.UIAreas[A];if(x.visible&&x.y<=z.y&&x.y+x.height>z.y&&x.x<=z.x&&x.x+x.width>z.x){z={x:z.x-x.x-10,y:z.y-x.y-10,delta:y};return x.scroll(z)}}return false};this.onClick=function(A){var y=_H.getCursorPosition(A);y.x-=10;y.y-=10;var C=null;var x;var D;var z=JSLINQ(this.UIAreas).OrderBy(function(E){return -E.depth});for(var D=0;D<z.items.length;D++){var x=z.items[D];if(x.visible&&x.y<=y.y&&x.y+x.height>y.y&&x.x<=y.x&&x.x+x.width>y.x){C=x;var B={x:y.x-x.x,y:y.y-x.y};x.click(B);break}}if(C){for(D=0;D<this.UIAreas.length;D++){x=this.UIAreas[D];if(C==x){x.depth=1}else{x.depth=0}}return true}return false};this.onMouseMove=function(A){if(this.dragger.isDragging()){this.dragger.mouseMove(A);return false}var y=_H.getCursorPosition(A);y.x-=10;y.y-=10;var z=JSLINQ(this.UIAreas).OrderBy(function(C){return -C.depth});for(var B=0;B<z.items.length;B++){var x=z.items[B];if(x.dragging||(x.visible&&x.y<=y.y&&x.y+x.height>y.y&&x.x<=y.x&&x.x+x.width>y.x)){y={x:y.x-x.x,y:y.y-x.y};return x.mouseMove(y)}}this.dragger.mouseMove(A);return false};this.onMouseUp=function(z){var y=_H.getCursorPosition(z,true);y.x-=10;y.y-=10;for(var B=0;B<this.UIAreas.length;B++){var x=this.UIAreas[B];var A={x:y.x-x.x,y:y.y-x.y};x.mouseUp(A)}this.dragger.mouseUp(z)};var f=this.debuggerArea=new UiArea(1347,95,200,240,this,true);f.visible=false;this.UIAreas.push(f);f.addControl(new TextArea(30,25,"Debugger",w,"blue"));f.addControl(new Button(40,60,60,22,"Stop",c,"rgb(50,150,50)",function(){u.windowLocation=_H.defaultWindowLocation(1,m,s);f.visible=false;t.visible=false;h.visible=true;j.visible=true;u.sonicToon=null}));f.addControl(new Button(40,95,90,22,"Hit Sonic",c,"rgb(50,150,50)",function(){u.sonicToon.hit()}));f.addControl(new Button(40,130,160,22,"Show Height Map",c,"rgb(50,150,50)",function(){if(this.text=="Show Height Map"){u.showHeightMap=true;this.text="Hide Height Map"}else{u.showHeightMap=false;this.text="Show Height Map"}}));f.addControl(new Button(40,160,160,22,"Switch Height Map",c,"rgb(50,150,50)",function(){u.SonicLevel.curHeightMap=!u.SonicLevel.curHeightMap}));f.addControl(new Button(40,190,160,22,"Debug Sonic",c,"rgb(50,150,50)",function(){if(this.text=="Debug Sonic"){u.sonicToon.debugging=true;this.text="Normal Sonic"}else{u.sonicToon.debugging=false;this.text="Debug Sonic"}}));var t=this.solidTileArea=new UiArea(40,450,430,400,this,true);t.visible=false;this.UIAreas.push(t);t.addControl(new TextArea(30,25,"Modify Solid Tile",w,"blue"));t.addControl(new Button(50,35,25,22,"<<",c,"rgb(50,150,50)",function(){if(g.tpIndex>0){q.tilePiece=u.SonicLevel.Blocks[--g.tpIndex]}}));t.addControl(new Button(75,35,25,22,">>",c,"rgb(50,150,50)",function(){if(g.tpIndex<u.SonicLevel.Blocks.length){q.tilePiece=u.SonicLevel.Blocks[++g.tpIndex]}}));t.addControl(new Button(360,80,45,22,"Full",c,"rgb(50,150,50)",function(){for(var x=0;x<16;x++){q.tilePiece.heightMask.items[x]=16}this.sprites=[]}));t.addControl(new Button(200,35,180,22,"Modify Height Map",c,"rgb(50,150,50)",function(){q.state=(q.state+1)%3;switch(q.state){case 0:this.text="Modify Height Map";break;case 1:this.text="Modify Tile Direction";break;case 2:this.text="Modify Tile Colors";break}}));var q=this.modifyTilePieceArea=new TilePieceArea(30,70,{x:4*5,y:4*5},null,0);t.addControl(q);var b=this.bgEditor=new UiArea(100,440,420,360,this,true);b.visible=false;this.UIAreas.push(b);b.addControl(new TextArea(30,25,"BG Editor",w,"blue"));b.addControl(new TileBGEditArea(60,35));var h=this.levelInformation=new UiArea(70,70,470,360,this);h.visible=true;this.UIAreas.push(h);h.addControl(new TextArea(30,25,"Level Selector",w,"blue"));h.addControl(new TextArea(30,52,function(){return !e?"Level Not Saved":(e)},w,"black"));h.addControl(new Button(250,70,100,22,"Save Level",c,"rgb(50,150,50)",function(){if(e){OurSonic.SonicLevels.SaveLevelInformation(e,Base64.encode(_H.stringify(u.SonicLevel)),function(x){},function(x){alert("Failure: "+_H.stringify(x))})}else{OurSonic.SonicLevels.saveLevel(Base64.encode(_H.stringify(u.SonicLevel)),function(x){a(e)})}}));var v;h.addControl(v=new Button(250,105,160,22,"Load Empty Level",c,"rgb(50,150,50)",function(){j.visible=true;l.visible=true;var x=0;var y=function(){var z=188;if(x==z){setTimeout(function(){alert(_H.stringify(u.SonicLevel));k(_H.stringify(u.SonicLevel),m);l.visible=false},500);return}setTimeout(y,100);_H.loadSprite("assets/Chunks/Tile"+x+++".png",function(A){l.text="Loading "+x+"/"+z;u.importChunkFromImage(A);if(x==z){u.inds={done:true}}})};setTimeout(y,100)}));v.visible=false;var d;h.addControl(d=new ScrollBox(30,70,25,11,190,"rgb(50,60,127)"));var e;OurSonic.SonicLevels.getLevels(function(z){for(var x=0;x<z.length;x++){var y=z[x];a(y)}});function a(y){var x;d.addControl(x=new Button(0,0,0,0,y,"10pt Arial","rgb(50,190,90)",function(){e="Downloading";OurSonic.SonicLevels.getLevel(y,function(z){e="loading";e=y;k(z,m)})}))}var j=this.levelManagerArea=new UiArea(500,25,400,400,this);j.visible=false;this.UIAreas.push(j);j.addControl(new TextArea(30,25,"Level Manager",w,"blue"));var l;j.addControl(l=new TextArea(270,25,"Loading",w,"green"));l.visible=false;j.addControl(new Button(35,100,160,22,"Show Height Map",c,"rgb(50,150,50)",function(){if(this.text=="Show Height Map"){u.showHeightMap=true;this.text="Hide Height Map"}else{u.showHeightMap=false;this.text="Show Height Map"}}));j.addControl(new Button(200,150,160,22,"Dragging",c,"rgb(50,150,50)",function(){u.clickState=(u.clickState+1)%4;switch(u.clickState){case ClickState.PlaceChunk:this.text="Modify Chunks";break;case ClickState.Dragging:this.text="Dragging";break;case ClickState.PlaceRing:this.text="Place Rings";break;case ClickState.PlaceObject:this.text="Place Object";break}}));j.addControl(new Button(200,180,160,22,"Switch Height Map",c,"rgb(50,150,50)",function(){u.SonicLevel.curHeightMap=!u.SonicLevel.curHeightMap}));j.addControl(new Button(35,150,160,22,"Modify Chunks",c,"rgb(50,150,50)",function(){p.visible=true}));j.addControl(new Button(35,150,160,22,"Modify Chunks",c,"rgb(50,150,50)",function(){p.visible=true}));j.addControl(new Button(35,175,160,22,"Modify Tile Pieces",c,"rgb(50,150,50)",function(){t.visible=true}));j.addControl(new Button(35,200,160,22,"Modify Tiles",c,"rgb(50,150,50)",function(){o.visible=true}));j.addControl(new Button(35,240,160,22,"Modify Background",c,"rgb(50,150,50)",function(){b.visible=true}));j.addControl(new Button(200,35,60,22,"Run",c,"rgb(50,150,50)",function(){j.visible=false;t.visible=false;h.visible=false;o.visible=false;p.visible=false;t.visible=false;f.visible=true;if(u.background){u.background.cache(u.scale)}u.windowLocation=_H.defaultWindowLocation(0,m,s);u.sonicToon=new Sonic(u.SonicLevel,u.scale);u.sonicToon.obtainedRing=[]}));var p=this.modifyTileChunkArea=new UiArea(900,450,400,400,this,true);p.visible=false;this.UIAreas.push(p);p.addControl(new TextArea(30,25,"Modify Tile Chunk",w,"blue"));var n=this.modifyTC=new TileChunkArea(30,70,{x:2,y:2},null,1);p.addControl(n);p.addControl(new Button(50,35,25,22,"<<",c,"rgb(50,150,50)",function(){if(g.modifyIndex>0){n.tileChunk=u.SonicLevel.Chunks[--g.modifyIndex]}}));p.addControl(new Button(80,35,25,22,">>",c,"rgb(50,150,50)",function(){if(g.modifyIndex<u.SonicLevel.Chunks.length){n.tileChunk=u.SonicLevel.Chunks[++g.modifyIndex]}}));var r=this.modifyTP=new TilePieceArea(300,160,{x:2*3,y:2*3},null,3);p.addControl(r);p.addControl(new Button(300,100,25,22,"<<",c,"rgb(50,150,50)",function(){if(g.modifyTPIndex>0){r.tilePiece=n.setToTile=u.SonicLevel.Blocks[--g.modifyTPIndex]}}));p.addControl(new Button(330,100,25,22,">>",c,"rgb(50,150,50)",function(){if(g.modifyTPIndex<u.SonicLevel.Blocks.length){r.tilePiece=n.setToTile=u.SonicLevel.Blocks[++g.modifyTPIndex]}}));var o=this.modifyTileArea=new UiArea(900,25,400,400,this,true);o.visible=false;this.UIAreas.push(o);o.addControl(new TextArea(30,25,"Modify Tile",w,"blue"));function k(L,N){u.loading=true;u.SonicLevel=jQuery.parseJSON(L);var C;var H;if(!u.SonicLevel.Chunks){u.SonicLevel.Chunks=[]}if(!u.SonicLevel.Blocks){u.SonicLevel.Blocks=[]}if(!u.SonicLevel.Tiles){u.SonicLevel.Tiles=[]}if(!u.SonicLevel.Rings){u.SonicLevel.Rings=[]}u.SonicLevel.LevelWidth=u.SonicLevel.ForegroundWidth;u.SonicLevel.LevelHeight=u.SonicLevel.ForegroundHeight;var O=decodeNumeric(u.SonicLevel.Foreground);u.SonicLevel.ChunkMap=[];u.SonicLevel.ChunkMap.length=u.SonicLevel.ForegroundWidth;for(var V=0;V<u.SonicLevel.ForegroundWidth;V++){u.SonicLevel.ChunkMap[V]=[];u.SonicLevel.ChunkMap[V].length=u.SonicLevel.ForegroundHeight;for(var W=0;W<u.SonicLevel.ForegroundHeight;W++){u.SonicLevel.ChunkMap[V][W]=O[V+W*u.SonicLevel.ForegroundWidth]}}var O=decodeNumeric(u.SonicLevel.Background);u.SonicLevel.BGChunkMap=[];u.SonicLevel.BGChunkMap.length=u.SonicLevel.BackgroundWidth;for(var V=0;V<u.SonicLevel.BackgroundWidth;V++){u.SonicLevel.BGChunkMap[V]=[];u.SonicLevel.BGChunkMap[V].length=u.SonicLevel.BackgroundHeight;for(var W=0;W<u.SonicLevel.BackgroundHeight;W++){u.SonicLevel.BGChunkMap[V][W]=O[V+W*u.SonicLevel.BackgroundWidth]}}for(var K=0;K<u.SonicLevel.Objects.length;K++){var S=u.SonicLevel.Objects[K];u.SonicLevel.Objects[K]=_H.ObjectParse(S)}u.SonicLevel.curHeightMap=true;for(H=0;H<u.SonicLevel.Tiles.length;H++){C=u.SonicLevel.Tiles[H];u.SonicLevel.Tiles[H]=decodeNumeric(C);var P=[];for(var K=0;K<u.SonicLevel.Tiles[H].length;K++){var Y=u.SonicLevel.Tiles[H][K];P.push(Y>>4);P.push(Y&15)}u.SonicLevel.Tiles[H]={colors:P};var X=u.SonicLevel.Tiles[H];var O=[];O.length=8;for(var S=0;S<8;S++){O[S]=[];O[S].length=8}for(var R=0;R<X.colors.length;R++){O[R%8][_H.floor(R/8)]=X.colors[R]}X.colors=O;X.__proto__=Tile.prototype;X.index=H}var x=u.SonicLevel.AnimatedChunks=[];if(u.SonicLevel.AnimatedFiles){for(I=0;I<u.SonicLevel.AnimatedFiles.length;I++){var D=u.SonicLevel.AnimatedFiles[I];for(H=0;H<D.length;H++){C=D[H];D[H]=decodeNumeric(C);var P=[];for(var K=0;K<D[H].length;K++){var Y=D[H][K];P.push(Y>>4);P.push(Y&15)}D[H]={colors:P};var X=D[H];var O=[];O.length=8;for(var S=0;S<8;S++){O[S]=[];O[S].length=8}for(var R=0;R<X.colors.length;R++){O[R%8][_H.floor(R/8)]=X.colors[R]}X.colors=O;X.__proto__=Tile.prototype;X.index="A"+H+"_"+I}}}for(H=0;H<u.SonicLevel.Blocks.length;H++){C=u.SonicLevel.Blocks[H];var P={};P.__proto__=TilePiece.prototype;P.index=H;P.tiles=[];for(var T=0;T<C.length;T++){P.tiles.push(C[T]);C[T].__proto__=TileItem.prototype}u.SonicLevel.Blocks[H]=P}var J;for(var F=0;F<u.SonicLevel.HeightMaps.length;F++){var y=true;var z=true;for(var M=0;M<u.SonicLevel.HeightMaps[F].length;M++){if(y&&u.SonicLevel.HeightMaps[F][M]!=0){y=false}if(z&&u.SonicLevel.HeightMaps[F][M]!=16){z=false}}if(y){u.SonicLevel.HeightMaps[F]=0}else{if(z){u.SonicLevel.HeightMaps[F]=1}else{u.SonicLevel.HeightMaps[F]=new HeightMask(0,u.SonicLevel.HeightMaps[F])}}}u.SonicLevel.Angles=decodeNumeric(u.SonicLevel.Angles);u.SonicLevel.CollisionIndexes1=decodeNumeric(u.SonicLevel.CollisionIndexes1);u.SonicLevel.CollisionIndexes2=decodeNumeric(u.SonicLevel.CollisionIndexes2);var I;for(H=0;H<u.SonicLevel.Chunks.length;H++){C=u.SonicLevel.Chunks[H];var P={};P.__proto__=TileChunk.prototype;P.index=H;P.tilePieces=[];P.tilePieces.length=8;for(var F=0;F<8;F++){P.tilePieces[F]=[];P.tilePieces[F].length=8}for(var T=0;T<C.length;T++){P.tilePieces[T%8][_H.floor(T/8)]=(C[T])}u.SonicLevel.Chunks[H]=P;P.animated=undefined;for(var G=0;G<P.tilePieces.length;G++){for(var I=0;I<P.tilePieces[G].length;I++){var W=P.tilePieces[G][I];var U=u.SonicLevel.Blocks[W.Block];if(U){for(var A=0;A<U.tiles.length;A++){var Q=U.tiles[A];if(u.SonicLevel.Tiles[Q.Tile]){var B=u.containsAnimatedTile(Q.Tile);if(B!=undefined){P.animated=B;x.push(P);break}}}if(P.animated){break}}if(P.animated){break}}}}var E=function(){j.visible=true;u.loading=false;n.tileChunk=u.SonicLevel.Chunks[0];q.tilePiece=r.tilePiece=u.SonicLevel.Blocks[0]};e="preloading sprites";u.CACHING=true;u.preLoadSprites(s,function(){u.CACHING=false;E();e="level loaded";u.forceResize()},function(Z){e=Z})}}function Dragger(a){this.lastPos=null;this.xsp=0;this.ysp=0;this.lag=0.925;this.click=function(b){this.lastPos={x:b.x,y:b.y}};this.isDragging=function(b){return this.lastPos};this.mouseUp=function(b){this.lastPos=null};this.mouseMove=function(b){if(!this.lastPos){return}this.xsp+=(this.lastPos.x-b.x)*2.7;this.ysp+=(this.lastPos.y-b.y)*2.7;this.xsp=(this.xsp>0?1:-1)*Math.min(Math.abs(this.xsp),60);this.ysp=(this.ysp>0?1:-1)*Math.min(Math.abs(this.ysp),60);this.lastPos={x:b.x,y:b.y}};this.tick=function(){a(this.xsp,this.ysp);if(this.xsp>0){this.xsp*=this.lag}else{this.xsp*=this.lag}if(this.ysp>0){this.ysp*=this.lag}else{this.ysp*=this.lag}if(Math.abs(this.xsp)<=2){this.xsp=0}if(Math.abs(this.ysp)<=2){this.ysp=0}}};