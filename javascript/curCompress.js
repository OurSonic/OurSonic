function HeightMask(c,d){this.width=16;this.height=16;this.angle=c;this.items=d?d:[];HeightMask.prototype.setItem=function(j,k,h){var a=0,b=0;switch(h){case RotationMode.Floor:a=j;b=k;break;case RotationMode.RightWall:a=k;b=j;break;case RotationMode.Ceiling:a=j;b=15-k;break;case RotationMode.LeftWall:a=k;b=15-j;break;default:}this.items[a]=16-b};this.colors=["rgba(24,98,235,0.6)","rgba(255,98,235,0.6)","rgba(24,218,235,0.6)","rgba(24,98,235,0.6)"];HeightMask.prototype.draw=function(r,v,w,y,A,C,x){var s;if((s=sonicManager.SpriteCache.heightMaps[this.index+" "+w.y+" "+w.x])){if(s.loaded){r.drawImage(s,v.x,v.y)}}else{for(var z=0;z<16;z++){for(var B=0;B<16;B++){var t=0,u=0;if(A){if(C){t=15-z;u=15-B}else{t=15-z;u=B}}else{if(C){t=z;u=15-B}else{t=z;u=B}}var a=v.x+(t*w.x);var b=v.y+(u*w.y);r.lineWidth=1;if(y<=0&&this.items[z]>=16-B&&x>0){r.fillStyle=this.colors[x];r.fillRect(a,b,w.x,w.y)}else{if(y!=-1){r.lineWidth=1;r.strokeStyle="#0C3146";r.strokeRect(a,b,w.x,w.y)}}}}if(y==1){r.strokeStyle="#DC4146";r.lineWidth=4;r.moveTo(v.x+8*w.x,v.y+8*w.y);r.lineTo(v.x+8*w.x+_H.sin((this.angle))*6*w.x,v.y+8*w.y+_H.cos((this.angle))*6*w.y);r.stroke()}}}}window._H={floor:function(b){if(b>0){return ~~b}return Math.floor(b)},min:function(c,d){return c>d?d:c},max:function(c,d){return c<d?d:c},xor:function(c,d){return(c&&!d)||(!c&&d)},loadSprite:function(f,d){var e=new Image();e.onload=function(){e.loaded=true;if(d){d(e)}};e.src=f;return e},fixAngle:function(d){var e=Math.floor((256-d)*1.4062)%360;var f=360-e;return _H.degtorad(f)},degtorad:function(b){return b*Math.PI/180},sign:function(b){return b==0?0:(b<0?-1:1)},defaultWindowLocation:function(b){switch(b){case 0:return{x:0,y:0,width:320,height:240,intersects:_H.intersects};case 1:return{x:0,y:0,width:900,height:240*2,intersects:_H.intersects}}return null},ObjectParse:function(b){switch(b.ID){case 1:return new MonitorObject(b);break;case 7:return new SpringObject(b);break}return new LevelObject(b)},intersects:function(b){if(this.x<b.X&&this.x+this.width>b.X&&this.y<b.Y&&this.y+this.height>b.Y){return true}return false},defaultCanvas:function(h,g){var e=document.createElement("canvas");e.width=h;e.height=g;var f=e.getContext("2d");f.width=h;f.height=g;return{canvas:e,context:f}},intersectRect:function(c,d){return !(d.left>c.right||d.right<c.left||d.top>c.bottom||d.bottom<c.top)},remove:function(d,e){var f=-1;while((f=d.indexOf(e))>-1){d.splice(f,1)}},getShortsFromInt:function(d,e){var f=-1;while((f=d.indexOf(e))>-1){d.splice(f,1)}},scaleSprite:function(o,n,f){var l=_H.getImageData(o);var d=[];for(var m=0;m<l.length;m+=4){d.push(_H.colorObjectFromData(l,m))}var k=this.defaultCanvas().context.createImageData(o.width*n.x,o.height*n.y);_H.setDataFromColors(k.data,d,n,o.width,{r:0,g:0,b:0});return _H.loadSprite(_H.getBase64Image(k),f)},getCursorPosition:function(c,d){if(c.targetTouches&&c.targetTouches.length>0){c=c.targetTouches[0]}if(c.pageX!=null&&c.pageY!=null){return{x:c.pageX,y:c.pageY}}if(c.x!=null&&c.y!=null){return{x:c.x,y:c.y}}return{x:c.clientX,y:c.clientY}},colorFromData:function(o,n){var q=o[n];var p=o[n+1];var m=o[n+2];var g=q.toString(16);var c=p.toString(16);var b=m.toString(16);return"#"+(g.length==1?"0"+g:g)+(c.length==1?"0"+c:c)+(b.length==1?"0"+b:b)},colorObjectFromData:function(g,c){var k=g[c];var j=g[c+1];var b=g[c+2];return{r:k,g:j,b:b}},parseNumber:function(b){switch(b){case"0":return 0;case"1":return 1;case"2":return 2;case"3":return 3;case"4":return 4;case"5":return 5;case"6":return 6;case"7":return 7;case"8":return 8;case"9":return 9;case"a":return 10;case"b":return 11;case"c":return 12;case"d":return 13;case"e":return 14;case"f":return 15;case"g":return 16}return -1},setDataFromColors:function(u,g,A,C,B){for(var w=0;w<g.length;w++){var j=(w%C);var k=_H.floor(w/C);var v=g[w];var x=false;if(B){if(v.r==B.r&&v.g==B.g&&v.b==B.b){x=true}}for(var y=0;y<A.x;y++){for(var z=0;z<A.y;z++){var D=(j*A.x+y);var E=(k*A.y+z);var c=(D+E*(A.x*C))*4;if(x){u[c+0]=0;u[c+1]=0;u[c+2]=0;u[c+3]=0;continue}u[c]=v.r;u[c+1]=v.g;u[c+2]=v.b;u[c+3]=255}}}},getImageData:function(h){var e=document.createElement("canvas");e.width=h.width;e.height=h.height;var f=e.getContext("2d");f.drawImage(h,0,0);var g=f.getImageData(0,0,h.width,h.height);return g.data},getBase64Image:function(g){var e=document.createElement("canvas");e.width=g.width;e.height=g.height;var f=e.getContext("2d");f.putImageData(g,0,0);var h=e.toDataURL("image/png");return h},isFunction:function(c){var d={};return c&&d.toString.call(c)=="[object Function]"},detect:function(f,d){for(var e in f){if(typeof(f[e])=="object"){if(d[f[e]]){alert("circ")}d[f[e]]=true;this.detect(f[e],d)}}},stringify:function(m,j){return JSON.stringify(m,function(a,b){if(a=="imageData"){return undefined}if(a=="oldScale"){return undefined}if(a=="sprite"){return undefined}if(a=="sprites"){return undefined}if(a=="index"){return undefined}if(a=="_style"){return undefined}else{return b}});if(j>0){return""}if(!j){j=0}var n=typeof(m);if(n!="object"||m===null){if(n=="string"){m='"'+m+'"'}return String(m)}else{var l,o,k=[],h=(m&&m.constructor==Array);for(l in m){o=m[l];n=typeof(o);if(n=="string"){o='"'+o+'"'}else{if(n=="object"&&o!==null){o=stringify(o,j+1)}}k.push((h?"":'"'+l+'":')+String(o))}return(h?"[":"{")+String(k)+(h?"]":"}")}},sin:function(b){return cos_table[(b+64)&255]},cos:function(b){return cos_table[(b)&255]}};window.cos_table=[1,0.9997,0.9988,0.99729,0.99518,0.99248,0.98918,0.98528,0.9807900000000001,0.9757,0.97003,0.96378,0.95694,0.94953,0.94154,0.93299,0.92388,0.91421,0.90399,0.89322,0.88192,0.87009,0.85773,0.84485,0.83147,0.81758,0.80321,0.78835,0.77301,0.7572100000000001,0.74095,0.72425,0.70711,0.68954,0.6715600000000001,0.65317,0.63439,0.6152300000000001,0.5957,0.57581,0.55557,0.535,0.5141,0.4929,0.4714,0.44961,0.42755,0.40524,0.38268,0.3599,0.33689,0.31368,0.29028,0.26671,0.24298,0.2191,0.19509,0.17096,0.14673,0.12241,0.09802,0.07356,0.04907,0.02454,0,-0.02454,-0.04907,-0.07356,-0.09802,-0.12241,-0.14673,-0.17096,-0.19509,-0.2191,-0.24298,-0.26671,-0.29028,-0.31368,-0.33689,-0.3599,-0.38268,-0.40524,-0.42755,-0.44961,-0.4714,-0.4929,-0.5141,-0.535,-0.55557,-0.57581,-0.5957,-0.6152300000000001,-0.63439,-0.65317,-0.6715600000000001,-0.68954,-0.70711,-0.72425,-0.74095,-0.7572100000000001,-0.77301,-0.78835,-0.80321,-0.81758,-0.83147,-0.84485,-0.85773,-0.87009,-0.88192,-0.89322,-0.90399,-0.91421,-0.92388,-0.93299,-0.94154,-0.94953,-0.95694,-0.96378,-0.97003,-0.9757,-0.9807900000000001,-0.98528,-0.98918,-0.99248,-0.99518,-0.99729,-0.9988,-0.9997,-1,-0.9997,-0.9988,-0.99729,-0.99518,-0.99248,-0.98918,-0.98528,-0.9807900000000001,-0.9757,-0.97003,-0.96378,-0.95694,-0.94953,-0.94154,-0.93299,-0.92388,-0.91421,-0.90399,-0.89322,-0.88192,-0.87009,-0.85773,-0.84485,-0.83147,-0.81758,-0.80321,-0.78835,-0.77301,-0.7572100000000001,-0.74095,-0.72425,-0.70711,-0.68954,-0.6715600000000001,-0.65317,-0.63439,-0.6152300000000001,-0.5957,-0.57581,-0.55557,-0.535,-0.5141,-0.4929,-0.4714,-0.44961,-0.42756,-0.40524,-0.38268,-0.3599,-0.33689,-0.31368,-0.29028,-0.26671,-0.24298,-0.2191,-0.19509,-0.17096,-0.14673,-0.12241,-0.09802,-0.07356,-0.04907,-0.02454,-0,0.02454,0.04907,0.07356,0.09802,0.12241,0.14673,0.17096,0.19509,0.2191,0.24298,0.26671,0.29028,0.31368,0.33689,0.3599,0.38268,0.40524,0.42756,0.44961,0.4714,0.4929,0.5141,0.535,0.55557,0.57581,0.5957,0.6152300000000001,0.63439,0.65317,0.6715600000000001,0.68954,0.70711,0.72425,0.74095,0.7572100000000001,0.77301,0.78835,0.80321,0.81758,0.83147,0.84485,0.85773,0.87009,0.88192,0.89322,0.90399,0.91421,0.92388,0.93299,0.94154,0.94953,0.95694,0.96378,0.97003,0.9757,0.9807900000000001,0.98528,0.98918,0.99248,0.99518,0.99729,0.9988,0.9997];var base64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");var base64inv={};for(var i=0;i<base64chars.length;i++){base64inv[base64chars[i]]=i}window.decodeNumeric=function(k){k=k.replace(new RegExp("[^"+base64chars.join("")+"=]","g"),"");var h=(k.charAt(k.length-1)=="="?(k.charAt(k.length-2)=="="?"AA":"A"):"");var j=[];k=k.substr(0,k.length-h.length)+h;for(var c=0;c<k.length;c+=4){var g=(base64inv[k.charAt(c)]<<18)+(base64inv[k.charAt(c+1)]<<12)+(base64inv[k.charAt(c+2)]<<6)+base64inv[k.charAt(c+3)];j.push((g>>>16)&255);j.push((g>>>8)&255);j.push(g&255)}return j.slice(0,j.length-1)};window.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var u="";var l,m,n,o,p,q,r;var s=0;t=Base64._utf8_encode(t);while(s<t.length){l=t.charCodeAt(s++);m=t.charCodeAt(s++);n=t.charCodeAt(s++);o=l>>2;p=((l&3)<<4)|(m>>4);q=((m&15)<<2)|(n>>6);r=n&63;if(isNaN(m)){q=r=64}else{if(isNaN(n)){r=64}}u=u+this._keyStr.charAt(o)+this._keyStr.charAt(p)+this._keyStr.charAt(q)+this._keyStr.charAt(r)}return u},decode:function(t){var u="";var l,m,n;var o,p,q,r;var s=0;t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(s<t.length){o=this._keyStr.indexOf(t.charAt(s++));p=this._keyStr.indexOf(t.charAt(s++));q=this._keyStr.indexOf(t.charAt(s++));r=this._keyStr.indexOf(t.charAt(s++));l=(o<<2)|(p>>4);m=((p&15)<<4)|(q>>2);n=((q&3)<<6)|r;u=u+String.fromCharCode(l);if(q!=64){u=u+String.fromCharCode(m)}if(r!=64){u=u+String.fromCharCode(n)}}u=Base64._utf8_decode(u);return u},_utf8_encode:function(g){g=g.replace(/\r\n/g,"\n");var h="";for(var f=0;f<g.length;f++){var c=g.charCodeAt(f);if(c<128){h+=String.fromCharCode(c)}else{if((c>127)&&(c<2048)){h+=String.fromCharCode((c>>6)|192);h+=String.fromCharCode((c&63)|128)}else{h+=String.fromCharCode((c>>12)|224);h+=String.fromCharCode(((c>>6)&63)|128);h+=String.fromCharCode((c&63)|128)}}}return h},_utf8_decode:function(h){var g="";var f=0;var c=c1=c2=0;while(f<h.length){c=h.charCodeAt(f);if(c<128){g+=String.fromCharCode(c);f++}else{if((c>191)&&(c<224)){c2=h.charCodeAt(f+1);g+=String.fromCharCode(((c&31)<<6)|(c2&63));f+=2}else{c2=h.charCodeAt(f+1);c3=h.charCodeAt(f+2);g+=String.fromCharCode(((c&15)<<12)|((c2&63)<<6)|(c3&63));f+=3}}}return g}};function OutStream(){this.bytestream=new Array();this.offset=0;this.WriteBit=function(b){this.bytestream[this.offset>>>3]|=b<<(this.offset&7);this.offset++};this.Write=function(f,e){for(var d=0;d<e;++d){this.WriteBit((f>>>d)&1)}}}function InStream(d,c){this.bytestream=d;this.bitcount=c;this.offset=0;this.ReadBit=function(){var a=this.bytestream[this.offset>>>3]>>(this.offset&7);this.offset++;return a&1};this.Read=function(b){if((this.offset+b)>this.bitcount){return null}var f=0;for(var a=0;a<b;++a){f|=this.ReadBit()<<a}return f}}function LZWCompressor(b){this.output=b;this.CompressDictionary=function(){this.hashtable=new Object();this.nextcode=0;for(var a=0;a<256;++a){var d=String.fromCharCode(a);this.hashtable[d]=this.nextcode++}this.Exists=function(c){return(this.hashtable.hasOwnProperty(c))};this.Insert=function(f){var c=this.ValSizeInBits();this.hashtable[f]=this.nextcode++;return c};this.Lookup=function(c){return(this.hashtable[c])};this.ValSizeInBits=function(){var c=Math.log(this.nextcode+1)/Math.LN2;return Math.ceil(c)}};this.compress=function(n){var l=n.length;if(l==0){return output.bytestream}var c=new this.CompressDictionary();var m=c.ValSizeInBits();var o="";for(var k=0;k<l;++k){var a=n.charAt(k);if(c.Exists(o+a)){o=o+a}else{m=c.Insert(o+a);this.output.Write(c.Lookup(o),m);o=a}}this.output.Write(c.Lookup(o),m)}}function LZWDecompressor(b){this.input=b;this.DecompressDictionary=function(){this.revhashtable=new Array();this.nextcode=0;for(var a=0;a<256;++a){this.revhashtable[this.nextcode++]=String.fromCharCode(a)}this.numBits=9;this.Size=function(){return(this.nextcode)};this.Insert=function(f){this.revhashtable[this.nextcode++]=f;var e=Math.log(this.nextcode+2)/Math.LN2;this.numBits=Math.ceil(e);return this.numBits};this.LookupIndex=function(d){return this.revhashtable[d]};this.ValSizeInBits=function(){return this.numBits}};this.decompress=function(k,a){if(a==0){return""}var l=new this.DecompressDictionary();var o=l.ValSizeInBits();var n=this.input.Read(o);var p=String.fromCharCode(n);var q=p;var m="";while((n=this.input.Read(o))!=null){if(n<l.Size()){m=l.LookupIndex(n)}else{m=q+q.charAt(0)}p+=m;o=l.Insert(q+m.charAt(0));q=m}return p}}var broken=_H.loadSprite("assets/Sprites/broken.png");function LevelObject(b){this.ObjectData=b;this.sprites=[];LevelObject.prototype.getRect=function(){return{left:0,right:0,top:0,bottom:0}};LevelObject.prototype.collide=function(){};LevelObject.prototype.draw=function(a,e,f){if(this.sprites[0]&&this.sprites[0].loaded){a.drawImage(this.sprites[0],(e.x-this.sprites[0].width/2)*f.x,(e.y-this.sprites[0].height/2)*f.y,this.sprites[0].width*f.x,this.sprites[0].height*f.y)}else{a.drawImage(broken,(e.x-broken.width/2)*f.x,(e.y-broken.height/2)*f.y,broken.width*f.x,broken.height*f.y)}}}var monitor=_H.loadSprite("assets/Sprites/monitorEmpty.png");var monitorBroken=_H.loadSprite("assets/Sprites/monitorBroken.png");function MonitorObject(d){this.ObjectData=d;this.sprites=[];var c="assets/Sprites/monitor";switch(this.ObjectData.SubType){case 1:this.sprites.push(_H.loadSprite(c+"SonicOneUp.png"));break;case 2:this.sprites.push(_H.loadSprite(c+"Death.png"));break;case 3:this.sprites.push(_H.loadSprite(c+"Ring.png"));break;case 4:this.sprites.push(_H.loadSprite(c+"SpeedShoe.png"));break;case 5:this.sprites.push(_H.loadSprite(c+"Flame.png"));break;case 6:this.sprites.push(_H.loadSprite(c+"Electric.png"));break;case 7:this.sprites.push(_H.loadSprite(c+"Bubble.png"));break;case 8:this.sprites.push(_H.loadSprite(c+"Stars.png"));break}MonitorObject.prototype.getRect=function(){var a=this.ObjectData.X-monitor.width/2;var b=this.ObjectData.Y-monitor.height/2;return{left:a,top:b,right:a+monitor.width,height:b+monitor.height}};MonitorObject.prototype.collide=function(){if(sonicManager.sonicToon.ysp==0){sonicManager.sonicToon.gsp=0;sonicManager.sonicToon.xsp=0;return}if(this.ObjectData.SubType==10){return}switch(this.ObjectData.SubType){case 1:sonicManager.sonicToon.Lives=1;break;case 2:sonicManager.sonicToon.hit();break;case 3:sonicManager.sonicToon.rings+=10;break;case 4:sonicManager.sonicToon.rings+=20;break;case 5:sonicManager.sonicToon.rings+=30;break;case 6:sonicManager.sonicToon.rings+=40;break;case 7:sonicManager.sonicToon.rings+=50;break;case 8:sonicManager.sonicToon.rings+=60;break}if(sonicManager.sonicToon.ysp>0){sonicManager.sonicToon.ysp*=-1}else{sonicManager.sonicToon.ysp*=1}this.ObjectData.SubType=10};MonitorObject.prototype.draw=function(a,b,f){if(this.sprites[0]&&this.sprites[0].loaded){if(this.ObjectData.SubType==10){a.drawImage(monitorBroken,(b.x-monitorBroken.width/2)*f.x,(b.y)*f.y,monitorBroken.width*f.x,monitorBroken.height*f.y)}else{a.drawImage(monitor,(b.x-monitor.width/2)*f.x,(b.y-monitor.height/2)*f.y,monitor.width*f.x,monitor.height*f.y);if(sonicManager.sonicToon){if(!(sonicManager.drawTickCount%6==0||sonicManager.drawTickCount%6==1)){a.drawImage(this.sprites[0],((b.x-monitor.width/2)+6)*f.x,((b.y-monitor.height/2)+3)*f.y,this.sprites[0].width*f.x,this.sprites[0].height*f.y)}}else{a.drawImage(this.sprites[0],((b.x-monitor.width/2)+6)*f.x,((b.y-monitor.height/2)+3)*f.y,this.sprites[0].width*f.x,this.sprites[0].height*f.y)}}}}}function SpringObject(d){this.ObjectData=d;this.sprites=[];var c="assets/Sprites/monitor";switch(this.ObjectData.SubType){case 1:this.sprites.push(_H.loadSprite(c+"SonicOneUp.png"));break;case 2:this.sprites.push(_H.loadSprite(c+"Death.png"));break;case 3:this.sprites.push(_H.loadSprite(c+"Ring.png"));break;case 4:this.sprites.push(_H.loadSprite(c+"SpeedShoe.png"));break;case 5:this.sprites.push(_H.loadSprite(c+"Flame.png"));break;case 6:this.sprites.push(_H.loadSprite(c+"Electric.png"));break;case 7:this.sprites.push(_H.loadSprite(c+"Bubble.png"));break;case 8:this.sprites.push(_H.loadSprite(c+"Stars.png"));break}SpringObject.prototype.getRect=function(){var a=this.ObjectData.X-monitor.width/2;var b=this.ObjectData.Y-monitor.height/2;return{left:a,top:b,right:a+monitor.width,bottom:b+monitor.height}};SpringObject.prototype.collide=function(){if(sonicManager.sonicToon.ysp==0){sonicManager.sonicToon.gsp=0;sonicManager.sonicToon.xsp=0;return}if(this.ObjectData.SubType==10){return}switch(this.ObjectData.SubType){case 1:sonicManager.sonicToon.Lives=1;break;case 2:sonicManager.sonicToon.hit();break;case 3:sonicManager.sonicToon.rings+=10;break;case 4:sonicManager.sonicToon.rings+=20;break;case 5:sonicManager.sonicToon.rings+=30;break;case 6:sonicManager.sonicToon.rings+=40;break;case 7:sonicManager.sonicToon.rings+=50;break;case 8:sonicManager.sonicToon.rings+=60;break}if(sonicManager.sonicToon.ysp>0){sonicManager.sonicToon.ysp*=-1}else{sonicManager.sonicToon.ysp*=1}this.ObjectData.SubType=10};SpringObject.prototype.draw=function(a,b,f){if(this.sprites[0]&&this.sprites[0].loaded){if(this.ObjectData.SubType==10){a.drawImage(monitorBroken,(b.x-monitorBroken.width/2)*f.x,(b.y)*f.y,monitorBroken.width*f.x,monitorBroken.height*f.y)}else{a.drawImage(monitor,(b.x-monitor.width/2)*f.x,(b.y-monitor.height/2)*f.y,monitor.width*f.x,monitor.height*f.y);if(sonicManager.sonicToon){if(!(sonicManager.drawTickCount%6==0||sonicManager.drawTickCount%6==1)){a.drawImage(this.sprites[0],((b.x-monitor.width/2)+6)*f.x,((b.y-monitor.height/2)+3)*f.y,this.sprites[0].width*f.x,this.sprites[0].height*f.y)}}else{a.drawImage(this.sprites[0],((b.x-monitor.width/2)+6)*f.x,((b.y-monitor.height/2)+3)*f.y,this.sprites[0].width*f.x,this.sprites[0].height*f.y)}}}}}(function(){JSLINQ=window.JSLINQ=function(b){return new JSLINQ.fn.init(b)};JSLINQ.fn=JSLINQ.prototype={init:function(b){this.items=b},jslinq:"2.10",ToArray:function(){return this.items},Where:function(e){var g;var h=new Array();for(var f=0;f<this.items.length;f++){if(e(this.items[f],f)){h[h.length]=this.items[f]}}return new JSLINQ(h)},Select:function(e){var g;var h=new Array();for(var f=0;f<this.items.length;f++){if(e(this.items[f])){h[h.length]=e(this.items[f])}}return new JSLINQ(h)},OrderBy:function(d){var f=new Array();for(var e=0;e<this.items.length;e++){f[f.length]=this.items[e]}return new JSLINQ(f.sort(function(a,b){var c=d(a);var h=d(b);return((c<h)?-1:((c>h)?1:0))}))},OrderByDescending:function(d){var f=new Array();for(var e=0;e<this.items.length;e++){f[f.length]=this.items[e]}return new JSLINQ(f.sort(function(a,b){var c=d(b);var h=d(a);return((c<h)?-1:((c>h)?1:0))}))},SelectMany:function(d){var f=new Array();for(var e=0;e<this.items.length;e++){f=f.concat(d(this.items[e]))}return new JSLINQ(f)},Count:function(b){if(b==null){return this.items.length}else{return this.Where(b).items.length}},Distinct:function(f){var j;var g=new Object();var k=new Array();for(var h=0;h<this.items.length;h++){j=f(this.items[h]);if(g[j]==null){g[j]=true;k[k.length]=j}}g=null;return new JSLINQ(k)},Any:function(c){for(var d=0;d<this.items.length;d++){if(c(this.items[d],d)){return true}}return false},All:function(c){for(var d=0;d<this.items.length;d++){if(!c(this.items[d],d)){return false}}return true},Reverse:function(){var d=new Array();for(var c=this.items.length-1;c>-1;c--){d[d.length]=this.items[c]}return new JSLINQ(d)},First:function(b){if(b!=null){return this.Where(b).First()}else{if(this.items.length>0){return this.items[0]}else{return null}}},Last:function(b){if(b!=null){return this.Where(b).Last()}else{if(this.items.length>0){return this.items[this.items.length-1]}else{return null}}},ElementAt:function(b){return this.items[b]},Concat:function(d){var c=d.items||d;return new JSLINQ(this.items.concat(c))},Intersect:function(o,k){var l;if(k!=undefined){l=k}else{l=function(e,c,f,d){return e==f}}var n=o.items||o;var m=new Array();for(var a=0;a<this.items.length;a++){for(var b=0;b<n.length;b++){if(l(this.items[a],a,n[b],b)){m[m.length]=this.items[a]}}}return new JSLINQ(m)},DefaultIfEmpty:function(b){if(this.items.length==0){return b}return this},ElementAtOrDefault:function(d,c){if(d>=0&&d<this.items.length){return this.items[d]}return c},FirstOrDefault:function(b){return this.First()||b},LastOrDefault:function(b){return this.Last()||b}};JSLINQ.fn.init.prototype=JSLINQ.fn})();jQuery.fn.rotate=function(j,q){var n=this.get(0);if(!q){n.angle=((n.angle==undefined?0:n.angle)+j)%360}else{n.angle=j}var o;if(n.angle>=0){o=Math.PI*n.angle/180}else{o=Math.PI*(360+n.angle)/180}var m=Math.cos(o);var p=Math.sin(o);if(document.all&&!window.opera){var k=document.createElement("img");k.src=n.src;k.height=n.height;k.width=n.width;k.style.filter="progid:DXImageTransform.Microsoft.Matrix(M11="+m+",M12="+(-p)+",M21="+p+",M22="+m+",SizingMethod='auto expand')"}else{var k=document.createElement("canvas");if(!n.oImage){k.oImage=new Image();k.oImage.src=n.src}else{k.oImage=n.oImage}k.style.width=k.width=Math.abs(m*k.oImage.width)+Math.abs(p*k.oImage.height);k.style.height=k.height=Math.abs(m*k.oImage.height)+Math.abs(p*k.oImage.width);var l=k.getContext("2d");l.save();if(o<=Math.PI/2){l.translate(p*k.oImage.height,0)}else{if(o<=Math.PI){l.translate(k.width,-m*k.oImage.height)}else{if(o<=1.5*Math.PI){l.translate(-m*k.oImage.width,k.height)}else{l.translate(0,-p*k.oImage.width)}}}l.rotate(o);l.drawImage(k.oImage,0,0,k.oImage.width,k.oImage.height);l.restore()}k.id=n.id;k.angle=n.angle;n.parentNode.replaceChild(k,n)};jQuery.fn.rotateRight=function(b){this.rotate(b==undefined?90:b)};jQuery.fn.rotateLeft=function(b){this.rotate(b==undefined?-90:-b)};function ParallaxBG(f,p){var q=this;var o=f;ParallaxBG.prototype.click=function(a,b){this.slots[b].rotateSpeed=a/this.width*2};ParallaxBG.prototype.onBar=function(e,g){var d=3*p.x;var a=this.slots[g].rotateSpeed;if(e>((this.width*a/2)-d)&&e<((this.width*a/2)+d)){var c={top:0,bottom:0};for(var b=g-1;b>=0;b--){if(this.slots[b].rotateSpeed!=a){c.top=b;break}}for(var b=g+1;b<this.height;b++){if(this.slots[b].rotateSpeed!=a){c.bottom=b;break}}return c}return null};ParallaxBG.prototype.cache=function(j){var u=(this.slots[0].colors.length*j.x);var b=sonicManager.windowLocation.height*j.y;var t=[];var a=_H.defaultCanvas();var e=this.slots[0].rotateSpeed;var d=0;var h={x:0,y:0};for(var c=0;c<this.slots.length;c++){if(e!=this.slots[c].rotateSpeed){e=this.slots[c].rotateSpeed;t[d]=(_H.loadSprite(a.canvas.toDataURL("image/png")));a=_H.defaultCanvas();d=c}var g={x:h.x,y:h.y+(c-d)*j.y};this.slots[c].draw(a.context,g,j)}t[d]=(_H.loadSprite(a.canvas.toDataURL("image/png")));this.sprites=t};ParallaxBG.prototype.init=function(d){var e=this.colors[0].length;var a=this.colors.length;this.slots=[];this.slots.length=a;for(var g=0;g<a;g++){this.slots[g]=new ParallaxBGSlot()}for(var c=0;c<a;c++){for(var b=0;b<e;b++){this.slots[c].colors[b]=(this.colors[c][b])}}for(var g=0;g<a;g++){this.slots[g].load(d)}};ParallaxBG.prototype.drawUI=function(a,e,h){if(this.sprite&&this.sprite.loaded){a.drawImage(this.sprite,e.x,e.y)}if(this.slots){var c=this.slots[0].rotateSpeed;var d=0;for(var b=0;b<this.slots.length;b++){if(c==this.slots[b].rotateSpeed){continue}var g=Math.floor(255/2/c);a.fillStyle="rgba("+g+",57,43,0.4)";a.fillRect(e.x,e.y+d*h.y,this.width*h.x,h.y*(b-d));a.strokeStyle="rgba("+g+",57,43,1)";a.lineWidth=3;a.strokeRect(e.x,e.y+d*h.y,this.width*h.x,h.y*(b-d));var j=3*h.x;a.fillRect(e.x+(this.width*c/2)-j,e.y+d*h.y,j*2,h.y*(b-d));d=b;c=this.slots[b].rotateSpeed}var g=Math.floor(255/2/c);a.fillStyle="rgba("+g+",57,43,0.4)";a.fillRect(e.x,e.y+d*h.y,this.width*h.x,h.y*(b-d));a.strokeStyle="rgba("+g+",57,43,1)";a.lineWidth=3;a.strokeRect(e.x,e.y+d*h.y,this.width*h.x,h.y*(b-d));var j=3*h.x;a.fillStyle="rgba("+g+",57,43,1)";a.fillRect(e.x+(this.width*c/2)-j,e.y+d*h.y,j*2,h.y*(b-d))}};ParallaxBG.prototype.draw=function(a,g,h,d){var j=(this.slots[0].colors.length*h.x);var b=sonicManager.windowLocation.height*h.y;for(var c in this.sprites){var e={x:g.x+(Math.floor(d*this.slots[c].rotateSpeed)),y:g.y+c*h.y};if(e.y>sonicManager.windowLocation.y*h.y||e.y<b+sonicManager.windowLocation.y*h.y){if(e.x>sonicManager.windowLocation.width||e.x+j<0){continue}if(this.sprite&&this.sprite.loaded){a.drawImage(this.sprite,e.x,e.y,this.sprite.width,this.sprite.height)}}}};q.width=o.width;q.height=o.height;var l=_H.getImageData(o);var k=[];for(var n=0;n<o.height;n++){k[n]=[];k[n].length=o.width}for(var m=0;m<l.length;m+=4){k[_H.floor(m/4/o.width)][m/4%o.width]=(_H.colorFromData(l,m))}q.colors=k;q.sprite=o;q.sprite.loaded=true;q.init(p)}function ParallaxBGSlot(){this.colors=[];this.sprite=null;this.rotateSpeed=1;ParallaxBGSlot.prototype.draw=function(d,e,f){if(this.sprite&&this.sprite.loaded){d.drawImage(this.sprite,e.x,e.y,this.sprite.width*f.x,this.sprite.height*f.y)}};ParallaxBGSlot.prototype.drawUI=function(f,j,k){for(var g=0;g<this.colors.length;g++){var h=this.colors[g];if(h=="#000000"){continue}f.fillStyle=h;f.fillRect(j.x+(g)*k.x,j.y,k.x,k.y)}};ParallaxBGSlot.prototype.load=function(l){var k={x:0,y:0};var m=_H.defaultCanvas(l.x*this.colors.length,l.y);var g=m.context;for(var h=0;h<this.colors.length;h++){var j=this.colors[h];g.fillStyle=j;g.fillRect(k.x+h*l.x,k.y,l.x,l.y)}var j=m.canvas.toDataURL("image/png");this.sprite=_H.loadSprite(j)}}function Ring(b){this.active=b;this.animationIndex=0;this.x=0;this.y=0;this.xsp=0;this.ysp=0;this.tickCount=0;this.draw=function(a,g,h){if(b){this.ysp+=0.09375;this.x+=this.xsp;this.y+=this.ysp;if(this.x<sonicManager.windowLocation.x||this.y<sonicManager.windowLocation.y||this.x>sonicManager.windowLocation.x+sonicManager.windowLocation.width||this.y>sonicManager.windowLocation.y+sonicManager.windowLocation.height){this.tickCount=4294967295;return false}if(sonicManager.sonicToon.checkCollisionLine(_H.floor(this.x)+8,_H.floor(this.y)+8,16,1)!=-1){this.ysp*=-0.75}if(sonicManager.sonicToon.checkCollisionLine(_H.floor(this.x)-8,_H.floor(this.y)+8,26,0)!=-1){this.xsp*=-0.75}if(sonicManager.drawTickCount>sonicManager.sonicToon.sonicLastHitTick+64&&_H.intersectRect(sonicManager.sonicToon.myRec,{left:this.x-8*h.x,right:this.x+8*h.x,top:this.y-8*h.y,bottom:this.y+8*h.y})){this.tickCount=4294967295;sonicManager.sonicToon.rings++;return false}this.tickCount++}if(sonicManager.sonicToon){this.animationIndex=_H.floor((sonicManager.drawTickCount%((b?4:8)*4))/(b?4:8))}else{this.animationIndex=0}var j;if(sonicManager.SpriteCache.rings){j=sonicManager.SpriteCache.rings}else{alert("sprite fial");return}var k=j[this.animationIndex*200+h.y*100+h.x];if(!k){alert("sprite fail");return}if(k.loaded){a.drawImage(k,_H.floor((g.x-8)*h.x),_H.floor((g.y-8)*h.y))}else{return false}}}function Sonic(f,e){this.x=f.StartPositions[0].X;this.y=f.StartPositions[0].Y;this.obtainedRing=[];this.rings=0;this.debugging=false;this.jumping=false;this.crouching=false;this.holdingLeft=false;this.holdingRight=false;this.LevelWidth=0;this.xsp=0;this.ysp=0;this.sonicLastHitTick=0;this.sonicJustHitTick=0;this.acc=0.046875;this.dec=0.5;this.frc=0.046875;this.gsp=0;this.rdec=0.125;this.rfrc=0.0234375;this.runningTick=0;this.slp=0.125;this.slpRollingUp=0.078125;this.slpRollingDown=0.3125;this.jmp=-6.5;this.grv=0.21875;this.air=0.09375;this.sonicLevel=f;this.inAir=false;this.wasInAir=false;this.holdingJump=false;this.haltSmoke=[];this.hlock=0;this.mode=RotationMode.Floor;this.facing=true;this.ticking=false;this.breaking=0;this.ducking=false;this.spinDash=false;this.myRec={};this.spinDashSpeed=0;this.angle=255;var d;this.updateMode=function(){if(this.angle<32||this.angle>224){this.mode=RotationMode.Floor}else{if(this.angle>32&&this.angle<96){this.mode=RotationMode.LeftWall}else{if(this.angle>96&&this.angle<160){this.mode=RotationMode.Ceiling}else{if(this.angle>160&&this.angle<224){this.mode=RotationMode.RightWall}}}}};this.tick=function(){if(this.debugging){var q=15;if(this.holdingRight){this.x+=q}if(this.holdingLeft){this.x-=q}if(this.crouching){this.y+=q}if(this.jumping){this.y-=q}return}this.updateMode();if(this.hlock>0){this.hlock--;this.holdingRight=false;this.holdingLeft=false}this.myRec={left:this.x-5,right:this.x+5,top:this.y-20,bottom:this.y+20};var u=6;if(this.jumping){this.wasJumping=true}else{if(this.wasJumping){this.wasJumping=false}}if(!this.inAir&&this.wasInAir){this.wasInAir=false;if(this.angle>=240||this.angle<=15){this.gsp=this.xsp}else{if((this.angle>=224&&this.angle<=239)||(this.angle>=16&&this.angle<=31)){this.gsp=this.ysp}else{if((this.angle>=192&&this.angle<=223)){this.gsp=-this.ysp}else{if((this.angle>=32&&this.angle<=63)){this.gsp=this.ysp}}}}this.xsp=0;this.ysp=0}if(!this.inAir&&!this.rolling){if(this.holdingRight&&!this.holdingLeft){this.facing=true;if(this.gsp>=0){this.gsp+=this.acc;if(this.gsp>u){this.gsp=u}}else{this.gsp+=this.dec;if(Math.abs(this.gsp)>4.5){this.facing=false;this.breaking=1;this.runningTick=0}}}if(this.holdingLeft&&!this.holdingRight){this.facing=false;if(this.gsp<=0){this.gsp-=this.acc;if(this.gsp<-u){this.gsp=-u}}else{this.gsp-=this.dec;if(Math.abs(this.gsp)>4.5){this.facing=true;this.breaking=-1;this.runningTick=0}}}if(!this.holdingLeft&&!this.holdingRight){this.gsp-=Math.min(Math.abs(this.gsp),this.frc)*(this.gsp>0?1:-1)}d=_H.sign(this.gsp);this.gsp+=this.slp*-_H.sin(this.angle);if(d!=_H.sign(this.gsp)&&d!=0){this.hlock=30}}this.ducking=false;if(this.crouching){if(Math.abs(this.gsp)>1.03125){this.rolling=true;this.currentlyBall=true}else{this.ducking=true}}else{if(this.spinDash){this.gsp=(8+_H.floor(this.spinDashSpeed)/2)*(this.facing?1:-1);this.spinDash=false;this.rolling=true;this.currentlyBall=true}}if(!this.isAir&&this.rolling){if(this.holdingLeft){if(this.gsp>0){if(this.rolling){this.gsp=_H.max(0,this.gsp-this.rdec)}}}if(this.holdingRight){if(this.gsp<0){if(this.rolling){this.gsp=_H.min(0,this.gsp+this.rdec)}}}this.gsp-=Math.min(Math.abs(this.gsp),this.rfrc)*(this.gsp>0?1:-1);d=_H.sign(this.gsp);var b=_H.sin(this.angle);if((b>0)!=(this.gsp>0)){this.gsp+=-this.slpRollingUp*b}else{this.gsp+=-this.slpRollingDown*b}if(d!=_H.sign(this.gsp)&&d!=0){this.hlock=30}}if(!this.inAir){this.xsp=this.gsp*_H.cos(this.angle);this.ysp=this.gsp*-_H.sin(this.angle);if(Math.abs(this.gsp)<2.5&&this.angle>=64&&this.angle<=192){if(this.mode==RotationMode.RightWall){this.x+=5}else{if(this.mode==RotationMode.LeftWall){this.x-=4}}this.angle=0;this.updateMode();this.hlock=30}}if(this.inAir){if(this.holdingRight&&!this.holdingLeft){this.facing=true;if(this.xsp>=0){this.xsp+=this.air;if(this.xsp>u){this.xsp=u}}else{this.xsp-=this.air}}if(this.holdingLeft&&!this.holdingRight){this.facing=false;if(this.xsp<=0){this.xsp-=this.air;if(this.xsp<-u){this.xsp=-u}}else{this.xsp+=this.air}}if(this.wasInAir){if(this.jumping){}else{}}this.ysp+=this.justHit?0.1875:this.grv;if(this.ysp<0&&this.ysp>-4){if(Math.abs(this.xsp)>0.125){this.xsp*=0.96875}}if(this.ysp>16){this.ysp=16}}if(this.wasInAir&&this.jumping){}else{if(this.jumping){if(this.ducking){this.spinDash=true;this.spinDashSpeed+=2;if(this.spinDashSpeed>8){this.spinDashSpeed=8}this.spriteState="spindash0"}else{this.wasInAir=true;this.inAir=true;this.currentlyBall=true;this.xsp=this.jmp*_H.sin(this.angle)+this.gsp*_H.cos(this.angle);this.ysp=this.jmp*_H.cos(this.angle)}}}if(this.xsp>0&&this.xsp<0.008){this.gsp=0;this.xsp=0}if(this.xsp<0&&this.xsp>-0.008){this.gsp=0;this.xsp=0}this.x+=this.xsp;this.y+=this.ysp;this.updateSprite();var r=_H.floor(this.x);var s=_H.floor(this.y);var x,y;var v=-10;var w=4;if(this.mode==RotationMode.Floor){if((x=this.checkCollisionLine(r+v,s+w,20,0))!=-1){if(x.pos<r){this.x=r=Math.ceil(x.pos/16)*16+10;this.gsp=0}else{this.x=r=Math.floor(x.pos/16)*16-10;this.gsp=0}if(this.inAir){this.xsp=0}}}else{if(this.mode==RotationMode.LeftWall){if((x=this.checkCollisionLine(r-w,s+v,20,1))!=-1){if(x.pos>s){this.y=s=Math.ceil(x.pos/16)*16-10}else{this.y=s=Math.floor(x.pos/16)*16+10;this.gsp=0}if(this.inAir){this.xsp=0}}}else{if(this.mode==RotationMode.Ceiling){if((x=this.checkCollisionLine(r-v,s-w,20,0))!=-1){if(x.pos<r){this.x=r=Math.ceil(x.pos/16)*16+10;this.gsp=0}else{this.x=r=Math.floor(x.pos/16)*16-10;this.gsp=0}if(this.inAir){this.xsp=0}}}else{if(this.mode==RotationMode.RightWall){if((x=this.checkCollisionLine(r+w,s+v,20,1))!=-1){if(x.pos<s){this.y=s=Math.ceil(x.pos/16)*16-11;this.gsp=0}else{this.y=s=Math.floor(x.pos/16)*16+11;this.gsp=0}if(this.inAir){this.xsp=0}}}}}}if(sonicManager.tickCount%4==0){this.checkCollisionWithRing();this.checkCollisionWithObjects()}if(this.inAir){this.angle=255}if(!this.inAir){var t=24;v=-9;w=0;if(this.mode==RotationMode.Floor){x=this.checkCollisionLine(r+v,s+w,t,1);y=this.checkCollisionLine(r-v,s+w,t,1);if(x==-1&&y==-1){this.inAir=true;this.wasInAir=true}else{if(x.pos>=0&&y.pos>=0){this.angle=x.angle;if(x.pos<y.pos){this.angle=x.angle;this.y=s=x.pos-20}else{this.angle=y.angle;this.y=s=y.pos-20}}else{if(x.pos>-1){this.angle=x.angle;this.y=s=x.pos-20}else{if(y.pos>-1){this.angle=y.angle;this.y=s=y.pos-20}}}}}else{if(this.mode==RotationMode.LeftWall){x=this.checkCollisionLine(r+w,s-v,t,2);y=this.checkCollisionLine(r+w,s+v,t,2);if(x==-1&&y==-1){this.inAir=true;this.wasInAir=true}else{if(x.pos>=0&&y.pos>=0){if(x.pos<y.pos){this.angle=x.angle;this.x=r=x.pos+20}else{this.angle=y.angle;this.x=r=y.pos+20}}else{if(x.pos>-1){this.angle=x.angle;this.x=r=x.pos+20}else{if(y.pos>-1){this.angle=y.angle;this.x=r=y.pos+20}}}}}else{if(this.mode==RotationMode.Ceiling){x=this.checkCollisionLine(r+v,s-w,t,3);y=this.checkCollisionLine(r-v,s-w,t,3);if(x==-1&&y==-1){this.inAir=true;this.wasInAir=true}else{if(x.pos>=0&&y.pos>=0){if(x.pos<y.pos){this.angle=x.angle;this.y=s=x.pos-20}else{this.angle=y.angle;this.y=s=y.pos-20}}else{if(x.pos>-1){this.angle=x.angle;this.y=s=x.pos-20}else{if(y.pos>-1){this.angle=y.angle;this.y=s=y.pos-20}}}}}else{if(this.mode==RotationMode.RightWall){x=this.checkCollisionLine(r+w,s-v,t,0);y=this.checkCollisionLine(r+w,s+v,t,0);if(x==-1&&y==-1){this.inAir=true;this.wasInAir=true}else{if(x.pos>=0&&y.pos>=0){if(x.pos<y.pos){this.angle=x.angle;this.x=r=x.pos-20}else{this.angle=y.angle;this.x=r=y.pos-20}}else{if(x.pos>-1){this.angle=x.angle;this.x=r=x.pos-20}else{if(y.pos>-1){this.angle=y.angle;this.x=r=y.pos-20}}}}}}}}this.updateMode()}else{x=this.checkCollisionLine(r-9,s,20,1);y=this.checkCollisionLine(r+9,s,20,1);if(x==-1&&y==-1){this.inAir=true;this.wasInAir=true}else{if(x.pos>=0&&y.pos>=0){if(x.pos<y.pos){if(this.y+(20)>=x.pos){this.angle=x.angle;this.y=s=x.pos-20;this.rolling=this.currentlyBall=false;this.inAir=false}}else{if(y.pos>-1){if(this.y+(20)>=y.pos){this.angle=y.angle;this.y=s=y.pos-20;this.rolling=this.currentlyBall=false;this.inAir=false}}}}else{if(x.pos>-1){if(this.y+(20)>=x.pos){this.angle=x.angle;this.y=s=x.pos-20;this.rolling=this.currentlyBall=false;this.inAir=false}}else{if(y.pos>-1){if(this.y+(20)>=y.pos){this.angle=y.angle;this.y=s=y.pos-20;this.rolling=this.currentlyBall=false;this.inAir=false}}}}}this.updateMode();var c=sonicManager.SpriteCache.sonicSprites[this.spriteState+e.x+e.y];var a=c.height/e.y/2;x=this.checkCollisionLine(r-9,s,a,3);y=this.checkCollisionLine(r+9,s,a,3);if((x==-1&&y==-1)){}else{if(x.pos>=0&&y.pos>=0){this.angle=x.angle;if(x.pos<y.pos){if(this.y+(a)>=x.pos){this.angle=x.angle;this.y=s=x.pos+a;this.ysp=0}}else{if(this.y+(a)>=y.pos){this.angle=y.angle;this.y=s=y.pos+a;this.ysp=0}}}else{if(x.pos>-1){if(this.y+(a)>=x.pos){this.angle=x.angle;this.y=s=x.pos+a;this.ysp=0}}else{if(y.pos>-1){if(this.y+(a)>=y.pos){this.angle=y.angle;this.y=s=y.pos+a;this.ysp=0}}}}this.updateMode()}}};this.debug=function(){this.debugging=!this.debugging;this.xsp=0;this.gsp=0;this.ysp=0;this.spriteState="normal"};this.hit=function(){if(sonicManager.drawTickCount-this.sonicJustHitTick<120){return}this.justHit=true;this.ysp=-4;this.xsp=2*(-1);this.sonicLastHitTick=sonicManager.drawTickCount;var k=0;var a=101.25;var b=false;var j=4;while(k<this.rings){var c=new Ring(true);sonicManager.activeRings.push(c);c.x=this.x;c.y=this.y-10;c.ysp=-Math.sin(a)*j;c.xsp=Math.cos(a)*j;if(b){c.ysp*=-1;a+=22.5}b=!b;k++;if(k==16){j=2;a=101.25}}this.rings=0};this.checkCollisionWithRing=function(){var c=this.myRec;for(var k in sonicManager.SonicLevel.Rings){var j=sonicManager.SonicLevel.Rings[k];if(this.obtainedRing[k]){continue}var a=j.X;var b=j.Y;if(_H.intersectRect(c,{left:a-8,right:a+8,top:b-8,bottom:b+8})){this.rings++;this.obtainedRing[k]=true}}};this.checkCollisionWithObjects=function(){var c=this.myRec;for(var k in sonicManager.SonicLevel.Objects){var j=sonicManager.SonicLevel.Objects[k];var a=j.X;var b=j.Y;if(_H.intersectRect(c,j.getRect())){j.collide()}}};this.sensorA=0;this.checkCollisionLine=function(j,k,b,a){var c=this.checkCollisionLineWrap(j,k,b,a);if(c!=-1&&c.angle==null){c=this.checkCollisionLineWrap(j,k,b,a)}if(c.angle==255){if(this.mode==RotationMode.Floor){}else{if(this.mode==RotationMode.LeftWall){c.angle=Math.floor(256/4*1)}else{if(this.mode==RotationMode.Ceiling){c.angle=Math.floor(256/4*2)}else{if(this.mode==RotationMode.RightWall){c.angle=Math.floor(256/4*3)}}}}}return c};this.checkCollisionLineWrap=function(D,E,A,x){var c=_H.floor(D/128);var m=_H.floor(E/128);var C=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[c][m]];var w=sonicManager.SonicLevel.curHeightMap?C.heightBlocks1:C.heightBlocks2;var u=sonicManager.SonicLevel.curHeightMap?C.angleMap1:C.angleMap2;var a=D-c*128;var b=E-m*128;var y=128;var z;var B;var v=0;switch(x){case 0:if(D+A>sonicManager.SonicLevel.LevelWidth*128){return{pos:sonicManager.SonicLevel.LevelWidth*128-20,angle:null}}for(z=0;z<A;z++){if(a+z>=128){C=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[c+1][m]];w=sonicManager.SonicLevel.curHeightMap?C.heightBlocks1:C.heightBlocks2;u=sonicManager.SonicLevel.curHeightMap?C.angleMap1:C.angleMap2;a-=128}if(D+z>this.LevelWidth||w[(a+z)][b]>=2){return{pos:D+z,angle:u[_H.floor((a+z)/16)][_H.floor((b)/16)]}}}break;case 1:if(E+A>sonicManager.SonicLevel.LevelHeight*128){return{pos:sonicManager.SonicLevel.LevelHeight*128-20,angle:null}}for(z=0;z<A;z+=1){if(b+v>=128){C=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[c][(m+1)]];w=sonicManager.SonicLevel.curHeightMap?C.heightBlocks1:C.heightBlocks2;u=sonicManager.SonicLevel.curHeightMap?C.angleMap1:C.angleMap2;b-=128}if(w[a][b+z]>=1){return{pos:E+z,angle:u[_H.floor((a)/16)][_H.floor((b+v)/16)]}}v++}break;case 2:if(D-A<0){return{pos:0+20,angle:null}}for(z=0;z<A;z++){if(a-z<0){C=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[(c-1),m]];w=sonicManager.SonicLevel.curHeightMap?C.heightBlocks1:C.heightBlocks2;u=sonicManager.SonicLevel.curHeightMap?C.angleMap1:C.angleMap2;a+=128}if(D-z<0||w[(a-z)][b]>=2){return{pos:D-z,angle:u[_H.floor((a-z)/16)][_H.floor((b)/16)]}}}break;case 3:if(E-A<0){return{pos:20,angle:null}}for(z=0;z<A;z+=1){if(b-v<0){C=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[c][(m-1)]];w=sonicManager.SonicLevel.curHeightMap?C.heightBlocks1:C.heightBlocks2;u=sonicManager.SonicLevel.curHeightMap?C.angleMap1:C.angleMap2;b+=128}if(w[a][b-z]>=2){return{pos:E-z,angle:u[_H.floor((a)/16)][_H.floor((b-v)/16)]}}v++}break}return -1};this.spriteState="normal";this.isLoading=function(){return this.imageLoaded[0]<this.imageLength};this.drawUI=function(a,b,c){a.font="13pt Arial bold";a.fillStyle="White";a.fillText("Rings: "+this.rings,b.x+90,b.y+45);a.fillText("Angle: "+this.angle.toString(16),b.x+90,b.y+75);a.fillText("Position: "+_H.floor(this.x)+", "+_H.floor(this.y),b.x+90,b.y+105);a.fillText("Speed: g: "+this.gsp.toFixed(3)+" x:"+this.xsp.toFixed(3)+" y:"+this.ysp.toFixed(3),b.x+90,b.y+135);a.fillText("Mode: "+this.mode,b.x+90,b.y+185)};this.draw=function(a,r){var c=_H.floor(this.x);var n=_H.floor(this.y);var b;var q=sonicManager.drawTickCount-this.sonicJustHitTick;if(q<120){if(q%8<4){return}}if(b=sonicManager.SpriteCache.sonicSprites[this.spriteState+r.x+r.y]){if(b.loaded){a.save();var s=(40-(b.height/r.y))/2;a.translate(((c-sonicManager.windowLocation.x)*r.x),((n-sonicManager.windowLocation.y+s)*r.y));if(!this.facing){a.scale(-1,1);a.rotate(-_H.fixAngle(this.angle));a.drawImage(b,-b.width/2,-b.height/2);if(this.spinDash){a.drawImage(sonicManager.SpriteCache.sonicSprites[("spinsmoke"+_H.floor((sonicManager.drawTickCount%14)/2))+r.x+r.y],(-b.width/2)-25*r.x,-b.height/2+(s*r.y)-15,b.width,b.height)}}else{a.rotate(_H.fixAngle(this.angle));a.drawImage(b,-b.width/2,-b.height/2);if(this.spinDash){a.drawImage(sonicManager.SpriteCache.sonicSprites[("spinsmoke"+_H.floor((sonicManager.drawTickCount%14)/2))+r.x+r.y],(-b.width/2)-25*r.x,-b.height/2+(s*r.y)-15,b.width,b.height)}}a.restore();for(var o=0;o<this.haltSmoke.length;o++){var p=this.haltSmoke[o];a.drawImage(sonicManager.SpriteCache.sonicSprites[("haltsmoke"+_H.floor((sonicManager.drawTickCount%(4*6))/6))+r.x+r.y],((p.x-sonicManager.windowLocation.x-25)*r.x),((p.y+12-sonicManager.windowLocation.y+s)*r.y));if(_H.floor(((sonicManager.drawTickCount+6)%(4*6))/6)==0){this.haltSmoke.splice(o,1)}}}}else{if(b=sonicManager.SpriteCache.sonicSprites[this.spriteState]){if(b.loaded){sonicManager.SpriteCache.sonicSprites[this.spriteState+r.x+r.y]=_H.scaleSprite(b,r)}}else{sonicManager.SpriteCache.sonicSprites[this.spriteState]=_H.loadSprite(this.spriteLocations[this.spriteState])}}};this.kill=function(){};this.pressJump=function(){if(!this.justHit){this.jumping=true}};this.pressCrouch=function(){if(!this.justHit){this.crouching=true}};this.pressLeft=function(){if(!this.justHit){this.holdingLeft=true}};this.pressRight=function(){if(!this.justHit){this.holdingRight=true}};this.releaseJump=function(){this.jumping=false};this.releaseCrouch=function(){this.crouching=false};this.releaseLeft=function(){this.holdingLeft=false};this.releaseRight=function(){this.holdingRight=false};this.buildHeightInfo=function(){this.LevelWidth=f.LevelWidth*128;for(var H=0;H<f.Chunks.length;H++){var z=f.Chunks[H];var A;var B=z.heightBlocks1=[];var C=z.heightBlocks2=[];var x=z.angleMap1=[];var y=z.angleMap2=[];C.length=B.length=128;x.length=y.length=8;for(var c=0;c<128;c++){B[c]=[];C[c]=[];x[c]=[];y[c]=[];y[c].length=x[c].length=8;C[c].length=B[c].length=128}for(var w=0;w<8;w++){for(var v=0;v<8;v++){var I=z.tilePieces[v][w];var D=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes1[I.Block]];var E=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes2[I.Block]];if(D==0){continue}var a;var b;x[v][w]=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes1[I.Block]];y[v][w]=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes2[I.Block]];if(I.XFlip){if(I.YFlip){x[v][w]=(x[v][w]+(127-x[v][w])*2)%255;y[v][w]=(y[v][w]+(127-y[v][w])*2)%255;x[v][w]=(255-x[v][w])%255;y[v][w]=(255-y[v][w])%255}else{x[v][w]=(255-x[v][w])%255;y[v][w]=(255-y[v][w])%255}}else{if(I.YFlip){x[v][w]=(x[v][w]+(127-x[v][w])*2)%255;y[v][w]=(y[v][w]+(127-y[v][w])*2)%255}else{x[v][w]=(x[v][w]);y[v][w]=(y[v][w])}}D=D.items;E=E.items;for(b=0;b<16;b++){for(a=0;a<16;a++){var F=0,G=0;if(I.XFlip){if(I.YFlip){F=15-a;G=15-b}else{F=15-a;G=b}}else{if(I.YFlip){F=a;G=15-b}else{F=a;G=b}}switch(I.Solid1){case 0:B[(v*16+F)][(w*16+G)]=false;break;case 1:case 2:case 3:B[(v*16+F)][(w*16+G)]=(D[a]>16-b)?I.Solid1:0;break}switch(I.Solid2){case 0:C[(v*16+F)][(w*16+G)]=false;break;case 1:case 2:case 3:C[(v*16+F)][(w*16+G)]=(E[a]>16-b)?I.Solid2:0;break}}}}}}};this.updateSprite=function(){var a=Math.abs(this.gsp);var b=parseInt(this.spriteState.substring(this.spriteState.length-1,this.spriteState.length));if(this.breaking>0){if(this.gsp>0||this.gsp==0||this.spriteState=="breaking3"){this.facing=false;this.breaking=0}}else{if(this.breaking<0){if(this.gsp<0||this.gsp==0||this.spriteState=="breaking3"){this.breaking=0;this.facing=true}}}if(this.justHit){if(this.spriteState.substring(0,this.spriteState.length-1)!="hit"){this.spriteState="hit0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(8-a))==0){this.spriteState="hit1"}}}else{if(a==0&&this.inAir==false){if(this.ducking){if(this.spinDash){if(this.spriteState.substring(0,this.spriteState.length-1)!="spindash"){this.spriteState="spindash0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(2-a))==0){this.spriteState="spindash"+((b+1)%6)}}}else{if(this.spriteState.substring(0,this.spriteState.length-1)!="duck"){this.spriteState="duck0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(4-a))==0){this.spriteState="duck1"}}}}else{this.spriteState="normal";this.currentlyBall=false;this.rolling=false;this.runningTick=0}}else{if(this.breaking!=0){if(this.spriteState.substring(0,this.spriteState.length-1)!="breaking"){this.spriteState="breaking0";this.runningTick=1}else{if((this.runningTick++)%(7)==0){this.spriteState="breaking"+((b+1)%4);if(b==0){this.haltSmoke.push({x:_H.floor(this.x),y:_H.floor(this.y)})}}}}else{if(this.currentlyBall){if(this.spriteState.substring(0,this.spriteState.length-1)!="balls"){this.spriteState="balls0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(8-a))==0){this.spriteState="balls"+((b+1)%5)}}}else{if(a<6){if(this.spriteState.substring(0,this.spriteState.length-1)!="running"){this.spriteState="running0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(8-a))==0||(_H.floor(8-a)==0)){this.spriteState="running"+((b+1)%8)}}}else{if(a>=6){if(this.spriteState.substring(0,this.spriteState.length-1)!="fastrunning"){this.spriteState="fastrunning0";this.runningTick=1}else{if(((this.runningTick++)%(Math.ceil(8-a))==0)||(_H.floor(8-a)==0)){this.spriteState="fastrunning"+((b+1)%4)}}}}}}}}};this.buildHeightInfo(f)}DEBUGs=true;window.requestAnimFrame=(function(b){if(window.requestAnimationFrame){return window.requestAnimationFrame(b)}if(window.webkitRequestAnimationFrame){return window.webkitRequestAnimationFrame(b)}if(window.mozRequestAnimationFrame){return window.mozRequestAnimationFrame(b)}if(window.oRequestAnimationFrame){return window.oRequestAnimationFrame(b)}if(window.msRequestAnimationFrame){return window.msRequestAnimationFrame(b)}window.setTimeout(b,1000/60)});function SonicEngine(n){var u=this;this.canvas=$("#"+n);this.canvasItem=document.getElementById(n).getContext("2d");var t=window.sonicManager=new SonicManager(this.canvasItem);this.canvasWidth=0;this.canvasHeight=0;document.getElementById(n).addEventListener("DOMMouseScroll",s,false);document.getElementById(n).addEventListener("mousewheel",s,false);document.getElementById(n).addEventListener("touchmove",l);document.getElementById(n).addEventListener("touchstart",o);document.getElementById(n).addEventListener("touchend",m);document.getElementById(n).addEventListener("mousedown",o);document.getElementById(n).addEventListener("mouseup",m);document.getElementById(n).addEventListener("mousemove",l);$(document).keydown(q);$(document).keyup(r);function o(a){a.preventDefault();if(t.uiManager.onClick(a)){return false}if(t.onClick(a)){return false}return false}function l(a){a.preventDefault();if(t.uiManager.onMouseMove(a)){return false}return false}function m(a){a.preventDefault();t.uiManager.onMouseUp(a)}function s(a){a.preventDefault();if(t.uiManager.onMouseScroll(a)){return false}return a.preventDefault()&&false}function q(a){switch(a.keyCode){case 66:if(t.sonicToon){t.sonicToon.hit()}break;case 67:if(t.sonicToon){t.sonicToon.debug()}break;case 68:t.SonicLevel.curHeightMap=!t.SonicLevel.curHeightMap;break;case 38:case 87:if(t.sonicToon){t.sonicToon.pressJump()}else{t.windowLocation.y-=128}break;case 40:case 83:if(t.sonicToon){t.sonicToon.pressCrouch()}else{t.windowLocation.y+=128}break;case 37:case 65:t.windowLocation.x-=128;if(t.sonicToon){t.sonicToon.pressLeft()}else{t.windowLocation.x-=128}break;case 39:case 68:t.windowLocation.x+=128;if(t.sonicToon){t.sonicToon.pressRight()}else{t.windowLocation.x+=128}break}}function r(a){switch(a.keyCode){case 38:case 87:if(t.sonicToon){t.sonicToon.releaseJump()}break;case 40:case 83:if(t.sonicToon){t.sonicToon.releaseCrouch()}break;case 37:case 65:if(t.sonicToon){t.sonicToon.releaseLeft()}break;case 39:case 68:if(t.sonicToon){t.sonicToon.releaseRight()}break}}u.resizeCanvas=function(){u.canvasWidth=$(window).width();u.canvasHeight=$(window).height();u.canvas.attr("width",u.canvasWidth);u.canvas.attr("height",u.canvasHeight)};function p(a){a.clearRect(0,0,u.canvasWidth,u.canvasHeight)}u.draw=function(){requestAnimFrame(u.draw);p(u.canvasItem);t.draw(u.canvasItem);t.uiManager.draw(u.canvasItem)};$(window).resize(this.resizeCanvas);this.resizeCanvas();requestAnimFrame(u.draw);window.setInterval(t.tick,1000/60,t)}function SonicManager(e){var f=this.scale={x:2,y:2};this.windowLocation=_H.defaultWindowLocation(1);this.showHeightMap=false;this.goodRing=new Ring(false);this.activeRings=[];this.background=null;this.uiManager=new UIManager(this,e,this.scale);this.SonicLevel={Tiles:[],Blocks:[],Chunks:[],ChunkMap:[[]],Rings:{},curHeightMap:true,LevelWidth:0,LevelHeight:0};var d=new TileChunk()+new TilePiece()+new Tile()+new HeightMask();this.SonicLevel.ChunkMap=[[]];this.clickState=ClickState.PlaceChunk;this.onClick=function(b){return;if(b.shiftKey){var a=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[_H.floor(b.x/(128*f.x)),_H.floor(b.y/(128*f.y))]];var p=a.getTilePiece((b.x-_H.floor(b.x/(128*f.x))*(128*f.x)),(b.y-_H.floor(b.y/(128*f.y))*(128*f.y)),f);if(p){this.uiManager.indexes.tpIndex=this.SonicLevel.Blocks.indexOf(p);this.uiManager.modifyTilePieceArea.tilePiece=p;this.uiManager.solidTileArea.visible=true}}else{if(!b.button||b.button==0){switch(this.clickState){case ClickState.PlaceChunk:this.SonicLevel.ChunkMap[_H.floor(b.x/(128*f.x)),_H.floor(b.y/(128*f.y))]=this.uiManager.indexes.modifyIndex;break;case ClickState.PlaceRing:var n=_H.floor((b.x-_H.floor(b.x/(128*f.x))*(128*f.x))/(f.x));var o=_H.floor((b.y-_H.floor(b.y/(128*f.y))*(128*f.y))/(f.y));var m=(_H.floor(n/16))+(_H.floor(b.x/(128*f.x)))*8;var c=(_H.floor(o/16))+(_H.floor(b.y/(128*f.y)))*8;if(this.SonicLevel.Rings[c*8*sonicManager.SonicLevel.LevelWidth+m]){delete this.SonicLevel.Rings[c*8*sonicManager.SonicLevel.LevelWidth+m]}else{this.SonicLevel.Rings[c*8*sonicManager.SonicLevel.LevelWidth+m]={x:m,y:c}}break;default:}}}};this.tickCount=0;this.drawTickCount=0;this.tick=function(a){if(a.loading){return}if(a.sonicToon){a.tickCount++;a.sonicToon.ticking=true;try{a.sonicToon.tick(a.SonicLevel,f)}finally{a.sonicToon.ticking=false}if(a.sonicToon.y>128*sonicManager.SonicLevel.LevelHeight){a.sonicToon.y=0}if(a.sonicToon.x>128*sonicManager.SonicLevel.LevelWidth){a.sonicToon.x=0}}};this.screenOffset={x:e.canvas.width/2-this.windowLocation.width*f.x/2,y:e.canvas.height/2-this.windowLocation.height*f.y/2};this.draw=function(O){O.save();this.drawTickCount++;if((this.spriteLoader&&!this.spriteLoader.tick())||this.loading){O.fillStyle="white";O.fillText("Loading...   ",95,95);O.restore();return}this.screenOffset={x:O.canvas.width/2-this.windowLocation.width*f.x/2,y:O.canvas.height/2-this.windowLocation.height*f.y/2};if(this.sonicToon){if(this.sonicToon.ticking){while(true){if(!this.sonicToon.ticking){break}}}O.translate(this.screenOffset.x,this.screenOffset.y);O.fillStyle="#000000";O.fillRect(0,0,this.windowLocation.width*f.x,this.windowLocation.height*f.x);O.beginPath();O.rect(0,0,this.windowLocation.width*f.x,this.windowLocation.height*f.x);O.clip();this.windowLocation.x=_H.floor(this.sonicToon.x-160);this.windowLocation.y=_H.floor(this.sonicToon.y-180);var H=_H.floor(this.windowLocation.x/f.x);if(this.background){this.background.draw(O,{x:-_H.floor(this.windowLocation.x/2)*f.x,y:-(_H.floor(this.windowLocation.y/4))*f.y},f,H)}}if(this.windowLocation.x<0){this.windowLocation.x=0}if(this.windowLocation.y<0){this.windowLocation.y=0}if(this.windowLocation.x>128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width){this.windowLocation.x=128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width}if(this.windowLocation.y>128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height){this.windowLocation.y=128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height}var X=[];for(var T=-128;T<this.windowLocation.width;T+=128){for(var M=-128;M<this.windowLocation.height;M+=128){X.push({x:T,y:M})}}if(this.SonicLevel.Chunks&&this.SonicLevel.Chunks.length>0){for(var W in X){var J=(this.windowLocation.x+X[W].x+128)/128;var L=(this.windowLocation.y+X[W].y+128)/128;var r=_H.floor(J);var K=_H.floor(L);if(r<0||K<0){continue}var P=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[r][K]];if(!P){continue}var Y={x:r*128*f.x,y:K*128*f.y};var Z={x:Y.x-this.windowLocation.x*f.x,y:Y.y-this.windowLocation.y*f.x};P.draw(O,Z,f,false);if(!this.sonicToon){O.strokeStyle="#DD0033";O.lineWidth=3;O.strokeRect(Z.x,Z.y,128*f.x,128*f.y)}}for(var b in this.SonicLevel.Rings){var a=this.SonicLevel.Rings[b];if(this.sonicToon){if(!this.sonicToon.obtainedRing[b]){if(this.windowLocation.intersects(a)){this.goodRing.draw(O,{x:(a.X)-this.windowLocation.x,y:(a.Y)-this.windowLocation.y},f,true)}}}else{if(this.windowLocation.intersects(a)){this.goodRing.draw(O,{x:(a.X)-this.windowLocation.x,y:(a.Y)-this.windowLocation.y},f,false)}}}for(var U=0;U<sonicManager.SonicLevel.Objects.length;U++){var V=sonicManager.SonicLevel.Objects[U];if(this.sonicToon){if(this.windowLocation.intersects({X:V.ObjectData.X,Y:V.ObjectData.Y})){V.draw(O,{x:(V.ObjectData.X)-this.windowLocation.x,y:(V.ObjectData.Y)-this.windowLocation.y},f,true)}}else{if(this.windowLocation.intersects({X:V.ObjectData.X,Y:V.ObjectData.Y})){V.draw(O,{x:(V.ObjectData.X)-this.windowLocation.x,y:(V.ObjectData.Y)-this.windowLocation.y},f,false)}}}for(var T=this.activeRings.length-1;T>=0;T--){var N=this.activeRings[T];N.draw(O,{x:N.x-this.windowLocation.x,y:N.y-this.windowLocation.y},f);if(N.tickCount>256){_H.remove(this.activeRings,N)}}if(this.sonicToon){this.sonicToon.draw(O,f);if(this.windowLocation.x<0){this.windowLocation.x=0}if(this.windowLocation.y<0){this.windowLocation.y=0}if(this.windowLocation.x>128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width){this.windowLocation.x=128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width}if(this.windowLocation.y>128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height){this.windowLocation.y=128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height}}for(var W in X){var J=(this.windowLocation.x+X[W].x+128)/128;var L=(this.windowLocation.y+X[W].y+128)/128;var r=_H.floor(J);var K=_H.floor(L);if(r<0||K<0){continue}var P=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[r][K]];if(!P){continue}var Y={x:r*128*f.x,y:K*128*f.y};var Z={x:Y.x-this.windowLocation.x*f.x,y:Y.y-this.windowLocation.y*f.x};P.draw(O,Z,f,true);if(!this.sonicToon){O.strokeStyle="#DD0033";O.lineWidth=3;O.strokeRect(Z.x,Z.y,128*f.x,128*f.y)}if(this.showHeightMap){var Q;if((Q=sonicManager.SpriteCache.heightMapChunks[(this.SonicLevel.curHeightMap?1:2)+" "+P.index+" "+f.y+" "+f.x])){if(Q.loaded){O.drawImage(Q,Z.x,Z.y)}}else{var S=this.SonicLevel.curHeightMap?sonicManager.SonicLevel.CollisionIndexes1:sonicManager.SonicLevel.CollisionIndexes2;for(var I=0;I<8;I++){for(var l=0;l<8;l++){var c=P.tilePieces[l][I];var R=sonicManager.SonicLevel.HeightMaps[S[c.Block]];if(R==0){continue}if(R==1){O.fillStyle="rgba(24,98,235,0.6)";O.fillRect(Z.x+(l*16)*f.x,Z.y+(I*16)*f.y,f.x*16,f.y*16);continue}var aa={x:Z.x+(l*16)*f.x,y:Z.y+(I*16)*f.y};R.draw(O,aa,f,-1,c.XFlip,c.YFlip);if(false&&md[l][I]!=null){var o=md[l][I];aa.x+=16*f.x/2;aa.y+=16*f.y/2;O.moveTo(aa.x,aa.y);O.lineTo(aa.x+_H.sin((o))*10*f.x,aa.y+_H.cos((o))*10*f.y);O.strokeStyle="#D141FF";O.lineWidth=4;O.stroke()}}}}}if(!this.sonicToon){O.strokeStyle="#DD0033";O.lineWidth=3;O.strokeRect(Z.x,Z.y,128*f.x,128*f.y)}}}O.restore();if(this.sonicToon){this.sonicToon.drawUI(O,{x:this.screenOffset.x,y:this.screenOffset.y},f)}};this.spriteLoader=null;this.SpriteCache={rings:[],tileChunks:[],tilePeices:[],tiles:[],sonicSprites:[],heightMaps:[],heightMapChunks:[]};this.preLoadSprites=function(D,j,K){this.SpriteCache={rings:[],tileChunks:[],tilePeices:[],tiles:[],sonicSprites:[],heightMaps:[],heightMapChunks:[]};var c=this.SpriteCache.rings;var z=0;var H=[];for(var A=0;A<4;A++){H[A]="assets/Sprites/ring"+A+".png";this.imageLength++}var J=this;var C;var y={sprites:0,tps:0,tcs:0,ss:0,hms:0,hmc:0};var E=this.spriteLoader=new SpriteLoader(j,K);var I=E.addStep("Sprites",function(h,g){var l=h*200;c[l]=_H.loadSprite(H[h],function(m){c[m.tag*200+D.x*100+D.y]=_H.scaleSprite(m,D,function(n){g()})});c[l].tag=h},function(){y.sprites=y.sprites+1;if(y.sprites==4){return true}return false});for(var k=0;k<H.length;k++){E.addIterationToStep(I,k)}var J=this;var G=1;var b=E.addStep("Chunk Maps",function(p,m){var h=_H.defaultCanvas(128*D.x,128*D.y);var l=h.context;l.clearRect(0,0,h.width,h.height);C=J.SonicLevel.Chunks[p];C.draw(l,{x:0,y:0},D,false);var n=h.canvas.toDataURL("image/png");J.SpriteCache.tileChunks[false+" "+C.index+" "+D.y+" "+D.x]=_H.loadSprite(n,function(L){y.tcs++;m()});l.clearRect(0,0,h.width,h.height);if(!C.onlyBackground()){C.draw(l,{x:0,y:0},D,true);var n=h.canvas.toDataURL("image/png");J.SpriteCache.tileChunks[true+" "+C.index+" "+D.y+" "+D.x]=_H.loadSprite(n,function(L){y.tcs++;m()})}else{J.SpriteCache.tileChunks[true+" "+C.index+" "+D.y+" "+D.x]=1;y.tcs++;m()}var r={x:0,y:0};l.clearRect(0,0,h.width,h.height);for(var g=0;g<8;g++){for(var x=0;x<8;x++){var u=C.tilePieces[x][g];var q=sonicManager.SonicLevel.CollisionIndexes1[u.Block];var o=sonicManager.SonicLevel.HeightMaps[q];if(o==0){continue}var s=x;var w=g;if(o==1){l.fillStyle="rgba(24,98,235,0.6)";l.fillRect(r.x+(s*16)*D.x,r.y+(w*16)*D.y,D.x*16,D.y*16);continue}var t={x:r.x+(s*16)*D.x,y:r.y+(w*16)*D.y};o.draw(l,t,D,-1,u.XFlip,u.YFlip,u.Solid1);var v=sonicManager.SonicLevel.Angles[q];if(v!=255){t.x+=16*D.x/2;t.y+=16*D.y/2;l.moveTo(t.x,t.y);l.lineTo(t.x+_H.sin((v)*(Math.PI/180))*10*D.x,t.y+_H.cos((v)*(Math.PI/180))*10*D.y);l.strokeStyle="#D141FF";l.lineWidth=2;l.stroke()}}}var n=h.canvas.toDataURL("image/png");J.SpriteCache.heightMapChunks[1+" "+C.index+" "+D.y+" "+D.x]=_H.loadSprite(n,function(L){y.hmc++;m()});l.clearRect(0,0,h.width,h.height);for(var g=0;g<8;g++){for(var x=0;x<8;x++){var u=C.tilePieces[x][g];var o=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes2[u.Block]];if(o==0){continue}var s=x;var w=g;if(o==1){l.fillStyle="rgba(24,98,235,0.6)";l.fillRect(r.x+(s*16)*D.x,r.y+(w*16)*D.y,D.x*16,D.y*16);continue}var t={x:r.x+(s*16)*D.x,y:r.y+(w*16)*D.y};o.draw(l,t,D,-1,u.XFlip,u.YFlip,u.Solid2)}}var n=h.canvas.toDataURL("image/png");J.SpriteCache.heightMapChunks[2+" "+C.index+" "+D.y+" "+D.x]=_H.loadSprite(n,function(L){y.hmc++;m()})},function(){if(y.tcs>=J.SonicLevel.Chunks.length*2/G&&y.hmc>=J.SonicLevel.Chunks.length*2/G){return true}return false});for(var B=0;B<this.SonicLevel.Chunks.length;B++){E.addIterationToStep(b,B)}var a=E.addStep("Background data",function(h,g){var n=_H.defaultCanvas(J.SonicLevel.BackgroundWidth/2*128*D.x,J.SonicLevel.BackgroundHeight*128*D.y);var p=n.context;p.clearRect(0,0,n.width,n.height);for(var l=0;l<J.SonicLevel.BackgroundWidth/2;l++){for(var m=0;m<J.SonicLevel.BackgroundHeight;m++){var o=sonicManager.SonicLevel.Chunks[J.SonicLevel.BGChunkMap[l][m]];if(o){o.draw(p,{x:l*128*D.x,y:m*128*D.y},D,0)}}}J.SpriteCache.bgImage=_H.loadSprite(n.canvas.toDataURL("image/png"),g)},function(){J.background=new ParallaxBG(J.SpriteCache.bgImage,{x:1,y:1});return true});E.addIterationToStep(a,0);var F=E.addStep("Sonic Sprites",function(l,h){var g=J.SpriteCache.sonicSprites;g[l]=_H.loadSprite(J.spriteLocations[l],function(m){g[m.tag+D.x+D.y]=_H.scaleSprite(m,D,h)});g[l].tag=l},function(){y.ss++;if(y.ss==J.imageLength){return true}return false});J.spriteLocations=[];J.imageLength=0;J.spriteLocations.normal="assets/Sprites/sonic.png";E.addIterationToStep(F,"normal");J.imageLength++;var A;for(A=0;A<4;A++){J.spriteLocations["fastrunning"+A]="assets/Sprites/fastrunning"+A+".png";J.imageLength++;E.addIterationToStep(F,"fastrunning"+A)}for(A=0;A<8;A++){J.spriteLocations["running"+A]="assets/Sprites/running"+A+".png";J.imageLength++;E.addIterationToStep(F,"running"+A)}for(A=0;A<4;A++){J.spriteLocations["breaking"+A]="assets/Sprites/breaking"+A+".png";J.imageLength++;E.addIterationToStep(F,"breaking"+A)}for(A=0;A<5;A++){J.spriteLocations["balls"+A]="assets/Sprites/balls"+A+".png";J.imageLength++;E.addIterationToStep(F,"balls"+A)}for(A=0;A<2;A++){J.spriteLocations["duck"+A]="assets/Sprites/duck"+A+".png";J.imageLength++;E.addIterationToStep(F,"duck"+A)}for(A=0;A<2;A++){J.spriteLocations["hit"+A]="assets/Sprites/hit"+A+".png";J.imageLength++;E.addIterationToStep(F,"hit"+A)}for(A=0;A<6;A++){J.spriteLocations["spindash"+A]="assets/Sprites/spindash"+A+".png";J.imageLength++;E.addIterationToStep(F,"spindash"+A)}for(A=0;A<7;A++){J.spriteLocations["spinsmoke"+A]="assets/Sprites/spinsmoke"+A+".png";J.imageLength++;E.addIterationToStep(F,"spinsmoke"+A)}for(A=0;A<4;A++){J.spriteLocations["haltsmoke"+A]="assets/Sprites/haltsmoke"+A+".png";J.imageLength++;E.addIterationToStep(F,"haltsmoke"+A)}}}ClickState={PlaceChunk:0,PlaceRing:1};function SpriteLoader(d,f){var e=this;this.stepIndex=0;this.steps=[];this.tickIndex=0;this.tick=function(){if(this.stepIndex==this.steps.length){d();return true}var a=this.steps[this.stepIndex];if(!a){return true}if(e.tickIndex%5==0){f("Caching: "+a.title+" "+(e.tickIndex+"/"+a.iterations.length))}if(a.iterations.length>this.tickIndex){a.method(a.iterations[this.tickIndex++],function(){if(a.finish()){e.stepIndex++;e.tickIndex=0}})}return false};this.addStep=function(c,a,b){this.steps.push({title:c,method:a,finish:b,iterations:[]});return this.steps.length-1};this.addIterationToStep=function(b,a){this.steps[b].iterations.push(a)}}var Stats=function(){var c,r,n=0,o=0,d=Date.now(),q=d,p=d,g=0,j=1000,k=0,Q,e,a,s=[[16,16,48],[0,255,255]],h=0,l=1000,m=0,u,f,b,t=[[16,48,16],[0,255,0]];c=document.createElement("div");c.style.cursor="pointer";c.style.width="80px";c.style.opacity="0.9";c.style.zIndex="10001";c.addEventListener("mousedown",function(v){v.preventDefault();n=(n+1)%2;0==n?(Q.style.display="block",u.style.display="none"):(Q.style.display="none",u.style.display="block")},!1);Q=document.createElement("div");Q.style.textAlign="left";Q.style.lineHeight="1.2em";Q.style.backgroundColor="rgb("+_H.floor(s[0][0]/2)+","+_H.floor(s[0][1]/2)+","+_H.floor(s[0][2]/2)+")";Q.style.padding="0 0 3px 3px";c.appendChild(Q);e=document.createElement("div");e.style.fontFamily="Helvetica, Arial, sans-serif";e.style.fontSize="9px";e.style.color="rgb("+s[1][0]+","+s[1][1]+","+s[1][2]+")";e.style.fontWeight="bold";e.innerHTML="FPS";Q.appendChild(e);a=document.createElement("div");a.style.position="relative";a.style.width="74px";a.style.height="30px";a.style.backgroundColor="rgb("+s[1][0]+","+s[1][1]+","+s[1][2]+")";for(Q.appendChild(a);74>a.children.length;){r=document.createElement("span"),r.style.width="1px",r.style.height="30px",r.style.cssFloat="left",r.style.backgroundColor="rgb("+s[0][0]+","+s[0][1]+","+s[0][2]+")",a.appendChild(r)}u=document.createElement("div");u.style.textAlign="left";u.style.lineHeight="1.2em";u.style.backgroundColor="rgb("+_H.floor(t[0][0]/2)+","+_H.floor(t[0][1]/2)+","+_H.floor(t[0][2]/2)+")";u.style.padding="0 0 3px 3px";u.style.display="none";c.appendChild(u);f=document.createElement("div");f.style.fontFamily="Helvetica, Arial, sans-serif";f.style.fontSize="9px";f.style.color="rgb("+t[1][0]+","+t[1][1]+","+t[1][2]+")";f.style.fontWeight="bold";f.innerHTML="MS";u.appendChild(f);b=document.createElement("div");b.style.position="relative";b.style.width="74px";b.style.height="30px";b.style.backgroundColor="rgb("+t[1][0]+","+t[1][1]+","+t[1][2]+")";for(u.appendChild(b);74>b.children.length;){r=document.createElement("span"),r.style.width="1px",r.style.height=30*Math.random()+"px",r.style.cssFloat="left",r.style.backgroundColor="rgb("+t[0][0]+","+t[0][1]+","+t[0][2]+")",b.appendChild(r)}return{getDomElement:function(){return c},getFps:function(){return g},getFpsMin:function(){return j},getFpsMax:function(){return k},getMs:function(){return h},getMsMin:function(){return l},getMsMax:function(){return m},update:function(){d=Date.now();h=d-q;l=Math.min(l,h);m=Math.max(m,h);f.textContent=h+" MS ("+l+"-"+m+")";var v=Math.min(30,30-30*(h/200));b.appendChild(b.firstChild).style.height=v+"px";q=d;o++;if(d>p+1000){g=Math.round(1000*o/(d-p)),j=Math.min(j,g),k=Math.max(k,g),e.textContent=g+" FPS ("+j+"-"+k+")",v=Math.min(30,30-30*(g/100)),a.appendChild(a.firstChild).style.height=v+"px",p=d,o=0}}}};function Tile(b){this.colors=b;this.sprites=[];Tile.prototype.changeColor=function(e,f,a){this.colors[e][f]=a;this.sprites=[]};Tile.prototype.draw=function(a,t,u,v,w,s,q){for(var m=0;m<this.colors.length;m++){for(var p=0;p<this.colors[m].length;p++){var j=this.colors[m][p];if(j==0){continue}var r=sonicManager.SonicLevel.Palette[s][j];a.fillStyle="#"+r;if(v){if(w){a.fillRect(t.x+(7-(m))*u.x,t.y+(7-p)*u.y,u.x,u.y)}else{a.fillRect(t.x+(7-(m))*u.x,t.y+(p)*u.y,u.x,u.y)}}else{if(w){a.fillRect(t.x+((m))*u.x,t.y+(7-p)*u.y,u.x,u.y)}else{a.fillRect(t.x+((m))*u.x,t.y+(p)*u.y,u.x,u.y)}}}}}}function TileChunk(b){this.tilePieces=b;this.hLayer=[[]];this.sprites=[];TileChunk.prototype.getTilePiece=function(e,f,a){return sonicManager.SonicLevel.Blocks[this.tilePieces[_H.floor((e/a.x/16))][_H.floor((f/a.y/16))]]};TileChunk.prototype.onlyBackground=function(){for(var a=0;a<this.tilePieces.length;a++){for(var f=0;f<this.tilePieces[a].length;f++){var h=this.tilePieces[a][f];var g=sonicManager.SonicLevel.Blocks[h.Block];if(g){if(!g.onlyBackground()){return false}}}}return true};TileChunk.prototype.draw=function(a,q,s,o){var j;if((j=sonicManager.SpriteCache.tileChunks[o+" "+this.index+" "+s.y+" "+s.x])){if(j==1){return}if(j.loaded){a.drawImage(j,q.x,q.y)}}else{for(var m=0;m<this.tilePieces.length;m++){for(var n=0;n<this.tilePieces[m].length;n++){var r=this.tilePieces[m][n];var p=sonicManager.SonicLevel.Blocks[r.Block];if(p){p.draw(a,{x:q.x+m*16*s.x,y:q.y+n*16*s.y},s,o,r.XFlip,r.YFlip)}}}}return true}}function TileItem(){TileItem.prototype.draw=function(){}}function TilePiece(c,d){this.tiles=d;TilePiece.prototype.click=function(b,f,a){};TilePiece.prototype.mouseOver=function(a,b){};TilePiece.prototype.onlyBackground=function(){for(var a=0;a<this.tiles.length;a++){var b=this.tiles[a];if(sonicManager.SonicLevel.Tiles[b.Tile]){if(b.Priority==true){return false}}}return true};TilePiece.prototype.draw=function(a,r,s,p,t,u){var b;if(t){if(u){b=[3,2,1,0]}else{b=[1,0,3,2]}}else{if(u){b=[2,3,0,1]}else{b=[0,1,2,3]}}var n;if((n=sonicManager.SpriteCache.tilePeices[p+" "+this.index+" "+s.y+" "+s.x])){if(n.loaded){a.drawImage(n,r.x,r.y)}}else{for(var o=0;o<this.tiles.length;o++){var q=this.tiles[o];if(sonicManager.SonicLevel.Tiles[q.Tile]){if(q.Priority==p){sonicManager.SonicLevel.Tiles[q.Tile].draw(a,{x:r.x+(b[o]%2)*8*s.x,y:r.y+_H.floor(b[o]/2)*8*s.y},s,_H.xor(t,q.XFlip),_H.xor(u,q.YFlip),q.Palette,false,p)}}}}return true};TilePiece.prototype.equals=function(b){for(var a=0;a<this.tiles.length;a++){if(b[a]!=this.tiles[a]){return false}}return true}}RotationMode={Floor:134,RightWall:224,Ceiling:314,LeftWall:44};function UiArea(n,o,m,j,k,h){this.x=n;this.y=o;this.manager=k;this.closable=h;this.width=m;this.height=j;this.depth=0;this.visible=true;this.dragging=false;this.controls=[];this.addControl=function(a){a.parent=this;this.controls.push(a);return a};var l=this;if(h){this.addControl(new Button(this.width-30,4,26,26,"X",this.manager.buttonFont,"Green",function(){l.visible=false}))}this.click=function(b){if(!this.visible){return}for(var c=0;c<this.controls.length;c++){var a=this.controls[c];if(a.visible&&a.y<=b.y&&a.y+a.height>b.y&&a.x<=b.x&&a.x+a.width>b.x){b.x-=a.x;b.y-=a.y;a.onClick(b);return false}}this.dragging={x:b.x,y:b.y}};this.mouseMove=function(b){if(!this.visible){return}if(!this.dragging){for(var c=0;c<this.controls.length;c++){var a=this.controls[c];if(a.visible&&a.y<=b.y&&a.y+a.height>b.y&&a.x<=b.x&&a.x+a.width>b.x){b.x-=a.x;b.y-=a.y;a.onMouseOver(b)}}return}this.x+=b.x-this.dragging.x;this.y+=b.y-this.dragging.y};this.mouseUp=function(b){if(!this.visible){return}for(var c=0;c<this.controls.length;c++){var a=this.controls[c];a.onMouseUp({x:b.x-a.x,y:b.y-a.y})}this.dragging=false};this.scroll=function(b){if(!this.visible){return}for(var c=0;c<this.controls.length;c++){var a=this.controls[c];if(a.visible&&a.y<=b.y&&a.y+a.height>b.y&&a.x<=b.x&&a.x+a.width>b.x){if(a.onScroll){b.x-=a.x;b.y-=a.y;a.onScroll(b);return false}}}};this.cachedDrawing=null;this.draw=function(c){if(!this.visible){return}var f;var r;var g;if(!this.cachedDrawing){var d=document.createElement("canvas");d.width=this.width+20;d.height=this.height+20;var e=d.getContext("2d");e.fillStyle="rgba(133,133,133,0.6)";e.lineWidth=9;e.strokeStyle="#333";var a=this.x;var b=this.y;this.x=10;this.y=10;roundRect(e,this.x,this.y,this.width,this.height,5,true,true);for(g=0;g<this.controls.length;g++){r=this.controls[g];f=r.forceDrawing();if(f.redraw){r.draw(e)}}this.x=a;this.y=b;this.cachedDrawing=_H.loadSprite(d.toDataURL("image/png"))}if(this.cachedDrawing.loaded){c.drawImage(this.cachedDrawing,_H.floor(this.x),_H.floor(this.y));if(this.cachedDrawing.width!=this.width+20||this.cachedDrawing.height!=this.height+20){this.cachedDrawing=null}c.save();c.translate(10,10);for(g=0;g<this.controls.length;g++){r=this.controls[g];f=r.forceDrawing();if(!f.redraw){r.draw(c)}if(f.clearCache){this.cachedDrawing=null}}c.restore()}else{c.fillStyle="rgba(133,133,133,0.6)";c.lineWidth=9;c.strokeStyle="#333";c.save();c.translate(10,10);roundRect(c,this.x,this.y,this.width,this.height,5,true,true);for(g=0;g<this.controls.length;g++){r=this.controls[g];r.draw(c)}c.restore()}};return this}function TextArea(j,k,h,g,f){this.forceDrawing=function(){if((_H.isFunction(this.text)?this.text():this.text)==this.oldText){return{redraw:true,clearCache:false}}this.oldText=_H.isFunction(this.text)?this.text():this.text;return{redraw:true,clearCache:true}};this.x=j;this.oldText="";this.y=k;this.visible=true;this.text=h;this.font=g;this.color=f;this.parent=null;this.onClick=function(a){return false};this.onMouseUp=function(a){if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(a){if(this.mouseOver){this.mouseOver()}};this.draw=function(a){if(!this.visible){return}var d=_H.isFunction(this.text)?this.text():this.text;if(a.font!=this.font){a.font=this.font}var e=a.measureText(d).width;var b=parseInt(a.font.split("pt")[0]);var c=3;a.strokeStyle=this.color;a.shadowColor="#FFF";a.shadowBlur=20;a.lineWidth=1.5;a.strokeText(d,this.parent.x+this.x,this.parent.y+this.y);a.strokeText(d,this.parent.x+this.x,this.parent.y+this.y);a.strokeText(d,this.parent.x+this.x,this.parent.y+this.y);a.strokeText(d,this.parent.x+this.x,this.parent.y+this.y);a.strokeText(d,this.parent.x+this.x,this.parent.y+this.y);a.shadowBlur=0};return this}function Button(t,u,s,o,r,n,m,l,q,p){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=t;this.y=u;this.visible=true;this.width=s;this.height=o;this.text=r;this.font=n;this.clicking=false;this.click=l;this.mouseUp=q;this.mouseOver=p;this.color=m;this.parent=null;this.onClick=function(a){if(!this.visible){return}this.clicking=true};this.onMouseUp=function(a){if(!this.visible){return}if(this.clicking){if(this.click){this.click()}}this.clicking=false;if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(a){if(!this.visible){return}if(this.mouseOver){this.mouseOver()}};this.draw=function(a){if(!this.visible){return}a.fillStyle=this.color;a.strokeStyle="#DAC333";a.lineWidth=2;roundRect(a,this.parent.x+this.x,this.parent.y+this.y,this.width,this.height,5,true,true);a.fillStyle=this.clicking?"#FCA":"#334";if(a.font!=this.font){a.font=this.font}a.fillText(this.text,this.parent.x+this.x+((this.width/2)-(a.measureText(this.text).width/2)),this.parent.y+this.y+(this.height/3)*2)};return this}function TilePieceArea(j,k,f,h,g){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=j;this.y=k;this.visible=true;this.scale=f;this.width=f.x*16;this.height=f.y*17;this.clicking=false;this.tilePiece=h;this.parent=null;this.state=g;this.onClick=function(a){if(!this.visible){return}this.clicking=true;this.clickHandled=false};this.onMouseUp=function(a){if(!this.visible){return}if(this.tilePiece&&this.clicking&&!this.clickHandled){this.tilePiece.click(_H.floor(a.x/f.x),_H.floor(a.y/f.y),this.state)}this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(a){if(!this.tilePiece){return}if(this.clicking){this.clickHandled=true;this.tilePiece.click(_H.floor(a.x/f.x),_H.floor(a.y/f.y),this.state)}else{this.tilePiece.mouseOver(_H.floor(a.x/f.x),_H.floor(a.y/f.y))}};this.draw=function(a){if(!this.visible){return}if(!this.tilePiece){return}this.tilePiece.tag=true;this.tilePiece.draw(a,{x:this.parent.x+this.x,y:this.parent.y+this.y},this.scale,this.state,true);this.tilePiece.tag=false};return this}function TileBGEditArea(e,f,d){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=e;this.y=f;this.visible=true;this.clicking=false;this.parallaxBG=d;this.parent=null;this.lowestClickedY=-1;this.highestClickedY=-1;this.onClick=function(b){if(!this.visible){return}this.clicking=true;this.parallaxBG=sonicManager.background;if(b.x>0&&b.y>0&&b.y<this.parallaxBG.height&&b.x<this.parallaxBG.width){var a;if((a=this.parallaxBG.onBar(b.x,b.y))){this.lowestClickedY=a.top;this.highestClickedY=a.bottom}else{this.lowestClickedY=b.y;this.highestClickedY=b.y}}this.clickHandled=false};this.onMouseUp=function(a){if(!this.visible){return}this.parallaxBG=sonicManager.background;this.highestClickedY=-1;this.lowestClickedY=-1;this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(a){if(!this.clicking){return}this.parallaxBG=sonicManager.background;if(a.x>0&&a.y>0&&a.y<this.parallaxBG.height&&a.x<this.parallaxBG.width){if(a.y>this.highestClickedY){this.highestClickedY=a.y}if(a.y<this.lowestClickedY){this.lowestClickedY=a.y}for(var b=this.lowestClickedY;b<this.highestClickedY;b++){this.parallaxBG.click(a.x,b)}}return false};this.draw=function(a){if(!this.visible){return}this.parallaxBG=sonicManager.background;if(!this.parallaxBG){return}this.width=this.parallaxBG.width;this.height=this.parallaxBG.height;this.parent.width=this.width+70;this.parent.height=this.height+50;var b={x:1,y:1};this.parallaxBG.drawUI(a,{x:this.parent.x+this.x,y:this.parent.y+this.y},b)};return this}function TileChunkArea(j,k,f,h,g){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=j;this.y=k;this.visible=true;this.scale=f;this.width=f.x*128;this.height=f.y*128;this.clicking=false;this.tileChunk=h;this.parent=null;this.state=g;this.setToTile=null;this.onClick=function(a){if(!this.visible){return}this.clicking=true};this.onMouseUp=function(a){if(!this.visible){return}if(this.clicking){if(this.setToTile!=null){this.tileChunk.tilePieces[((_H.floor(a.x/this.scale.x/16)))][(_H.floor(a.y/this.scale.y/16))]=sonicManager.SonicLevel.Blocks.indexOf(this.setToTile);this.tileChunk.sprites=[]}}this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(a){if(this.clicking){}};this.draw=function(a){if(!this.visible){return}if(!this.tileChunk){return}this.tileChunk.draw(a,{x:this.parent.x+this.x,y:this.parent.y+this.y},this.scale,true)};return this}function ScrollBox(p,q,l,o,m,j,k){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=p;this.y=q;this.itemWidth=m;this.visible=true;var n=14;this.width=m+n;this.visibleItems=o;this.itemHeight=l;this.backColor=j;this.height=o*l;this.parent=null;this.scrollOffset=0;this.scrollPosition=0;this.dragging=false;if(k){this.controls=k}else{this.controls=[]}this.scrolling=false;this.addControl=function(a){a.parent=this;this.controls.push(a);return a};this.onClick=function(b){if(!this.visible){return}for(var c=this.scrollOffset;c<this.controls.length;c++){var a=this.controls[c];if(a.y<=b.y&&a.y+a.height>b.y&&a.x<=b.x&&a.x+a.width>b.x){b.x-=a.x;b.y-=a.y;a.onClick(b);return false}}if(b.x>this.itemWidth&&b.x<this.itemWidth+n){if(this.scrollPosition>b.y){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}}this.dragging=true;return false};this.onMouseUp=function(b){if(!this.visible){return}this.dragging=false;for(var c=this.scrollOffset;c<this.controls.length;c++){var a=this.controls[c];if(a.y<=b.y&&a.y+a.height>b.y&&a.x<=b.x&&a.x+a.width>b.x){b.x-=a.x;b.y-=a.y;a.onMouseUp(b);return false}}if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(b){if(!this.visible){return}for(var c=0;c<this.controls.length;c++){var a=this.controls[c];if(a.y<=b.y&&a.y+a.height>b.y&&a.x<=b.x&&a.x+a.width>b.x){b.x-=a.x;b.y-=a.y;a.onMouseOver(b);break}}if(this.dragging&&b.x>this.itemWidth&&b.x<this.itemWidth+n){if(this.scrollPosition>b.y){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}}if(this.mouseOver){this.mouseOver()}};this.onScroll=function(b){if(!this.visible){return}if(b.delta>0){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}for(var c=0;c<this.controls.length;c++){var a=this.controls[c];if(a.y<=b.y&&a.y+a.height>b.y&&a.x<=b.x&&a.x+a.width>b.x){b.x-=a.x;b.y-=a.y;if(a.onScroll){a.onScroll(b)}return false}}if(this.scroll){this.scroll()}};this.draw=function(a){if(!this.visible){return}a.fillStyle=this.backColor;var c;a.fillStyle=this.backColor;a.lineWidth=1;a.strokeStyle="#333";roundRect(a,this.parent.x+this.x,this.parent.y+this.y,this.itemWidth+n+6,this.visibleItems*this.itemHeight,3,true,true);a.fillStyle="grey";a.lineWidth=1;a.strokeStyle="#444";a.fillRect(this.parent.x+this.x+this.itemWidth+2+2,this.parent.y+this.y+2,n,this.visibleItems*this.itemHeight-2);a.fillStyle="red";a.lineWidth=1;a.strokeStyle="#444";this.scrollPosition=(this.visibleItems*this.itemHeight-2)*this.scrollOffset/this.controls.length;a.fillRect(this.parent.x+this.x+this.itemWidth+2+2+2,this.parent.y+this.y+2+(this.scrollPosition),n-2,5);var b=1;for(c=this.scrollOffset;c<Math.min(this.controls.length,this.scrollOffset+this.visibleItems);c++){this.controls[c].parent={x:this.parent.x+this.x,y:this.parent.y+this.y};this.controls[c].x=2;this.controls[c].y=b;this.controls[c].height=this.itemHeight;this.controls[c].width=this.itemWidth;b+=this.itemHeight;this.controls[c].draw(a)}};return this}function roundRect(j,p,q,o,l,m,k,n){if(typeof n=="undefined"){n=true}if(typeof m==="undefined"){m=5}j.beginPath();j.moveTo(p+m,q);j.lineTo(p+o-m,q);j.quadraticCurveTo(p+o,q,p+o,q+m);j.lineTo(p+o,q+l-m);j.quadraticCurveTo(p+o,q+l,p+o-m,q+l);j.lineTo(p+m,q+l);j.quadraticCurveTo(p,q+l,p,q+l-m);j.lineTo(p,q+m);j.quadraticCurveTo(p,q,p+m,q);j.closePath();if(n){j.stroke()}if(k){j.fill()}}function UIManager(Q,I,O){this.UIAreas=[];this.messages=[];var S=this.textFont="18pt sans-serrif ";var z=this.buttonFont="13pt Arial bold";I.font=S;var D=this.indexes={tpIndex:0,modifyIndex:0,modifyTPIndex:0};this.dragger=new Dragger(function(a,b){Q.windowLocation.x+=a;Q.windowLocation.y+=b});this.draw=function(d){this.dragger.tick();d.save();var e=JSLINQ(this.UIAreas).OrderBy(function(f){return f.depth});for(var b=0;b<e.items.length;b++){var c=e.items[b];c.draw(d)}if(DEBUGs){for(var a=0;a<this.messages.length;a++){d.fillText(this.messages[a],10,25+a*30)}}d.restore()};this.onMouseScroll=function(d){var c=d.wheelDelta?d.wheelDelta/40:d.detail?-d.detail:0;for(var a=0;a<this.UIAreas.length;a++){var b=this.UIAreas[a];if(b.visible&&b.y<=d.y&&b.y+b.height>d.y&&b.x<=d.x&&b.x+b.width>d.x){d={x:d.x-b.x-10,y:d.y-b.y-10,delta:c};return b.scroll(d)}}return false};this.onClick=function(a){var f=_H.getCursorPosition(a);f.x-=10;f.y-=10;var c=null;var e;var d;var g=JSLINQ(this.UIAreas).OrderBy(function(h){return -h.depth});for(var d=0;d<g.items.length;d++){var e=g.items[d];if(e.visible&&e.y<=f.y&&e.y+e.height>f.y&&e.x<=f.x&&e.x+e.width>f.x){c=e;var b={x:f.x-e.x,y:f.y-e.y};e.click(b);break}}if(c){for(d=0;d<this.UIAreas.length;d++){e=this.UIAreas[d];if(c==e){e.depth=1}else{e.depth=0}}return true}this.dragger.click(a);return false};this.onMouseMove=function(a){var d=_H.getCursorPosition(a);d.x-=10;d.y-=10;var e=JSLINQ(this.UIAreas).OrderBy(function(f){return -f.depth});for(var b=0;b<e.items.length;b++){var c=e.items[b];if(c.dragging||(c.visible&&c.y<=d.y&&c.y+c.height>d.y&&c.x<=d.x&&c.x+c.width>d.x)){d={x:d.x-c.x,y:d.y-c.y};return c.mouseMove(d)}}this.dragger.mouseMove(a);return false};this.onMouseUp=function(e){var d=_H.getCursorPosition(e,true);d.x-=10;d.y-=10;for(var b=0;b<this.UIAreas.length;b++){var c=this.UIAreas[b];var a={x:d.x-c.x,y:d.y-c.y};c.mouseUp(a)}this.dragger.mouseUp(e)};var C=this.debuggerArea=new UiArea(1347,95,200,240,this,true);C.visible=false;this.UIAreas.push(C);C.addControl(new TextArea(30,25,"Debugger",S,"blue"));C.addControl(new Button(40,60,60,22,"Stop",z,"rgb(50,150,50)",function(){Q.windowLocation=_H.defaultWindowLocation(1);C.visible=false;P.visible=false;E.visible=true;F.visible=true;Q.sonicToon=null}));C.addControl(new Button(40,95,90,22,"Hit Sonic",z,"rgb(50,150,50)",function(){Q.sonicToon.hit()}));C.addControl(new Button(40,130,160,22,"Show Height Map",z,"rgb(50,150,50)",function(){if(this.text=="Show Height Map"){Q.showHeightMap=true;this.text="Hide Height Map"}else{Q.showHeightMap=false;this.text="Show Height Map"}}));C.addControl(new Button(40,160,160,22,"Switch Height Map",z,"rgb(50,150,50)",function(){Q.SonicLevel.curHeightMap=!Q.SonicLevel.curHeightMap}));C.addControl(new Button(40,190,160,22,"Debug Sonic",z,"rgb(50,150,50)",function(){if(this.text=="Debug Sonic"){Q.sonicToon.debugging=true;this.text="Normal Sonic"}else{Q.sonicToon.debugging=false;this.text="Debug Sonic"}}));var P=this.solidTileArea=new UiArea(40,450,430,400,this,true);P.visible=false;this.UIAreas.push(P);P.addControl(new TextArea(30,25,"Modify Solid Tile",S,"blue"));P.addControl(new Button(50,35,25,22,"<<",z,"rgb(50,150,50)",function(){if(D.tpIndex>0){M.tilePiece=Q.SonicLevel.Blocks[--D.tpIndex]}}));P.addControl(new Button(75,35,25,22,">>",z,"rgb(50,150,50)",function(){if(D.tpIndex<Q.SonicLevel.Blocks.length){M.tilePiece=Q.SonicLevel.Blocks[++D.tpIndex]}}));P.addControl(new Button(360,80,45,22,"Full",z,"rgb(50,150,50)",function(){for(var a=0;a<16;a++){M.tilePiece.heightMask.items[a]=16}this.sprites=[]}));P.addControl(new Button(200,35,180,22,"Modify Height Map",z,"rgb(50,150,50)",function(){M.state=(M.state+1)%3;switch(M.state){case 0:this.text="Modify Height Map";break;case 1:this.text="Modify Tile Direction";break;case 2:this.text="Modify Tile Colors";break}}));var M=this.modifyTilePieceArea=new TilePieceArea(30,70,{x:4*5,y:4*5},null,0);P.addControl(M);var y=this.bgEditor=new UiArea(100,440,420,360,this,true);y.visible=false;this.UIAreas.push(y);y.addControl(new TextArea(30,25,"BG Editor",S,"blue"));y.addControl(new TileBGEditArea(60,35));var E=this.levelInformation=new UiArea(70,70,470,360,this);E.visible=true;this.UIAreas.push(E);E.addControl(new TextArea(30,25,"Level Selector",S,"blue"));E.addControl(new TextArea(30,52,function(){return !B?"Level Not Saved":(B)},S,"black"));E.addControl(new Button(250,70,100,22,"Save Level",z,"rgb(50,150,50)",function(){if(B){OurSonic.SonicLevels.SaveLevelInformation(B,Base64.encode(_H.stringify(Q.SonicLevel)),function(a){},function(a){alert("Failure: "+_H.stringify(a))})}else{OurSonic.SonicLevels.saveLevel(Base64.encode(_H.stringify(Q.SonicLevel)),function(a){x(B)})}}));var R;E.addControl(R=new Button(250,105,160,22,"Load Empty Level",z,"rgb(50,150,50)",function(){F.visible=true;H.visible=true;var a=0;var b=function(){var c=188;if(a==c){setTimeout(function(){alert(_H.stringify(Q.SonicLevel));G(_H.stringify(Q.SonicLevel),I);H.visible=false},500);return}setTimeout(b,100);_H.loadSprite("assets/Chunks/Tile"+a+++".png",function(d){H.text="Loading "+a+"/"+c;Q.importChunkFromImage(d);if(a==c){Q.inds={done:true}}})};setTimeout(b,100)}));R.visible=false;var A;E.addControl(A=new ScrollBox(30,70,25,11,190,"rgb(50,60,127)"));var B;OurSonic.SonicLevels.getLevels(function(c){for(var a=0;a<c.length;a++){var b=c[a];x(b)}});function x(b){var a;A.addControl(a=new Button(0,0,0,0,b,"10pt Arial","rgb(50,190,90)",function(){B="Downloading";OurSonic.SonicLevels.getLevel(b,function(c){B="loading";B=b;G(c,I)})}))}var F=this.levelManagerArea=new UiArea(500,25,400,400,this);F.visible=false;this.UIAreas.push(F);F.addControl(new TextArea(30,25,"Level Manager",S,"blue"));var H;F.addControl(H=new TextArea(270,25,"Loading",S,"green"));H.visible=false;F.addControl(new Button(35,100,160,22,"Show Height Map",z,"rgb(50,150,50)",function(){if(this.text=="Show Height Map"){Q.showHeightMap=true;this.text="Hide Height Map"}else{Q.showHeightMap=false;this.text="Show Height Map"}}));F.addControl(new Button(200,150,160,22,"Place Chunks",z,"rgb(50,150,50)",function(){Q.clickState=(Q.clickState+1)%2;switch(Q.clickState){case ClickState.PlaceChunk:this.text="Place Chunks";break;case ClickState.PlaceRing:this.text="Place Rings";break}}));F.addControl(new Button(200,180,160,22,"Switch Height Map",z,"rgb(50,150,50)",function(){Q.SonicLevel.curHeightMap=!Q.SonicLevel.curHeightMap}));F.addControl(new Button(35,150,160,22,"Modify Chunks",z,"rgb(50,150,50)",function(){L.visible=true}));F.addControl(new Button(35,150,160,22,"Modify Chunks",z,"rgb(50,150,50)",function(){L.visible=true}));F.addControl(new Button(35,175,160,22,"Modify Tile Pieces",z,"rgb(50,150,50)",function(){P.visible=true}));F.addControl(new Button(35,200,160,22,"Modify Tiles",z,"rgb(50,150,50)",function(){K.visible=true}));F.addControl(new Button(35,240,160,22,"Modify Background",z,"rgb(50,150,50)",function(){y.visible=true}));F.addControl(new Button(200,35,60,22,"Run",z,"rgb(50,150,50)",function(){F.visible=false;P.visible=false;E.visible=false;K.visible=false;L.visible=false;P.visible=false;C.visible=true;Q.background.cache(Q.scale);Q.windowLocation=_H.defaultWindowLocation(0);Q.sonicToon=new Sonic(Q.SonicLevel,Q.scale);Q.sonicToon.obtainedRing=[]}));var L=this.modifyTileChunkArea=new UiArea(900,450,400,400,this,true);L.visible=false;this.UIAreas.push(L);L.addControl(new TextArea(30,25,"Modify Tile Chunk",S,"blue"));var J=this.modifyTC=new TileChunkArea(30,70,{x:2,y:2},null,1);L.addControl(J);L.addControl(new Button(50,35,25,22,"<<",z,"rgb(50,150,50)",function(){if(D.modifyIndex>0){J.tileChunk=Q.SonicLevel.Chunks[--D.modifyIndex]}}));L.addControl(new Button(80,35,25,22,">>",z,"rgb(50,150,50)",function(){if(D.modifyIndex<Q.SonicLevel.Chunks.length){J.tileChunk=Q.SonicLevel.Chunks[++D.modifyIndex]}}));var N=this.modifyTP=new TilePieceArea(300,160,{x:2*3,y:2*3},null,3);L.addControl(N);L.addControl(new Button(300,100,25,22,"<<",z,"rgb(50,150,50)",function(){if(D.modifyTPIndex>0){N.tilePiece=J.setToTile=Q.SonicLevel.Blocks[--D.modifyTPIndex]}}));L.addControl(new Button(330,100,25,22,">>",z,"rgb(50,150,50)",function(){if(D.modifyTPIndex<Q.SonicLevel.Blocks.length){N.tilePiece=J.setToTile=Q.SonicLevel.Blocks[++D.modifyTPIndex]}}));var K=this.modifyTileArea=new UiArea(900,25,400,400,this,true);K.visible=false;this.UIAreas.push(K);K.addControl(new TextArea(30,25,"Modify Tile",S,"blue"));function G(e,f){F.visible=true;Q.loading=true;Q.SonicLevel=jQuery.parseJSON(e);var q;var a;if(!Q.SonicLevel.Chunks){Q.SonicLevel.Chunks=[]}if(!Q.SonicLevel.Blocks){Q.SonicLevel.Blocks=[]}if(!Q.SonicLevel.Tiles){Q.SonicLevel.Tiles=[]}if(!Q.SonicLevel.Rings){Q.SonicLevel.Rings=[]}Q.SonicLevel.LevelWidth=Q.SonicLevel.ForegroundWidth;Q.SonicLevel.LevelHeight=Q.SonicLevel.ForegroundHeight;var g=decodeNumeric(Q.SonicLevel.Foreground);Q.SonicLevel.ChunkMap=[];Q.SonicLevel.ChunkMap.length=Q.SonicLevel.ForegroundWidth;for(var m=0;m<Q.SonicLevel.ForegroundWidth;m++){Q.SonicLevel.ChunkMap[m]=[];Q.SonicLevel.ChunkMap[m].length=Q.SonicLevel.ForegroundHeight;for(var n=0;n<Q.SonicLevel.ForegroundHeight;n++){Q.SonicLevel.ChunkMap[m][n]=g[m+n*Q.SonicLevel.ForegroundWidth]}}var g=decodeNumeric(Q.SonicLevel.Background);Q.SonicLevel.BGChunkMap=[];Q.SonicLevel.BGChunkMap.length=Q.SonicLevel.BackgroundWidth;for(var m=0;m<Q.SonicLevel.BackgroundWidth;m++){Q.SonicLevel.BGChunkMap[m]=[];Q.SonicLevel.BGChunkMap[m].length=Q.SonicLevel.BackgroundHeight;for(var n=0;n<Q.SonicLevel.BackgroundHeight;n++){Q.SonicLevel.BGChunkMap[m][n]=g[m+n*Q.SonicLevel.BackgroundWidth]}}for(var d=0;d<Q.SonicLevel.Objects.length;d++){var k=Q.SonicLevel.Objects[d];Q.SonicLevel.Objects[d]=_H.ObjectParse(k)}Q.SonicLevel.curHeightMap=true;for(a=0;a<Q.SonicLevel.Tiles.length;a++){q=Q.SonicLevel.Tiles[a];Q.SonicLevel.Tiles[a]=decodeNumeric(q);var h=[];for(var d=0;d<Q.SonicLevel.Tiles[a].length;d++){var p=Q.SonicLevel.Tiles[a][d];h.push(p>>4);h.push(p&15)}Q.SonicLevel.Tiles[a]={colors:h};var o=Q.SonicLevel.Tiles[a];var g=[];g.length=8;for(var k=0;k<8;k++){g[k]=[];g[k].length=8}for(var j=0;j<o.colors.length;j++){g[j%8][_H.floor(j/8)]=o.colors[j]}o.colors=g;o.__proto__=Tile.prototype;o.index=a}for(a=0;a<Q.SonicLevel.Blocks.length;a++){q=Q.SonicLevel.Blocks[a];var h={};h.__proto__=TilePiece.prototype;h.index=a;h.tiles=[];for(var l=0;l<q.length;l++){h.tiles.push(q[l]);q[l].__proto__=TileItem.prototype}Q.SonicLevel.Blocks[a]=h}var c;for(var s=0;s<Q.SonicLevel.HeightMaps.length;s++){Q.SonicLevel.HeightMaps[s]=new HeightMask(0,Q.SonicLevel.HeightMaps[s])}Q.SonicLevel.Angles=decodeNumeric(Q.SonicLevel.Angles);Q.SonicLevel.CollisionIndexes1=decodeNumeric(Q.SonicLevel.CollisionIndexes1);Q.SonicLevel.CollisionIndexes2=decodeNumeric(Q.SonicLevel.CollisionIndexes2);var b;for(a=0;a<Q.SonicLevel.Chunks.length;a++){q=Q.SonicLevel.Chunks[a];var h={};h.__proto__=TileChunk.prototype;h.index=a;h.tilePieces=[];h.tilePieces.length=8;for(var s=0;s<8;s++){h.tilePieces[s]=[];h.tilePieces[s].length=8}for(var l=0;l<q.length;l++){h.tilePieces[l%8][_H.floor(l/8)]=(q[l])}Q.SonicLevel.Chunks[a]=h}var r=function(){Q.loading=false;J.tileChunk=Q.SonicLevel.Chunks[0];M.tilePiece=N.tilePiece=Q.SonicLevel.Blocks[0]};B="preloading sprites";Q.preLoadSprites(O,function(){r();B="level loaded"},function(t){B=t})}}function Dragger(b){this.lastPos=null;this.xsp=0;this.ysp=0;this.lag=1;this.click=function(a){this.lastPos={x:a.x,y:a.y}};this.mouseUp=function(a){this.lastPos=null};this.mouseMove=function(a){if(!this.lastPos){return}this.xsp+=(this.lastPos.x-a.x)*0.4;this.ysp+=(this.lastPos.y-a.y)*0.4;this.xsp=(this.xsp>0?1:-1)*Math.min(Math.abs(this.xsp),30);this.ysp=(this.ysp>0?1:-1)*Math.min(Math.abs(this.ysp),30);this.lastPos={x:a.x,y:a.y}};this.tick=function(){b(this.xsp,this.ysp);if(this.xsp>0){this.xsp-=this.lag}else{this.xsp+=this.lag}if(this.ysp>0){this.ysp-=this.lag}else{this.ysp+=this.lag}if(Math.abs(this.xsp)<=this.lag){this.xsp=0}if(Math.abs(this.ysp)<=this.lag){this.ysp=0}}}function HeightMask(a,b){this.width=16;this.height=16;this.angle=a;this.items=b?b:[];HeightMask.prototype.setItem=function(f,g,e){var c=0,d=0;switch(e){case RotationMode.Floor:c=f;d=g;break;case RotationMode.RightWall:c=g;d=f;break;case RotationMode.Ceiling:c=f;d=15-g;break;case RotationMode.LeftWall:c=g;d=15-f;break;default:}this.items[c]=16-d};this.colors=["rgba(24,98,235,0.6)","rgba(255,98,235,0.6)","rgba(24,218,235,0.6)","rgba(24,98,235,0.6)"];HeightMask.prototype.draw=function(e,j,k,m,o,q,l){var f;if((f=sonicManager.SpriteCache.heightMaps[this.index+" "+k.y+" "+k.x])){if(f.loaded){e.drawImage(f,j.x,j.y)}}else{for(var n=0;n<16;n++){for(var p=0;p<16;p++){var g=0,h=0;if(o){if(q){g=15-n;h=15-p}else{g=15-n;h=p}}else{if(q){g=n;h=15-p}else{g=n;h=p}}var c=j.x+(g*k.x);var d=j.y+(h*k.y);e.lineWidth=1;if(m<=0&&this.items[n]>=16-p&&l>0){e.fillStyle=this.colors[l];e.fillRect(c,d,k.x,k.y)}else{if(m!=-1){e.lineWidth=1;e.strokeStyle="#0C3146";e.strokeRect(c,d,k.x,k.y)}}}}if(m==1){e.strokeStyle="#DC4146";e.lineWidth=4;e.moveTo(j.x+8*k.x,j.y+8*k.y);e.lineTo(j.x+8*k.x+_H.sin((this.angle))*6*k.x,j.y+8*k.y+_H.cos((this.angle))*6*k.y);e.stroke()}}}}window._H={floor:function(a){if(a>0){return ~~a}return Math.floor(a)},min:function(a,b){return a>b?b:a},max:function(a,b){return a<b?b:a},xor:function(a,b){return(a&&!b)||(!a&&b)},loadSprite:function(c,a){var b=new Image();b.onload=function(){b.loaded=true;if(a){a(b)}};b.src=c;return b},fixAngle:function(a){var b=Math.floor((256-a)*1.4062)%360;var c=360-b;return _H.degtorad(c)},degtorad:function(a){return a*Math.PI/180},sign:function(a){return a==0?0:(a<0?-1:1)},defaultWindowLocation:function(a){switch(a){case 0:return{x:0,y:0,width:320,height:240,intersects:_H.intersects};case 1:return{x:0,y:0,width:900,height:240*2,intersects:_H.intersects}}return null},ObjectParse:function(a){switch(a.ID){case 1:return new MonitorObject(a);break;case 7:return new SpringObject(a);break}return new LevelObject(a)},intersects:function(a){if(this.x<a.X&&this.x+this.width>a.X&&this.y<a.Y&&this.y+this.height>a.Y){return true}return false},defaultCanvas:function(d,c){var a=document.createElement("canvas");a.width=d;a.height=c;var b=a.getContext("2d");b.width=d;b.height=c;return{canvas:a,context:b}},intersectRect:function(a,b){return !(b.left>a.right||b.right<a.left||b.top>a.bottom||b.bottom<a.top)},remove:function(a,b){var c=-1;while((c=a.indexOf(b))>-1){a.splice(c,1)}},getShortsFromInt:function(a,b){var c=-1;while((c=a.indexOf(b))>-1){a.splice(c,1)}},scaleSprite:function(j,h,b){var e=_H.getImageData(j);var a=[];for(var g=0;g<e.length;g+=4){a.push(_H.colorObjectFromData(e,g))}var c=this.defaultCanvas().context.createImageData(j.width*h.x,j.height*h.y);_H.setDataFromColors(c.data,a,h,j.width,{r:0,g:0,b:0});return _H.loadSprite(_H.getBase64Image(c),b)},getCursorPosition:function(a,b){if(a.targetTouches&&a.targetTouches.length>0){a=a.targetTouches[0]}if(a.pageX!=null&&a.pageY!=null){return{x:a.pageX,y:a.pageY}}if(a.x!=null&&a.y!=null){return{x:a.x,y:a.y}}return{x:a.clientX,y:a.clientY}},colorFromData:function(j,h){var l=j[h];var k=j[h+1];var f=j[h+2];var e=l.toString(16);var d=k.toString(16);var a=f.toString(16);return"#"+(e.length==1?"0"+e:e)+(d.length==1?"0"+d:d)+(a.length==1?"0"+a:a)},colorObjectFromData:function(e,d){var h=e[d];var f=e[d+1];var a=e[d+2];return{r:h,g:f,b:a}},parseNumber:function(a){switch(a){case"0":return 0;case"1":return 1;case"2":return 2;case"3":return 3;case"4":return 4;case"5":return 5;case"6":return 6;case"7":return 7;case"8":return 8;case"9":return 9;case"a":return 10;case"b":return 11;case"c":return 12;case"d":return 13;case"e":return 14;case"f":return 15;case"g":return 16}return -1},setDataFromColors:function(f,b,p,r,q){for(var l=0;l<b.length;l++){var d=(l%r);var e=_H.floor(l/r);var h=b[l];var m=false;if(q){if(h.r==q.r&&h.g==q.g&&h.b==q.b){m=true}}for(var n=0;n<p.x;n++){for(var o=0;o<p.y;o++){var s=(d*p.x+n);var t=(e*p.y+o);var a=(s+t*(p.x*r))*4;if(m){f[a+0]=0;f[a+1]=0;f[a+2]=0;f[a+3]=0;continue}f[a]=h.r;f[a+1]=h.g;f[a+2]=h.b;f[a+3]=255}}}},getImageData:function(d){var a=document.createElement("canvas");a.width=d.width;a.height=d.height;var b=a.getContext("2d");b.drawImage(d,0,0);var c=b.getImageData(0,0,d.width,d.height);return c.data},getBase64Image:function(c){var a=document.createElement("canvas");a.width=c.width;a.height=c.height;var b=a.getContext("2d");b.putImageData(c,0,0);var d=a.toDataURL("image/png");return d},isFunction:function(a){var b={};return a&&b.toString.call(a)=="[object Function]"},detect:function(c,a){for(var b in c){if(typeof(c[b])=="object"){if(a[c[b]]){alert("circ")}a[c[b]]=true;this.detect(c[b],a)}}},stringify:function(e,b){return JSON.stringify(e,function(h,j){if(h=="imageData"){return undefined}if(h=="oldScale"){return undefined}if(h=="sprite"){return undefined}if(h=="sprites"){return undefined}if(h=="index"){return undefined}if(h=="_style"){return undefined}else{return j}});if(b>0){return""}if(!b){b=0}var f=typeof(e);if(f!="object"||e===null){if(f=="string"){e='"'+e+'"'}return String(e)}else{var d,g,c=[],a=(e&&e.constructor==Array);for(d in e){g=e[d];f=typeof(g);if(f=="string"){g='"'+g+'"'}else{if(f=="object"&&g!==null){g=stringify(g,b+1)}}c.push((a?"":'"'+d+'":')+String(g))}return(a?"[":"{")+String(c)+(a?"]":"}")}},sin:function(a){return cos_table[(a+64)&255]},cos:function(a){return cos_table[(a)&255]}};window.cos_table=[1,0.9997,0.9988,0.99729,0.99518,0.99248,0.98918,0.98528,0.9807900000000001,0.9757,0.97003,0.96378,0.95694,0.94953,0.94154,0.93299,0.92388,0.91421,0.90399,0.89322,0.88192,0.87009,0.85773,0.84485,0.83147,0.81758,0.80321,0.78835,0.77301,0.7572100000000001,0.74095,0.72425,0.70711,0.68954,0.6715600000000001,0.65317,0.63439,0.6152300000000001,0.5957,0.57581,0.55557,0.535,0.5141,0.4929,0.4714,0.44961,0.42755,0.40524,0.38268,0.3599,0.33689,0.31368,0.29028,0.26671,0.24298,0.2191,0.19509,0.17096,0.14673,0.12241,0.09802,0.07356,0.04907,0.02454,0,-0.02454,-0.04907,-0.07356,-0.09802,-0.12241,-0.14673,-0.17096,-0.19509,-0.2191,-0.24298,-0.26671,-0.29028,-0.31368,-0.33689,-0.3599,-0.38268,-0.40524,-0.42755,-0.44961,-0.4714,-0.4929,-0.5141,-0.535,-0.55557,-0.57581,-0.5957,-0.6152300000000001,-0.63439,-0.65317,-0.6715600000000001,-0.68954,-0.70711,-0.72425,-0.74095,-0.7572100000000001,-0.77301,-0.78835,-0.80321,-0.81758,-0.83147,-0.84485,-0.85773,-0.87009,-0.88192,-0.89322,-0.90399,-0.91421,-0.92388,-0.93299,-0.94154,-0.94953,-0.95694,-0.96378,-0.97003,-0.9757,-0.9807900000000001,-0.98528,-0.98918,-0.99248,-0.99518,-0.99729,-0.9988,-0.9997,-1,-0.9997,-0.9988,-0.99729,-0.99518,-0.99248,-0.98918,-0.98528,-0.9807900000000001,-0.9757,-0.97003,-0.96378,-0.95694,-0.94953,-0.94154,-0.93299,-0.92388,-0.91421,-0.90399,-0.89322,-0.88192,-0.87009,-0.85773,-0.84485,-0.83147,-0.81758,-0.80321,-0.78835,-0.77301,-0.7572100000000001,-0.74095,-0.72425,-0.70711,-0.68954,-0.6715600000000001,-0.65317,-0.63439,-0.6152300000000001,-0.5957,-0.57581,-0.55557,-0.535,-0.5141,-0.4929,-0.4714,-0.44961,-0.42756,-0.40524,-0.38268,-0.3599,-0.33689,-0.31368,-0.29028,-0.26671,-0.24298,-0.2191,-0.19509,-0.17096,-0.14673,-0.12241,-0.09802,-0.07356,-0.04907,-0.02454,-0,0.02454,0.04907,0.07356,0.09802,0.12241,0.14673,0.17096,0.19509,0.2191,0.24298,0.26671,0.29028,0.31368,0.33689,0.3599,0.38268,0.40524,0.42756,0.44961,0.4714,0.4929,0.5141,0.535,0.55557,0.57581,0.5957,0.6152300000000001,0.63439,0.65317,0.6715600000000001,0.68954,0.70711,0.72425,0.74095,0.7572100000000001,0.77301,0.78835,0.80321,0.81758,0.83147,0.84485,0.85773,0.87009,0.88192,0.89322,0.90399,0.91421,0.92388,0.93299,0.94154,0.94953,0.95694,0.96378,0.97003,0.9757,0.9807900000000001,0.98528,0.98918,0.99248,0.99518,0.99729,0.9988,0.9997];var base64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");var base64inv={};for(var i=0;i<base64chars.length;i++){base64inv[base64chars[i]]=i}window.decodeNumeric=function(f){f=f.replace(new RegExp("[^"+base64chars.join("")+"=]","g"),"");var d=(f.charAt(f.length-1)=="="?(f.charAt(f.length-2)=="="?"AA":"A"):"");var e=[];f=f.substr(0,f.length-d.length)+d;for(var a=0;a<f.length;a+=4){var b=(base64inv[f.charAt(a)]<<18)+(base64inv[f.charAt(a+1)]<<12)+(base64inv[f.charAt(a+2)]<<6)+base64inv[f.charAt(a+3)];e.push((b>>>16)&255);e.push((b>>>8)&255);e.push(b&255)}return e.slice(0,e.length-1)};window.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(j){var k="";var a,b,c,d,e,f,g;var h=0;j=Base64._utf8_encode(j);while(h<j.length){a=j.charCodeAt(h++);b=j.charCodeAt(h++);c=j.charCodeAt(h++);d=a>>2;e=((a&3)<<4)|(b>>4);f=((b&15)<<2)|(c>>6);g=c&63;if(isNaN(b)){f=g=64}else{if(isNaN(c)){g=64}}k=k+this._keyStr.charAt(d)+this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)}return k},decode:function(j){var k="";var a,b,c;var d,e,f,g;var h=0;j=j.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(h<j.length){d=this._keyStr.indexOf(j.charAt(h++));e=this._keyStr.indexOf(j.charAt(h++));f=this._keyStr.indexOf(j.charAt(h++));g=this._keyStr.indexOf(j.charAt(h++));a=(d<<2)|(e>>4);b=((e&15)<<4)|(f>>2);c=((f&3)<<6)|g;k=k+String.fromCharCode(a);if(f!=64){k=k+String.fromCharCode(b)}if(g!=64){k=k+String.fromCharCode(c)}}k=Base64._utf8_decode(k);return k},_utf8_encode:function(d){d=d.replace(/\r\n/g,"\n");var e="";for(var b=0;b<d.length;b++){var a=d.charCodeAt(b);if(a<128){e+=String.fromCharCode(a)}else{if((a>127)&&(a<2048)){e+=String.fromCharCode((a>>6)|192);e+=String.fromCharCode((a&63)|128)}else{e+=String.fromCharCode((a>>12)|224);e+=String.fromCharCode(((a>>6)&63)|128);e+=String.fromCharCode((a&63)|128)}}}return e},_utf8_decode:function(e){var d="";var b=0;var a=c1=c2=0;while(b<e.length){a=e.charCodeAt(b);if(a<128){d+=String.fromCharCode(a);b++}else{if((a>191)&&(a<224)){c2=e.charCodeAt(b+1);d+=String.fromCharCode(((a&31)<<6)|(c2&63));b+=2}else{c2=e.charCodeAt(b+1);c3=e.charCodeAt(b+2);d+=String.fromCharCode(((a&15)<<12)|((c2&63)<<6)|(c3&63));b+=3}}}return d}};function OutStream(){this.bytestream=new Array();this.offset=0;this.WriteBit=function(a){this.bytestream[this.offset>>>3]|=a<<(this.offset&7);this.offset++};this.Write=function(c,b){for(var a=0;a<b;++a){this.WriteBit((c>>>a)&1)}}}function InStream(b,a){this.bytestream=b;this.bitcount=a;this.offset=0;this.ReadBit=function(){var c=this.bytestream[this.offset>>>3]>>(this.offset&7);this.offset++;return c&1};this.Read=function(d){if((this.offset+d)>this.bitcount){return null}var e=0;for(var c=0;c<d;++c){e|=this.ReadBit()<<c}return e}}function LZWCompressor(a){this.output=a;this.CompressDictionary=function(){this.hashtable=new Object();this.nextcode=0;for(var b=0;b<256;++b){var c=String.fromCharCode(b);this.hashtable[c]=this.nextcode++}this.Exists=function(d){return(this.hashtable.hasOwnProperty(d))};this.Insert=function(e){var d=this.ValSizeInBits();this.hashtable[e]=this.nextcode++;return d};this.Lookup=function(d){return(this.hashtable[d])};this.ValSizeInBits=function(){var d=Math.log(this.nextcode+1)/Math.LN2;return Math.ceil(d)}};this.compress=function(h){var f=h.length;if(f==0){return output.bytestream}var d=new this.CompressDictionary();var g=d.ValSizeInBits();var j="";for(var e=0;e<f;++e){var b=h.charAt(e);if(d.Exists(j+b)){j=j+b}else{g=d.Insert(j+b);this.output.Write(d.Lookup(j),g);j=b}}this.output.Write(d.Lookup(j),g)}}function LZWDecompressor(a){this.input=a;this.DecompressDictionary=function(){this.revhashtable=new Array();this.nextcode=0;for(var b=0;b<256;++b){this.revhashtable[this.nextcode++]=String.fromCharCode(b)}this.numBits=9;this.Size=function(){return(this.nextcode)};this.Insert=function(d){this.revhashtable[this.nextcode++]=d;var c=Math.log(this.nextcode+2)/Math.LN2;this.numBits=Math.ceil(c);return this.numBits};this.LookupIndex=function(c){return this.revhashtable[c]};this.ValSizeInBits=function(){return this.numBits}};this.decompress=function(c,b){if(b==0){return""}var d=new this.DecompressDictionary();var g=d.ValSizeInBits();var f=this.input.Read(g);var h=String.fromCharCode(f);var j=h;var e="";while((f=this.input.Read(g))!=null){if(f<d.Size()){e=d.LookupIndex(f)}else{e=j+j.charAt(0)}h+=e;g=d.Insert(j+e.charAt(0));j=e}return h}}var broken=_H.loadSprite("assets/Sprites/broken.png");function LevelObject(a){this.ObjectData=a;this.sprites=[];LevelObject.prototype.getRect=function(){return{left:0,right:0,top:0,bottom:0}};LevelObject.prototype.collide=function(){};LevelObject.prototype.draw=function(b,c,d){if(this.sprites[0]&&this.sprites[0].loaded){b.drawImage(this.sprites[0],(c.x-this.sprites[0].width/2)*d.x,(c.y-this.sprites[0].height/2)*d.y,this.sprites[0].width*d.x,this.sprites[0].height*d.y)}else{b.drawImage(broken,(c.x-broken.width/2)*d.x,(c.y-broken.height/2)*d.y,broken.width*d.x,broken.height*d.y)}}}var monitor=_H.loadSprite("assets/Sprites/monitorEmpty.png");var monitorBroken=_H.loadSprite("assets/Sprites/monitorBroken.png");function MonitorObject(b){this.ObjectData=b;this.sprites=[];var a="assets/Sprites/monitor";switch(this.ObjectData.SubType){case 1:this.sprites.push(_H.loadSprite(a+"SonicOneUp.png"));break;case 2:this.sprites.push(_H.loadSprite(a+"Death.png"));break;case 3:this.sprites.push(_H.loadSprite(a+"Ring.png"));break;case 4:this.sprites.push(_H.loadSprite(a+"SpeedShoe.png"));break;case 5:this.sprites.push(_H.loadSprite(a+"Flame.png"));break;case 6:this.sprites.push(_H.loadSprite(a+"Electric.png"));break;case 7:this.sprites.push(_H.loadSprite(a+"Bubble.png"));break;case 8:this.sprites.push(_H.loadSprite(a+"Stars.png"));break}MonitorObject.prototype.getRect=function(){var c=this.ObjectData.X-monitor.width/2;var d=this.ObjectData.Y-monitor.height/2;return{left:c,top:d,right:c+monitor.width,height:d+monitor.height}};MonitorObject.prototype.collide=function(){if(sonicManager.sonicToon.ysp==0){sonicManager.sonicToon.gsp=0;sonicManager.sonicToon.xsp=0;return}if(this.ObjectData.SubType==10){return}switch(this.ObjectData.SubType){case 1:sonicManager.sonicToon.Lives=1;break;case 2:sonicManager.sonicToon.hit();break;case 3:sonicManager.sonicToon.rings+=10;break;case 4:sonicManager.sonicToon.rings+=20;break;case 5:sonicManager.sonicToon.rings+=30;break;case 6:sonicManager.sonicToon.rings+=40;break;case 7:sonicManager.sonicToon.rings+=50;break;case 8:sonicManager.sonicToon.rings+=60;break}if(sonicManager.sonicToon.ysp>0){sonicManager.sonicToon.ysp*=-1}else{sonicManager.sonicToon.ysp*=1}this.ObjectData.SubType=10};MonitorObject.prototype.draw=function(c,d,e){if(this.sprites[0]&&this.sprites[0].loaded){if(this.ObjectData.SubType==10){c.drawImage(monitorBroken,(d.x-monitorBroken.width/2)*e.x,(d.y)*e.y,monitorBroken.width*e.x,monitorBroken.height*e.y)}else{c.drawImage(monitor,(d.x-monitor.width/2)*e.x,(d.y-monitor.height/2)*e.y,monitor.width*e.x,monitor.height*e.y);if(sonicManager.sonicToon){if(!(sonicManager.drawTickCount%6==0||sonicManager.drawTickCount%6==1)){c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}else{c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}}}}function SpringObject(b){this.ObjectData=b;this.sprites=[];var a="assets/Sprites/monitor";switch(this.ObjectData.SubType){case 1:this.sprites.push(_H.loadSprite(a+"SonicOneUp.png"));break;case 2:this.sprites.push(_H.loadSprite(a+"Death.png"));break;case 3:this.sprites.push(_H.loadSprite(a+"Ring.png"));break;case 4:this.sprites.push(_H.loadSprite(a+"SpeedShoe.png"));break;case 5:this.sprites.push(_H.loadSprite(a+"Flame.png"));break;case 6:this.sprites.push(_H.loadSprite(a+"Electric.png"));break;case 7:this.sprites.push(_H.loadSprite(a+"Bubble.png"));break;case 8:this.sprites.push(_H.loadSprite(a+"Stars.png"));break}SpringObject.prototype.getRect=function(){var c=this.ObjectData.X-monitor.width/2;var d=this.ObjectData.Y-monitor.height/2;return{left:c,top:d,right:c+monitor.width,bottom:d+monitor.height}};SpringObject.prototype.collide=function(){if(sonicManager.sonicToon.ysp==0){sonicManager.sonicToon.gsp=0;sonicManager.sonicToon.xsp=0;return}if(this.ObjectData.SubType==10){return}switch(this.ObjectData.SubType){case 1:sonicManager.sonicToon.Lives=1;break;case 2:sonicManager.sonicToon.hit();break;case 3:sonicManager.sonicToon.rings+=10;break;case 4:sonicManager.sonicToon.rings+=20;break;case 5:sonicManager.sonicToon.rings+=30;break;case 6:sonicManager.sonicToon.rings+=40;break;case 7:sonicManager.sonicToon.rings+=50;break;case 8:sonicManager.sonicToon.rings+=60;break}if(sonicManager.sonicToon.ysp>0){sonicManager.sonicToon.ysp*=-1}else{sonicManager.sonicToon.ysp*=1}this.ObjectData.SubType=10};SpringObject.prototype.draw=function(c,d,e){if(this.sprites[0]&&this.sprites[0].loaded){if(this.ObjectData.SubType==10){c.drawImage(monitorBroken,(d.x-monitorBroken.width/2)*e.x,(d.y)*e.y,monitorBroken.width*e.x,monitorBroken.height*e.y)}else{c.drawImage(monitor,(d.x-monitor.width/2)*e.x,(d.y-monitor.height/2)*e.y,monitor.width*e.x,monitor.height*e.y);if(sonicManager.sonicToon){if(!(sonicManager.drawTickCount%6==0||sonicManager.drawTickCount%6==1)){c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}else{c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}}}}function ParallaxBG(a,h){var j=this;var g=a;ParallaxBG.prototype.click=function(f,k){this.slots[k].rotateSpeed=f/this.width*2};ParallaxBG.prototype.onBar=function(n,o){var m=3*h.x;var f=this.slots[o].rotateSpeed;if(n>((this.width*f/2)-m)&&n<((this.width*f/2)+m)){var l={top:0,bottom:0};for(var k=o-1;k>=0;k--){if(this.slots[k].rotateSpeed!=f){l.top=k;break}}for(var k=o+1;k<this.height;k++){if(this.slots[k].rotateSpeed!=f){l.bottom=k;break}}return l}return null};ParallaxBG.prototype.cache=function(q){var s=(this.slots[0].colors.length*q.x);var k=sonicManager.windowLocation.height*q.y;var r=[];var f=_H.defaultCanvas();var n=this.slots[0].rotateSpeed;var m=0;var p={x:0,y:0};for(var l=0;l<this.slots.length;l++){if(n!=this.slots[l].rotateSpeed){n=this.slots[l].rotateSpeed;r[m]=(_H.loadSprite(f.canvas.toDataURL("image/png")));f=_H.defaultCanvas();m=l}var o={x:p.x,y:p.y+(l-m)*q.y};this.slots[l].draw(f.context,o,q)}r[m]=(_H.loadSprite(f.canvas.toDataURL("image/png")));this.sprites=r};ParallaxBG.prototype.init=function(m){var n=this.colors[0].length;var f=this.colors.length;this.slots=[];this.slots.length=f;for(var o=0;o<f;o++){this.slots[o]=new ParallaxBGSlot()}for(var l=0;l<f;l++){for(var k=0;k<n;k++){this.slots[l].colors[k]=(this.colors[l][k])}}for(var o=0;o<f;o++){this.slots[o].load(m)}};ParallaxBG.prototype.drawUI=function(f,n,p){if(this.sprite&&this.sprite.loaded){f.drawImage(this.sprite,n.x,n.y)}if(this.slots){var l=this.slots[0].rotateSpeed;var m=0;for(var k=0;k<this.slots.length;k++){if(l==this.slots[k].rotateSpeed){continue}var o=Math.floor(255/2/l);f.fillStyle="rgba("+o+",57,43,0.4)";f.fillRect(n.x,n.y+m*p.y,this.width*p.x,p.y*(k-m));f.strokeStyle="rgba("+o+",57,43,1)";f.lineWidth=3;f.strokeRect(n.x,n.y+m*p.y,this.width*p.x,p.y*(k-m));var q=3*p.x;f.fillRect(n.x+(this.width*l/2)-q,n.y+m*p.y,q*2,p.y*(k-m));m=k;l=this.slots[k].rotateSpeed}var o=Math.floor(255/2/l);f.fillStyle="rgba("+o+",57,43,0.4)";f.fillRect(n.x,n.y+m*p.y,this.width*p.x,p.y*(k-m));f.strokeStyle="rgba("+o+",57,43,1)";f.lineWidth=3;f.strokeRect(n.x,n.y+m*p.y,this.width*p.x,p.y*(k-m));var q=3*p.x;f.fillStyle="rgba("+o+",57,43,1)";f.fillRect(n.x+(this.width*l/2)-q,n.y+m*p.y,q*2,p.y*(k-m))}};ParallaxBG.prototype.draw=function(f,o,p,m){var q=(this.slots[0].colors.length*p.x);var k=sonicManager.windowLocation.height*p.y;for(var l in this.sprites){var n={x:o.x+(Math.floor(m*this.slots[l].rotateSpeed)),y:o.y+l*p.y};if(n.y>sonicManager.windowLocation.y*p.y||n.y<k+sonicManager.windowLocation.y*p.y){if(n.x>sonicManager.windowLocation.width||n.x+q<0){continue}if(this.sprite&&this.sprite.loaded){f.drawImage(this.sprite,n.x,n.y,this.sprite.width,this.sprite.height)}}}};j.width=g.width;j.height=g.height;var c=_H.getImageData(g);var b=[];for(var e=0;e<g.height;e++){b[e]=[];b[e].length=g.width}for(var d=0;d<c.length;d+=4){b[_H.floor(d/4/g.width)][d/4%g.width]=(_H.colorFromData(c,d))}j.colors=b;j.sprite=g;j.sprite.loaded=true;j.init(h)}function ParallaxBGSlot(){this.colors=[];this.sprite=null;this.rotateSpeed=1;ParallaxBGSlot.prototype.draw=function(a,b,c){if(this.sprite&&this.sprite.loaded){a.drawImage(this.sprite,b.x,b.y,this.sprite.width*c.x,this.sprite.height*c.y)}};ParallaxBGSlot.prototype.drawUI=function(a,d,e){for(var b=0;b<this.colors.length;b++){var c=this.colors[b];if(c=="#000000"){continue}a.fillStyle=c;a.fillRect(d.x+(b)*e.x,d.y,e.x,e.y)}};ParallaxBGSlot.prototype.load=function(e){var d={x:0,y:0};var f=_H.defaultCanvas(e.x*this.colors.length,e.y);var a=f.context;for(var b=0;b<this.colors.length;b++){var c=this.colors[b];a.fillStyle=c;a.fillRect(d.x+b*e.x,d.y,e.x,e.y)}var c=f.canvas.toDataURL("image/png");this.sprite=_H.loadSprite(c)}}function Ring(a){this.active=a;this.animationIndex=0;this.x=0;this.y=0;this.xsp=0;this.ysp=0;this.tickCount=0;this.draw=function(b,c,d){if(a){this.ysp+=0.09375;this.x+=this.xsp;this.y+=this.ysp;if(this.x<sonicManager.windowLocation.x||this.y<sonicManager.windowLocation.y||this.x>sonicManager.windowLocation.x+sonicManager.windowLocation.width||this.y>sonicManager.windowLocation.y+sonicManager.windowLocation.height){this.tickCount=4294967295;return false}if(sonicManager.sonicToon.checkCollisionLine(_H.floor(this.x)+8,_H.floor(this.y)+8,16,1)!=-1){this.ysp*=-0.75}if(sonicManager.sonicToon.checkCollisionLine(_H.floor(this.x)-8,_H.floor(this.y)+8,26,0)!=-1){this.xsp*=-0.75}if(sonicManager.drawTickCount>sonicManager.sonicToon.sonicLastHitTick+64&&_H.intersectRect(sonicManager.sonicToon.myRec,{left:this.x-8*d.x,right:this.x+8*d.x,top:this.y-8*d.y,bottom:this.y+8*d.y})){this.tickCount=4294967295;sonicManager.sonicToon.rings++;return false}this.tickCount++}if(sonicManager.sonicToon){this.animationIndex=_H.floor((sonicManager.drawTickCount%((a?4:8)*4))/(a?4:8))}else{this.animationIndex=0}var e;if(sonicManager.SpriteCache.rings){e=sonicManager.SpriteCache.rings}else{alert("sprite fial");return}var f=e[this.animationIndex*200+d.y*100+d.x];if(!f){alert("sprite fail");return}if(f.loaded){b.drawImage(f,_H.floor((c.x-8)*d.x),_H.floor((c.y-8)*d.y))}else{return false}}}function Sonic(c,b){this.x=c.StartPositions[0].X;this.y=c.StartPositions[0].Y;this.obtainedRing=[];this.rings=0;this.debugging=false;this.jumping=false;this.crouching=false;this.holdingLeft=false;this.holdingRight=false;this.LevelWidth=0;this.xsp=0;this.ysp=0;this.sonicLastHitTick=0;this.sonicJustHitTick=0;this.acc=0.046875;this.dec=0.5;this.frc=0.046875;this.gsp=0;this.rdec=0.125;this.rfrc=0.0234375;this.runningTick=0;this.slp=0.125;this.slpRollingUp=0.078125;this.slpRollingDown=0.3125;this.jmp=-6.5;this.grv=0.21875;this.air=0.09375;this.sonicLevel=c;this.inAir=false;this.wasInAir=false;this.holdingJump=false;this.haltSmoke=[];this.hlock=0;this.mode=RotationMode.Floor;this.facing=true;this.ticking=false;this.breaking=0;this.ducking=false;this.spinDash=false;this.myRec={};this.spinDashSpeed=0;this.angle=255;var a;this.updateMode=function(){if(this.angle<32||this.angle>224){this.mode=RotationMode.Floor}else{if(this.angle>32&&this.angle<96){this.mode=RotationMode.LeftWall}else{if(this.angle>96&&this.angle<160){this.mode=RotationMode.Ceiling}else{if(this.angle>160&&this.angle<224){this.mode=RotationMode.RightWall}}}}};this.tick=function(){if(this.debugging){var g=15;if(this.holdingRight){this.x+=g}if(this.holdingLeft){this.x-=g}if(this.crouching){this.y+=g}if(this.jumping){this.y-=g}return}this.updateMode();if(this.hlock>0){this.hlock--;this.holdingRight=false;this.holdingLeft=false}this.myRec={left:this.x-5,right:this.x+5,top:this.y-20,bottom:this.y+20};var l=6;if(this.jumping){this.wasJumping=true}else{if(this.wasJumping){this.wasJumping=false}}if(!this.inAir&&this.wasInAir){this.wasInAir=false;if(this.angle>=240||this.angle<=15){this.gsp=this.xsp}else{if((this.angle>=224&&this.angle<=239)||(this.angle>=16&&this.angle<=31)){this.gsp=this.ysp}else{if((this.angle>=192&&this.angle<=223)){this.gsp=-this.ysp}else{if((this.angle>=32&&this.angle<=63)){this.gsp=this.ysp}}}}this.xsp=0;this.ysp=0}if(!this.inAir&&!this.rolling){if(this.holdingRight&&!this.holdingLeft){this.facing=true;if(this.gsp>=0){this.gsp+=this.acc;if(this.gsp>l){this.gsp=l}}else{this.gsp+=this.dec;if(Math.abs(this.gsp)>4.5){this.facing=false;this.breaking=1;this.runningTick=0}}}if(this.holdingLeft&&!this.holdingRight){this.facing=false;if(this.gsp<=0){this.gsp-=this.acc;if(this.gsp<-l){this.gsp=-l}}else{this.gsp-=this.dec;if(Math.abs(this.gsp)>4.5){this.facing=true;this.breaking=-1;this.runningTick=0}}}if(!this.holdingLeft&&!this.holdingRight){this.gsp-=Math.min(Math.abs(this.gsp),this.frc)*(this.gsp>0?1:-1)}a=_H.sign(this.gsp);this.gsp+=this.slp*-_H.sin(this.angle);if(a!=_H.sign(this.gsp)&&a!=0){this.hlock=30}}this.ducking=false;if(this.crouching){if(Math.abs(this.gsp)>1.03125){this.rolling=true;this.currentlyBall=true}else{this.ducking=true}}else{if(this.spinDash){this.gsp=(8+_H.floor(this.spinDashSpeed)/2)*(this.facing?1:-1);this.spinDash=false;this.rolling=true;this.currentlyBall=true}}if(!this.isAir&&this.rolling){if(this.holdingLeft){if(this.gsp>0){if(this.rolling){this.gsp=_H.max(0,this.gsp-this.rdec)}}}if(this.holdingRight){if(this.gsp<0){if(this.rolling){this.gsp=_H.min(0,this.gsp+this.rdec)}}}this.gsp-=Math.min(Math.abs(this.gsp),this.rfrc)*(this.gsp>0?1:-1);a=_H.sign(this.gsp);var e=_H.sin(this.angle);if((e>0)!=(this.gsp>0)){this.gsp+=-this.slpRollingUp*e}else{this.gsp+=-this.slpRollingDown*e}if(a!=_H.sign(this.gsp)&&a!=0){this.hlock=30}}if(!this.inAir){this.xsp=this.gsp*_H.cos(this.angle);this.ysp=this.gsp*-_H.sin(this.angle);if(Math.abs(this.gsp)<2.5&&this.angle>=64&&this.angle<=192){if(this.mode==RotationMode.RightWall){this.x+=5}else{if(this.mode==RotationMode.LeftWall){this.x-=4}}this.angle=0;this.updateMode();this.hlock=30}}if(this.inAir){if(this.holdingRight&&!this.holdingLeft){this.facing=true;if(this.xsp>=0){this.xsp+=this.air;if(this.xsp>l){this.xsp=l}}else{this.xsp-=this.air}}if(this.holdingLeft&&!this.holdingRight){this.facing=false;if(this.xsp<=0){this.xsp-=this.air;if(this.xsp<-l){this.xsp=-l}}else{this.xsp+=this.air}}if(this.wasInAir){if(this.jumping){}else{}}this.ysp+=this.justHit?0.1875:this.grv;if(this.ysp<0&&this.ysp>-4){if(Math.abs(this.xsp)>0.125){this.xsp*=0.96875}}if(this.ysp>16){this.ysp=16}}if(this.wasInAir&&this.jumping){}else{if(this.jumping){if(this.ducking){this.spinDash=true;this.spinDashSpeed+=2;if(this.spinDashSpeed>8){this.spinDashSpeed=8}this.spriteState="spindash0"}else{this.wasInAir=true;this.inAir=true;this.currentlyBall=true;this.xsp=this.jmp*_H.sin(this.angle)+this.gsp*_H.cos(this.angle);this.ysp=this.jmp*_H.cos(this.angle)}}}if(this.xsp>0&&this.xsp<0.008){this.gsp=0;this.xsp=0}if(this.xsp<0&&this.xsp>-0.008){this.gsp=0;this.xsp=0}this.x+=this.xsp;this.y+=this.ysp;this.updateSprite();var h=_H.floor(this.x);var j=_H.floor(this.y);var o,p;var m=-10;var n=4;if(this.mode==RotationMode.Floor){if((o=this.checkCollisionLine(h+m,j+n,20,0))!=-1){if(o.pos<h){this.x=h=Math.ceil(o.pos/16)*16+10;this.gsp=0}else{this.x=h=Math.floor(o.pos/16)*16-10;this.gsp=0}if(this.inAir){this.xsp=0}}}else{if(this.mode==RotationMode.LeftWall){if((o=this.checkCollisionLine(h-n,j+m,20,1))!=-1){if(o.pos>j){this.y=j=Math.ceil(o.pos/16)*16-10}else{this.y=j=Math.floor(o.pos/16)*16+10;this.gsp=0}if(this.inAir){this.xsp=0}}}else{if(this.mode==RotationMode.Ceiling){if((o=this.checkCollisionLine(h-m,j-n,20,0))!=-1){if(o.pos<h){this.x=h=Math.ceil(o.pos/16)*16+10;this.gsp=0}else{this.x=h=Math.floor(o.pos/16)*16-10;this.gsp=0}if(this.inAir){this.xsp=0}}}else{if(this.mode==RotationMode.RightWall){if((o=this.checkCollisionLine(h+n,j+m,20,1))!=-1){if(o.pos<j){this.y=j=Math.ceil(o.pos/16)*16-11;this.gsp=0}else{this.y=j=Math.floor(o.pos/16)*16+11;this.gsp=0}if(this.inAir){this.xsp=0}}}}}}if(sonicManager.tickCount%4==0){this.checkCollisionWithRing();this.checkCollisionWithObjects()}if(this.inAir){this.angle=255}if(!this.inAir){var k=24;m=-9;n=0;if(this.mode==RotationMode.Floor){o=this.checkCollisionLine(h+m,j+n,k,1);p=this.checkCollisionLine(h-m,j+n,k,1);if(o==-1&&p==-1){this.inAir=true;this.wasInAir=true}else{if(o.pos>=0&&p.pos>=0){this.angle=o.angle;if(o.pos<p.pos){this.angle=o.angle;this.y=j=o.pos-20}else{this.angle=p.angle;this.y=j=p.pos-20}}else{if(o.pos>-1){this.angle=o.angle;this.y=j=o.pos-20}else{if(p.pos>-1){this.angle=p.angle;this.y=j=p.pos-20}}}}}else{if(this.mode==RotationMode.LeftWall){o=this.checkCollisionLine(h+n,j-m,k,2);p=this.checkCollisionLine(h+n,j+m,k,2);if(o==-1&&p==-1){this.inAir=true;this.wasInAir=true}else{if(o.pos>=0&&p.pos>=0){if(o.pos<p.pos){this.angle=o.angle;this.x=h=o.pos+20}else{this.angle=p.angle;this.x=h=p.pos+20}}else{if(o.pos>-1){this.angle=o.angle;this.x=h=o.pos+20}else{if(p.pos>-1){this.angle=p.angle;this.x=h=p.pos+20}}}}}else{if(this.mode==RotationMode.Ceiling){o=this.checkCollisionLine(h+m,j-n,k,3);p=this.checkCollisionLine(h-m,j-n,k,3);if(o==-1&&p==-1){this.inAir=true;this.wasInAir=true}else{if(o.pos>=0&&p.pos>=0){if(o.pos<p.pos){this.angle=o.angle;this.y=j=o.pos-20}else{this.angle=p.angle;this.y=j=p.pos-20}}else{if(o.pos>-1){this.angle=o.angle;this.y=j=o.pos-20}else{if(p.pos>-1){this.angle=p.angle;this.y=j=p.pos-20}}}}}else{if(this.mode==RotationMode.RightWall){o=this.checkCollisionLine(h+n,j-m,k,0);p=this.checkCollisionLine(h+n,j+m,k,0);if(o==-1&&p==-1){this.inAir=true;this.wasInAir=true}else{if(o.pos>=0&&p.pos>=0){if(o.pos<p.pos){this.angle=o.angle;this.x=h=o.pos-20}else{this.angle=p.angle;this.x=h=p.pos-20}}else{if(o.pos>-1){this.angle=o.angle;this.x=h=o.pos-20}else{if(p.pos>-1){this.angle=p.angle;this.x=h=p.pos-20}}}}}}}}this.updateMode()}else{o=this.checkCollisionLine(h-9,j,20,1);p=this.checkCollisionLine(h+9,j,20,1);if(o==-1&&p==-1){this.inAir=true;this.wasInAir=true}else{if(o.pos>=0&&p.pos>=0){if(o.pos<p.pos){if(this.y+(20)>=o.pos){this.angle=o.angle;this.y=j=o.pos-20;this.rolling=this.currentlyBall=false;this.inAir=false}}else{if(p.pos>-1){if(this.y+(20)>=p.pos){this.angle=p.angle;this.y=j=p.pos-20;this.rolling=this.currentlyBall=false;this.inAir=false}}}}else{if(o.pos>-1){if(this.y+(20)>=o.pos){this.angle=o.angle;this.y=j=o.pos-20;this.rolling=this.currentlyBall=false;this.inAir=false}}else{if(p.pos>-1){if(this.y+(20)>=p.pos){this.angle=p.angle;this.y=j=p.pos-20;this.rolling=this.currentlyBall=false;this.inAir=false}}}}}this.updateMode();var f=sonicManager.SpriteCache.sonicSprites[this.spriteState+b.x+b.y];var d=f.height/b.y/2;o=this.checkCollisionLine(h-9,j,d,3);p=this.checkCollisionLine(h+9,j,d,3);if((o==-1&&p==-1)){}else{if(o.pos>=0&&p.pos>=0){this.angle=o.angle;if(o.pos<p.pos){if(this.y+(d)>=o.pos){this.angle=o.angle;this.y=j=o.pos+d;this.ysp=0}}else{if(this.y+(d)>=p.pos){this.angle=p.angle;this.y=j=p.pos+d;this.ysp=0}}}else{if(o.pos>-1){if(this.y+(d)>=o.pos){this.angle=o.angle;this.y=j=o.pos+d;this.ysp=0}}else{if(p.pos>-1){if(this.y+(d)>=p.pos){this.angle=p.angle;this.y=j=p.pos+d;this.ysp=0}}}}this.updateMode()}}};this.debug=function(){this.debugging=!this.debugging;this.xsp=0;this.gsp=0;this.ysp=0;this.spriteState="normal"};this.hit=function(){if(sonicManager.drawTickCount-this.sonicJustHitTick<120){return}this.justHit=true;this.ysp=-4;this.xsp=2*(-1);this.sonicLastHitTick=sonicManager.drawTickCount;var h=0;var d=101.25;var e=false;var g=4;while(h<this.rings){var f=new Ring(true);sonicManager.activeRings.push(f);f.x=this.x;f.y=this.y-10;f.ysp=-Math.sin(d)*g;f.xsp=Math.cos(d)*g;if(e){f.ysp*=-1;d+=22.5}e=!e;h++;if(h==16){g=2;d=101.25}}this.rings=0};this.checkCollisionWithRing=function(){var f=this.myRec;for(var h in sonicManager.SonicLevel.Rings){var g=sonicManager.SonicLevel.Rings[h];if(this.obtainedRing[h]){continue}var d=g.X;var e=g.Y;if(_H.intersectRect(f,{left:d-8,right:d+8,top:e-8,bottom:e+8})){this.rings++;this.obtainedRing[h]=true}}};this.checkCollisionWithObjects=function(){var f=this.myRec;for(var h in sonicManager.SonicLevel.Objects){var g=sonicManager.SonicLevel.Objects[h];var d=g.X;var e=g.Y;if(_H.intersectRect(f,g.getRect())){g.collide()}}};this.sensorA=0;this.checkCollisionLine=function(g,h,e,d){var f=this.checkCollisionLineWrap(g,h,e,d);if(f!=-1&&f.angle==null){f=this.checkCollisionLineWrap(g,h,e,d)}if(f.angle==255){if(this.mode==RotationMode.Floor){}else{if(this.mode==RotationMode.LeftWall){f.angle=Math.floor(256/4*1)}else{if(this.mode==RotationMode.Ceiling){f.angle=Math.floor(256/4*2)}else{if(this.mode==RotationMode.RightWall){f.angle=Math.floor(256/4*3)}}}}}return f};this.checkCollisionLineWrap=function(s,t,p,l){var f=_H.floor(s/128);var g=_H.floor(t/128);var r=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[f][g]];var k=sonicManager.SonicLevel.curHeightMap?r.heightBlocks1:r.heightBlocks2;var h=sonicManager.SonicLevel.curHeightMap?r.angleMap1:r.angleMap2;var d=s-f*128;var e=t-g*128;var n=128;var o;var q;var j=0;switch(l){case 0:if(s+p>sonicManager.SonicLevel.LevelWidth*128){return{pos:sonicManager.SonicLevel.LevelWidth*128-20,angle:null}}for(o=0;o<p;o++){if(d+o>=128){r=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[f+1][g]];k=sonicManager.SonicLevel.curHeightMap?r.heightBlocks1:r.heightBlocks2;h=sonicManager.SonicLevel.curHeightMap?r.angleMap1:r.angleMap2;d-=128}if(s+o>this.LevelWidth||k[(d+o)][e]>=2){return{pos:s+o,angle:h[_H.floor((d+o)/16)][_H.floor((e)/16)]}}}break;case 1:if(t+p>sonicManager.SonicLevel.LevelHeight*128){return{pos:sonicManager.SonicLevel.LevelHeight*128-20,angle:null}}for(o=0;o<p;o+=1){if(e+j>=128){r=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[f][(g+1)]];k=sonicManager.SonicLevel.curHeightMap?r.heightBlocks1:r.heightBlocks2;h=sonicManager.SonicLevel.curHeightMap?r.angleMap1:r.angleMap2;e-=128}if(k[d][e+o]>=1){return{pos:t+o,angle:h[_H.floor((d)/16)][_H.floor((e+j)/16)]}}j++}break;case 2:if(s-p<0){return{pos:0+20,angle:null}}for(o=0;o<p;o++){if(d-o<0){r=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[(f-1),g]];k=sonicManager.SonicLevel.curHeightMap?r.heightBlocks1:r.heightBlocks2;h=sonicManager.SonicLevel.curHeightMap?r.angleMap1:r.angleMap2;d+=128}if(s-o<0||k[(d-o)][e]>=2){return{pos:s-o,angle:h[_H.floor((d-o)/16)][_H.floor((e)/16)]}}}break;case 3:if(t-p<0){return{pos:20,angle:null}}for(o=0;o<p;o+=1){if(e-j<0){r=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[f][(g-1)]];k=sonicManager.SonicLevel.curHeightMap?r.heightBlocks1:r.heightBlocks2;h=sonicManager.SonicLevel.curHeightMap?r.angleMap1:r.angleMap2;e+=128}if(k[d][e-o]>=2){return{pos:t-o,angle:h[_H.floor((d)/16)][_H.floor((e-j)/16)]}}j++}break}return -1};this.spriteState="normal";this.isLoading=function(){return this.imageLoaded[0]<this.imageLength};this.drawUI=function(d,e,f){d.font="13pt Arial bold";d.fillStyle="White";d.fillText("Rings: "+this.rings,e.x+90,e.y+45);d.fillText("Angle: "+this.angle.toString(16),e.x+90,e.y+75);d.fillText("Position: "+_H.floor(this.x)+", "+_H.floor(this.y),e.x+90,e.y+105);d.fillText("Speed: g: "+this.gsp.toFixed(3)+" x:"+this.xsp.toFixed(3)+" y:"+this.ysp.toFixed(3),e.x+90,e.y+135);d.fillText("Mode: "+this.mode,e.x+90,e.y+185)};this.draw=function(d,l){var f=_H.floor(this.x);var g=_H.floor(this.y);var e;var k=sonicManager.drawTickCount-this.sonicJustHitTick;if(k<120){if(k%8<4){return}}if(e=sonicManager.SpriteCache.sonicSprites[this.spriteState+l.x+l.y]){if(e.loaded){d.save();var m=(40-(e.height/l.y))/2;d.translate(((f-sonicManager.windowLocation.x)*l.x),((g-sonicManager.windowLocation.y+m)*l.y));if(!this.facing){d.scale(-1,1);d.rotate(-_H.fixAngle(this.angle));d.drawImage(e,-e.width/2,-e.height/2);if(this.spinDash){d.drawImage(sonicManager.SpriteCache.sonicSprites[("spinsmoke"+_H.floor((sonicManager.drawTickCount%14)/2))+l.x+l.y],(-e.width/2)-25*l.x,-e.height/2+(m*l.y)-15,e.width,e.height)}}else{d.rotate(_H.fixAngle(this.angle));d.drawImage(e,-e.width/2,-e.height/2);if(this.spinDash){d.drawImage(sonicManager.SpriteCache.sonicSprites[("spinsmoke"+_H.floor((sonicManager.drawTickCount%14)/2))+l.x+l.y],(-e.width/2)-25*l.x,-e.height/2+(m*l.y)-15,e.width,e.height)}}d.restore();for(var h=0;h<this.haltSmoke.length;h++){var j=this.haltSmoke[h];d.drawImage(sonicManager.SpriteCache.sonicSprites[("haltsmoke"+_H.floor((sonicManager.drawTickCount%(4*6))/6))+l.x+l.y],((j.x-sonicManager.windowLocation.x-25)*l.x),((j.y+12-sonicManager.windowLocation.y+m)*l.y));if(_H.floor(((sonicManager.drawTickCount+6)%(4*6))/6)==0){this.haltSmoke.splice(h,1)}}}}else{if(e=sonicManager.SpriteCache.sonicSprites[this.spriteState]){if(e.loaded){sonicManager.SpriteCache.sonicSprites[this.spriteState+l.x+l.y]=_H.scaleSprite(e,l)}}else{sonicManager.SpriteCache.sonicSprites[this.spriteState]=_H.loadSprite(this.spriteLocations[this.spriteState])}}};this.kill=function(){};this.pressJump=function(){if(!this.justHit){this.jumping=true}};this.pressCrouch=function(){if(!this.justHit){this.crouching=true}};this.pressLeft=function(){if(!this.justHit){this.holdingLeft=true}};this.pressRight=function(){if(!this.justHit){this.holdingRight=true}};this.releaseJump=function(){this.jumping=false};this.releaseCrouch=function(){this.crouching=false};this.releaseLeft=function(){this.holdingLeft=false};this.releaseRight=function(){this.holdingRight=false};this.buildHeightInfo=function(){this.LevelWidth=c.LevelWidth*128;for(var t=0;t<c.Chunks.length;t++){var l=c.Chunks[t];var m;var n=l.heightBlocks1=[];var o=l.heightBlocks2=[];var j=l.angleMap1=[];var k=l.angleMap2=[];o.length=n.length=128;j.length=k.length=8;for(var f=0;f<128;f++){n[f]=[];o[f]=[];j[f]=[];k[f]=[];k[f].length=j[f].length=8;o[f].length=n[f].length=128}for(var h=0;h<8;h++){for(var g=0;g<8;g++){var u=l.tilePieces[g][h];var p=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes1[u.Block]];var q=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes2[u.Block]];if(p==0){continue}var d;var e;j[g][h]=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes1[u.Block]];k[g][h]=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes2[u.Block]];if(u.XFlip){if(u.YFlip){j[g][h]=(j[g][h]+(127-j[g][h])*2)%255;k[g][h]=(k[g][h]+(127-k[g][h])*2)%255;j[g][h]=(255-j[g][h])%255;k[g][h]=(255-k[g][h])%255}else{j[g][h]=(255-j[g][h])%255;k[g][h]=(255-k[g][h])%255}}else{if(u.YFlip){j[g][h]=(j[g][h]+(127-j[g][h])*2)%255;k[g][h]=(k[g][h]+(127-k[g][h])*2)%255}else{j[g][h]=(j[g][h]);k[g][h]=(k[g][h])}}p=p.items;q=q.items;for(e=0;e<16;e++){for(d=0;d<16;d++){var r=0,s=0;if(u.XFlip){if(u.YFlip){r=15-d;s=15-e}else{r=15-d;s=e}}else{if(u.YFlip){r=d;s=15-e}else{r=d;s=e}}switch(u.Solid1){case 0:n[(g*16+r)][(h*16+s)]=false;break;case 1:case 2:case 3:n[(g*16+r)][(h*16+s)]=(p[d]>16-e)?u.Solid1:0;break}switch(u.Solid2){case 0:o[(g*16+r)][(h*16+s)]=false;break;case 1:case 2:case 3:o[(g*16+r)][(h*16+s)]=(q[d]>16-e)?u.Solid2:0;break}}}}}}};this.updateSprite=function(){var d=Math.abs(this.gsp);var e=parseInt(this.spriteState.substring(this.spriteState.length-1,this.spriteState.length));if(this.breaking>0){if(this.gsp>0||this.gsp==0||this.spriteState=="breaking3"){this.facing=false;this.breaking=0}}else{if(this.breaking<0){if(this.gsp<0||this.gsp==0||this.spriteState=="breaking3"){this.breaking=0;this.facing=true}}}if(this.justHit){if(this.spriteState.substring(0,this.spriteState.length-1)!="hit"){this.spriteState="hit0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(8-d))==0){this.spriteState="hit1"}}}else{if(d==0&&this.inAir==false){if(this.ducking){if(this.spinDash){if(this.spriteState.substring(0,this.spriteState.length-1)!="spindash"){this.spriteState="spindash0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(2-d))==0){this.spriteState="spindash"+((e+1)%6)}}}else{if(this.spriteState.substring(0,this.spriteState.length-1)!="duck"){this.spriteState="duck0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(4-d))==0){this.spriteState="duck1"}}}}else{this.spriteState="normal";this.currentlyBall=false;this.rolling=false;this.runningTick=0}}else{if(this.breaking!=0){if(this.spriteState.substring(0,this.spriteState.length-1)!="breaking"){this.spriteState="breaking0";this.runningTick=1}else{if((this.runningTick++)%(7)==0){this.spriteState="breaking"+((e+1)%4);if(e==0){this.haltSmoke.push({x:_H.floor(this.x),y:_H.floor(this.y)})}}}}else{if(this.currentlyBall){if(this.spriteState.substring(0,this.spriteState.length-1)!="balls"){this.spriteState="balls0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(8-d))==0){this.spriteState="balls"+((e+1)%5)}}}else{if(d<6){if(this.spriteState.substring(0,this.spriteState.length-1)!="running"){this.spriteState="running0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(8-d))==0||(_H.floor(8-d)==0)){this.spriteState="running"+((e+1)%8)}}}else{if(d>=6){if(this.spriteState.substring(0,this.spriteState.length-1)!="fastrunning"){this.spriteState="fastrunning0";this.runningTick=1}else{if(((this.runningTick++)%(Math.ceil(8-d))==0)||(_H.floor(8-d)==0)){this.spriteState="fastrunning"+((e+1)%4)}}}}}}}}};this.buildHeightInfo(c)}DEBUGs=true;window.requestAnimFrame=(function(a){if(window.requestAnimationFrame){return window.requestAnimationFrame(a)}if(window.webkitRequestAnimationFrame){return window.webkitRequestAnimationFrame(a)}if(window.mozRequestAnimationFrame){return window.mozRequestAnimationFrame(a)}if(window.oRequestAnimationFrame){return window.oRequestAnimationFrame(a)}if(window.msRequestAnimationFrame){return window.msRequestAnimationFrame(a)}window.setTimeout(a,1000/60)});function SonicEngine(c){var k=this;this.canvas=$("#"+c);this.canvasItem=document.getElementById(c).getContext("2d");var j=window.sonicManager=new SonicManager(this.canvasItem);this.canvasWidth=0;this.canvasHeight=0;document.getElementById(c).addEventListener("DOMMouseScroll",h,false);document.getElementById(c).addEventListener("mousewheel",h,false);document.getElementById(c).addEventListener("touchmove",a);document.getElementById(c).addEventListener("touchstart",d);document.getElementById(c).addEventListener("touchend",b);document.getElementById(c).addEventListener("mousedown",d);document.getElementById(c).addEventListener("mouseup",b);document.getElementById(c).addEventListener("mousemove",a);$(document).keydown(f);$(document).keyup(g);function d(l){l.preventDefault();if(j.uiManager.onClick(l)){return false}if(j.onClick(l)){return false}return false}function a(l){l.preventDefault();if(j.uiManager.onMouseMove(l)){return false}return false}function b(l){l.preventDefault();j.uiManager.onMouseUp(l)}function h(l){l.preventDefault();if(j.uiManager.onMouseScroll(l)){return false}return l.preventDefault()&&false}function f(l){switch(l.keyCode){case 66:if(j.sonicToon){j.sonicToon.hit()}break;case 67:if(j.sonicToon){j.sonicToon.debug()}break;case 68:j.SonicLevel.curHeightMap=!j.SonicLevel.curHeightMap;break;case 38:case 87:if(j.sonicToon){j.sonicToon.pressJump()}else{j.windowLocation.y-=128}break;case 40:case 83:if(j.sonicToon){j.sonicToon.pressCrouch()}else{j.windowLocation.y+=128}break;case 37:case 65:j.windowLocation.x-=128;if(j.sonicToon){j.sonicToon.pressLeft()}else{j.windowLocation.x-=128}break;case 39:case 68:j.windowLocation.x+=128;if(j.sonicToon){j.sonicToon.pressRight()}else{j.windowLocation.x+=128}break}}function g(l){switch(l.keyCode){case 38:case 87:if(j.sonicToon){j.sonicToon.releaseJump()}break;case 40:case 83:if(j.sonicToon){j.sonicToon.releaseCrouch()}break;case 37:case 65:if(j.sonicToon){j.sonicToon.releaseLeft()}break;case 39:case 68:if(j.sonicToon){j.sonicToon.releaseRight()}break}}k.resizeCanvas=function(){k.canvasWidth=$(window).width();k.canvasHeight=$(window).height();k.canvas.attr("width",k.canvasWidth);k.canvas.attr("height",k.canvasHeight)};function e(l){l.clearRect(0,0,k.canvasWidth,k.canvasHeight)}k.draw=function(){requestAnimFrame(k.draw);e(k.canvasItem);j.draw(k.canvasItem);j.uiManager.draw(k.canvasItem)};$(window).resize(this.resizeCanvas);this.resizeCanvas();requestAnimFrame(k.draw);window.setInterval(j.tick,1000/60,j)}function SonicManager(b){var c=this.scale={x:2,y:2};this.windowLocation=_H.defaultWindowLocation(1);this.showHeightMap=false;this.goodRing=new Ring(false);this.activeRings=[];this.background=null;this.uiManager=new UIManager(this,b,this.scale);this.SonicLevel={Tiles:[],Blocks:[],Chunks:[],ChunkMap:[[]],Rings:{},curHeightMap:true,LevelWidth:0,LevelHeight:0};var a=new TileChunk()+new TilePiece()+new Tile()+new HeightMask();this.SonicLevel.ChunkMap=[[]];this.clickState=ClickState.PlaceChunk;this.onClick=function(f){return;if(f.shiftKey){var d=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[_H.floor(f.x/(128*c.x)),_H.floor(f.y/(128*c.y))]];var l=d.getTilePiece((f.x-_H.floor(f.x/(128*c.x))*(128*c.x)),(f.y-_H.floor(f.y/(128*c.y))*(128*c.y)),c);if(l){this.uiManager.indexes.tpIndex=this.SonicLevel.Blocks.indexOf(l);this.uiManager.modifyTilePieceArea.tilePiece=l;this.uiManager.solidTileArea.visible=true}}else{if(!f.button||f.button==0){switch(this.clickState){case ClickState.PlaceChunk:this.SonicLevel.ChunkMap[_H.floor(f.x/(128*c.x)),_H.floor(f.y/(128*c.y))]=this.uiManager.indexes.modifyIndex;break;case ClickState.PlaceRing:var j=_H.floor((f.x-_H.floor(f.x/(128*c.x))*(128*c.x))/(c.x));var k=_H.floor((f.y-_H.floor(f.y/(128*c.y))*(128*c.y))/(c.y));var h=(_H.floor(j/16))+(_H.floor(f.x/(128*c.x)))*8;var g=(_H.floor(k/16))+(_H.floor(f.y/(128*c.y)))*8;if(this.SonicLevel.Rings[g*8*sonicManager.SonicLevel.LevelWidth+h]){delete this.SonicLevel.Rings[g*8*sonicManager.SonicLevel.LevelWidth+h]}else{this.SonicLevel.Rings[g*8*sonicManager.SonicLevel.LevelWidth+h]={x:h,y:g}}break;default:}}}};this.tickCount=0;this.drawTickCount=0;this.tick=function(d){if(d.loading){return}if(d.sonicToon){d.tickCount++;d.sonicToon.ticking=true;try{d.sonicToon.tick(d.SonicLevel,c)}finally{d.sonicToon.ticking=false}if(d.sonicToon.y>128*sonicManager.SonicLevel.LevelHeight){d.sonicToon.y=0}if(d.sonicToon.x>128*sonicManager.SonicLevel.LevelWidth){d.sonicToon.x=0}}};this.screenOffset={x:b.canvas.width/2-this.windowLocation.width*c.x/2,y:b.canvas.height/2-this.windowLocation.height*c.y/2};this.draw=function(k){k.save();this.drawTickCount++;if((this.spriteLoader&&!this.spriteLoader.tick())||this.loading){k.fillStyle="white";k.fillText("Loading...   ",95,95);k.restore();return}this.screenOffset={x:k.canvas.width/2-this.windowLocation.width*c.x/2,y:k.canvas.height/2-this.windowLocation.height*c.y/2};if(this.sonicToon){if(this.sonicToon.ticking){while(true){if(!this.sonicToon.ticking){break}}}k.translate(this.screenOffset.x,this.screenOffset.y);k.fillStyle="#000000";k.fillRect(0,0,this.windowLocation.width*c.x,this.windowLocation.height*c.x);k.beginPath();k.rect(0,0,this.windowLocation.width*c.x,this.windowLocation.height*c.x);k.clip();this.windowLocation.x=_H.floor(this.sonicToon.x-160);this.windowLocation.y=_H.floor(this.sonicToon.y-180);var E=_H.floor(this.windowLocation.x/c.x);if(this.background){this.background.draw(k,{x:-_H.floor(this.windowLocation.x/2)*c.x,y:-(_H.floor(this.windowLocation.y/4))*c.y},c,E)}}if(this.windowLocation.x<0){this.windowLocation.x=0}if(this.windowLocation.y<0){this.windowLocation.y=0}if(this.windowLocation.x>128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width){this.windowLocation.x=128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width}if(this.windowLocation.y>128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height){this.windowLocation.y=128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height}var w=[];for(var s=-128;s<this.windowLocation.width;s+=128){for(var h=-128;h<this.windowLocation.height;h+=128){w.push({x:s,y:h})}}if(this.SonicLevel.Chunks&&this.SonicLevel.Chunks.length>0){for(var v in w){var F=(this.windowLocation.x+w[v].x+128)/128;var G=(this.windowLocation.y+w[v].y+128)/128;var e=_H.floor(F);var g=_H.floor(G);if(e<0||g<0){continue}var m=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[e][g]];if(!m){continue}var x={x:e*128*c.x,y:g*128*c.y};var y={x:x.x-this.windowLocation.x*c.x,y:x.y-this.windowLocation.y*c.x};m.draw(k,y,c,false);if(!this.sonicToon){k.strokeStyle="#DD0033";k.lineWidth=3;k.strokeRect(y.x,y.y,128*c.x,128*c.y)}}for(var B in this.SonicLevel.Rings){var A=this.SonicLevel.Rings[B];if(this.sonicToon){if(!this.sonicToon.obtainedRing[B]){if(this.windowLocation.intersects(A)){this.goodRing.draw(k,{x:(A.X)-this.windowLocation.x,y:(A.Y)-this.windowLocation.y},c,true)}}}else{if(this.windowLocation.intersects(A)){this.goodRing.draw(k,{x:(A.X)-this.windowLocation.x,y:(A.Y)-this.windowLocation.y},c,false)}}}for(var t=0;t<sonicManager.SonicLevel.Objects.length;t++){var u=sonicManager.SonicLevel.Objects[t];if(this.sonicToon){if(this.windowLocation.intersects({X:u.ObjectData.X,Y:u.ObjectData.Y})){u.draw(k,{x:(u.ObjectData.X)-this.windowLocation.x,y:(u.ObjectData.Y)-this.windowLocation.y},c,true)}}else{if(this.windowLocation.intersects({X:u.ObjectData.X,Y:u.ObjectData.Y})){u.draw(k,{x:(u.ObjectData.X)-this.windowLocation.x,y:(u.ObjectData.Y)-this.windowLocation.y},c,false)}}}for(var s=this.activeRings.length-1;s>=0;s--){var j=this.activeRings[s];j.draw(k,{x:j.x-this.windowLocation.x,y:j.y-this.windowLocation.y},c);if(j.tickCount>256){_H.remove(this.activeRings,j)}}if(this.sonicToon){this.sonicToon.draw(k,c);if(this.windowLocation.x<0){this.windowLocation.x=0}if(this.windowLocation.y<0){this.windowLocation.y=0}if(this.windowLocation.x>128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width){this.windowLocation.x=128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width}if(this.windowLocation.y>128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height){this.windowLocation.y=128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height}}for(var v in w){var F=(this.windowLocation.x+w[v].x+128)/128;var G=(this.windowLocation.y+w[v].y+128)/128;var e=_H.floor(F);var g=_H.floor(G);if(e<0||g<0){continue}var m=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[e][g]];if(!m){continue}var x={x:e*128*c.x,y:g*128*c.y};var y={x:x.x-this.windowLocation.x*c.x,y:x.y-this.windowLocation.y*c.x};m.draw(k,y,c,true);if(!this.sonicToon){k.strokeStyle="#DD0033";k.lineWidth=3;k.strokeRect(y.x,y.y,128*c.x,128*c.y)}if(this.showHeightMap){var n;if((n=sonicManager.SpriteCache.heightMapChunks[(this.SonicLevel.curHeightMap?1:2)+" "+m.index+" "+c.y+" "+c.x])){if(n.loaded){k.drawImage(n,y.x,y.y)}}else{var q=this.SonicLevel.curHeightMap?sonicManager.SonicLevel.CollisionIndexes1:sonicManager.SonicLevel.CollisionIndexes2;for(var f=0;f<8;f++){for(var d=0;d<8;d++){var C=m.tilePieces[d][f];var p=sonicManager.SonicLevel.HeightMaps[q[C.Block]];if(p==0){continue}if(p==1){k.fillStyle="rgba(24,98,235,0.6)";k.fillRect(y.x+(d*16)*c.x,y.y+(f*16)*c.y,c.x*16,c.y*16);continue}var z={x:y.x+(d*16)*c.x,y:y.y+(f*16)*c.y};p.draw(k,z,c,-1,C.XFlip,C.YFlip);if(false&&md[d][f]!=null){var D=md[d][f];z.x+=16*c.x/2;z.y+=16*c.y/2;k.moveTo(z.x,z.y);k.lineTo(z.x+_H.sin((D))*10*c.x,z.y+_H.cos((D))*10*c.y);k.strokeStyle="#D141FF";k.lineWidth=4;k.stroke()}}}}}if(!this.sonicToon){k.strokeStyle="#DD0033";k.lineWidth=3;k.strokeRect(y.x,y.y,128*c.x,128*c.y)}}}k.restore();if(this.sonicToon){this.sonicToon.drawUI(k,{x:this.screenOffset.x,y:this.screenOffset.y},c)}};this.spriteLoader=null;this.SpriteCache={rings:[],tileChunks:[],tilePeices:[],tiles:[],sonicSprites:[],heightMaps:[],heightMapChunks:[]};this.preLoadSprites=function(q,g,x){this.SpriteCache={rings:[],tileChunks:[],tilePeices:[],tiles:[],sonicSprites:[],heightMaps:[],heightMapChunks:[]};var f=this.SpriteCache.rings;var m=0;var u=[];for(var n=0;n<4;n++){u[n]="assets/Sprites/ring"+n+".png";this.imageLength++}var w=this;var p;var l={sprites:0,tps:0,tcs:0,ss:0,hms:0,hmc:0};var r=this.spriteLoader=new SpriteLoader(g,x);var v=r.addStep("Sprites",function(k,j){var y=k*200;f[y]=_H.loadSprite(u[k],function(z){f[z.tag*200+q.x*100+q.y]=_H.scaleSprite(z,q,function(A){j()})});f[y].tag=k},function(){l.sprites=l.sprites+1;if(l.sprites==4){return true}return false});for(var h=0;h<u.length;h++){r.addIterationToStep(v,h)}var w=this;var t=1;var e=r.addStep("Chunk Maps",function(G,D){var B=_H.defaultCanvas(128*q.x,128*q.y);var C=B.context;C.clearRect(0,0,B.width,B.height);p=w.SonicLevel.Chunks[G];p.draw(C,{x:0,y:0},q,false);var E=B.canvas.toDataURL("image/png");w.SpriteCache.tileChunks[false+" "+p.index+" "+q.y+" "+q.x]=_H.loadSprite(E,function(k){l.tcs++;D()});C.clearRect(0,0,B.width,B.height);if(!p.onlyBackground()){p.draw(C,{x:0,y:0},q,true);var E=B.canvas.toDataURL("image/png");w.SpriteCache.tileChunks[true+" "+p.index+" "+q.y+" "+q.x]=_H.loadSprite(E,function(k){l.tcs++;D()})}else{w.SpriteCache.tileChunks[true+" "+p.index+" "+q.y+" "+q.x]=1;l.tcs++;D()}var I={x:0,y:0};C.clearRect(0,0,B.width,B.height);for(var A=0;A<8;A++){for(var z=0;z<8;z++){var K=p.tilePieces[z][A];var H=sonicManager.SonicLevel.CollisionIndexes1[K.Block];var F=sonicManager.SonicLevel.HeightMaps[H];if(F==0){continue}var j=z;var y=A;if(F==1){C.fillStyle="rgba(24,98,235,0.6)";C.fillRect(I.x+(j*16)*q.x,I.y+(y*16)*q.y,q.x*16,q.y*16);continue}var J={x:I.x+(j*16)*q.x,y:I.y+(y*16)*q.y};F.draw(C,J,q,-1,K.XFlip,K.YFlip,K.Solid1);var L=sonicManager.SonicLevel.Angles[H];if(L!=255){J.x+=16*q.x/2;J.y+=16*q.y/2;C.moveTo(J.x,J.y);C.lineTo(J.x+_H.sin((L)*(Math.PI/180))*10*q.x,J.y+_H.cos((L)*(Math.PI/180))*10*q.y);C.strokeStyle="#D141FF";C.lineWidth=2;C.stroke()}}}var E=B.canvas.toDataURL("image/png");w.SpriteCache.heightMapChunks[1+" "+p.index+" "+q.y+" "+q.x]=_H.loadSprite(E,function(k){l.hmc++;D()});C.clearRect(0,0,B.width,B.height);for(var A=0;A<8;A++){for(var z=0;z<8;z++){var K=p.tilePieces[z][A];var F=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes2[K.Block]];if(F==0){continue}var j=z;var y=A;if(F==1){C.fillStyle="rgba(24,98,235,0.6)";C.fillRect(I.x+(j*16)*q.x,I.y+(y*16)*q.y,q.x*16,q.y*16);continue}var J={x:I.x+(j*16)*q.x,y:I.y+(y*16)*q.y};F.draw(C,J,q,-1,K.XFlip,K.YFlip,K.Solid2)}}var E=B.canvas.toDataURL("image/png");w.SpriteCache.heightMapChunks[2+" "+p.index+" "+q.y+" "+q.x]=_H.loadSprite(E,function(k){l.hmc++;D()})},function(){if(l.tcs>=w.SonicLevel.Chunks.length*2/t&&l.hmc>=w.SonicLevel.Chunks.length*2/t){return true}return false});for(var o=0;o<this.SonicLevel.Chunks.length;o++){r.addIterationToStep(e,o)}var d=r.addStep("Background data",function(B,A){var j=_H.defaultCanvas(w.SonicLevel.BackgroundWidth/2*128*q.x,w.SonicLevel.BackgroundHeight*128*q.y);var z=j.context;z.clearRect(0,0,j.width,j.height);for(var C=0;C<w.SonicLevel.BackgroundWidth/2;C++){for(var D=0;D<w.SonicLevel.BackgroundHeight;D++){var k=sonicManager.SonicLevel.Chunks[w.SonicLevel.BGChunkMap[C][D]];if(k){k.draw(z,{x:C*128*q.x,y:D*128*q.y},q,0)}}}w.SpriteCache.bgImage=_H.loadSprite(j.canvas.toDataURL("image/png"),A)},function(){w.background=new ParallaxBG(w.SpriteCache.bgImage,{x:1,y:1});return true});r.addIterationToStep(d,0);var s=r.addStep("Sonic Sprites",function(y,k){var j=w.SpriteCache.sonicSprites;j[y]=_H.loadSprite(w.spriteLocations[y],function(z){j[z.tag+q.x+q.y]=_H.scaleSprite(z,q,k)});j[y].tag=y},function(){l.ss++;if(l.ss==w.imageLength){return true}return false});w.spriteLocations=[];w.imageLength=0;w.spriteLocations.normal="assets/Sprites/sonic.png";r.addIterationToStep(s,"normal");w.imageLength++;var n;for(n=0;n<4;n++){w.spriteLocations["fastrunning"+n]="assets/Sprites/fastrunning"+n+".png";w.imageLength++;r.addIterationToStep(s,"fastrunning"+n)}for(n=0;n<8;n++){w.spriteLocations["running"+n]="assets/Sprites/running"+n+".png";w.imageLength++;r.addIterationToStep(s,"running"+n)}for(n=0;n<4;n++){w.spriteLocations["breaking"+n]="assets/Sprites/breaking"+n+".png";w.imageLength++;r.addIterationToStep(s,"breaking"+n)}for(n=0;n<5;n++){w.spriteLocations["balls"+n]="assets/Sprites/balls"+n+".png";w.imageLength++;r.addIterationToStep(s,"balls"+n)}for(n=0;n<2;n++){w.spriteLocations["duck"+n]="assets/Sprites/duck"+n+".png";w.imageLength++;r.addIterationToStep(s,"duck"+n)}for(n=0;n<2;n++){w.spriteLocations["hit"+n]="assets/Sprites/hit"+n+".png";w.imageLength++;r.addIterationToStep(s,"hit"+n)}for(n=0;n<6;n++){w.spriteLocations["spindash"+n]="assets/Sprites/spindash"+n+".png";w.imageLength++;r.addIterationToStep(s,"spindash"+n)}for(n=0;n<7;n++){w.spriteLocations["spinsmoke"+n]="assets/Sprites/spinsmoke"+n+".png";w.imageLength++;r.addIterationToStep(s,"spinsmoke"+n)}for(n=0;n<4;n++){w.spriteLocations["haltsmoke"+n]="assets/Sprites/haltsmoke"+n+".png";w.imageLength++;r.addIterationToStep(s,"haltsmoke"+n)}}}ClickState={PlaceChunk:0,PlaceRing:1};function SpriteLoader(a,c){var b=this;this.stepIndex=0;this.steps=[];this.tickIndex=0;this.tick=function(){if(this.stepIndex==this.steps.length){a();return true}var d=this.steps[this.stepIndex];if(!d){return true}if(b.tickIndex%5==0){c("Caching: "+d.title+" "+(b.tickIndex+"/"+d.iterations.length))}if(d.iterations.length>this.tickIndex){d.method(d.iterations[this.tickIndex++],function(){if(d.finish()){b.stepIndex++;b.tickIndex=0}})}return false};this.addStep=function(f,d,e){this.steps.push({title:f,method:d,finish:e,iterations:[]});return this.steps.length-1};this.addIterationToStep=function(e,d){this.steps[e].iterations.push(d)}}var Stats=function(){var C,v,M=0,N=0,D=Date.now(),P=D,O=D,G=0,I=1000,J=0,z,E,A,w=[[16,16,48],[0,255,255]],H=0,K=1000,L=0,y,F,B,x=[[16,48,16],[0,255,0]];C=document.createElement("div");C.style.cursor="pointer";C.style.width="80px";C.style.opacity="0.9";C.style.zIndex="10001";C.addEventListener("mousedown",function(b){b.preventDefault();M=(M+1)%2;0==M?(z.style.display="block",y.style.display="none"):(z.style.display="none",y.style.display="block")},!1);z=document.createElement("div");z.style.textAlign="left";z.style.lineHeight="1.2em";z.style.backgroundColor="rgb("+_H.floor(w[0][0]/2)+","+_H.floor(w[0][1]/2)+","+_H.floor(w[0][2]/2)+")";z.style.padding="0 0 3px 3px";C.appendChild(z);E=document.createElement("div");E.style.fontFamily="Helvetica, Arial, sans-serif";E.style.fontSize="9px";E.style.color="rgb("+w[1][0]+","+w[1][1]+","+w[1][2]+")";E.style.fontWeight="bold";E.innerHTML="FPS";z.appendChild(E);A=document.createElement("div");A.style.position="relative";A.style.width="74px";A.style.height="30px";A.style.backgroundColor="rgb("+w[1][0]+","+w[1][1]+","+w[1][2]+")";for(z.appendChild(A);74>A.children.length;){v=document.createElement("span"),v.style.width="1px",v.style.height="30px",v.style.cssFloat="left",v.style.backgroundColor="rgb("+w[0][0]+","+w[0][1]+","+w[0][2]+")",A.appendChild(v)}y=document.createElement("div");y.style.textAlign="left";y.style.lineHeight="1.2em";y.style.backgroundColor="rgb("+_H.floor(x[0][0]/2)+","+_H.floor(x[0][1]/2)+","+_H.floor(x[0][2]/2)+")";y.style.padding="0 0 3px 3px";y.style.display="none";C.appendChild(y);F=document.createElement("div");F.style.fontFamily="Helvetica, Arial, sans-serif";F.style.fontSize="9px";F.style.color="rgb("+x[1][0]+","+x[1][1]+","+x[1][2]+")";F.style.fontWeight="bold";F.innerHTML="MS";y.appendChild(F);B=document.createElement("div");B.style.position="relative";B.style.width="74px";B.style.height="30px";B.style.backgroundColor="rgb("+x[1][0]+","+x[1][1]+","+x[1][2]+")";for(y.appendChild(B);74>B.children.length;){v=document.createElement("span"),v.style.width="1px",v.style.height=30*Math.random()+"px",v.style.cssFloat="left",v.style.backgroundColor="rgb("+x[0][0]+","+x[0][1]+","+x[0][2]+")",B.appendChild(v)}return{getDomElement:function(){return C},getFps:function(){return G},getFpsMin:function(){return I},getFpsMax:function(){return J},getMs:function(){return H},getMsMin:function(){return K},getMsMax:function(){return L},update:function(){D=Date.now();H=D-P;K=Math.min(K,H);L=Math.max(L,H);F.textContent=H+" MS ("+K+"-"+L+")";var b=Math.min(30,30-30*(H/200));B.appendChild(B.firstChild).style.height=b+"px";P=D;N++;if(D>O+1000){G=Math.round(1000*N/(D-O)),I=Math.min(I,G),J=Math.max(J,G),E.textContent=G+" FPS ("+I+"-"+J+")",b=Math.min(30,30-30*(G/100)),A.appendChild(A.firstChild).style.height=b+"px",O=D,N=0}}}};function Tile(a){this.colors=a;this.sprites=[];Tile.prototype.changeColor=function(c,d,b){this.colors[c][d]=b;this.sprites=[]};Tile.prototype.draw=function(b,k,l,n,o,h,f){for(var d=0;d<this.colors.length;d++){for(var e=0;e<this.colors[d].length;e++){var c=this.colors[d][e];if(c==0){continue}var g=sonicManager.SonicLevel.Palette[h][c];b.fillStyle="#"+g;if(n){if(o){b.fillRect(k.x+(7-(d))*l.x,k.y+(7-e)*l.y,l.x,l.y)}else{b.fillRect(k.x+(7-(d))*l.x,k.y+(e)*l.y,l.x,l.y)}}else{if(o){b.fillRect(k.x+((d))*l.x,k.y+(7-e)*l.y,l.x,l.y)}else{b.fillRect(k.x+((d))*l.x,k.y+(e)*l.y,l.x,l.y)}}}}}}function TileChunk(a){this.tilePieces=a;this.hLayer=[[]];this.sprites=[];TileChunk.prototype.getTilePiece=function(c,d,b){return sonicManager.SonicLevel.Blocks[this.tilePieces[_H.floor((c/b.x/16))][_H.floor((d/b.y/16))]]};TileChunk.prototype.onlyBackground=function(){for(var b=0;b<this.tilePieces.length;b++){for(var c=0;c<this.tilePieces[b].length;c++){var e=this.tilePieces[b][c];var d=sonicManager.SonicLevel.Blocks[e.Block];if(d){if(!d.onlyBackground()){return false}}}}return true};TileChunk.prototype.draw=function(b,h,l,f){var c;if((c=sonicManager.SpriteCache.tileChunks[f+" "+this.index+" "+l.y+" "+l.x])){if(c==1){return}if(c.loaded){b.drawImage(c,h.x,h.y)}}else{for(var d=0;d<this.tilePieces.length;d++){for(var e=0;e<this.tilePieces[d].length;e++){var k=this.tilePieces[d][e];var g=sonicManager.SonicLevel.Blocks[k.Block];if(g){g.draw(b,{x:h.x+d*16*l.x,y:h.y+e*16*l.y},l,f,k.XFlip,k.YFlip)}}}}return true}}function TileItem(){TileItem.prototype.draw=function(){}}function TilePiece(a,b){this.tiles=b;TilePiece.prototype.click=function(d,e,c){};TilePiece.prototype.mouseOver=function(c,d){};TilePiece.prototype.onlyBackground=function(){for(var c=0;c<this.tiles.length;c++){var d=this.tiles[c];if(sonicManager.SonicLevel.Tiles[d.Tile]){if(d.Priority==true){return false}}}return true};TilePiece.prototype.draw=function(c,j,k,g,l,m){var d;if(l){if(m){d=[3,2,1,0]}else{d=[1,0,3,2]}}else{if(m){d=[2,3,0,1]}else{d=[0,1,2,3]}}var e;if((e=sonicManager.SpriteCache.tilePeices[g+" "+this.index+" "+k.y+" "+k.x])){if(e.loaded){c.drawImage(e,j.x,j.y)}}else{for(var f=0;f<this.tiles.length;f++){var h=this.tiles[f];if(sonicManager.SonicLevel.Tiles[h.Tile]){if(h.Priority==g){sonicManager.SonicLevel.Tiles[h.Tile].draw(c,{x:j.x+(d[f]%2)*8*k.x,y:j.y+_H.floor(d[f]/2)*8*k.y},k,_H.xor(l,h.XFlip),_H.xor(m,h.YFlip),h.Palette,false,g)}}}}return true};TilePiece.prototype.equals=function(d){for(var c=0;c<this.tiles.length;c++){if(d[c]!=this.tiles[c]){return false}}return true}}RotationMode={Floor:134,RightWall:224,Ceiling:314,LeftWall:44};function UiArea(f,g,e,b,c,a){this.x=f;this.y=g;this.manager=c;this.closable=a;this.width=e;this.height=b;this.depth=0;this.visible=true;this.dragging=false;this.controls=[];this.addControl=function(h){h.parent=this;this.controls.push(h);return h};var d=this;if(a){this.addControl(new Button(this.width-30,4,26,26,"X",this.manager.buttonFont,"Green",function(){d.visible=false}))}this.click=function(j){if(!this.visible){return}for(var k=0;k<this.controls.length;k++){var h=this.controls[k];if(h.visible&&h.y<=j.y&&h.y+h.height>j.y&&h.x<=j.x&&h.x+h.width>j.x){j.x-=h.x;j.y-=h.y;h.onClick(j);return false}}this.dragging={x:j.x,y:j.y}};this.mouseMove=function(j){if(!this.visible){return}if(!this.dragging){for(var k=0;k<this.controls.length;k++){var h=this.controls[k];if(h.visible&&h.y<=j.y&&h.y+h.height>j.y&&h.x<=j.x&&h.x+h.width>j.x){j.x-=h.x;j.y-=h.y;h.onMouseOver(j)}}return}this.x+=j.x-this.dragging.x;this.y+=j.y-this.dragging.y};this.mouseUp=function(j){if(!this.visible){return}for(var k=0;k<this.controls.length;k++){var h=this.controls[k];h.onMouseUp({x:j.x-h.x,y:j.y-h.y})}this.dragging=false};this.scroll=function(j){if(!this.visible){return}for(var k=0;k<this.controls.length;k++){var h=this.controls[k];if(h.visible&&h.y<=j.y&&h.y+h.height>j.y&&h.x<=j.x&&h.x+h.width>j.x){if(h.onScroll){j.x-=h.x;j.y-=h.y;h.onScroll(j);return false}}}};this.cachedDrawing=null;this.draw=function(l){if(!this.visible){return}var o;var q;var p;if(!this.cachedDrawing){var m=document.createElement("canvas");m.width=this.width+20;m.height=this.height+20;var n=m.getContext("2d");n.fillStyle="rgba(133,133,133,0.6)";n.lineWidth=9;n.strokeStyle="#333";var h=this.x;var k=this.y;this.x=10;this.y=10;roundRect(n,this.x,this.y,this.width,this.height,5,true,true);for(p=0;p<this.controls.length;p++){q=this.controls[p];o=q.forceDrawing();if(o.redraw){q.draw(n)}}this.x=h;this.y=k;this.cachedDrawing=_H.loadSprite(m.toDataURL("image/png"))}if(this.cachedDrawing.loaded){l.drawImage(this.cachedDrawing,_H.floor(this.x),_H.floor(this.y));if(this.cachedDrawing.width!=this.width+20||this.cachedDrawing.height!=this.height+20){this.cachedDrawing=null}l.save();l.translate(10,10);for(p=0;p<this.controls.length;p++){q=this.controls[p];o=q.forceDrawing();if(!o.redraw){q.draw(l)}if(o.clearCache){this.cachedDrawing=null}}l.restore()}else{l.fillStyle="rgba(133,133,133,0.6)";l.lineWidth=9;l.strokeStyle="#333";l.save();l.translate(10,10);roundRect(l,this.x,this.y,this.width,this.height,5,true,true);for(p=0;p<this.controls.length;p++){q=this.controls[p];q.draw(l)}l.restore()}};return this}function TextArea(d,e,c,b,a){this.forceDrawing=function(){if((_H.isFunction(this.text)?this.text():this.text)==this.oldText){return{redraw:true,clearCache:false}}this.oldText=_H.isFunction(this.text)?this.text():this.text;return{redraw:true,clearCache:true}};this.x=d;this.oldText="";this.y=e;this.visible=true;this.text=c;this.font=b;this.color=a;this.parent=null;this.onClick=function(f){return false};this.onMouseUp=function(f){if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(f){if(this.mouseOver){this.mouseOver()}};this.draw=function(f){if(!this.visible){return}var k=_H.isFunction(this.text)?this.text():this.text;if(f.font!=this.font){f.font=this.font}var l=f.measureText(k).width;var g=parseInt(f.font.split("pt")[0]);var j=3;f.strokeStyle=this.color;f.shadowColor="#FFF";f.shadowBlur=20;f.lineWidth=1.5;f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.strokeText(k,this.parent.x+this.x,this.parent.y+this.y);f.shadowBlur=0};return this}function Button(j,k,h,d,g,c,b,a,f,e){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=j;this.y=k;this.visible=true;this.width=h;this.height=d;this.text=g;this.font=c;this.clicking=false;this.click=a;this.mouseUp=f;this.mouseOver=e;this.color=b;this.parent=null;this.onClick=function(l){if(!this.visible){return}this.clicking=true};this.onMouseUp=function(l){if(!this.visible){return}if(this.clicking){if(this.click){this.click()}}this.clicking=false;if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(l){if(!this.visible){return}if(this.mouseOver){this.mouseOver()}};this.draw=function(l){if(!this.visible){return}l.fillStyle=this.color;l.strokeStyle="#DAC333";l.lineWidth=2;roundRect(l,this.parent.x+this.x,this.parent.y+this.y,this.width,this.height,5,true,true);l.fillStyle=this.clicking?"#FCA":"#334";if(l.font!=this.font){l.font=this.font}l.fillText(this.text,this.parent.x+this.x+((this.width/2)-(l.measureText(this.text).width/2)),this.parent.y+this.y+(this.height/3)*2)};return this}function TilePieceArea(d,e,a,c,b){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=d;this.y=e;this.visible=true;this.scale=a;this.width=a.x*16;this.height=a.y*17;this.clicking=false;this.tilePiece=c;this.parent=null;this.state=b;this.onClick=function(f){if(!this.visible){return}this.clicking=true;this.clickHandled=false};this.onMouseUp=function(f){if(!this.visible){return}if(this.tilePiece&&this.clicking&&!this.clickHandled){this.tilePiece.click(_H.floor(f.x/a.x),_H.floor(f.y/a.y),this.state)}this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(f){if(!this.tilePiece){return}if(this.clicking){this.clickHandled=true;this.tilePiece.click(_H.floor(f.x/a.x),_H.floor(f.y/a.y),this.state)}else{this.tilePiece.mouseOver(_H.floor(f.x/a.x),_H.floor(f.y/a.y))}};this.draw=function(f){if(!this.visible){return}if(!this.tilePiece){return}this.tilePiece.tag=true;this.tilePiece.draw(f,{x:this.parent.x+this.x,y:this.parent.y+this.y},this.scale,this.state,true);this.tilePiece.tag=false};return this}function TileBGEditArea(b,c,a){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=b;this.y=c;this.visible=true;this.clicking=false;this.parallaxBG=a;this.parent=null;this.lowestClickedY=-1;this.highestClickedY=-1;this.onClick=function(f){if(!this.visible){return}this.clicking=true;this.parallaxBG=sonicManager.background;if(f.x>0&&f.y>0&&f.y<this.parallaxBG.height&&f.x<this.parallaxBG.width){var d;if((d=this.parallaxBG.onBar(f.x,f.y))){this.lowestClickedY=d.top;this.highestClickedY=d.bottom}else{this.lowestClickedY=f.y;this.highestClickedY=f.y}}this.clickHandled=false};this.onMouseUp=function(d){if(!this.visible){return}this.parallaxBG=sonicManager.background;this.highestClickedY=-1;this.lowestClickedY=-1;this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(d){if(!this.clicking){return}this.parallaxBG=sonicManager.background;if(d.x>0&&d.y>0&&d.y<this.parallaxBG.height&&d.x<this.parallaxBG.width){if(d.y>this.highestClickedY){this.highestClickedY=d.y}if(d.y<this.lowestClickedY){this.lowestClickedY=d.y}for(var f=this.lowestClickedY;f<this.highestClickedY;f++){this.parallaxBG.click(d.x,f)}}return false};this.draw=function(d){if(!this.visible){return}this.parallaxBG=sonicManager.background;if(!this.parallaxBG){return}this.width=this.parallaxBG.width;this.height=this.parallaxBG.height;this.parent.width=this.width+70;this.parent.height=this.height+50;var e={x:1,y:1};this.parallaxBG.drawUI(d,{x:this.parent.x+this.x,y:this.parent.y+this.y},e)};return this}function TileChunkArea(d,e,a,c,b){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=d;this.y=e;this.visible=true;this.scale=a;this.width=a.x*128;this.height=a.y*128;this.clicking=false;this.tileChunk=c;this.parent=null;this.state=b;this.setToTile=null;this.onClick=function(f){if(!this.visible){return}this.clicking=true};this.onMouseUp=function(f){if(!this.visible){return}if(this.clicking){if(this.setToTile!=null){this.tileChunk.tilePieces[((_H.floor(f.x/this.scale.x/16)))][(_H.floor(f.y/this.scale.y/16))]=sonicManager.SonicLevel.Blocks.indexOf(this.setToTile);this.tileChunk.sprites=[]}}this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(f){if(this.clicking){}};this.draw=function(f){if(!this.visible){return}if(!this.tileChunk){return}this.tileChunk.draw(f,{x:this.parent.x+this.x,y:this.parent.y+this.y},this.scale,true)};return this}function ScrollBox(g,h,c,f,d,a,b){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=g;this.y=h;this.itemWidth=d;this.visible=true;var e=14;this.width=d+e;this.visibleItems=f;this.itemHeight=c;this.backColor=a;this.height=f*c;this.parent=null;this.scrollOffset=0;this.scrollPosition=0;this.dragging=false;if(b){this.controls=b}else{this.controls=[]}this.scrolling=false;this.addControl=function(j){j.parent=this;this.controls.push(j);return j};this.onClick=function(k){if(!this.visible){return}for(var l=this.scrollOffset;l<this.controls.length;l++){var j=this.controls[l];if(j.y<=k.y&&j.y+j.height>k.y&&j.x<=k.x&&j.x+j.width>k.x){k.x-=j.x;k.y-=j.y;j.onClick(k);return false}}if(k.x>this.itemWidth&&k.x<this.itemWidth+e){if(this.scrollPosition>k.y){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}}this.dragging=true;return false};this.onMouseUp=function(k){if(!this.visible){return}this.dragging=false;for(var l=this.scrollOffset;l<this.controls.length;l++){var j=this.controls[l];if(j.y<=k.y&&j.y+j.height>k.y&&j.x<=k.x&&j.x+j.width>k.x){k.x-=j.x;k.y-=j.y;j.onMouseUp(k);return false}}if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(k){if(!this.visible){return}for(var l=0;l<this.controls.length;l++){var j=this.controls[l];if(j.y<=k.y&&j.y+j.height>k.y&&j.x<=k.x&&j.x+j.width>k.x){k.x-=j.x;k.y-=j.y;j.onMouseOver(k);break}}if(this.dragging&&k.x>this.itemWidth&&k.x<this.itemWidth+e){if(this.scrollPosition>k.y){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}}if(this.mouseOver){this.mouseOver()}};this.onScroll=function(k){if(!this.visible){return}if(k.delta>0){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}for(var l=0;l<this.controls.length;l++){var j=this.controls[l];if(j.y<=k.y&&j.y+j.height>k.y&&j.x<=k.x&&j.x+j.width>k.x){k.x-=j.x;k.y-=j.y;if(j.onScroll){j.onScroll(k)}return false}}if(this.scroll){this.scroll()}};this.draw=function(j){if(!this.visible){return}j.fillStyle=this.backColor;var l;j.fillStyle=this.backColor;j.lineWidth=1;j.strokeStyle="#333";roundRect(j,this.parent.x+this.x,this.parent.y+this.y,this.itemWidth+e+6,this.visibleItems*this.itemHeight,3,true,true);j.fillStyle="grey";j.lineWidth=1;j.strokeStyle="#444";j.fillRect(this.parent.x+this.x+this.itemWidth+2+2,this.parent.y+this.y+2,e,this.visibleItems*this.itemHeight-2);j.fillStyle="red";j.lineWidth=1;j.strokeStyle="#444";this.scrollPosition=(this.visibleItems*this.itemHeight-2)*this.scrollOffset/this.controls.length;j.fillRect(this.parent.x+this.x+this.itemWidth+2+2+2,this.parent.y+this.y+2+(this.scrollPosition),e-2,5);var k=1;for(l=this.scrollOffset;l<Math.min(this.controls.length,this.scrollOffset+this.visibleItems);l++){this.controls[l].parent={x:this.parent.x+this.x,y:this.parent.y+this.y};this.controls[l].x=2;this.controls[l].y=k;this.controls[l].height=this.itemHeight;this.controls[l].width=this.itemWidth;k+=this.itemHeight;this.controls[l].draw(j)}};return this}function roundRect(a,g,h,f,c,d,b,e){if(typeof e=="undefined"){e=true}if(typeof d==="undefined"){d=5}a.beginPath();a.moveTo(g+d,h);a.lineTo(g+f-d,h);a.quadraticCurveTo(g+f,h,g+f,h+d);a.lineTo(g+f,h+c-d);a.quadraticCurveTo(g+f,h+c,g+f-d,h+c);a.lineTo(g+d,h+c);a.quadraticCurveTo(g,h+c,g,h+c-d);a.lineTo(g,h+d);a.quadraticCurveTo(g,h,g+d,h);a.closePath();if(e){a.stroke()}if(b){a.fill()}}function UIManager(u,m,s){this.UIAreas=[];this.messages=[];var w=this.textFont="18pt sans-serrif ";var c=this.buttonFont="13pt Arial bold";m.font=w;var g=this.indexes={tpIndex:0,modifyIndex:0,modifyTPIndex:0};this.dragger=new Dragger(function(x,y){u.windowLocation.x+=x;u.windowLocation.y+=y});this.draw=function(y){this.dragger.tick();y.save();var z=JSLINQ(this.UIAreas).OrderBy(function(C){return C.depth});for(var B=0;B<z.items.length;B++){var x=z.items[B];x.draw(y)}if(DEBUGs){for(var A=0;A<this.messages.length;A++){y.fillText(this.messages[A],10,25+A*30)}}y.restore()};this.onMouseScroll=function(z){var y=z.wheelDelta?z.wheelDelta/40:z.detail?-z.detail:0;for(var A=0;A<this.UIAreas.length;A++){var x=this.UIAreas[A];if(x.visible&&x.y<=z.y&&x.y+x.height>z.y&&x.x<=z.x&&x.x+x.width>z.x){z={x:z.x-x.x-10,y:z.y-x.y-10,delta:y};return x.scroll(z)}}return false};this.onClick=function(A){var y=_H.getCursorPosition(A);y.x-=10;y.y-=10;var C=null;var x;var D;var z=JSLINQ(this.UIAreas).OrderBy(function(E){return -E.depth});for(var D=0;D<z.items.length;D++){var x=z.items[D];if(x.visible&&x.y<=y.y&&x.y+x.height>y.y&&x.x<=y.x&&x.x+x.width>y.x){C=x;var B={x:y.x-x.x,y:y.y-x.y};x.click(B);break}}if(C){for(D=0;D<this.UIAreas.length;D++){x=this.UIAreas[D];if(C==x){x.depth=1}else{x.depth=0}}return true}this.dragger.click(A);return false};this.onMouseMove=function(A){var y=_H.getCursorPosition(A);y.x-=10;y.y-=10;var z=JSLINQ(this.UIAreas).OrderBy(function(C){return -C.depth});for(var B=0;B<z.items.length;B++){var x=z.items[B];if(x.dragging||(x.visible&&x.y<=y.y&&x.y+x.height>y.y&&x.x<=y.x&&x.x+x.width>y.x)){y={x:y.x-x.x,y:y.y-x.y};return x.mouseMove(y)}}this.dragger.mouseMove(A);return false};this.onMouseUp=function(z){var y=_H.getCursorPosition(z,true);y.x-=10;y.y-=10;for(var B=0;B<this.UIAreas.length;B++){var x=this.UIAreas[B];var A={x:y.x-x.x,y:y.y-x.y};x.mouseUp(A)}this.dragger.mouseUp(z)};var f=this.debuggerArea=new UiArea(1347,95,200,240,this,true);f.visible=false;this.UIAreas.push(f);f.addControl(new TextArea(30,25,"Debugger",w,"blue"));f.addControl(new Button(40,60,60,22,"Stop",c,"rgb(50,150,50)",function(){u.windowLocation=_H.defaultWindowLocation(1);f.visible=false;t.visible=false;h.visible=true;j.visible=true;u.sonicToon=null}));f.addControl(new Button(40,95,90,22,"Hit Sonic",c,"rgb(50,150,50)",function(){u.sonicToon.hit()}));f.addControl(new Button(40,130,160,22,"Show Height Map",c,"rgb(50,150,50)",function(){if(this.text=="Show Height Map"){u.showHeightMap=true;this.text="Hide Height Map"}else{u.showHeightMap=false;this.text="Show Height Map"}}));f.addControl(new Button(40,160,160,22,"Switch Height Map",c,"rgb(50,150,50)",function(){u.SonicLevel.curHeightMap=!u.SonicLevel.curHeightMap}));f.addControl(new Button(40,190,160,22,"Debug Sonic",c,"rgb(50,150,50)",function(){if(this.text=="Debug Sonic"){u.sonicToon.debugging=true;this.text="Normal Sonic"}else{u.sonicToon.debugging=false;this.text="Debug Sonic"}}));var t=this.solidTileArea=new UiArea(40,450,430,400,this,true);t.visible=false;this.UIAreas.push(t);t.addControl(new TextArea(30,25,"Modify Solid Tile",w,"blue"));t.addControl(new Button(50,35,25,22,"<<",c,"rgb(50,150,50)",function(){if(g.tpIndex>0){q.tilePiece=u.SonicLevel.Blocks[--g.tpIndex]}}));t.addControl(new Button(75,35,25,22,">>",c,"rgb(50,150,50)",function(){if(g.tpIndex<u.SonicLevel.Blocks.length){q.tilePiece=u.SonicLevel.Blocks[++g.tpIndex]}}));t.addControl(new Button(360,80,45,22,"Full",c,"rgb(50,150,50)",function(){for(var x=0;x<16;x++){q.tilePiece.heightMask.items[x]=16}this.sprites=[]}));t.addControl(new Button(200,35,180,22,"Modify Height Map",c,"rgb(50,150,50)",function(){q.state=(q.state+1)%3;switch(q.state){case 0:this.text="Modify Height Map";break;case 1:this.text="Modify Tile Direction";break;case 2:this.text="Modify Tile Colors";break}}));var q=this.modifyTilePieceArea=new TilePieceArea(30,70,{x:4*5,y:4*5},null,0);t.addControl(q);var b=this.bgEditor=new UiArea(100,440,420,360,this,true);b.visible=false;this.UIAreas.push(b);b.addControl(new TextArea(30,25,"BG Editor",w,"blue"));b.addControl(new TileBGEditArea(60,35));var h=this.levelInformation=new UiArea(70,70,470,360,this);h.visible=true;this.UIAreas.push(h);h.addControl(new TextArea(30,25,"Level Selector",w,"blue"));h.addControl(new TextArea(30,52,function(){return !e?"Level Not Saved":(e)},w,"black"));h.addControl(new Button(250,70,100,22,"Save Level",c,"rgb(50,150,50)",function(){if(e){OurSonic.SonicLevels.SaveLevelInformation(e,Base64.encode(_H.stringify(u.SonicLevel)),function(x){},function(x){alert("Failure: "+_H.stringify(x))})}else{OurSonic.SonicLevels.saveLevel(Base64.encode(_H.stringify(u.SonicLevel)),function(x){a(e)})}}));var v;h.addControl(v=new Button(250,105,160,22,"Load Empty Level",c,"rgb(50,150,50)",function(){j.visible=true;l.visible=true;var x=0;var y=function(){var z=188;if(x==z){setTimeout(function(){alert(_H.stringify(u.SonicLevel));k(_H.stringify(u.SonicLevel),m);l.visible=false},500);return}setTimeout(y,100);_H.loadSprite("assets/Chunks/Tile"+x+++".png",function(A){l.text="Loading "+x+"/"+z;u.importChunkFromImage(A);if(x==z){u.inds={done:true}}})};setTimeout(y,100)}));v.visible=false;var d;h.addControl(d=new ScrollBox(30,70,25,11,190,"rgb(50,60,127)"));var e;OurSonic.SonicLevels.getLevels(function(z){for(var x=0;x<z.length;x++){var y=z[x];a(y)}});function a(y){var x;d.addControl(x=new Button(0,0,0,0,y,"10pt Arial","rgb(50,190,90)",function(){e="Downloading";OurSonic.SonicLevels.getLevel(y,function(z){e="loading";e=y;k(z,m)})}))}var j=this.levelManagerArea=new UiArea(500,25,400,400,this);j.visible=false;this.UIAreas.push(j);j.addControl(new TextArea(30,25,"Level Manager",w,"blue"));var l;j.addControl(l=new TextArea(270,25,"Loading",w,"green"));l.visible=false;j.addControl(new Button(35,100,160,22,"Show Height Map",c,"rgb(50,150,50)",function(){if(this.text=="Show Height Map"){u.showHeightMap=true;this.text="Hide Height Map"}else{u.showHeightMap=false;this.text="Show Height Map"}}));j.addControl(new Button(200,150,160,22,"Place Chunks",c,"rgb(50,150,50)",function(){u.clickState=(u.clickState+1)%2;switch(u.clickState){case ClickState.PlaceChunk:this.text="Place Chunks";break;case ClickState.PlaceRing:this.text="Place Rings";break}}));j.addControl(new Button(200,180,160,22,"Switch Height Map",c,"rgb(50,150,50)",function(){u.SonicLevel.curHeightMap=!u.SonicLevel.curHeightMap}));j.addControl(new Button(35,150,160,22,"Modify Chunks",c,"rgb(50,150,50)",function(){p.visible=true}));j.addControl(new Button(35,150,160,22,"Modify Chunks",c,"rgb(50,150,50)",function(){p.visible=true}));j.addControl(new Button(35,175,160,22,"Modify Tile Pieces",c,"rgb(50,150,50)",function(){t.visible=true}));j.addControl(new Button(35,200,160,22,"Modify Tiles",c,"rgb(50,150,50)",function(){o.visible=true}));j.addControl(new Button(35,240,160,22,"Modify Background",c,"rgb(50,150,50)",function(){b.visible=true}));j.addControl(new Button(200,35,60,22,"Run",c,"rgb(50,150,50)",function(){j.visible=false;t.visible=false;h.visible=false;o.visible=false;p.visible=false;t.visible=false;f.visible=true;u.background.cache(u.scale);u.windowLocation=_H.defaultWindowLocation(0);u.sonicToon=new Sonic(u.SonicLevel,u.scale);u.sonicToon.obtainedRing=[]}));var p=this.modifyTileChunkArea=new UiArea(900,450,400,400,this,true);p.visible=false;this.UIAreas.push(p);p.addControl(new TextArea(30,25,"Modify Tile Chunk",w,"blue"));var n=this.modifyTC=new TileChunkArea(30,70,{x:2,y:2},null,1);p.addControl(n);p.addControl(new Button(50,35,25,22,"<<",c,"rgb(50,150,50)",function(){if(g.modifyIndex>0){n.tileChunk=u.SonicLevel.Chunks[--g.modifyIndex]}}));p.addControl(new Button(80,35,25,22,">>",c,"rgb(50,150,50)",function(){if(g.modifyIndex<u.SonicLevel.Chunks.length){n.tileChunk=u.SonicLevel.Chunks[++g.modifyIndex]}}));var r=this.modifyTP=new TilePieceArea(300,160,{x:2*3,y:2*3},null,3);p.addControl(r);p.addControl(new Button(300,100,25,22,"<<",c,"rgb(50,150,50)",function(){if(g.modifyTPIndex>0){r.tilePiece=n.setToTile=u.SonicLevel.Blocks[--g.modifyTPIndex]}}));p.addControl(new Button(330,100,25,22,">>",c,"rgb(50,150,50)",function(){if(g.modifyTPIndex<u.SonicLevel.Blocks.length){r.tilePiece=n.setToTile=u.SonicLevel.Blocks[++g.modifyTPIndex]}}));var o=this.modifyTileArea=new UiArea(900,25,400,400,this,true);o.visible=false;this.UIAreas.push(o);o.addControl(new TextArea(30,25,"Modify Tile",w,"blue"));function k(E,F){j.visible=true;u.loading=true;u.SonicLevel=jQuery.parseJSON(E);var x;var A;if(!u.SonicLevel.Chunks){u.SonicLevel.Chunks=[]}if(!u.SonicLevel.Blocks){u.SonicLevel.Blocks=[]}if(!u.SonicLevel.Tiles){u.SonicLevel.Tiles=[]}if(!u.SonicLevel.Rings){u.SonicLevel.Rings=[]}u.SonicLevel.LevelWidth=u.SonicLevel.ForegroundWidth;u.SonicLevel.LevelHeight=u.SonicLevel.ForegroundHeight;var G=decodeNumeric(u.SonicLevel.Foreground);u.SonicLevel.ChunkMap=[];u.SonicLevel.ChunkMap.length=u.SonicLevel.ForegroundWidth;for(var L=0;L<u.SonicLevel.ForegroundWidth;L++){u.SonicLevel.ChunkMap[L]=[];u.SonicLevel.ChunkMap[L].length=u.SonicLevel.ForegroundHeight;for(var M=0;M<u.SonicLevel.ForegroundHeight;M++){u.SonicLevel.ChunkMap[L][M]=G[L+M*u.SonicLevel.ForegroundWidth]}}var G=decodeNumeric(u.SonicLevel.Background);u.SonicLevel.BGChunkMap=[];u.SonicLevel.BGChunkMap.length=u.SonicLevel.BackgroundWidth;for(var L=0;L<u.SonicLevel.BackgroundWidth;L++){u.SonicLevel.BGChunkMap[L]=[];u.SonicLevel.BGChunkMap[L].length=u.SonicLevel.BackgroundHeight;for(var M=0;M<u.SonicLevel.BackgroundHeight;M++){u.SonicLevel.BGChunkMap[L][M]=G[L+M*u.SonicLevel.BackgroundWidth]}}for(var D=0;D<u.SonicLevel.Objects.length;D++){var J=u.SonicLevel.Objects[D];u.SonicLevel.Objects[D]=_H.ObjectParse(J)}u.SonicLevel.curHeightMap=true;for(A=0;A<u.SonicLevel.Tiles.length;A++){x=u.SonicLevel.Tiles[A];u.SonicLevel.Tiles[A]=decodeNumeric(x);var H=[];for(var D=0;D<u.SonicLevel.Tiles[A].length;D++){var O=u.SonicLevel.Tiles[A][D];H.push(O>>4);H.push(O&15)}u.SonicLevel.Tiles[A]={colors:H};var N=u.SonicLevel.Tiles[A];var G=[];G.length=8;for(var J=0;J<8;J++){G[J]=[];G[J].length=8}for(var I=0;I<N.colors.length;I++){G[I%8][_H.floor(I/8)]=N.colors[I]}N.colors=G;N.__proto__=Tile.prototype;N.index=A}for(A=0;A<u.SonicLevel.Blocks.length;A++){x=u.SonicLevel.Blocks[A];var H={};H.__proto__=TilePiece.prototype;H.index=A;H.tiles=[];for(var K=0;K<x.length;K++){H.tiles.push(x[K]);x[K].__proto__=TileItem.prototype}u.SonicLevel.Blocks[A]=H}var C;for(var z=0;z<u.SonicLevel.HeightMaps.length;z++){u.SonicLevel.HeightMaps[z]=new HeightMask(0,u.SonicLevel.HeightMaps[z])}u.SonicLevel.Angles=decodeNumeric(u.SonicLevel.Angles);u.SonicLevel.CollisionIndexes1=decodeNumeric(u.SonicLevel.CollisionIndexes1);u.SonicLevel.CollisionIndexes2=decodeNumeric(u.SonicLevel.CollisionIndexes2);var B;for(A=0;A<u.SonicLevel.Chunks.length;A++){x=u.SonicLevel.Chunks[A];var H={};H.__proto__=TileChunk.prototype;H.index=A;H.tilePieces=[];H.tilePieces.length=8;for(var z=0;z<8;z++){H.tilePieces[z]=[];H.tilePieces[z].length=8}for(var K=0;K<x.length;K++){H.tilePieces[K%8][_H.floor(K/8)]=(x[K])}u.SonicLevel.Chunks[A]=H}var y=function(){u.loading=false;n.tileChunk=u.SonicLevel.Chunks[0];q.tilePiece=r.tilePiece=u.SonicLevel.Blocks[0]};e="preloading sprites";u.preLoadSprites(s,function(){y();e="level loaded"},function(P){e=P})}}function Dragger(a){this.lastPos=null;this.xsp=0;this.ysp=0;this.lag=1;this.click=function(b){this.lastPos={x:b.x,y:b.y}};this.mouseUp=function(b){this.lastPos=null};this.mouseMove=function(b){if(!this.lastPos){return}this.xsp+=(this.lastPos.x-b.x)*0.4;this.ysp+=(this.lastPos.y-b.y)*0.4;this.xsp=(this.xsp>0?1:-1)*Math.min(Math.abs(this.xsp),30);this.ysp=(this.ysp>0?1:-1)*Math.min(Math.abs(this.ysp),30);this.lastPos={x:b.x,y:b.y}};this.tick=function(){a(this.xsp,this.ysp);if(this.xsp>0){this.xsp-=this.lag}else{this.xsp+=this.lag}if(this.ysp>0){this.ysp-=this.lag}else{this.ysp+=this.lag}if(Math.abs(this.xsp)<=this.lag){this.xsp=0}if(Math.abs(this.ysp)<=this.lag){this.ysp=0}}};