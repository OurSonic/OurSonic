function Editor(a){this.assetFrame=a;this.lineWidth=1;this.currentColor=0;this.showOutline=true;this.draw=function(b,c,d,e,f){this.assetFrame.drawUI(b,c,d,this.showOutline,e,f)};this.drawPixel=function(f){var d=_H.floor(this.lineWidth/2);if(this.lineWidth==1){this.assetFrame.colorMap[f.x][f.y]=this.currentColor}else{var e,b;for(e=-d;e<d;e++){for(b=-d;b<d;b++){this.assetFrame.colorMap[Math.min(Math.max(0,f.x+e),this.assetFrame.width)][Math.min(Math.max(0,f.y+b),this.assetFrame.height)]=this.currentColor}}}};this.drawLine=function(f,g){f={x:f.x,y:f.y};var b=Math.abs((g.x)-(f.x));var c=Math.abs((g.y)-(f.y));var h=1,j=1,d;var e=b-c;if(f.x>g.x){h=-1}if(f.y>g.y){j=-1}while(true){this.drawPixel(f);if(f.x==g.x&&f.y==g.y){break}d=e*2;if(d>-c){e-=c;f.x+=h}if(d<b){e+=b;f.y+=j}}}}function HeightMask(a){this.width=16;this.height=16;this.items=a?a:[];this.setItem=function(e,f,d){var b=0,c=0;switch(d){case RotationMode.Floor:b=e;c=f;break;case RotationMode.RightWall:b=f;c=e;break;case RotationMode.Ceiling:b=e;c=15-f;break;case RotationMode.LeftWall:b=f;c=15-e;break;default:}this.items[b]=16-c};this.drawUI=function(e,h,j,l,n,p,k,d){if(k>0){for(var m=0;m<16;m++){for(var o=0;o<16;o++){var f=0,g=0;if(n){if(p){f=15-m;g=15-o}else{f=15-m;g=o}}else{if(p){f=m;g=15-o}else{f=m;g=o}}var b=h.x+(f*j.x);var c=h.y+(g*j.y);e.lineWidth=1;if(l<=0&&_H.itemsGood(this.items,m,o,g)&&k>0){e.fillStyle=HeightMask.colors[k];e.fillRect(b,c,j.x,j.y)}else{if(l!=-1){e.lineWidth=1;e.strokeStyle="#0C3146";e.strokeRect(b,c,j.x,j.y)}}}}if(!(d==0||d==255||d==1)){if(n){if(p){d=192-d+192;d=128-d+128}else{d=128-d+128}}else{if(p){d=192-d+192}else{d=d}}}e.beginPath();e.lineWidth=4;e.strokeStyle="#03F3CA";e.moveTo(h.x+j.x*16/2,h.y+j.y*16/2);e.lineTo(h.x+j.x*16/2-_H.sin(d)*j.x*8,h.y+j.y*16/2-_H.cos(d)*j.x*8);e.stroke()}};this.draw=function(e,k,l,n,p,r,m,d){_H.save(e);var j={x:k.x,y:k.y};if(p){k.x=-k.x-16*l.x;e.scale(-1,1)}if(r){k.y=-k.y-16*l.y;e.scale(1,-1)}var f;if((f=sonicManager.SpriteCache.heightMaps[this.index])){if(f.loaded){e.drawImage(f,k.x,k.y)}}else{e.strokeStyle="#000000";e.strokeRect(k.x,k.y,l.x*16,l.y*16);if(m>0){for(var o=0;o<16;o++){for(var q=0;q<16;q++){var g=0,h=0;if(_H.itemsGood(this.items,o,q,h)){g=o;h=q;var b=k.x+(g*l.x);var c=k.y+(h*l.y);e.lineWidth=1;e.fillStyle=HeightMask.colors[m];e.fillRect(b,c,l.x,l.y)}}}e.beginPath();e.lineWidth=3;e.strokeStyle="rgba(163,241,255,0.8)";e.moveTo(k.x+l.x*16/2,k.y+l.y*16/2);e.lineTo(k.x+l.x*16/2-_H.sin(d)*l.x*8,k.y+l.y*16/2-_H.cos(d)*l.x*8);e.stroke();e.beginPath();e.fillStyle="rgba(163,241,255,0.8)";e.arc(k.x+l.x*16/2-_H.sin(d)*l.x*8,k.y+l.y*16/2-_H.cos(d)*l.x*8,5,0,2*Math.PI,true);e.fill()}}_H.restore(e);k.x=j.x;k.y=j.y}}HeightMask.colors=["rgba(24,98,235,0.6)","rgba(255,98,235,0.6)","rgba(24,218,235,0.6)","rgba(24,98,235,0.6)"];window._H={extend:function(c,a){for(var b in a){c[b]=a[b]}return c},save:function(a){if(window.StateCount==undefined){window.StateCount=0}window.StateCount++;a.save()},restore:function(a){window.StateCount--;a.restore()},decodeString:function(h){var j=h.indexOf("&");var k=h.substring(0,j);var b=parseInt(k);var e=h.substring(j+1,b+j);var a=e.split("&");var g=h.substring(b+j,h.length);for(var c=a.length-1;c>=0;c--){var f="&"+c;g=g.replaceAll(f,a[c])}return g},floor:function(a){if(a>0){return ~~a}return Math.floor(a)},min:function(a,b){return a>b?b:a},max:function(a,b){return a<b?b:a},xor:function(a,b){return(a&&!b)||(!a&&b)},loadSprite:function(c,a){var b=new Image();b.onload=function(){b.loaded=true;if(a){a(b)}};b.src=c;return b},fixAngle:function(a){var b=Math.floor((256-a)*1.4062)%360;var c=360-b;return _H.degtorad(c)},degtorad:function(a){return a*Math.PI/180},sign:function(a){return a==0?0:(a<0?-1:1)},getQueryString:function(){var d={},b=location.search.substring(1),c=/([^&=]+)=([^&]*)/g,a;while(a=c.exec(b)){d[decodeURIComponent(a[1])]=decodeURIComponent(a[2])}return d},negateColor:function(c){var f=parseInt(c.substring(0,2),16);var d=parseInt(c.substring(2,4),16);var a=parseInt(c.substring(4,6),16);var e=1;f=_H.floor((255-f)*e);d=_H.floor((255-d)*e);a=_H.floor((255-a)*e);return f.toString(16)+d.toString(16)+a.toString(16)},defaultWindowLocation:function(c,a,b){switch(c){case 0:return{x:0,y:0,width:320,height:240,intersects:_H.intersects};case 1:var d=0;var e=0;if(sonicManager.SonicLevel&&sonicManager.SonicLevel.StartPositions&&sonicManager.SonicLevel.StartPositions[0]){d=sonicManager.SonicLevel.StartPositions[0].X-128*2;e=sonicManager.SonicLevel.StartPositions[0].Y-128*2}return{x:d,y:e,width:a.canvas.width/b.x,height:a.canvas.height/b.y,intersects:_H.intersects}}return null},ObjectParse:function(a){a.upperNibble=function(){return this.SubType>>4};a.lowerNibble=function(){return this.SubType&15};return null;switch(a.ID){case 1:return new MonitorObject(a);case 2:return new CollisionSwitcherObject(a);case 7:return new SpringObject(a)}return new LevelObject(a)},itemsGood:function(a,c,d,b){if(a[c]<0){return Math.abs(a[c])>=d}return a[c]>=16-d},intersects:function(a){if(this.width==undefined||this.height==undefined||this.x==undefined||this.y==undefined||a.Y==undefined||a.X==undefined){alert("bad intersects")}if(this.x<a.X&&this.x+this.width>a.X&&this.y<a.Y&&this.y+this.height>a.Y){return true}return false},intersects2:function(b,a){if(b.width==undefined||b.height==undefined||b.x==undefined||b.y==undefined||a.Y==undefined||a.X==undefined){alert("bad intersects")}if(b.x<a.X&&b.x+b.width>a.X&&b.y<a.Y&&b.y+b.height>a.Y){return true}return false},defaultCanvas:function(d,c){var a=document.createElement("canvas");a.width=d;a.height=c;var b=a.getContext("2d");b.width=d;b.height=c;return{canvas:a,context:b}},intersectRect:function(a,b){return !(b.x>a.x+a.width||b.x+b.width<a.x||b.y>a.y+a.height||b.y+b.height<a.y)},remove:function(a,b){var c;while((c=a.indexOf(b))>-1){a.splice(c,1)}},getShortsFromInt:function(a,b){var c;while((c=a.indexOf(b))>-1){a.splice(c,1)}},scaleSprite:function(j,h,b){var e=_H.getImageData(j);var a=[];for(var g=0;g<e.length;g+=4){a.push(_H.colorObjectFromData(e,g))}var c=this.defaultCanvas().context.createImageData(j.width*h.x,j.height*h.y);_H.setDataFromColors(c.data,a,h,j.width,{r:0,g:0,b:0});return _H.loadSprite(_H.getBase64Image(c),b)},getCursorPosition:function(a){if(a.targetTouches&&a.targetTouches.length>0){a=a.targetTouches[0]}if(a.pageX!=null&&a.pageY!=null){return{x:a.pageX,y:a.pageY}}if(a.x!=null&&a.y!=null){return{x:a.x,y:a.y}}return{x:a.clientX,y:a.clientY}},colorFromData:function(j,h){var l=j[h];var k=j[h+1];var f=j[h+2];var e=l.toString(16);var d=k.toString(16);var a=f.toString(16);return"#"+(e.length==1?"0"+e:e)+(d.length==1?"0"+d:d)+(a.length==1?"0"+a:a)},colorObjectFromData:function(e,d){var h=e[d];var f=e[d+1];var a=e[d+2];return{r:h,g:f,b:a}},parseNumber:function(a){switch(a){case"0":return 0;case"1":return 1;case"2":return 2;case"3":return 3;case"4":return 4;case"5":return 5;case"6":return 6;case"7":return 7;case"8":return 8;case"9":return 9;case"a":return 10;case"b":return 11;case"c":return 12;case"d":return 13;case"e":return 14;case"f":return 15;case"g":return 16}return -1},setDataFromColors:function(f,b,p,r,q){for(var l=0;l<b.length;l++){var d=(l%r);var e=_H.floor(l/r);var h=b[l];var m=false;if(q){if(h.r==q.r&&h.g==q.g&&h.b==q.b){m=true}}for(var n=0;n<p.x;n++){for(var o=0;o<p.y;o++){var s=(d*p.x+n);var t=(e*p.y+o);var a=(s+t*(p.x*r))*4;if(m){f[a+0]=0;f[a+1]=0;f[a+2]=0;f[a+3]=0;continue}f[a]=h.r;f[a+1]=h.g;f[a+2]=h.b;f[a+3]=255}}}},getImageData:function(d){var a=document.createElement("canvas");a.width=d.width;a.height=d.height;var b=a.getContext("2d");b.drawImage(d,0,0);var c=b.getImageData(0,0,d.width,d.height);return c.data},getBase64Image:function(c){var a=document.createElement("canvas");a.width=c.width;a.height=c.height;var b=a.getContext("2d");b.putImageData(c,0,0);var d=a.toDataURL("image/png");return d},isFunction:function(a){var b={};return a&&b.toString.call(a)=="[object Function]"},detect:function(c,a){for(var b in c){if(typeof(c[b])=="object"){if(a[c[b]]){alert("circ")}a[c[b]]=true;this.detect(c[b],a)}}},stringify:function(a){return JSON.stringify(a,function(b,c){if(b=="imageData"){return undefined}if(b=="oldScale"){return undefined}if(b=="sprite"){return undefined}if(b=="sprites"){return undefined}if(b=="index"){return undefined}if(b=="_style"){return undefined}else{return c}})},sin:function(a){return cos_table[(a+64)&255]},cos:function(a){return cos_table[(a)&255]},getName:function(b){var a=/function (.{1,})\(/;var c=(a).exec((b).constructor.toString());return(c&&c.length>1)?c[1]:""}};window.cos_table=[1,0.9997,0.9988,0.99729,0.99518,0.99248,0.98918,0.98528,0.9807900000000001,0.9757,0.97003,0.96378,0.95694,0.94953,0.94154,0.93299,0.92388,0.91421,0.90399,0.89322,0.88192,0.87009,0.85773,0.84485,0.83147,0.81758,0.80321,0.78835,0.77301,0.7572100000000001,0.74095,0.72425,0.70711,0.68954,0.6715600000000001,0.65317,0.63439,0.6152300000000001,0.5957,0.57581,0.55557,0.535,0.5141,0.4929,0.4714,0.44961,0.42755,0.40524,0.38268,0.3599,0.33689,0.31368,0.29028,0.26671,0.24298,0.2191,0.19509,0.17096,0.14673,0.12241,0.09802,0.07356,0.04907,0.02454,0,-0.02454,-0.04907,-0.07356,-0.09802,-0.12241,-0.14673,-0.17096,-0.19509,-0.2191,-0.24298,-0.26671,-0.29028,-0.31368,-0.33689,-0.3599,-0.38268,-0.40524,-0.42755,-0.44961,-0.4714,-0.4929,-0.5141,-0.535,-0.55557,-0.57581,-0.5957,-0.6152300000000001,-0.63439,-0.65317,-0.6715600000000001,-0.68954,-0.70711,-0.72425,-0.74095,-0.7572100000000001,-0.77301,-0.78835,-0.80321,-0.81758,-0.83147,-0.84485,-0.85773,-0.87009,-0.88192,-0.89322,-0.90399,-0.91421,-0.92388,-0.93299,-0.94154,-0.94953,-0.95694,-0.96378,-0.97003,-0.9757,-0.9807900000000001,-0.98528,-0.98918,-0.99248,-0.99518,-0.99729,-0.9988,-0.9997,-1,-0.9997,-0.9988,-0.99729,-0.99518,-0.99248,-0.98918,-0.98528,-0.9807900000000001,-0.9757,-0.97003,-0.96378,-0.95694,-0.94953,-0.94154,-0.93299,-0.92388,-0.91421,-0.90399,-0.89322,-0.88192,-0.87009,-0.85773,-0.84485,-0.83147,-0.81758,-0.80321,-0.78835,-0.77301,-0.7572100000000001,-0.74095,-0.72425,-0.70711,-0.68954,-0.6715600000000001,-0.65317,-0.63439,-0.6152300000000001,-0.5957,-0.57581,-0.55557,-0.535,-0.5141,-0.4929,-0.4714,-0.44961,-0.42756,-0.40524,-0.38268,-0.3599,-0.33689,-0.31368,-0.29028,-0.26671,-0.24298,-0.2191,-0.19509,-0.17096,-0.14673,-0.12241,-0.09802,-0.07356,-0.04907,-0.02454,-0,0.02454,0.04907,0.07356,0.09802,0.12241,0.14673,0.17096,0.19509,0.2191,0.24298,0.26671,0.29028,0.31368,0.33689,0.3599,0.38268,0.40524,0.42756,0.44961,0.4714,0.4929,0.5141,0.535,0.55557,0.57581,0.5957,0.6152300000000001,0.63439,0.65317,0.6715600000000001,0.68954,0.70711,0.72425,0.74095,0.7572100000000001,0.77301,0.78835,0.80321,0.81758,0.83147,0.84485,0.85773,0.87009,0.88192,0.89322,0.90399,0.91421,0.92388,0.93299,0.94154,0.94953,0.95694,0.96378,0.97003,0.9757,0.9807900000000001,0.98528,0.98918,0.99248,0.99518,0.99729,0.9988,0.9997];var base64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");var base64inv={};for(var i=0;i<base64chars.length;i++){base64inv[base64chars[i]]=i}window.decodeNumeric=function(f){f=f.replace(new RegExp("[^"+base64chars.join("")+"=]","g"),"");var d=(f.charAt(f.length-1)=="="?(f.charAt(f.length-2)=="="?"AA":"A"):"");var e=[];f=f.substr(0,f.length-d.length)+d;for(var a=0;a<f.length;a+=4){var b=(base64inv[f.charAt(a)]<<18)+(base64inv[f.charAt(a+1)]<<12)+(base64inv[f.charAt(a+2)]<<6)+base64inv[f.charAt(a+3)];e.push((b>>>16)&255);e.push((b>>>8)&255);e.push(b&255)}return e.slice(0,e.length-1)};window.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(j){var k="";var a,b,c,d,e,f,g;var h=0;j=Base64._utf8_encode(j);while(h<j.length){a=j.charCodeAt(h++);b=j.charCodeAt(h++);c=j.charCodeAt(h++);d=a>>2;e=((a&3)<<4)|(b>>4);f=((b&15)<<2)|(c>>6);g=c&63;if(isNaN(b)){f=g=64}else{if(isNaN(c)){g=64}}k=k+this._keyStr.charAt(d)+this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)}return k},decode:function(j){var k="";var a,b,c;var d,e,f,g;var h=0;j=j.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(h<j.length){d=this._keyStr.indexOf(j.charAt(h++));e=this._keyStr.indexOf(j.charAt(h++));f=this._keyStr.indexOf(j.charAt(h++));g=this._keyStr.indexOf(j.charAt(h++));a=(d<<2)|(e>>4);b=((e&15)<<4)|(f>>2);c=((f&3)<<6)|g;k=k+String.fromCharCode(a);if(f!=64){k=k+String.fromCharCode(b)}if(g!=64){k=k+String.fromCharCode(c)}}k=Base64._utf8_decode(k);return k},_utf8_encode:function(d){d=d.replace(/\r\n/g,"\n");var e="";for(var b=0;b<d.length;b++){var a=d.charCodeAt(b);if(a<128){e+=String.fromCharCode(a)}else{if((a>127)&&(a<2048)){e+=String.fromCharCode((a>>6)|192);e+=String.fromCharCode((a&63)|128)}else{e+=String.fromCharCode((a>>12)|224);e+=String.fromCharCode(((a>>6)&63)|128);e+=String.fromCharCode((a&63)|128)}}}return e},_utf8_decode:function(g){var f="";var e=0;var a,b,d;while(e<g.length){a=g.charCodeAt(e);if(a<128){f+=String.fromCharCode(a);e++}else{if((a>191)&&(a<224)){b=g.charCodeAt(e+1);f+=String.fromCharCode(((a&31)<<6)|(b&63));e+=2}else{b=g.charCodeAt(e+1);d=g.charCodeAt(e+2);f+=String.fromCharCode(((a&15)<<12)|((b&63)<<6)|(d&63));e+=3}}}return f}};String.prototype.replaceAll=function(b,c,a){return this.replace(new RegExp(b.replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g,"\\$&"),(a?"gi":"g")),(typeof(c)=="string")?c.replace(/\$/g,"$$$$"):c)};var broken=_H.loadSprite("assets/Sprites/broken.png");function LevelObject(a){this.ObjectData=a;this.sprites=[];this.Width=30;this.Height=30;this.getRect=function(){var d=this.ObjectData.X-monitor.width/2;var e=this.ObjectData.Y-monitor.height/2;var c=this.Width;var b=this.Height;return{x:d,y:e,width:c,height:b}};this.collide=function(){};this.draw=function(b,c,d){if(this.sprites[0]&&this.sprites[0].loaded){b.drawImage(this.sprites[0],(c.x-this.sprites[0].width/2)*d.x,(c.y-this.sprites[0].height/2)*d.y,this.sprites[0].width*d.x,this.sprites[0].height*d.y)}else{b.drawImage(broken,(c.x-broken.width/2)*d.x,(c.y-broken.height/2)*d.y,broken.width*d.x,broken.height*d.y)}}}var monitor=_H.loadSprite("assets/Sprites/monitorEmpty.png");var monitorBroken=_H.loadSprite("assets/Sprites/monitorBroken.png");function CollisionSwitcherObject(a){this.ObjectData=a;this.sprites=[];this.Width=10;this.Height=70;this.getRect=function(){var b=this.ObjectData.X-this.Width/2;var c=this.ObjectData.Y-this.Height/2;return{x:b,y:c,width:this.Width,height:this.Height}};this.collide=function(){if(sonicManager.sonicToon.xsp>0){sonicManager.SonicLevel.curHeightMap=true}else{sonicManager.SonicLevel.curHeightMap=false}};this.draw=function(b,c,d){if(sonicManager.showHeightMap){b.fillStyle="#FFFFFF";b.fillRect((this.ObjectData.X-5-sonicManager.windowLocation.x)*d.x,(this.ObjectData.Y-50-sonicManager.windowLocation.y)*d.y,10*d.x,100*d.y)}}}function MonitorObject(b){this.ObjectData=b;this.sprites=[];var a="assets/Sprites/monitor";switch(this.ObjectData.SubType){case 1:this.sprites.push(_H.loadSprite(a+"SonicOneUp.png"));break;case 2:this.sprites.push(_H.loadSprite(a+"Death.png"));break;case 3:this.sprites.push(_H.loadSprite(a+"Ring.png"));break;case 4:this.sprites.push(_H.loadSprite(a+"SpeedShoe.png"));break;case 5:this.sprites.push(_H.loadSprite(a+"Flame.png"));break;case 6:this.sprites.push(_H.loadSprite(a+"Electric.png"));break;case 7:this.sprites.push(_H.loadSprite(a+"Bubble.png"));break;case 8:this.sprites.push(_H.loadSprite(a+"Stars.png"));break}this.getRect=function(){var c=this.ObjectData.X-monitor.width/2;var d=this.ObjectData.Y-monitor.height/2;return{x:c,y:d,width:monitor.width,height:monitor.height}};this.collide=function(){if(sonicManager.sonicToon.ysp==0){sonicManager.sonicToon.gsp=0;sonicManager.sonicToon.xsp=0;return}if(this.ObjectData.SubType==10){return}switch(this.ObjectData.SubType){case 1:sonicManager.sonicToon.Lives=1;break;case 2:sonicManager.sonicToon.hit();break;case 3:sonicManager.sonicToon.rings+=10;break;case 4:sonicManager.sonicToon.rings+=20;break;case 5:sonicManager.sonicToon.rings+=30;break;case 6:sonicManager.sonicToon.rings+=40;break;case 7:sonicManager.sonicToon.rings+=50;break;case 8:sonicManager.sonicToon.rings+=60;break}if(sonicManager.sonicToon.ysp>0){sonicManager.sonicToon.ysp*=-1}else{sonicManager.sonicToon.ysp*=1}this.ObjectData.SubType=10};this.draw=function(c,d,e){if(this.sprites[0]&&this.sprites[0].loaded){if(this.ObjectData.SubType==10){c.drawImage(monitorBroken,(d.x-monitorBroken.width/2)*e.x,(d.y)*e.y,monitorBroken.width*e.x,monitorBroken.height*e.y)}else{c.drawImage(monitor,(d.x-monitor.width/2)*e.x,(d.y-monitor.height/2)*e.y,monitor.width*e.x,monitor.height*e.y);if(sonicManager.sonicToon){if(!(sonicManager.drawTickCount%6==0||sonicManager.drawTickCount%6==1)){c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}else{c.drawImage(this.sprites[0],((d.x-monitor.width/2)+6)*e.x,((d.y-monitor.height/2)+3)*e.y,this.sprites[0].width*e.x,this.sprites[0].height*e.y)}}}}}SpringType={Yellow:0,Red:1};FacingType={Yellow:0,Red:1};function SpringObject(c){this.ObjectData=c;this.sprites=[];this.facing=0;this.xflip=false;this.yflip=false;this.type=SpringType.Yellow;var b="assets/Sprites/spring";switch(this.ObjectData.lowerNibble()){case 0:this.type=SpringType.Yellow;b+="yellow";break;case 2:this.type=SpringType.Red;b+="red";break;default:this.type=SpringType.Red;b+="red";break}switch(this.ObjectData.upperNibble()){case 0:break;case 1:this.sideways=true;break;case 2:this.yflip=true;break;case 3:break;case 4:break}var a;this.sprites.push(a=_H.loadSprite(b+"closed.png"));this.getRect=function(){var d=this.ObjectData.X-a.width/2;var e=this.ObjectData.Y-a.height/2;return{x:d,y:e,width:a.width,height:a.height}};this.collide=function(){var d;switch(this.type){case SpringType.Red:d=16;break;case SpringType.Yellow:d=10;break}if(this.sideways){if(this.xflip){sonicManager.sonicToon.xsp=d}else{sonicManager.sonicToon.xsp=-d}}else{if(this.yflip){sonicManager.sonicToon.ysp=d}else{sonicManager.sonicToon.ysp=-d}}};this.draw=function(d,e,f){if(this.sprites[0]&&this.sprites[0].loaded){d.drawImage(this.sprites[0],(e.x-this.sprites[0].width/2)*f.x,(e.y)*f.y,this.sprites[0].width*f.x,this.sprites[0].height*f.y)}}}(function(){JSLINQ=window.JSLINQ=function(a){return new JSLINQ.fn.init(a)};JSLINQ.fn=JSLINQ.prototype={init:function(a){this.items=a},jslinq:"2.10",ToArray:function(){return this.items},Where:function(a){var c;var d=new Array();for(var b=0;b<this.items.length;b++){if(a(this.items[b],b)){d[d.length]=this.items[b]}}return new JSLINQ(d)},Select:function(a){var c;var d=new Array();for(var b=0;b<this.items.length;b++){if(a(this.items[b])){d[d.length]=a(this.items[b])}}return new JSLINQ(d)},OrderBy:function(a){var c=new Array();for(var b=0;b<this.items.length;b++){c[c.length]=this.items[b]}return new JSLINQ(c.sort(function(d,e){var f=a(d);var g=a(e);return((f<g)?-1:((f>g)?1:0))}))},OrderByDescending:function(a){var c=new Array();for(var b=0;b<this.items.length;b++){c[c.length]=this.items[b]}return new JSLINQ(c.sort(function(d,e){var f=a(e);var g=a(d);return((f<g)?-1:((f>g)?1:0))}))},SelectMany:function(a){var c=new Array();for(var b=0;b<this.items.length;b++){c=c.concat(a(this.items[b]))}return new JSLINQ(c)},Count:function(a){if(a==null){return this.items.length}else{return this.Where(a).items.length}},Distinct:function(a){var d;var b=new Object();var e=new Array();for(var c=0;c<this.items.length;c++){d=a(this.items[c]);if(b[d]==null){b[d]=true;e[e.length]=d}}b=null;return new JSLINQ(e)},Any:function(a){for(var b=0;b<this.items.length;b++){if(a(this.items[b],b)){return true}}return false},All:function(a){for(var b=0;b<this.items.length;b++){if(!a(this.items[b],b)){return false}}return true},Reverse:function(){var b=new Array();for(var a=this.items.length-1;a>-1;a--){b[b.length]=this.items[a]}return new JSLINQ(b)},First:function(a){if(a!=null){return this.Where(a).First()}else{if(this.items.length>0){return this.items[0]}else{return null}}},Last:function(a){if(a!=null){return this.Where(a).Last()}else{if(this.items.length>0){return this.items[this.items.length-1]}else{return null}}},ElementAt:function(a){return this.items[a]},Concat:function(b){var a=b.items||b;return new JSLINQ(this.items.concat(a))},Intersect:function(j,e){var f;if(e!=undefined){f=e}else{f=function(k,a,l,b){return k==l}}var h=j.items||j;var g=new Array();for(var c=0;c<this.items.length;c++){for(var d=0;d<h.length;d++){if(f(this.items[c],c,h[d],d)){g[g.length]=this.items[c]}}}return new JSLINQ(g)},DefaultIfEmpty:function(a){if(this.items.length==0){return a}return this},ElementAtOrDefault:function(b,a){if(b>=0&&b<this.items.length){return this.items[b]}return a},FirstOrDefault:function(a){return this.First()||a},LastOrDefault:function(a){return this.Last()||a}};JSLINQ.fn.init.prototype=JSLINQ.fn})();jQuery.fn.rotate=function(a,h){var e=this.get(0);if(!h){e.angle=((e.angle==undefined?0:e.angle)+a)%360}else{e.angle=a}if(e.angle>=0){var f=Math.PI*e.angle/180}else{var f=Math.PI*(360+e.angle)/180}var d=Math.cos(f);var g=Math.sin(f);if(document.all&&!window.opera){var b=document.createElement("img");b.src=e.src;b.height=e.height;b.width=e.width;b.style.filter="progid:DXImageTransform.Microsoft.Matrix(M11="+d+",M12="+(-g)+",M21="+g+",M22="+d+",SizingMethod='auto expand')"}else{var b=document.createElement("canvas");if(!e.oImage){b.oImage=new Image();b.oImage.src=e.src}else{b.oImage=e.oImage}b.style.width=b.width=Math.abs(d*b.oImage.width)+Math.abs(g*b.oImage.height);b.style.height=b.height=Math.abs(d*b.oImage.height)+Math.abs(g*b.oImage.width);var c=b.getContext("2d");_H.save(c);if(f<=Math.PI/2){c.translate(g*b.oImage.height,0)}else{if(f<=Math.PI){c.translate(b.width,-d*b.oImage.height)}else{if(f<=1.5*Math.PI){c.translate(-d*b.oImage.width,b.height)}else{c.translate(0,-g*b.oImage.width)}}}c.rotate(f);c.drawImage(b.oImage,0,0,b.oImage.width,b.oImage.height);_H.restore(c)}b.id=e.id;b.angle=e.angle;e.parentNode.replaceChild(b,e)};jQuery.fn.rotateRight=function(a){this.rotate(a==undefined?90:a)};jQuery.fn.rotateLeft=function(a){this.rotate(a==undefined?-90:-a)};function ObjectManager(a){this.sonicManager=a;window.objectManager=this;this.metaObjectFrameworks=[];this.objectFrameworks=[];this.init=function(){}}function LevelObject(a){this.assets=[];this.key=a?a:"";this.pieces=[];this.paths=[];this.projectiles=[];this.initScript="";this.tickScript="";this.collideScript="";this.hurtScript="";this.init=function(b,c){};this.tick=function(b,c){};this.onCollide=function(b,c){};this.onHurtSonic=function(b,d,c){}}function LevelObjectAsset(a){this.frames=[];this.name=a?a:""}function LevelObjectAssetFrame(d){this.offsetX=0;this.width=0;this.height=0;this.offsetY=0;this.hurtSonicMap=[];this.collisionMap=[];for(var c=0;c<100;c++){this.collisionMap[c]=[];this.hurtSonicMap[c]=[];for(var b=0;b<100;b++){this.collisionMap[c][b]=Math.random()*100<50;this.hurtSonicMap[c][b]=Math.random()*100<50}}this.colorMap=[];this.palette=[];this.name=d?d:"";this.drawUI=function(a,h,j,m,k,l){a.strokeStyle="#000000";a.lineWidth=1;for(var n=0;n<this.colorMap.length;n++){for(var o=0;o<this.colorMap[n].length;o++){var f=n;var g=o;var e=this.palette[this.colorMap[f][g]];if(a.fillStyle!="#"+e){a.fillStyle="#"+e}a.fillRect(h.x+f*j.x,h.y+g*j.y,j.x,j.y);if(m){a.strokeRect(h.x+f*j.x,h.y+g*j.y,j.x,j.y)}if(k){if(this.hurtSonicMap[f][g]){a.fillStyle="rgba(30,34,255,0.6)";a.fillRect(h.x+f*j.x,h.y+g*j.y,j.x,j.y)}}if(l){if(this.collisionMap[f][g]){a.fillStyle="rgba(211,12,55,0.6)";a.fillRect(h.x+f*j.x,h.y+g*j.y,j.x,j.y)}}}}a.beginPath();a.moveTo(h.x+this.offsetX*j.x,h.y+0);a.lineTo(h.x+this.offsetX*j.x,h.y+this.height*j.y);a.lineWidth=3;a.strokeStyle="#000000";a.stroke();a.beginPath();a.moveTo(h.x+0,h.y+this.offsetY*j.y);a.lineTo(h.x+this.width*j.x,h.y+this.offsetY*j.y);a.lineWidth=3;a.strokeStyle="#000000";a.stroke()};this.draw=function(a,e,f){}}function LevelObjectPiece(a){this.assetIndex=0;this.frameIndex=0;this.collided=false;this.xflip=false;this.yflip=false;this.name=a?a:""}function LevelObjectPath(a){this.pieces=[];this.name=a?a:""}function LevelObjectInfo(){this.x=0;this.y=0;this.xsp=0;this.ysp=0;this.xflip=0;this.yflip=0;this.subdata=undefined;this.key=undefined}function LevelProjectile(a){this.x=0;this.y=0;this.xsp=0;this.ysp=0;this.xflip=0;this.yflip=0;this.subdata=undefined;this.assets=[];this.name=a?a:"";this.init=function(b,c){};this.tick=function(b,c){};this.onCollide=function(b,c){};this.onHurtSonic=function(b,d,c){}}function LevelEvent(){this.triggered=false;this.state={};this.tick=function(a,b){};this.trigger=function(a){this.state=a}}function ParallaxBG(a,c){var d=this;var b=a;this.click=function(e,f){this.slots[f].rotateSpeed=e/this.width*2};this.onBar=function(j,k){var h=3*c.x;var e=this.slots[k].rotateSpeed;if(j>((this.width*e/2)-h)&&j<((this.width*e/2)+h)){var g={top:0,bottom:0};for(var f=k-1;f>=0;f--){if(this.slots[f].rotateSpeed!=e){g.top=f;break}}for(var f=k+1;f<this.height;f++){if(this.slots[f].rotateSpeed!=e){g.bottom=f;break}}return g}return null};this.cache=function(n){var p=(this.width*n.x);var f=sonicManager.windowLocation.height*n.y;var o=[];var e=_H.defaultCanvas();var k=this.slots[0].rotateSpeed;var j=0;var m={x:0,y:0};for(var g=0;g<this.slots.length;g++){if(k!=this.slots[g].rotateSpeed){k=this.slots[g].rotateSpeed;o[j]=(_H.loadSprite(e.canvas.toDataURL("image/png")));e=_H.defaultCanvas();j=g}var l={x:m.x,y:m.y+(g-j)*n.y};this.slots[g].draw(e.context,l,n)}o[j]=(_H.loadSprite(e.canvas.toDataURL("image/png")));this.sprites=o};this.init=function(m){var n=this.width;var e=this.height;this.slots=[];for(var o=0;o<e;o++){this.slots[o]=new ParallaxBGSlot()}var k=_H.defaultCanvas(n,e);var g=_H.defaultCanvas(n,1);k.context.drawImage(this.sprite,0,0);for(var f=0;f<e;f++){var l=k.context.getImageData(0,f,n,1);g.context.putImageData(l,0,0);this.slots[f].sprite=(_H.loadSprite(g.canvas.toDataURL("image/png")))}for(var o=0;o<e;o++){this.slots[o].load(m)}};this.drawUI=function(e,j,l){if(this.sprite&&this.sprite.loaded){e.drawImage(this.sprite,j.x,j.y)}if(this.slots){var g=this.slots[0].rotateSpeed;var h=0;for(var f=0;f<this.slots.length;f++){if(g==this.slots[f].rotateSpeed){continue}var k=Math.floor(255/2/g);e.fillStyle="rgba("+k+",57,43,0.4)";e.fillRect(j.x,j.y+h*l.y,this.width*l.x,l.y*(f-h));e.strokeStyle="rgba("+k+",57,43,1)";e.lineWidth=3;e.strokeRect(j.x,j.y+h*l.y,this.width*l.x,l.y*(f-h));var m=3*l.x;e.fillRect(j.x+(this.width*g/2)-m,j.y+h*l.y,m*2,l.y*(f-h));h=f;g=this.slots[f].rotateSpeed}var k=Math.floor(255/2/g);e.fillStyle="rgba("+k+",57,43,0.4)";e.fillRect(j.x,j.y+h*l.y,this.width*l.x,l.y*(f-h));e.strokeStyle="rgba("+k+",57,43,1)";e.lineWidth=3;e.strokeRect(j.x,j.y+h*l.y,this.width*l.x,l.y*(f-h));var m=3*l.x;e.fillStyle="rgba("+k+",57,43,1)";e.fillRect(j.x+(this.width*g/2)-m,j.y+h*l.y,m*2,l.y*(f-h))}};this.draw=function(e,l,m,j){var n=(this.width*m.x);var f=sonicManager.windowLocation.height*m.y;for(var g in this.sprites){var k={x:l.x+(Math.floor(j*this.slots[g].rotateSpeed)),y:l.y+g*m.y};if(k.y>sonicManager.windowLocation.y*m.y||k.y<f+sonicManager.windowLocation.y*m.y){if(k.x>sonicManager.windowLocation.width||k.x+n<0){continue}if(this.sprite&&this.sprite.loaded){e.drawImage(this.sprite,k.x,k.y,this.sprite.width,this.sprite.height)}}}};d.width=b.width;d.height=b.height;d.sprite=b;d.sprite.loaded=true;d.init(c)}function ParallaxBGSlot(){this.sprite=null;this.rotateSpeed=1;this.draw=function(a,b,c){if(this.sprite&&this.sprite.loaded){a.drawImage(this.sprite,b.x,b.y,this.sprite.width,this.sprite.height)}};this.drawUI=function(a,b,c){if(this.sprite&&this.sprite.loaded){a.drawImage(this.sprite,b.x,b.y,this.sprite.width,this.sprite.height)}};this.load=function(a){}}function Ring(a){this.active=a;this.animationIndex=0;this.x=0;this.y=0;this.xsp=0;this.ysp=0;this.tickCount=0;this.draw=function(b,c,d){if(a){this.ysp+=0.09375;this.x+=this.xsp;this.y+=this.ysp;if(this.x<sonicManager.windowLocation.x||this.y<sonicManager.windowLocation.y||this.x>sonicManager.windowLocation.x+sonicManager.windowLocation.width||this.y>sonicManager.windowLocation.y+sonicManager.windowLocation.height){this.tickCount=4294967295;return false}if(sonicManager.sonicToon.checkCollisionLine(_H.floor(this.x)+8,_H.floor(this.y)+8,16,1)!=-1){this.ysp*=-0.75}if(sonicManager.sonicToon.checkCollisionLine(_H.floor(this.x)-8,_H.floor(this.y)+8,26,0)!=-1){this.xsp*=-0.75}if(sonicManager.drawTickCount>sonicManager.sonicToon.sonicLastHitTick+64&&_H.intersectRect(sonicManager.sonicToon.myRec,{x:this.x-8*d.x,width:8*2*d.x,y:this.y-8*d.y,height:2*8*d.y})){this.tickCount=4294967295;sonicManager.sonicToon.rings++;return false}this.tickCount++}if(sonicManager.sonicToon){this.animationIndex=_H.floor((sonicManager.drawTickCount%((a?4:8)*4))/(a?4:8))}else{this.animationIndex=0}var e;if(sonicManager.SpriteCache.rings){e=sonicManager.SpriteCache.rings}else{return}var f=e[this.animationIndex*200+d.y*100+d.x];if(!f){return}if(f.loaded){b.drawImage(f,_H.floor((c.x-8)*d.x),_H.floor((c.y-8)*d.y))}else{return false}}}Sensor=function(d,e,f,g,c,a,b){this.x1=d;this.y1=f;this.x2=e;this.y2=g;this.color=a;this.manager=c;this.check=function(h){var j;var k=_H.floor(h.x);var l=_H.floor(h.y);switch(h.mode){case RotationMode.Floor:j=this.checkCollisionLineWrap(k+this.x1,k+this.x2,l+this.y1,l+this.y2,b);break;case RotationMode.LeftWall:j=this.checkCollisionLineWrap(k-this.y1,k-this.y2,l+this.x1,l+this.x2,b);break;case RotationMode.Ceiling:j=this.checkCollisionLineWrap(k-this.x1,k-this.x2,l-this.y1,l-this.y2,b);break;case RotationMode.RightWall:j=this.checkCollisionLineWrap(k+this.y1,k+this.y2,l-this.x1,l-this.x2,b);break}if(j!=-1){if(j.angle==255||j.angle==0||j.angle==1){if(h.mode==RotationMode.Floor){j.angle=255}if(h.mode==RotationMode.LeftWall){j.angle=64}if(h.mode==RotationMode.Ceiling){j.angle=128}if(h.mode==RotationMode.RightWall){j.angle=192}}}return j};this.checkCollisionLineWrap=function(t,u,v,w,q){var k=_H.floor(t/128);var l=_H.floor(v/128);var s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[k][l]];var o=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;var m=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;var h=t-k*128;var j=v-l*128;var p;var n=0;var r;if(v==w){if(Math.max(t,u)>sonicManager.SonicLevel.LevelWidth*128){return{value:sonicManager.SonicLevel.LevelWidth*128-20,angle:255}}if(t<u){r=u-t;if(o[(h)][j]>=2){for(p=0;p<128*10;p++){if(h-p<0){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[k-1][l]];o=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;m=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;h+=128}if(t-p>this.LevelWidth||o[(h-p)][j]>=2){return{value:t-p,angle:m[_H.floor((h-p)/16)][_H.floor((j)/16)]}}}}for(p=0;p<r;p++){if(h+p>=128){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[k+1][l]];o=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;m=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;h-=128}if(t+p>this.LevelWidth||o[(h+p)][j]>=2){return{value:t+p,angle:m[_H.floor((h+p)/16)][_H.floor((j)/16)]}}}}else{r=t-u;if(o[(h)][j]>=2){for(p=0;p<128*10;p++){if(h+p>=128){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[k+1][l]];o=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;m=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;h-=128}if(t+p>this.LevelWidth||o[(h+p)][j]>=2){return{value:t+p,angle:m[_H.floor((h+p)/16)][_H.floor((j)/16)]}}}}for(p=0;p<r;p++){if(h-p<0){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[k-1][l]];o=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;m=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;h+=128}if(t-p>this.LevelWidth||o[(h-p)][j]>=2){return{value:t-p,angle:m[_H.floor((h-p)/16)][_H.floor((j)/16)]}}}}}else{if(Math.max(v,w)>sonicManager.SonicLevel.LevelHeight*128){return{value:sonicManager.SonicLevel.LevelHeight*128-20,angle:255}}if(v<w){r=w-v;if(o[(h)][j]>=2){for(p=0;p<128*10;p++){if(j-p<0){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[k][(l-1)]];o=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;m=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;j+=128}if(o[h][j-p]>1){return{value:v-p,angle:m[_H.floor((h)/16)][_H.floor((j-p)/16)]}}}}for(p=0;p<r;p++){if(j+p>=128){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[k][(l+1)]];o=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;m=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;j-=128}if(o[h][j+p]>=1){if(o[h][j+p]==1&&sonicManager.sonicToon.inAir&&sonicManager.sonicToon.ysp<0){continue}return{value:v+p,angle:m[_H.floor((h)/16)][_H.floor((j+p)/16)]}}}}else{r=v-w;if(o[(h)][j]>=2){for(p=0;p<128*10;p++){if(j+p>=128){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[k][(l+1)]];o=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;m=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;j-=128}if(o[h][j+p]>=1){return{value:v+p,angle:m[_H.floor((h)/16)][_H.floor((j+p)/16)]}}}}for(p=0;p<r;p++){if(j-p<0){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[k][(l-1)]];o=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;m=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;j+=128}if(o[h][j-p]>1){return{value:v-p,angle:m[_H.floor((h)/16)][_H.floor((j-p)/16)]}}}}}return -1};this.draw=function(h,k,j,l){var m=_H.floor(j.x)-sonicManager.windowLocation.x;var n=_H.floor(j.y)-sonicManager.windowLocation.y;h.beginPath();if(l&&l.chosen){h.strokeStyle="#FFF76D";h.lineWidth=4}else{h.strokeStyle=this.color;h.lineWidth=2}switch(j.mode){case RotationMode.Floor:h.moveTo((m+this.x1)*k.x,(n+this.y1)*k.y);h.lineTo((m+this.x2)*k.x,(n+this.y2)*k.y);break;case RotationMode.LeftWall:h.moveTo((m-this.y1)*k.x,(n+this.x1)*k.y);h.lineTo((m-this.y2)*k.x,(n+this.x2)*k.y);break;case RotationMode.Ceiling:h.moveTo((m-this.x1)*k.x,(n-this.y1)*k.y);h.lineTo((m-this.x2)*k.x,(n-this.y2)*k.y);break;case RotationMode.RightWall:h.moveTo((m+this.y1)*k.x,(n-this.x1)*k.y);h.lineTo((m+this.y2)*k.x,(n-this.x2)*k.y);break}h.closePath();h.stroke()}};SensorManager=function(a){this.sonicManager=a;this.sensors=[];this.sensorResults=[];this.check=function(b){var d=false;for(var c in this.sensors){this.sensorResults[c]=this.sensors[c].check(b);d=d||(this.sensorResults[c]!=-1)}return d};this.draw=function(b,e,c){for(var d in this.sensors){this.sensors[d].draw(b,e,c,this.sensorResults[d])}};this.getResult=function(b){return this.sensorResults[b]};this.addSensor=function(b,c){this.sensors[b]=(c);this.sensorResults[b]=false;return c};this.createHorizontalSensor=function(d,g,e,f,b,c){return this.addSensor(d,new Sensor(e,f,g,g,this,b,c))};this.createVerticalSensor=function(d,e,f,g,b,c){return this.addSensor(d,new Sensor(e,e,f,g,this,b,c))}};function Sonic(d,c){this.x=d.StartPositions[0].X;this.y=d.StartPositions[0].Y;this.obtainedRing=[];this.rings=0;this.debugging=false;this.jumping=false;this.crouching=false;this.holdingLeft=false;this.holdingRight=false;this.holdingUp=false;this.LevelWidth=0;this.xsp=0;this.ysp=0;this.sonicLastHitTick=0;this.sonicJustHitTick=0;this.acc=0.046875;this.dec=0.5;this.frc=0.046875;this.gsp=0;this.rdec=0.125;this.rfrc=0.0234375;this.runningTick=0;this.slp=0.125;this.slpRollingUp=0.078125;this.slpRollingDown=0.3125;this.jmp=-6.5;this.grv=0.21875;this.air=0.09375;this.sonicLevel=d;this.inAir=false;this.wasInAir=false;this.holdingJump=false;this.haltSmoke=[];this.sensorManager=new SensorManager(sonicManager);this.hlock=0;this.mode=RotationMode.Floor;this.facing=true;this.ticking=false;this.breaking=0;this.ducking=false;this.spinDash=false;this.myRec={};this.spinDashSpeed=0;this.angle=255;var b;this.sensorManager.createVerticalSensor("a",-9,0,36,"#F202F2");this.sensorManager.createVerticalSensor("b",9,0,36,"#02C2F2");this.sensorManager.createVerticalSensor("c",-9,0,-20,"#2D2C21");this.sensorManager.createVerticalSensor("d",9,0,-20,"#C242822");this.sensorManager.createHorizontalSensor("m1",4,0,-12,"#212C2E");this.sensorManager.createHorizontalSensor("m2",4,0,12,"#22Ffc1");this.watcher=new Watcher();this.updateMode=function(){if(this.angle<=34||this.angle>=192){this.mode=RotationMode.Floor}else{if(this.angle>34&&this.angle<86){this.mode=RotationMode.LeftWall}else{if(this.angle>=86&&this.angle<161){this.mode=RotationMode.Ceiling}else{if(this.angle>161&&this.angle<192){this.mode=RotationMode.RightWall}}}}this.myRec={x:this.x-5,width:5*2,y:this.y-20,height:20*2}};this.effectPhysics=function(){this.watcher.tick();var f=6;if(!this.jumping){if(!this.inAir&&this.wasJumping){this.wasJumping=false}}if(this.inAir&&!this.wasInAir){this.wasInAir=true;if((this.angle>=112&&this.angle<=144)){this.xsp=(this.gsp)}}if(!this.inAir&&this.wasInAir){this.wasInAir=false;if((this.angle>=240||this.angle<=15)){this.gsp=(this.xsp)}else{if((this.angle>=224&&this.angle<=239)||(this.angle>=16&&this.angle<=31)){this.gsp=(this.ysp)}else{if((this.angle>=192&&this.angle<=223)){this.gsp=(-this.ysp)}else{if((this.angle>=32&&this.angle<=63)){this.gsp=(this.ysp)}}}}this.xsp=0;this.ysp=0}if(!this.inAir&&!this.rolling){if(!this.holdingLeft&&!this.holdingRight){this.gsp-=(Math.min(Math.abs(this.gsp),this.watcher.multiply(this.frc))*(this.gsp>0?1:-1))}b=_H.sign(this.gsp);this.gsp+=this.watcher.multiply(this.slp)*-_H.sin(this.angle);if(b!=_H.sign(this.gsp)&&b!=0){this.hlock=30}if(this.holdingRight&&!this.holdingLeft){this.facing=true;if(this.gsp>=0){this.gsp+=this.watcher.multiply(this.acc);if(this.gsp>f){this.gsp=f}}else{this.gsp+=this.watcher.multiply(this.dec);if(Math.abs(this.gsp)>4.5){this.facing=false;this.breaking=1;this.runningTick=0}}}if(this.holdingLeft&&!this.holdingRight){this.facing=false;if(this.gsp<=0){this.gsp-=this.watcher.multiply(this.acc);if(this.gsp<-f){this.gsp=-f}}else{this.gsp-=this.watcher.multiply(this.dec);if(Math.abs(this.gsp)>4.5){this.facing=true;this.breaking=-1;this.runningTick=0}}}}this.ducking=false;if(this.crouching){if(Math.abs(this.gsp)>1.03125){this.rolling=true;this.currentlyBall=true}else{this.ducking=true}}else{if(this.spinDash){this.gsp=(8+_H.floor(this.spinDashSpeed)/2)*(this.facing?1:-1);this.spinDash=false;this.rolling=true;this.currentlyBall=true}}if(!this.inAir&&this.rolling){if(this.holdingLeft){if(this.gsp>0){if(this.rolling){this.gsp=(_H.max(0,this.gsp-this.watcher.multiply(this.rdec)))}}}if(this.holdingRight){if(this.gsp<0){if(this.rolling){this.gsp=(_H.min(0,this.gsp+this.watcher.multiply(this.rdec)))}}}this.gsp-=(Math.min(Math.abs(this.gsp),this.watcher.multiply(this.rfrc))*(this.gsp>0?1:-1));b=_H.sign(this.gsp);var e=_H.sin(this.angle);if((e>0)==(this.gsp>0)){this.gsp+=this.watcher.multiply(-this.slpRollingUp)*e}else{this.gsp+=this.watcher.multiply(-this.slpRollingDown)*e}if(this.gsp>f*2.5){this.gsp=f*2.5}if(this.gsp<-f*2.5){this.gsp=-f*2.5}if(b!=_H.sign(this.gsp)&&b!=0){this.hlock=30}if(Math.abs(this.gsp)<0.53125){this.rolling=false;this.currentlyBall=false}}if(this.inAir){if(this.holdingRight&&!this.holdingLeft){this.facing=true;if(this.xsp>=0){this.xsp+=this.watcher.multiply(this.air);if(this.xsp>f){this.xsp=f}}else{this.xsp+=this.watcher.multiply(this.air)}}if(this.holdingLeft&&!this.holdingRight){this.facing=false;if(this.xsp<=0){this.xsp-=this.watcher.multiply(this.air);if(this.xsp<-f){this.xsp=-f}}else{this.xsp-=this.watcher.multiply(this.air)}}if(this.wasInAir){if(this.jumping){}else{}}this.ysp+=this.watcher.multiply(this.justHit?0.1875:this.grv);if(this.ysp<0&&this.ysp>-4){if(Math.abs(this.xsp)>0.125){this.xsp*=0.96875}}if(this.ysp>16){this.ysp=16}}if(this.wasInAir&&this.jumping){}else{if(this.jumping&&!this.wasJumping){this.wasJumping=true;if(this.ducking){this.spinDash=true;this.spinDashSpeed+=2;if(this.spinDashSpeed>8){this.spinDashSpeed=8}this.spriteState="spindash0"}else{this.inAir=true;this.currentlyBall=true;this.xsp=this.jmp*_H.sin(this.angle)+this.gsp*_H.cos(this.angle);this.ysp=this.jmp*_H.cos(this.angle)}}}this.checkCollisionWithRing();this.checkCollisionWithObjects();if(!this.inAir){if(this.spinDash){this.gsp=0}this.xsp=this.gsp*_H.cos(this.angle);this.ysp=this.gsp*-_H.sin(this.angle);if(Math.abs(this.gsp)<2.5&&this.mode!=RotationMode.Floor){if(this.mode==RotationMode.RightWall){this.x-=0}else{if(this.mode==RotationMode.LeftWall){this.x+=0}else{if(this.mode==RotationMode.Ceiling){this.y+=0}}}this.mode=RotationMode.Floor;this.angle=255;this.updateMode();this.hlock=30}}if(this.xsp>0&&this.xsp<0.008){this.gsp=0;this.xsp=0}if(this.xsp<0&&this.xsp>-0.008){this.gsp=0;this.xsp=0}this.x=((sonicManager.SonicLevel.LevelWidth*128)+(this.x+this.xsp))%(sonicManager.SonicLevel.LevelWidth*128);this.y=((sonicManager.SonicLevel.LevelHeight*128)+(this.y+this.ysp))%(sonicManager.SonicLevel.LevelHeight*128)};this.tick=function(){if(this.debugging){var g=this.watcher.multiply(15);if(this.holdingRight){this.x+=g}if(this.holdingLeft){this.x-=g}if(this.crouching){this.y+=g}if(this.holdingUp){this.y-=g}this.x=((sonicManager.SonicLevel.LevelWidth*128)+(this.x))%(sonicManager.SonicLevel.LevelWidth*128);this.y=((sonicManager.SonicLevel.LevelHeight*128)+(this.y))%(sonicManager.SonicLevel.LevelHeight*128);return}this.updateMode();if(this.hlock>0){this.hlock--;this.holdingRight=false;this.holdingLeft=false}if(this.inAir){this.angle=255;this.mode=RotationMode.Floor}this.effectPhysics();this.updateSprite();var h=_H.floor(this.x);var j=_H.floor(this.y);this.sensorManager.check(this);var o=this.sensorManager.getResult("m1");var p=this.sensorManager.getResult("m2");switch(this.mode){case RotationMode.Floor:if(o!=-1){this.x=h=o.value+12;this.gsp=0;if(this.inAir){this.xsp=0}}if(p!=-1){this.x=h=p.value-12;this.gsp=0;if(this.inAir){this.xsp=0}}break;case RotationMode.LeftWall:if(o!=-1){this.y=j=o.value-12;if(this.inAir){this.xsp=0}}if(p!=-1){this.y=j=p.value+12;this.gsp=0;if(this.inAir){this.xsp=0}}break;case RotationMode.Ceiling:if(o!=-1){this.x=h=o.value+12;this.gsp=0;if(this.inAir){this.xsp=0}}if(p!=-1){this.x=h=p.value-12;this.gsp=0;if(this.inAir){this.xsp=0}}break;case RotationMode.RightWall:if(o!=-1){this.y=j=o.value-12;this.gsp=0;if(this.inAir){this.xsp=0}}if(p!=-1){this.y=j=p.value+12;this.gsp=0;if(this.inAir){this.xsp=0}}break}this.sensorManager.check(this);var k=this.sensorManager.getResult("a");var l=this.sensorManager.getResult("b");if(!this.inAir){if(k==-1&&l==-1){this.inAir=true}else{this.justHit=false;switch(this.mode){case RotationMode.Floor:if(k.value>=0&&l.value>=0){if(k.value<l.value){k.chosen=true;this.angle=k.angle;this.y=j=k.value-20}else{l.chosen=true;this.angle=l.angle;this.y=j=l.value-20}}else{if(k.value>-1){k.chosen=true;this.angle=k.angle;this.y=j=k.value-20}else{if(l.value>-1){l.chosen=true;this.angle=l.angle;this.y=j=l.value-20}}}break;case RotationMode.LeftWall:if(k.value>=0&&l.value>=0){if(k.value>l.value){k.chosen=true;this.angle=k.angle;this.x=h=k.value+20}else{l.chosen=true;this.angle=l.angle;this.x=h=l.value+20}}else{if(k.value>-1){k.chosen=true;this.angle=k.angle;this.x=h=k.value+20}else{if(l.value>-1){l.chosen=true;this.angle=l.angle;this.x=h=l.value+20}}}break;case RotationMode.Ceiling:if(k.value>=0&&l.value>=0){if(k.value>l.value){k.chosen=true;this.angle=k.angle;this.y=j=k.value+20}else{l.chosen=true;this.angle=l.angle;this.y=j=l.value+20}}else{if(k.value>-1){k.chosen=true;this.angle=k.angle;this.y=j=k.value+20}else{if(l.value>-1){l.chosen=true;this.angle=l.angle;this.y=j=l.value+20}}}break;case RotationMode.RightWall:if(k.value>=0&&l.value>=0){if(k.value<l.value){k.chosen=true;this.angle=k.angle;this.x=h=k.value-20}else{l.chosen=true;this.angle=l.angle;this.x=h=l.value-20}}else{if(k.value>-1){k.chosen=true;this.angle=k.angle;this.x=h=k.value-20}else{if(l.value>-1){l.chosen=true;this.angle=l.angle;this.x=h=l.value-20}}}break}}this.updateMode()}else{if(k==-1&&l==-1){this.inAir=true}else{if(k.value>=0&&l.value>=0){if(k.value<l.value){if(this.y+(20)>=k.value){this.angle=k.angle;this.y=j=k.value-20;this.rolling=this.currentlyBall=false;this.inAir=false}}else{if(l.value>-1){if(this.y+(20)>=l.value){this.angle=l.angle;this.y=j=l.value-20;this.rolling=this.currentlyBall=false;this.inAir=false}}}}else{if(k.value>-1){if(this.y+(20)>=k.value){this.angle=k.angle;this.y=j=k.value-20;this.rolling=this.currentlyBall=false;this.inAir=false}}else{if(l.value>-1){if(this.y+(20)>=l.value){this.angle=l.angle;this.y=j=l.value-20;this.rolling=this.currentlyBall=false;this.inAir=false}}}}}this.updateMode();var f=sonicManager.SpriteCache.sonicSprites[this.spriteState+c.x+c.y];var e=f.height/c.y/2;this.sensorManager.check(this);var m=this.sensorManager.getResult("c");var n=this.sensorManager.getResult("d");if((m==-1&&n==-1)){}else{if(m.value>=0&&n.value>=0){this.angle=m.angle;if(m.value<n.value){if(this.y+(e)>=m.value){if(this.ysp<0){this.angle=m.angle;this.y=j=m.value+e;if(m.angle==255){this.ysp=0}else{this.gsp=-this.ysp;this.inAir=false;this.wasInAir=false}}}}else{if(this.y+(e)>=n.value){if(this.ysp<0){this.angle=n.angle;this.y=j=n.value+e;if(m.angle==255){this.ysp=0}else{this.gsp=-this.ysp;this.inAir=false;this.wasInAir=false}}}}}else{if(m.value>-1){if(this.y+(e)>=m.value){if(this.ysp<0){this.angle=m.angle;this.y=j=m.value+e;if(m.angle==255){this.ysp=0}else{this.gsp=-this.ysp;this.inAir=false;this.wasInAir=false}}}}else{if(n.value>-1){if(this.y+(e)>=n.value){if(this.ysp<0){this.angle=n.angle;this.y=j=n.value+e;if(m.angle==255){this.ysp=0}else{this.gsp=-this.ysp;this.inAir=false;this.wasInAir=false}}}}}}this.updateMode()}}};this.debug=function(){this.debugging=!this.debugging;this.xsp=0;this.gsp=0;this.ysp=0;this.spriteState="normal"};this.hit=function(){if(sonicManager.drawTickCount-this.sonicJustHitTick<120){return}this.justHit=true;this.ysp=-4;this.xsp=2*(-1);this.sonicLastHitTick=sonicManager.drawTickCount;var j=0;var e=101.25;var f=false;var h=4;while(j<this.rings){var g=new Ring(true);sonicManager.activeRings.push(g);g.x=this.x;g.y=this.y-10;g.ysp=-Math.sin(e)*h;g.xsp=Math.cos(e)*h;if(f){g.ysp*=-1;e+=22.5}f=!f;j++;if(j==16){h=2;e=101.25}}this.rings=0};this.checkCollisionWithRing=function(){var g=this.myRec;for(var j in sonicManager.SonicLevel.Rings){var h=sonicManager.SonicLevel.Rings[j];if(this.obtainedRing[j]){continue}var e=h.X;var f=h.Y;if(_H.intersectRect(g,{x:e-8,width:8*2,y:f-8,height:8*2})){this.rings++;this.obtainedRing[j]=true}}};this.checkCollisionWithObjects=function(){var g=this.myRec;for(var j in sonicManager.SonicLevel.Objects){var h=sonicManager.SonicLevel.Objects[j];var e=h.X;var f=h.Y;if(_H.intersectRect(g,h.getRect())){h.collide()}}};this.sensorA=0;this.checkCollisionLine=function(h,j,f,e){var g=this.checkCollisionLineWrap(h,j,f,e);if(g!=-1&&g.angle==null){g=this.checkCollisionLineWrap(h,j,f,e)}if(g.angle==255){if(this.mode==RotationMode.Floor){}else{if(this.mode==RotationMode.LeftWall){}else{if(this.mode==RotationMode.Ceiling){}else{if(this.mode==RotationMode.RightWall){}}}}}return g};this.checkCollisionLineWrap=function(t,u,q,n){var g=_H.floor(t/128);var h=_H.floor(u/128);var s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[g][h]];var l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;var j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;var e=t-g*128;var f=u-h*128;var o=128;var p;var r;var k=0;switch(n){case 0:if(t+q>sonicManager.SonicLevel.LevelWidth*128){return{pos:sonicManager.SonicLevel.LevelWidth*128-20,angle:null}}for(p=0;p<q;p++){if(e+p>=128){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[g+1][h]];l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;e-=128}if(t+p>this.LevelWidth||l[(e+p)][f]>=2){return{pos:t+p,angle:j[_H.floor((e+p)/16)][_H.floor((f)/16)]}}}break;case 1:if(u+q>sonicManager.SonicLevel.LevelHeight*128){return{pos:sonicManager.SonicLevel.LevelHeight*128-20,angle:null}}for(p=0;p<q;p+=1){if(f+k>=128){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[g][(h+1)]];l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;f-=128}if(l[e][f+p]>=1){return{pos:u+p,angle:j[_H.floor((e)/16)][_H.floor((f+k)/16)]}}k++}break;case 2:if(t-q<0){return{pos:0+20,angle:null}}for(p=0;p<q;p++){if(e-p<0){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[(g-1),h]];l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;e+=128}if(t-p<0||l[(e-p)][f]>=2){return{pos:t-p,angle:j[_H.floor((e-p)/16)][_H.floor((f)/16)]}}}break;case 3:if(u-q<0){return{pos:20,angle:null}}for(p=0;p<q;p+=1){if(f-k<0){s=sonicManager.SonicLevel.Chunks[sonicManager.SonicLevel.ChunkMap[g][(h-1)]];l=sonicManager.SonicLevel.curHeightMap?s.heightBlocks1:s.heightBlocks2;j=sonicManager.SonicLevel.curHeightMap?s.angleMap1:s.angleMap2;f+=128}if(l[e][f-p]>=2){return{pos:u-p,angle:j[_H.floor((e)/16)][_H.floor((f-k)/16)]}}k++}break}return -1};this.spriteState="normal";this.isLoading=function(){return this.imageLoaded[0]<this.imageLength};this.drawUI=function(e,f,g){e.font="13pt Arial bold";e.fillStyle="White";e.fillText("Rings: "+this.rings,f.x+90,f.y+45);e.fillText("Angle: "+this.angle.toString(16),f.x+90,f.y+75);e.fillText("Position: "+_H.floor(this.x)+", "+_H.floor(this.y),f.x+90,f.y+105);e.fillText("Speed: g: "+this.gsp.toFixed(3)+" x:"+this.xsp.toFixed(3)+" y:"+this.ysp.toFixed(3),f.x+90,f.y+135);e.fillText("Mode: "+a(this.mode),f.x+90,f.y+165);if(this.inAir){e.fillText("Air ",f.x+220,f.y+45)}if(this.hlock>0){e.fillText("HLock: "+this.hlock,f.x+90,f.y+195)}};function a(e){switch(e){case RotationMode.Floor:return"Floor";case RotationMode.Ceiling:return"Ceiling";case RotationMode.RightWall:return"Right Wall";case RotationMode.LeftWall:return"Left Wall"}}this.draw=function(e,o){var g=_H.floor(this.x);var h=_H.floor(this.y);var f;var l=sonicManager.drawTickCount-this.sonicJustHitTick;if(l<120){if(l%8<4){return}}if(f=sonicManager.SpriteCache.sonicSprites[this.spriteState+o.x+o.y]){if(f.loaded){_H.save(e);var p=0;var q=0;if(f.height!=40*o.x){switch(this.mode){case RotationMode.Floor:var m=0;q=(40-((f.height+m)/o.y))/2;break;case RotationMode.LeftWall:var m=15;p=-(40-((f.height+m)/o.x))/2;break;case RotationMode.Ceiling:var m=8;q=-(40-((f.height+m)/o.y))/2;break;case RotationMode.RightWall:var m=20;p=-(40-((f.height+m)/o.x))/2;break}}e.translate((g-sonicManager.windowLocation.x+p+p)*o.x,((h-sonicManager.windowLocation.y+q)*o.y));if(!this.facing){e.scale(-1,1);if(!this.currentlyBall&&!this.spinDash){e.rotate(-_H.fixAngle(this.angle))}e.drawImage(f,-f.width/2,-f.height/2);if(this.spinDash){e.drawImage(sonicManager.SpriteCache.sonicSprites[("spinsmoke"+_H.floor((sonicManager.drawTickCount%14)/2))+o.x+o.y],(-f.width/2)-25*o.x,-f.height/2+(q*o.y)-14,f.width,f.height)}}else{if(!this.currentlyBall&&!this.spinDash){e.rotate(_H.fixAngle(this.angle))}e.drawImage(f,-f.width/2,-f.height/2);if(this.spinDash){e.drawImage(sonicManager.SpriteCache.sonicSprites[("spinsmoke"+_H.floor((sonicManager.drawTickCount%14)/2))+o.x+o.y],(-f.width/2)-25*o.x,-f.height/2+(q*o.y)-14,f.width,f.height)}}_H.restore(e);if(sonicManager.showHeightMap){this.sensorManager.draw(e,o,this)}for(var j=0;j<this.haltSmoke.length;j++){var k=this.haltSmoke[j];e.drawImage(sonicManager.SpriteCache.sonicSprites[("haltsmoke"+_H.floor((sonicManager.drawTickCount%(4*6))/6))+o.x+o.y],((k.x-sonicManager.windowLocation.x-25)*o.x),((k.y+12-sonicManager.windowLocation.y+q)*o.y));if(_H.floor(((sonicManager.drawTickCount+6)%(4*6))/6)==0){this.haltSmoke.splice(j,1)}}}}else{if(f=sonicManager.SpriteCache.sonicSprites[this.spriteState]){if(f.loaded){sonicManager.SpriteCache.sonicSprites[this.spriteState+o.x+o.y]=_H.scaleSprite(f,o)}}else{sonicManager.SpriteCache.sonicSprites[this.spriteState]=_H.loadSprite(this.spriteLocations[this.spriteState])}}};this.kill=function(){};this.pressJump=function(){if(this.debugging||!this.justHit){this.jumping=true}};this.pressUp=function(){if(this.debugging||!this.justHit){this.holdingUp=true}};this.pressCrouch=function(){if(this.debugging||!this.justHit){this.crouching=true}};this.pressLeft=function(){if(this.debugging||!this.justHit){this.holdingLeft=true}};this.pressRight=function(){if(this.debugging||!this.justHit){this.holdingRight=true}};this.releaseJump=function(){this.jumping=false};this.releaseUp=function(){this.holdingUp=false};this.releaseCrouch=function(){this.crouching=false};this.releaseLeft=function(){this.holdingLeft=false};this.releaseRight=function(){this.holdingRight=false};this.buildHeightInfo=function(){this.LevelWidth=d.LevelWidth*128;for(var u=0;u<d.Chunks.length;u++){var m=d.Chunks[u];var n;var o=m.heightBlocks1=[];var p=m.heightBlocks2=[];var k=m.angleMap1=[];var l=m.angleMap2=[];for(var g=0;g<128;g++){o[g]=[];p[g]=[]}for(var g=0;g<8;g++){k[g]=[];l[g]=[]}for(var j=0;j<8;j++){for(var h=0;h<8;h++){var w=m.tilePieces[h][j];k[h][j]=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes1[w.Block]];l[h][j]=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes2[w.Block]];if(!(k[h][j]==0||k[h][j]==255||k[h][j]==1)){if(w.XFlip){if(w.YFlip){k[h][j]=192-k[h][j]+192;k[h][j]=128-k[h][j]+128}else{k[h][j]=128-k[h][j]+128}}else{if(w.YFlip){k[h][j]=192-k[h][j]+192}else{k[h][j]=(k[h][j])}}}if(!(l[h][j]==0||l[h][j]==255||l[h][j]==1)){if(w.XFlip){if(w.YFlip){l[h][j]=192-l[h][j]+192;l[h][j]=128-l[h][j]+128}else{l[h][j]=128-l[h][j]+128}}else{if(w.YFlip){l[h][j]=192-l[h][j]+192}else{l[h][j]=(l[h][j])}}}var e;var f;var q=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes1[w.Block]];var r=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes2[w.Block]];if(q==undefined||r==undefined){continue}var v;if(q==0||q==1){v=q==0?0:w.Solid1;for(f=0;f<16;f++){for(e=0;e<16;e++){o[(h*16+e)][(j*16+f)]=v}}}else{q=q.items}if(r==0||r==1){v=r==0?0:w.Solid2;for(f=0;f<16;f++){for(e=0;e<16;e++){p[(h*16+e)][(j*16+f)]=v}}}else{r=r.items}for(f=0;f<16;f++){for(e=0;e<16;e++){var s=0,t=0;if(w.XFlip){if(w.YFlip){s=15-e;t=15-f}else{s=15-e;t=f}}else{if(w.YFlip){s=e;t=15-f}else{s=e;t=f}}if(!(q==0||q==1)){switch(w.Solid1){case 0:o[(h*16+s)][(j*16+t)]=false;break;case 1:case 2:case 3:o[(h*16+s)][(j*16+t)]=_H.itemsGood(q,e,f,t)?w.Solid1:0;break}}if(!(r==0||r==1)){switch(w.Solid2){case 0:p[(h*16+s)][(j*16+t)]=false;break;case 1:case 2:case 3:p[(h*16+s)][(j*16+t)]=_H.itemsGood(r,e,f,t)?w.Solid2:0;break}}}}}}}};this.empty=function(){for(var f=0;f<d.Chunks.length;f++){var e=d.Chunks[f];e.heightBlocks1=null;e.heightBlocks2=null;e.angleMap1=null;e.angleMap2=null}};this.updateSprite=function(){var e=Math.abs(this.gsp);var f=parseInt(this.spriteState.substring(this.spriteState.length-1,this.spriteState.length));if(this.breaking>0){if(this.gsp>0||this.gsp==0||this.spriteState=="breaking3"){this.facing=false;this.breaking=0}}else{if(this.breaking<0){if(this.gsp<0||this.gsp==0||this.spriteState=="breaking3"){this.breaking=0;this.facing=true}}}if(this.justHit){if(this.spriteState.substring(0,this.spriteState.length-1)!="hit"){this.spriteState="hit0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(8-e))==0){this.spriteState="hit1"}}}else{if(this.spinDash){if(this.spriteState.substring(0,this.spriteState.length-1)!="spindash"){this.spriteState="spindash0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(2-e))==0){this.spriteState="spindash"+((f+1)%6)}}}else{if(e==0&&this.inAir==false){if(this.ducking){if(this.spriteState.substring(0,this.spriteState.length-1)!="duck"){this.spriteState="duck0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(4-e))==0){this.spriteState="duck1"}}}else{if(this.holdingUp){if(this.spriteState.substring(0,this.spriteState.length-1)!="lookingup"){this.spriteState="lookingup0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(4-e))==0){this.spriteState="lookingup1"}}}else{this.spriteState="normal";this.currentlyBall=false;this.rolling=false;this.runningTick=0}}}else{if(this.breaking!=0){if(this.spriteState.substring(0,this.spriteState.length-1)!="breaking"){this.spriteState="breaking0";this.runningTick=1}else{if((this.runningTick++)%(7)==0){this.spriteState="breaking"+((f+1)%4);if(f==0){this.haltSmoke.push({x:_H.floor(this.x),y:_H.floor(this.y)})}}}}else{if(this.currentlyBall){if(this.spriteState.substring(0,this.spriteState.length-1)!="balls"){this.spriteState="balls0";this.runningTick=1}else{if(((this.runningTick++)%(_H.floor(8-e))==0)||(8-e<1)){this.spriteState="balls"+((f+1)%5)}}}else{if(e<6){if(this.spriteState.substring(0,this.spriteState.length-1)!="running"){this.spriteState="running0";this.runningTick=1}else{if((this.runningTick++)%(_H.floor(8-e))==0||(_H.floor(8-e)==0)){this.spriteState="running"+((f+1)%8)}}}else{if(e>=6){if(this.spriteState.substring(0,this.spriteState.length-1)!="fastrunning"){this.spriteState="fastrunning0";this.runningTick=1}else{if(((this.runningTick++)%(Math.ceil(8-e))==0)||(_H.floor(8-e)==0)){this.spriteState="fastrunning"+((f+1)%4)}}}}}}}}}};this.buildHeightInfo(d)}function Watcher(){var a=0;this.mult=1;this.tick=function(){if(sonicManager.inHaltMode){this.mult=1;return}var c=new Date().getTime();var b=0;if(a==0){b=16.6}else{b=c-a}a=c;this.mult=b/16.6};this.multiply=function(b){return b;return this.mult*b}}DEBUGs=true;window.requestAnimFrame=(function(a){if(window.requestAnimationFrame){return window.requestAnimationFrame(a)}if(window.webkitRequestAnimationFrame){return window.webkitRequestAnimationFrame(a)}if(window.mozRequestAnimationFrame){return window.mozRequestAnimationFrame(a)}if(window.oRequestAnimationFrame){return window.oRequestAnimationFrame(a)}if(window.msRequestAnimationFrame){return window.msRequestAnimationFrame(a)}window.setTimeout(a,1000/60)});function SonicEngine(c){var l=this;this.canvas=$("#"+c);this.canvasItem=document.getElementById(c).getContext("2d");this.canvasWidth=0;this.canvasHeight=0;var h=document.getElementById(c);h.addEventListener("DOMMouseScroll",j,false);h.addEventListener("mousewheel",j,false);h.addEventListener("touchmove",a);h.addEventListener("touchstart",d);h.addEventListener("touchend",b);h.addEventListener("mousedown",d);h.addEventListener("mouseup",b);h.addEventListener("mousemove",a);h.addEventListener("contextmenu",function(m){m.preventDefault()},false);$(document).keypress(f);$(document).keydown(function(m){if(m.ctrlKey||m.keyCode==8||m.keyCode==46||m.keyCode==37||m.keyCode==39){m.preventDefault();f(m)}});$(document).keyup(g);function d(m){m.preventDefault();if(k.uiManager.onClick(m)){return false}if(k.onClick(m)){return false}k.uiManager.dragger.click(m);return false}function a(m){m.preventDefault();if(k.uiManager.onMouseMove(m)){return false}return false}function b(m){m.preventDefault();k.uiManager.onMouseUp(m);return false}function j(m){m.preventDefault();if(k.uiManager.onMouseScroll(m)){return false}return m.preventDefault()&&false}function f(m){if(!k.sonicToon){k.uiManager.onKeyDown(m)}switch(m.keyCode){case 79:if(k.sonicToon){k.inHaltMode=!k.inHaltMode}break;case 80:if(k.sonicToon){if(k.inHaltMode){k.waitingForTickContinue=false}}break;case 66:if(k.sonicToon){k.sonicToon.hit()}break;case 67:if(k.sonicToon){k.sonicToon.debug()}break;case 69:k.SonicLevel.curHeightMap=!k.SonicLevel.curHeightMap;break;case 70:k.showHeightMap=!k.showHeightMap;break;case 38:case 87:if(k.sonicToon){k.sonicToon.pressUp()}else{k.windowLocation.y-=128}break;case 32:if(k.sonicToon){k.sonicToon.pressJump()}break;case 40:case 83:if(k.sonicToon){k.sonicToon.pressCrouch()}else{k.windowLocation.y+=128}break;case 37:case 65:k.windowLocation.x-=128;if(k.sonicToon){k.sonicToon.pressLeft()}else{k.windowLocation.x-=128}break;case 39:case 68:k.windowLocation.x+=128;if(k.sonicToon){k.sonicToon.pressRight()}else{k.windowLocation.x+=128}break}}function g(m){switch(m.keyCode){case 38:case 87:if(k.sonicToon){k.sonicToon.releaseUp()}break;case 32:if(k.sonicToon){k.sonicToon.releaseJump()}break;case 40:case 83:if(k.sonicToon){k.sonicToon.releaseCrouch()}break;case 37:case 65:if(k.sonicToon){k.sonicToon.releaseLeft()}break;case 39:case 68:if(k.sonicToon){k.sonicToon.releaseRight()}break}}l.resizeCanvas=function(){l.canvasWidth=$(window).width();l.canvasHeight=$(window).height();window.sonicManager.windowLocation=_H.defaultWindowLocation(window.sonicManager.sonicToon?0:1,l.canvasItem,window.sonicManager.scale);l.canvas.attr("width",l.canvasWidth);l.canvas.attr("height",l.canvasHeight)};function e(m){m.clearRect(0,0,l.canvasWidth,l.canvasHeight)}l.draw=function(){requestAnimFrame(l.draw);if(!k.inHaltMode){e(l.canvasItem)}k.draw(l.canvasItem);k.uiManager.draw(l.canvasItem)};$(window).resize(this.resizeCanvas);var k=window.sonicManager=new SonicManager(this.canvasItem,this.resizeCanvas);this.resizeCanvas();requestAnimFrame(l.draw);window.setInterval(k.tick,1000/60,k)}function SonicManager(a,b){var c=this.scale={x:2,y:2};window.sonicManager=this;this.windowLocation=_H.defaultWindowLocation(1,a,c);this.showHeightMap=false;this.goodRing=new Ring(false);this.activeRings=[];this.forceResize=b;this.background=null;this.uiManager=new UIManager(this,a,this.scale);this.uiManager.objectFrameworkArea.populate(new LevelObject("Somekey"));this.SonicLevel={Tiles:[],Blocks:[],Chunks:[],ChunkMap:[[]],Rings:{},curHeightMap:true,LevelWidth:0,LevelHeight:0};this.containsAnimatedTile=function(h){for(var g=0;g<sonicManager.SonicLevel.Animations.length;g++){var e=sonicManager.SonicLevel.Animations[g];var f=e.AnimationTileIndex;var j=e.NumberOfTiles;if(h>=f&&h<f+j){return e}}return undefined};this.SonicLevel.ChunkMap=[[]];this.clickState=ClickState.Dragging;this.onClick=function(g){g={x:g.x/c.x+this.windowLocation.x,y:g.y/c.y+this.windowLocation.y};if(!g.button||g.button==0){switch(this.clickState){case ClickState.Dragging:return false;break;case ClickState.PlaceChunk:var h,j;h=_H.floor(g.x/(128));j=_H.floor(g.y/(128));var f=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[h][j]];var n=f.getBlock((g.x-h*(128)),(g.y-j*(128)));if(n){var p=f.getTilePiece((g.x-h*(128)),(g.y-j*(128)));this.uiManager.indexes.tpIndex=this.SonicLevel.Blocks.indexOf(n);this.uiManager.modifyTilePieceArea.tilePiece=n;this.uiManager.solidTileArea.visible=true;this.uiManager.modifyTilePieceArea.tpc=p}return true;break;case ClickState.PlaceRing:var h=_H.floor((g.x));var j=_H.floor((g.y));this.SonicLevel.Rings.push({X:h,Y:j});return true;break;case ClickState.PlaceObject:var h=_H.floor((g.x));var j=_H.floor((g.y));for(var k=0;k<sonicManager.SonicLevel.Objects.length;k++){var m=sonicManager.SonicLevel.Objects[k];if(_H.intersects2(m.getRect(),{X:h,Y:j})){alert("Object Data: "+_H.stringify(m))}}return true;break;default:}}return false};this.tickCount=0;this.drawTickCount=0;this.inHaltMode=false;this.waitingForTickContinue=false;this.waitingForDrawContinue=false;var d=this;this.tick=function(){if(d.loading){return}if(d.sonicToon){if(d.inHaltMode){if(d.waitingForTickContinue){return}}d.tickCount++;d.sonicToon.ticking=true;try{d.sonicToon.tick(d.SonicLevel,c)}catch(e){var f="There was an error on this page.\n\n";f+="Error description: "+e.message+"\n\n";f+="Click OK to continue.\n\n";alert(f)}finally{d.sonicToon.ticking=false}if(d.inHaltMode){if(d.waitingForTickContinue){return}else{d.waitingForTickContinue=true;d.waitingForDrawContinue=false}}if(d.sonicToon.y>128*sonicManager.SonicLevel.LevelHeight){d.sonicToon.y=0}if(d.sonicToon.x>128*sonicManager.SonicLevel.LevelWidth){d.sonicToon.x=0}}};this.screenOffset={x:a.canvas.width/2-this.windowLocation.width*c.x/2,y:a.canvas.height/2-this.windowLocation.height*c.y/2};this.draw=function(m){if(this.inHaltMode){m.fillStyle="white";m.font="21pt arial bold";m.fillText("HALT MODE\r\n Press: P to step\r\n        O to resume",10,120);if(this.waitingForDrawContinue){return}else{this.waitingForDrawContinue=true}}_H.save(m);this.drawTickCount++;if((this.spriteLoader&&!this.spriteLoader.tick())||this.loading){m.fillStyle="white";m.fillText("Loading...   ",95,95);_H.restore(m);return}this.screenOffset={x:m.canvas.width/2-this.windowLocation.width*c.x/2,y:m.canvas.height/2-this.windowLocation.height*c.y/2};if(this.sonicToon){if(this.sonicToon.ticking){while(true){if(!this.sonicToon.ticking){break}}}m.translate(this.screenOffset.x,this.screenOffset.y);m.fillStyle="#000000";m.fillRect(0,0,this.windowLocation.width*c.x,this.windowLocation.height*c.x);m.beginPath();m.rect(0,0,this.windowLocation.width*c.x,this.windowLocation.height*c.x);m.clip();this.windowLocation.x=_H.floor(this.sonicToon.x-this.windowLocation.width*c.x/4);this.windowLocation.y=_H.floor(this.sonicToon.y-this.windowLocation.height*c.y/4);if(this.background){var F=this.windowLocation.x;var j=(this.background.width/c.x);var x=_H.floor(F/j)*j;this.background.draw(m,{x:-_H.floor(this.windowLocation.x)*c.x+x,y:-(_H.floor(this.windowLocation.y/4))*c.y},c,F);this.background.draw(m,{x:-_H.floor(this.windowLocation.x)*c.x+x+this.background.width,y:-(_H.floor(this.windowLocation.y/4))*c.y},c,F)}}if(this.windowLocation.x<0){this.windowLocation.x=0}if(this.windowLocation.y<0){this.windowLocation.y=0}if(this.windowLocation.x>128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width){this.windowLocation.x=128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width}if(this.windowLocation.y>128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height){this.windowLocation.y=128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height}var A=[];for(var u=-1;u<this.windowLocation.width/128;u+=1){for(var g=-1;g<this.windowLocation.height/128;g+=1){A.push({x:u,y:g})}}if(this.SonicLevel.Chunks&&this.SonicLevel.Chunks.length>0){var n=this.SonicLevel.AnimatedChunks;for(var v=0;v<n.length;v++){n[v].animatedTick()}var s=_H.floor((this.windowLocation.x+128)/128);var t=_H.floor((this.windowLocation.y+128)/128);for(var z in A){var e=s+A[z].x;var f=t+A[z].y;if(e<0||f<0||e>=this.SonicLevel.LevelWidth||f>=this.SonicLevel.LevelHeight){continue}var p=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[e][f]];if(!p){continue}var B={x:e*128*c.x,y:f*128*c.y};var C={x:B.x-this.windowLocation.x*c.x,y:B.y-this.windowLocation.y*c.x};p.draw(m,C,c,false);if(!this.sonicToon){m.strokeStyle="#DD0033";m.lineWidth=3;m.strokeRect(C.x,C.y,128*c.x,128*c.y)}}for(var E in this.SonicLevel.Rings){var D=this.SonicLevel.Rings[E];if(this.sonicToon){if(!this.sonicToon.obtainedRing[E]){if(this.windowLocation.intersects(D)){this.goodRing.draw(m,{x:(D.X)-this.windowLocation.x,y:(D.Y)-this.windowLocation.y},c,true)}}}else{if(this.windowLocation.intersects(D)){this.goodRing.draw(m,{x:(D.X)-this.windowLocation.x,y:(D.Y)-this.windowLocation.y},c,false)}}}for(var w=0;w<sonicManager.SonicLevel.Objects.length;w++){var y=sonicManager.SonicLevel.Objects[w];if(this.sonicToon){if(this.windowLocation.intersects({X:y.ObjectData.X,Y:y.ObjectData.Y})){y.draw(m,{x:(y.ObjectData.X)-this.windowLocation.x,y:(y.ObjectData.Y)-this.windowLocation.y},c,true)}}else{if(this.windowLocation.intersects({X:y.ObjectData.X,Y:y.ObjectData.Y})){y.draw(m,{x:(y.ObjectData.X)-this.windowLocation.x,y:(y.ObjectData.Y)-this.windowLocation.y},c,false)}}}for(var u=this.activeRings.length-1;u>=0;u--){var h=this.activeRings[u];h.draw(m,{x:h.x-this.windowLocation.x,y:h.y-this.windowLocation.y},c);if(h.tickCount>256){_H.remove(this.activeRings,h)}}if(this.sonicToon){this.sonicToon.draw(m,c);if(this.windowLocation.x<0){this.windowLocation.x=0}if(this.windowLocation.y<0){this.windowLocation.y=0}if(this.windowLocation.x>128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width){this.windowLocation.x=128*sonicManager.SonicLevel.LevelWidth-this.windowLocation.width}if(this.windowLocation.y>128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height){this.windowLocation.y=128*sonicManager.SonicLevel.LevelHeight-this.windowLocation.height}}for(var z in A){var e=s+A[z].x;var f=t+A[z].y;if(e<0||f<0||e>=this.SonicLevel.LevelWidth||f>=this.SonicLevel.LevelHeight){continue}var p=this.SonicLevel.Chunks[this.SonicLevel.ChunkMap[e][f]];if(!p){continue}var B={x:e*128*c.x,y:f*128*c.y};var C={x:B.x-this.windowLocation.x*c.x,y:B.y-this.windowLocation.y*c.x};p.draw(m,C,c,true);if(!this.sonicToon){m.strokeStyle="#DD0033";m.lineWidth=3;m.strokeRect(C.x,C.y,128*c.x,128*c.y)}if(this.showHeightMap){var q;if((q=sonicManager.SpriteCache.heightMapChunks[(this.SonicLevel.curHeightMap?1:2)+" "+p.index+" "+c.y+" "+c.x])){if(q.loaded){m.drawImage(q,C.x,C.y)}}}if(!this.sonicToon){m.strokeStyle="#DD0033";m.lineWidth=3;m.strokeRect(C.x,C.y,128*c.x,128*c.y)}}}_H.restore(m);if(this.sonicToon){this.sonicToon.drawUI(m,{x:this.screenOffset.x,y:this.screenOffset.y},c)}};this.spriteLoader=null;this.SpriteCache={rings:[],tileChunks:[],tilePeices:[],tiles:[],sonicSprites:[],heightMaps:[],heightMapChunks:[]};this.preLoadSprites=function(s,h,z){this.SpriteCache={rings:[],tileChunks:[],tilePeices:[],tiles:[],sonicSprites:[],heightMaps:[],heightMapChunks:[]};var g=this.SpriteCache.rings;var n=0;var w=[];for(var o=0;o<4;o++){w[o]="assets/Sprites/ring"+o+".png";this.imageLength++}var y=this;var q;var m={sprites:0,tps:0,tcs:0,ss:0,hms:0,hmc:0,tls:0,px:0,aes:0};var t=this.spriteLoader=new SpriteLoader(h,z);var x=t.addStep("Sprites",function(k,j){var A=k*200;g[A]=_H.loadSprite(w[k],function(B){g[B.tag*200+s.x*100+s.y]=_H.scaleSprite(B,s,function(C){j()})});g[A].tag=k},function(){m.sprites=m.sprites+1;if(m.sprites==4){return true}return false},false);for(var l=0;l<w.length;l++){t.addIterationToStep(x,l)}var y=this;var v=1;var r=0;var f=t.addStep("Chunk Maps",function(K,G){var E=_H.defaultCanvas(128*s.x,128*s.y);var F=E.context;F.clearRect(0,0,E.width,E.height);q=y.SonicLevel.Chunks[K];q.draw(F,{x:0,y:0},s,false);var H=E.canvas.toDataURL("image/png");y.SpriteCache.tileChunks[false+" "+q.index+" "+s.y+" "+s.x+" -"]=_H.loadSprite(H,function(k){m.tcs++;G()});E=_H.defaultCanvas(128*s.x,128*s.y);F=E.context;F.clearRect(0,0,E.width,E.height);if(!q.onlyBackground()){q.draw(F,{x:0,y:0},s,true);var H=E.canvas.toDataURL("image/png");y.SpriteCache.tileChunks[true+" "+q.index+" "+s.y+" "+s.x+" -"]=_H.loadSprite(H,function(k){m.tcs++;G()})}else{y.SpriteCache.tileChunks[true+" "+q.index+" "+s.y+" "+s.x+" -"]=1;m.tcs++;G()}if(q.animated){sonicManager.drawTickCount=0;sonicManager.CACHING=false;for(var D=0;D<q.animated.Frames.length;D++){var I=q.animated.Frames[D];E=_H.defaultCanvas(128*s.x,128*s.y);F=E.context;F.clearRect(0,0,E.width,E.height);q.draw(F,{x:0,y:0},s,true,D);var H=E.canvas.toDataURL("image/png");y.SpriteCache.tileChunks[true+" "+q.index+" "+s.y+" "+s.x+" "+D]=_H.loadSprite(H,function(k){});E=_H.defaultCanvas(128*s.x,128*s.y);F=E.context;F.clearRect(0,0,E.width,E.height);q.draw(F,{x:0,y:0},s,false,D);var H=E.canvas.toDataURL("image/png");y.SpriteCache.tileChunks[false+" "+q.index+" "+s.y+" "+s.x+" "+D]=_H.loadSprite(H,function(k){})}sonicManager.CACHING=true}var L={x:0,y:0};E=_H.defaultCanvas(128*s.x,128*s.y);F=E.context;F.clearRect(0,0,E.width,E.height);for(var C=0;C<8;C++){for(var B=0;B<8;B++){var N=q.tilePieces[B][C];var J=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes1[N.Block]];var j=B;var A=C;var O;var M={x:L.x+(j*16)*s.x,y:L.y+(A*16)*s.y};if(J==undefined){continue}if(J==0){}else{if(J==1){if(N.Solid1>0){F.fillStyle=HeightMask.colors[N.Solid1];F.fillRect(L.x+(j*16)*s.x,L.y+(A*16)*s.y,s.x*16,s.y*16)}}else{O=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes1[N.Block]];J.draw(F,M,s,-1,N.XFlip,N.YFlip,N.Solid1,O)}}}}var H=E.canvas.toDataURL("image/png");y.SpriteCache.heightMapChunks[1+" "+q.index+" "+s.y+" "+s.x]=_H.loadSprite(H,function(k){m.hmc++;G()});E=_H.defaultCanvas(128*s.x,128*s.y);F=E.context;F.clearRect(0,0,E.width,E.height);for(var C=0;C<8;C++){for(var B=0;B<8;B++){var N=q.tilePieces[B][C];var J=sonicManager.SonicLevel.HeightMaps[sonicManager.SonicLevel.CollisionIndexes2[N.Block]];var j=B;var A=C;var O;var M={x:L.x+(j*16)*s.x,y:L.y+(A*16)*s.y};if(J==undefined){continue}if(J==0){}else{if(J==1){if(N.Solid2>0){F.fillStyle=HeightMask.colors[N.Solid2];F.fillRect(L.x+(j*16)*s.x,L.y+(A*16)*s.y,s.x*16,s.y*16)}}else{O=sonicManager.SonicLevel.Angles[sonicManager.SonicLevel.CollisionIndexes2[N.Block]];J.draw(F,M,s,-1,N.XFlip,N.YFlip,N.Solid2,O)}}}}var H=E.canvas.toDataURL("image/png");y.SpriteCache.heightMapChunks[2+" "+q.index+" "+s.y+" "+s.x]=_H.loadSprite(H,function(k){m.hmc++;G()})},function(){if(m.tcs>=y.SonicLevel.Chunks.length*2/v&&m.hmc>=y.SonicLevel.Chunks.length*2/v){return true}return false},false);for(var p=0;p<this.SonicLevel.Chunks.length;p++){t.addIterationToStep(f,p)}var u=t.addStep("Sonic Sprites",function(A,k){var j=y.SpriteCache.sonicSprites;j[A]=_H.loadSprite(y.spriteLocations[A],function(B){j[B.tag+s.x+s.y]=_H.scaleSprite(B,s,k)});j[A].tag=A},function(){m.ss++;if(m.ss==y.imageLength){return true}return false},false);y.spriteLocations=[];y.imageLength=0;y.spriteLocations.normal="assets/Sprites/sonic.png";t.addIterationToStep(u,"normal");y.imageLength++;var o;for(o=0;o<4;o++){y.spriteLocations["fastrunning"+o]="assets/Sprites/fastrunning"+o+".png";y.imageLength++;t.addIterationToStep(u,"fastrunning"+o)}for(o=0;o<8;o++){y.spriteLocations["running"+o]="assets/Sprites/running"+o+".png";y.imageLength++;t.addIterationToStep(u,"running"+o)}for(o=0;o<4;o++){y.spriteLocations["breaking"+o]="assets/Sprites/breaking"+o+".png";y.imageLength++;t.addIterationToStep(u,"breaking"+o)}for(o=0;o<5;o++){y.spriteLocations["balls"+o]="assets/Sprites/balls"+o+".png";y.imageLength++;t.addIterationToStep(u,"balls"+o)}for(o=0;o<2;o++){y.spriteLocations["duck"+o]="assets/Sprites/duck"+o+".png";y.imageLength++;t.addIterationToStep(u,"duck"+o)}for(o=0;o<2;o++){y.spriteLocations["hit"+o]="assets/Sprites/hit"+o+".png";y.imageLength++;t.addIterationToStep(u,"hit"+o)}for(o=0;o<6;o++){y.spriteLocations["spindash"+o]="assets/Sprites/spindash"+o+".png";y.imageLength++;t.addIterationToStep(u,"spindash"+o)}for(o=0;o<7;o++){y.spriteLocations["spinsmoke"+o]="assets/Sprites/spinsmoke"+o+".png";y.imageLength++;t.addIterationToStep(u,"spinsmoke"+o)}for(o=0;o<4;o++){y.spriteLocations["haltsmoke"+o]="assets/Sprites/haltsmoke"+o+".png";y.imageLength++;t.addIterationToStep(u,"haltsmoke"+o)}for(o=0;o<2;o++){y.spriteLocations["lookingup"+o]="assets/Sprites/lookingup"+o+".png";y.imageLength++;t.addIterationToStep(u,"lookingup"+o)}var e=t.addStep("Background data",function(C,B){var j=_H.defaultCanvas(y.SonicLevel.BackgroundWidth*128*s.x,y.SonicLevel.BackgroundHeight*128*s.y);var A=j.context;A.clearRect(0,0,j.width,j.height);for(var D=0;D<y.SonicLevel.BackgroundWidth;D++){for(var E=0;E<y.SonicLevel.BackgroundHeight;E++){var k=sonicManager.SonicLevel.Chunks[y.SonicLevel.BGChunkMap[D][E]];if(k){k.draw(A,{x:D*128*s.x,y:E*128*s.y},s,0)}}}y.SpriteCache.bgImage=_H.loadSprite(j.canvas.toDataURL("image/png"),B)},function(){y.background=new ParallaxBG(y.SpriteCache.bgImage,{x:1,y:1});return true},true);t.addIterationToStep(e,0)}}ClickState={Dragging:0,PlaceChunk:1,PlaceRing:2,PlaceObject:3};function SpriteLoader(a,c){var b=this;this.stepIndex=0;this.steps=[];this.done=false;this.tickIndex=0;this.tick=function(){if(this.stepIndex==this.steps.length){if(!this.done){this.done=true;a()}return true}var d=this.steps[this.stepIndex];if(!d){return true}if(b.tickIndex%_H.floor(d.iterations.length/12)==0){c("Caching: "+d.title+" "+Math.floor(((b.tickIndex/d.iterations.length)*100))+"%")}if(d.iterations.length>this.tickIndex){d.method(d.iterations[this.tickIndex++],function(){if(d.finish()){b.stepIndex++;b.tickIndex=0}})}return false};this.addStep=function(g,e,f,d){if(d){return -1}this.steps.push({title:g,method:e,finish:f,iterations:[]});return this.steps.length-1};this.addIterationToStep=function(e,d){if(e==-1){return}this.steps[e].iterations.push(d)}}
/*
* xStats.js
* Copyright 2011-2012 John-David Dalton <http://allyoucanleet.com/>
* Based on Stats.js, copyright Ricardo Cabello <http://mrdoob.com/>
* Available under MIT license <https://github.com/jdalton/xstats.js/raw/master/LICENSE.txt>
*/
(function(B,g){var p=(p=B.performance||B.webkitPerformance||B.console)&&p.memory&&p,d={counter:1,frames:0,lastSecond:null,lastTime:null,data:{fps:new f,ms:new f,mem:new f}},z=[].slice,m=Math.floor,o=Math.max,q=Math.min,w=Math.round;function f(){return l([],{max:null,min:null})}function k(E){var D=this;return(D&&D.constructor!=k)?new k(E):(E instanceof k)?E:l(D,typeof E=="string"?{type:E}:E)}function C(L){var D,F,G,H,J,K,M,O,P,E=d.data,I=this,N={};if(I&&I.constructor!=C){return new C(L)}F=g.createElement("div");O="xstats"+d.counter++;l(I,L||(L={}));I.uid=O;l(N,I);G=I.fps=l(l({},I.fps),L.fps);K=I.ms=l(l({},I.ms),L.ms);J=I.mem=l(l({},I.mem),L.mem);M=I.padding*2;H=I.height-M;P=I.width-M;D=o(1,w(P*0.02));P=m(P/D);N.titleHeight=w(H*0.28);N.barWidth=D+4;N.fontSize=(N.titleHeight/22.2).toFixed(2);N.innerWidth=D*P;N.innerHeight=H-N.titleHeight;N.padding=w((I.width-N.innerWidth)/2);if(E.ms.length<P){E.fps.length=E.ms.length=E.mem.length=P}c(n(".#{uid},.#{uid} .bg,.#{uid} .fg{width:#{width}px;height:#{height}px}.#{uid} .mi{margin:#{padding}px;width:#{innerWidth}px}.#{uid} p{font-size:#{fontSize}em;height:#{titleHeight}px;width:#{innerWidth}px}.#{uid} ul{height:#{innerHeight}px;width:#{innerWidth}px}.#{uid} li{width:#{barWidth}px}",N)+n(".#{uid}.fps{color:#{fg}}.#{uid}.fps ul{background:#{fg}}.#{uid}.fps .bg,.#{uid}.fps li{background:#{bg}}",l(N,G))+n(".#{uid}.ms{color:#{fg}}.#{uid}.ms ul{background:#{fg}}.#{uid}.ms .bg,.#{uid}.ms li{background:#{bg}}",l(N,K))+n(".#{uid}.mem{color:#{fg}}.#{uid}.mem ul{background:#{fg}}.#{uid}.mem .bg,.#{uid}.mem li{background:#{bg}}",l(N,J)));F.className="xstats "+O+" "+I.mode;F.innerHTML="<div class=bg></div><div class=mi><p>&nbsp;</p><ul>"+v("<li></li>",P)+"</ul></div><div class=fg></div>";if(typeof F.addEventListener!="undefined"){F.addEventListener("click",e(I),false)}else{if(F.attachEvent!="undefined"){F.attachEvent("onclick",e(I))}}I.element=F;I.canvas=F.getElementsByTagName("ul")[0];I.title=F.getElementsByTagName("p")[0].firstChild;C.subclasses.push(I)}function a(E,D){E.className+=(E.className?" ":"")+D}function c(D){var E,F="cssText",G=d.sheet;if(!G){E=g.getElementsByTagName("head")[0];G=d.sheet=g.createElement("style");G.type="text/css";E.insertBefore(G,E.firstChild)}if(!(E="styleSheet" in G&&G.styleSheet)){F="nodeValue";E=G.firstChild||G.appendChild(g.createTextNode(""))}E[F]+=D}function h(D,E){var F=-1,G=D.length;while(++F<G){if(E(D[F],F,D)===false){break}}return D}function l(D,F){F||(F={});for(var E in F){D[E]=F[E]}return D}function n(F,E){for(var D in E){F=F.replace(RegExp("#\\{"+D+"\\}","g"),E[D])}return F}function t(G,D){var F,E=G.className.split(" "),H=[];while((F=E.pop())){if(D!=F){H.push(F)}}G.className=H.join(" ")}function v(F,D){if(D<1){return""}if(D%2){return v(F,D-1)+F}var E=v(F,D/2);return E+E}function b(G,E){var F=this,D=F.events||(F.events={});h(G.split(" "),function(H){(D[H]||(D[H]=[])).push(E)});return F}function j(J){var H=this,E=k(J),D=(arguments[0]=E,z.call(arguments)),F=H.events,G=F&&F[E.type]||[],I=true;h(G.slice(),function(K){if(!(I=K.apply(H,D)!==false)){return I}});return I}function u(G,E){var F=this,D=F.events;h(G.split(" "),function(J){var I=D&&D[J]||[],H=indexOf(I,E);if(H>-1){I.splice(H,1)}});return F}function s(F){var E=this,D=E.events;h(F?F.split(" "):D,function(G){(D&&D[G]||[]).length=0});return E}function e(D){return function(){if(!D.locked){var I=D.mode=="fps"?"ms":D.mode=="ms"?(p?"mem":"fps"):"fps",F=D.element,J=D.canvas.childNodes,E=d.data[I],G=E[0],K=J.length,H=K--;D.mode=I;y(D,G&&G.value);while(H--){G=E[K-H];x(D,J[H],G&&G.percent)}t(F,"fps");t(F,"ms");t(F,"mem");a(F,I)}}}function r(E,G){var D=d.data[E],F=q(100,100*(G/(E=="fps"?80:E=="ms"?1000:128)));G=E=="mem"?G.toFixed(2):w(G);D.length=[D.length,D.unshift({value:G,percent:F})][0];G=m(G);D.min=q(D.min!=null?D.min:G,G);D.max=o(D.max!=null?D.max:G,G)}function x(F,G,H){var E=100,D=(E/16)*15,I=(D/100)*H,J=H!=null?(D-I).toFixed(2):E;G.style.height=J+"%"}function y(E,H){var F=E.mode,G=F=="mem"?"MB":F.toUpperCase(),D=d.data[F];E.title.nodeValue=H==null?" ":H+G+" ("+D.min+"-"+D.max+")"}function A(){var D=d.data,E=new Date,F=E-d.lastSecond;if(d.lastTime!=null){d.frames++;r("ms",o(1000/60,E-d.lastTime));if(F>999){r("fps",q(60,1000/(F/d.frames)));p&&r("mem",p.memory.usedJSHeapSize/1048576);d.frames=0;d.lastSecond=E}h(C.subclasses,function(J){var G=J.canvas,I=J.mode,H=D[I][0];if(H&&(I=="ms"||!d.frames)){y(J,H.value);x(J,G.insertBefore(G.lastChild,G.firstChild),H.percent)}})}else{d.lastSecond=E}d.lastTime=E}C.subclasses=[];l(C.prototype,{height:48,width:94,padding:3,locked:false,mode:"fps",on:b,fps:{bg:"#282845",fg:"#1affff"},ms:{bg:"#284528",fg:"#1aff1a"},mem:{bg:"#452831",fg:"#ff1a8d"},addListener:b,emit:j,removeAllListeners:s,removeListener:u});k.prototype.type="";C.Event=k;B.xStats=C;p=p&&!!p.memory.usedJSHeapSize&&p;setInterval(A,1000/60);setInterval(function(){var D=d.data,E=D.fps[0],F=D.mem[0],G=D.ms[0];h(C.subclasses,function(H){H.emit("sample",{fps:E&&E.value,mem:F&&F.value,ms:G&&G.value})})},2000);c(".xstats div{position:absolute;overflow:hidden}.xstats p{margin:0;overflow:hidden;font-family:sans-serif;-webkit-text-size-adjust:100%}.xstats ul{margin:0;padding:0;list-style:none;overflow:hidden}.xstats li{float:right;height:100%;margin-left:-4px}.xstats .bg{opacity:.5;filter:alpha(opacity=50)}.xstats{cursor:pointer;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-o-user-select:none;user-select:none}")}(this,this.document));function Tile(a){this.colors=a;this.sprites=[];this.changeColor=function(c,d,b){this.colors[c][d]=b;this.sprites=[]};this.checkGood=function(e,n,o,q,r,m,k,c){if(this.index[0]!="A"){for(var h=0;h<sonicManager.SonicLevel.Animations.length;h++){var b=sonicManager.SonicLevel.Animations[h];var d=b.AnimationTileIndex;var l=b.NumberOfTiles;if(this.index>=d&&this.index<d+l){if(sonicManager.CACHING){return true}var j=c||((_H.floor(sonicManager.drawTickCount%(b.Frames.length*10)/10)));var g=b.Frames[j];if(!g){g=b.Frames[0]}var f=sonicManager.SonicLevel.AnimatedFiles[b.AnimationFile];var p=f[g.StartingTileIndex+(this.index-d)];if(p){if(e.fillStyle!="rbga(255,255,255,255)"){e.fillStyle="rbga(255,255,255,255)"}p.draw(e,n,o,q,r,m,k,c);return true}}}}return false};this.drawUI=function(b,h,k,l,n,g){for(var d=0;d<this.colors.length;d++){for(var e=0;e<this.colors[d].length;e++){var c=this.colors[d][e];if(c==0){continue}var f=sonicManager.SonicLevel.Palette[g][c];if(b.fillStyle!="#"+f){b.fillStyle="#"+f}if(l){if(n){b.fillRect(h.x+(7-(d))*k.x,h.y+(7-e)*k.y,k.x,k.y)}else{b.fillRect(h.x+(7-(d))*k.x,h.y+(e)*k.y,k.x,k.y)}}else{if(n){b.fillRect(h.x+((d))*k.x,h.y+(7-e)*k.y,k.x,k.y)}else{b.fillRect(h.x+((d))*k.x,h.y+(e)*k.y,k.x,k.y)}}}}};this.draw=function(c,q,r,s,t,p,l,b){if(this.checkGood(c,q,r,s,t,p,l,b)){return}var f;if((f=sonicManager.SpriteCache.tiles[this.index+" "+s+" "+t+" "+p+" "+r.y+" "+r.x])){if(this.index[0]!="A"){c.putImageData(f,q.x,q.y)}else{c.drawImage(f,q.x,q.y)}}else{if(q.x<0||q.y<0){return}_H.save(c);var o={x:q.x,y:q.y};if(s){q.x=-q.x-this.colors.length*r.x;c.scale(-1,1)}if(t){q.y=-q.y-this.colors.length*r.y;c.scale(1,-1)}for(var h=0;h<this.colors.length;h++){for(var k=0;k<this.colors[h].length;k++){var g=this.colors[h][k];if(g==0){continue}var n=sonicManager.SonicLevel.Palette[p][g];if(c.fillStyle!="#"+n){c.fillStyle="#"+n}c.fillRect(q.x+((h))*r.x,q.y+(k)*r.y,r.x,r.y)}}_H.restore(c);q.x=o.x;q.y=o.y;var d=this.colors.length*r.x;var e=this.colors.length*r.y;if(this.index[0]!="A"){sonicManager.SpriteCache.tiles[this.index+" "+s+" "+t+" "+p+" "+r.y+" "+r.x]=c.getImageData(o.x,o.y,d,e)}else{}}}}function TileChunk(a){this.tilePieces=a;this.hLayer=[[]];this.sprites=[];this.getTilePiece=function(b,c){return this.tilePieces[_H.floor((b/16))][_H.floor((c/16))]};this.getBlock=function(b,c){return sonicManager.SonicLevel.Blocks[this.tilePieces[_H.floor((b/16))][_H.floor((c/16))].Block]};this.onlyBackground=function(){for(var b=0;b<this.tilePieces.length;b++){for(var c=0;c<this.tilePieces[b].length;c++){var e=this.tilePieces[b][c];var d=sonicManager.SonicLevel.Blocks[e.Block];if(d){if(!d.onlyBackground()){return false}}}}return true};this.lastAnimatedFrame=0;this.lastAnimatedIndex=0;this.animatedTick=function(){if(this.lastAnimatedFrame==undefined){this.lastAnimatedFrame=0;this.lastAnimatedIndex=0}if(this.animated.Frames[this.lastAnimatedIndex].Ticks==0||(sonicManager.drawTickCount-this.lastAnimatedFrame)>=((this.animated.AutomatedTiming>0)?this.animated.AutomatedTiming:this.animated.Frames[this.lastAnimatedIndex].Ticks)){this.lastAnimatedFrame=sonicManager.drawTickCount;this.lastAnimatedIndex=(this.lastAnimatedIndex+1)%this.animated.Frames.length}};this.draw=function(c,k,m,g,b){if(g==1&&b==undefined&&this.animated!=undefined){b=this.lastAnimatedIndex}var d;if((d=sonicManager.SpriteCache.tileChunks[g+" "+this.index+" "+m.y+" "+m.x+" "+((b!=undefined)?b:"-")])){if(d==1){return false}if(d.loaded){c.drawImage(d,k.x,k.y)}}else{for(var e=0;e<this.tilePieces.length;e++){for(var f=0;f<this.tilePieces[e].length;f++){var l=this.tilePieces[e][f];var h=sonicManager.SonicLevel.Blocks[l.Block];if(h){h.draw(c,{x:k.x+e*16*m.x,y:k.y+f*16*m.y},m,g,l.XFlip,l.YFlip,this.animated,b)}}}}return true}}function TileItem(){this.draw=function(){}}function TilePiece(a,b){this.tiles=b;this.click=function(d,e,c){};this.mouseOver=function(c,d){};this.onlyBackground=function(){for(var c=0;c<this.tiles.length;c++){var d=this.tiles[c];if(sonicManager.SonicLevel.Tiles[d.Tile]){if(d.Priority==true){return false}}}return true};this.drawUI=function(c,g,h,j,k){var d;if(j){if(k){d=[3,2,1,0]}else{d=[1,0,3,2]}}else{if(k){d=[2,3,0,1]}else{d=[0,1,2,3]}}for(var e=0;e<this.tiles.length;e++){var f=this.tiles[e];if(sonicManager.SonicLevel.Tiles[f.Tile]){sonicManager.SonicLevel.Tiles[f.Tile].drawUI(c,{x:g.x+(d[e]%2)*8*h.x,y:g.y+_H.floor(d[e]/2)*8*h.y},h,_H.xor(j,f.XFlip),_H.xor(k,f.YFlip),f.Palette)}}return true};this.draw=function(e,l,m,j,n,o,c,d){var f;if(n){if(o){f=[3,2,1,0]}else{f=[1,0,3,2]}}else{if(o){f=[2,3,0,1]}else{f=[0,1,2,3]}}var g;if((g=sonicManager.SpriteCache.tilePeices[j+" "+this.index+" "+m.y+" "+m.x])){if(g.loaded){e.drawImage(g,l.x,l.y)}}else{for(var h=0;h<this.tiles.length;h++){var k=this.tiles[h];if(sonicManager.SonicLevel.Tiles[k.Tile]){if(k.Priority==j){sonicManager.SonicLevel.Tiles[k.Tile].draw(e,{x:l.x+(f[h]%2)*8*m.x,y:l.y+_H.floor(f[h]/2)*8*m.y},m,_H.xor(n,k.XFlip),_H.xor(o,k.YFlip),k.Palette,j,d)}}}}return true};this.equals=function(d){for(var c=0;c<this.tiles.length;c++){if(d[c]!=this.tiles[c]){return false}}return true}}RotationMode={Floor:134,RightWall:224,Ceiling:314,LeftWall:44};function UiArea(f,g,e,b,c,a){this.x=f;this.y=g;this.manager=c;this.closable=a;this.width=e;this.height=b;this.depth=0;this.visible=true;this.dragging=false;this.controls=[];this.onMove=function(){};this.addControl=function(h){h.parent=this;this.controls.push(h);return h};var d=this;if(a){this.addControl(new Button(this.width-30,4,26,23,"X",this.manager.buttonFont,"Green",function(){d.visible=false}))}this.click=function(j){if(!this.visible){return}for(var k=0;k<this.controls.length;k++){var h=this.controls[k];h.focused=false;if(h.visible&&h.y<=j.y&&h.y+h.height>j.y&&h.x<=j.x&&h.x+h.width>j.x){j.x-=h.x;j.y-=h.y;h.onClick(j);return false}}this.dragging={x:j.x,y:j.y}};this.onKeyDown=function(j){if(!this.visible){return}for(var k=0;k<this.controls.length;k++){var h=this.controls[k];h.onKeyDown(j)}};this.mouseMove=function(j){if(!this.visible){return}if(!this.dragging){for(var k=0;k<this.controls.length;k++){var h=this.controls[k];if(h.visible&&h.y<=j.y&&h.y+h.height>j.y&&h.x<=j.x&&h.x+h.width>j.x){j.x-=h.x;j.y-=h.y;h.onMouseOver(j)}}return}this.x+=j.x-this.dragging.x;this.y+=j.y-this.dragging.y;this.onMove()};this.mouseUp=function(j){if(!this.visible){return}for(var k=0;k<this.controls.length;k++){var h=this.controls[k];h.onMouseUp({x:j.x-h.x,y:j.y-h.y})}this.dragging=false};this.scroll=function(j){if(!this.visible){return}for(var k=0;k<this.controls.length;k++){var h=this.controls[k];if(h.visible&&h.y<=j.y&&h.y+h.height>j.y&&h.x<=j.x&&h.x+h.width>j.x){if(h.onScroll){j.x-=h.x;j.y-=h.y;h.onScroll(j);return false}}}};this.cachedDrawing=null;this.draw=function(l){if(!this.visible){return}var o;var s;var p;if(!this.cachedDrawing){var m=document.createElement("canvas");m.width=this.width+20;m.height=this.height+20;var n=m.getContext("2d");var q=n.createLinearGradient(0,0,0,this.height);q.addColorStop(0,"rgba(220,220,220,0.85)");q.addColorStop(1,"rgba(142,142,142,0.85)");n.fillStyle=q;n.strokeStyle="#333";var h=this.x;var k=this.y;this.x=10;this.y=10;var r=30;roundRect(n,this.x,this.y,this.width,this.height,r,true,true);n.beginPath();n.moveTo(this.x,this.y+r);n.lineTo(this.x+this.width,this.y+r);n.lineWidth=2;n.strokeStyle="#000000";n.stroke();for(p=0;p<this.controls.length;p++){s=this.controls[p];o=s.forceDrawing();if(o.redraw){s.draw(n)}}this.x=h;this.y=k;this.cachedDrawing=_H.loadSprite(m.toDataURL("image/png"))}if(this.cachedDrawing.loaded){l.drawImage(this.cachedDrawing,_H.floor(this.x),_H.floor(this.y));if(this.cachedDrawing.width!=this.width+20||this.cachedDrawing.height!=this.height+20){this.cachedDrawing=null}_H.save(l);l.translate(10,10);for(p=0;p<this.controls.length;p++){s=this.controls[p];o=s.forceDrawing();if(!o.redraw){s.draw(l)}if(o.clearCache){this.cachedDrawing=null}}_H.restore(l)}else{n=l;var q=n.createLinearGradient(0,0,0,this.height);q.addColorStop(0,"rgba(220,220,220,0.85)");q.addColorStop(1,"rgba(142,142,142,0.85)");n.fillStyle=q;n.strokeStyle="#333";var h=this.x;var k=this.y;this.x+=10;this.y+=10;var r=30;roundRect(n,this.x,this.y,this.width,this.height,r,true,true);n.beginPath();n.moveTo(this.x,this.y+r);n.lineTo(this.x+this.width,this.y+r);n.lineWidth=2;n.strokeStyle="#000000";n.stroke();for(p=0;p<this.controls.length;p++){s=this.controls[p];s.draw(l)}this.x=h;this.y=k;_H.restore(l)}};return this}function TextArea(d,e,c,b,a){this.forceDrawing=function(){if((_H.isFunction(this.text)?this.text():this.text)==this.oldText){return{redraw:true,clearCache:false}}this.oldText=_H.isFunction(this.text)?this.text():this.text;return{redraw:true,clearCache:true}};this.x=d;this.oldText="";this.y=e;this.visible=true;this.text=c;this.font=b;this.color=a;this.parent=null;this.onKeyDown=function(f){};this.onClick=function(f){return false};this.onMouseUp=function(f){if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(f){if(this.mouseOver){this.mouseOver()}};this.draw=function(f){if(!this.visible){return}var k=_H.isFunction(this.text)?this.text():this.text;if(f.font!=this.font){f.font=this.font}var l=f.measureText(k).width;var g=parseInt(f.font.split("pt")[0]);var j=3;f.fillStyle=this.color;f.fillText(k,this.parent.x+this.x,this.parent.y+this.y)};return this}function Button(k,l,j,e,h,d,b,a,g,f){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=k;this.y=l;this.visible=true;this.width=j;this.height=e;this.text=h;this.toggle=false;this.toggled=false;this.font=d;this.clicking=false;this.click=a;this.mouseUp=g;this.mouseOver=f;this.color=b;this.parent=null;var c=false;this.button1Grad=null;this.button2Grad=null;this.buttonBorderGrad=null;this.onClick=function(m){if(!this.visible){return}this.clicking=true;if(this.toggle){this.toggled=!this.toggled}};this.onMouseUp=function(m){if(!this.visible){return}if(this.clicking){if(this.click){this.click()}}this.clicking=false;if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(m){if(!this.visible){return}if(this.mouseOver){this.mouseOver()}};this.onKeyDown=function(m){};this.draw=function(m){if(!this.visible){return}if(!c){c=true;this.button1Grad=m.createLinearGradient(0,0,0,1);this.button1Grad.addColorStop(0,"#FFFFFF");this.button1Grad.addColorStop(1,"#dedede");this.button2Grad=m.createLinearGradient(0,0,0,1);this.button2Grad.addColorStop(0,"#dedede");this.button2Grad.addColorStop(1,"#FFFFFF");this.buttonBorderGrad=m.createLinearGradient(0,0,0,1);this.buttonBorderGrad.addColorStop(0,"#AFAFAF");this.buttonBorderGrad.addColorStop(1,"#7a7a7a")}m.strokeStyle=this.buttonBorderGrad;m.fillStyle=this.toggle?(this.toggled?this.button1Grad:this.button2Grad):(this.clicking?this.button1Grad:this.button2Grad);m.lineWidth=2;roundRect(m,this.parent.x+this.x,this.parent.y+this.y,this.width,this.height,2,true,true);if(m.font!=this.font){m.font=this.font}m.fillStyle="#000000";m.fillText((_H.isFunction(this.text)?this.text():this.text),this.parent.x+this.x+((this.width/2)-(m.measureText(this.text).width/2)),this.parent.y+this.y+(this.height/3)*2)};return this}function TextBox(j,k,h,e,f,d,b,g){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=j;this.y=k;this.visible=true;this.width=h;this.textChanged=g;this.height=e;this.text=f;this.font=d;this.clicking=false;this.color=b;this.parent=null;this.cursorPosition=0;this.dragPosition=-1;var c=false;this.focused=false;this.blinked=false;this.blinkTick=0;this.button1Grad=null;this.button2Grad=null;this.buttonBorderGrad=null;this.onKeyDown=function(l){if(l.altKey){return}if(this.focused){if(l.ctrlKey){if(l.keyCode==65){this.dragPosition=0;this.cursorPosition=this.text.length}else{if(l.keyCode==67){}else{if(l.keyCode==88){this.text=this.text.substring(0,Math.min(this.cursorPosition,this.dragPosition))+this.text.substring(Math.max(this.cursorPosition,this.dragPosition),this.text.length);this.cursorPosition=Math.min(this.cursorPosition,this.dragPosition);this.dragPosition=-1}}}}else{if(l.keyCode==37){if(l.shiftKey){if(this.dragPosition==-1){this.dragPosition=this.cursorPosition}this.cursorPosition=Math.max(this.cursorPosition-1,0)}else{this.dragPosition=-1;this.cursorPosition=Math.max(this.cursorPosition-1,0)}}else{if(l.keyCode==39){if(l.shiftKey){if(this.dragPosition==-1){this.dragPosition=this.cursorPosition}this.cursorPosition=Math.min(this.cursorPosition+1,this.text.length)}else{this.dragPosition=-1;this.cursorPosition=Math.min(this.cursorPosition+1,this.text.length)}}else{if(l.keyCode==8){if(this.dragPosition==-1){this.text=this.text.substring(0,this.cursorPosition-1)+this.text.substring(this.cursorPosition,this.text.length)}else{this.text=this.text.substring(0,Math.min(this.cursorPosition,this.dragPosition))+this.text.substring(Math.max(this.cursorPosition,this.dragPosition),this.text.length)}if(this.dragPosition==-1){if(this.cursorPosition>0){this.cursorPosition--}}else{this.cursorPosition=Math.min(this.cursorPosition,this.dragPosition)}}else{if(l.keyCode==46){if(this.dragPosition==-1){this.text=this.text.substring(0,this.cursorPosition)+this.text.substring(Math.min(this.cursorPosition+1,this.text.length),this.text.length)}else{this.text=this.text.substring(0,Math.min(this.cursorPosition,this.dragPosition))+this.text.substring(Math.max(this.cursorPosition,this.dragPosition),this.text.length)}if(this.dragPosition==-1){}else{this.cursorPosition=Math.min(this.cursorPosition,this.dragPosition)}}else{var m=String.fromCharCode(l.keyCode);if(this.dragPosition==-1){this.text=this.text.substring(0,this.cursorPosition)+m+this.text.substring(this.cursorPosition,this.text.length)}else{this.text=this.text.substring(0,Math.min(this.cursorPosition,this.dragPosition))+m+this.text.substring(Math.max(this.cursorPosition,this.dragPosition),this.text.length)}if(this.dragPosition==-1){this.cursorPosition++}else{this.cursorPosition=Math.max(this.cursorPosition,this.dragPosition)}}}this.dragPosition=-1}}}if(this.textChanged){this.textChanged()}l.preventDefault()}};var a;this.onClick=function(l){if(!this.visible){return}this.clicking=true;this.focused=true;for(var m=0;m<this.text.length;m++){this.dragPosition=-1;var n=a.measureText(this.text.substring(0,m)).width;if(n>l.x-14){this.cursorPosition=m;return}}this.cursorPosition=this.text.length};this.onMouseUp=function(l){if(!this.visible){return}if(this.clicking){}this.clicking=false;if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(l){if(!this.visible){return}if(this.clicking){if(this.dragPosition==-1){this.dragPosition=this.cursorPosition}for(var m=0;m<this.text.length;m++){var n=a.measureText(this.text.substring(0,m)).width;if(n>l.x-14){this.cursorPosition=m;return}}this.cursorPosition=this.text.length}if(this.mouseOver){this.mouseOver()}};this.draw=function(l){if(!this.visible){return}if(!this.focused){this.cursorPosition=-1;this.dragPosition=-1}a=l;if(!c){c=true;this.button1Grad=l.createLinearGradient(0,0,0,1);this.button1Grad.addColorStop(0,"#FFFFFF");this.button1Grad.addColorStop(1,"#dedede");this.button2Grad=l.createLinearGradient(0,0,0,1);this.button2Grad.addColorStop(0,"#dedede");this.button2Grad.addColorStop(1,"#FFFFFF");this.buttonBorderGrad=l.createLinearGradient(0,0,0,1);this.buttonBorderGrad.addColorStop(0,"#AFAFAF");this.buttonBorderGrad.addColorStop(1,"#7a7a7a")}l.strokeStyle=this.buttonBorderGrad;l.fillStyle=this.clicking?this.button1Grad:this.button2Grad;l.lineWidth=2;roundRect(l,this.parent.x+this.x,this.parent.y+this.y,this.width,this.height,2,true,true);if(l.font!=this.font){l.font=this.font}if(this.dragPosition!=-1){l.fillStyle="#598AFF";var n=l.measureText(this.text.substring(0,Math.min(this.dragPosition,this.cursorPosition))).width;var o=l.measureText(this.text.substring(0,Math.max(this.dragPosition,this.cursorPosition))).width;l.fillRect(this.parent.x+this.x+8+n,this.parent.y+this.y+3,o-n,(this.height-7))}l.fillStyle="#000000";l.fillText(this.text,this.parent.x+this.x+8,this.parent.y+this.y+(this.height/3)*2);if(this.focused&&((this.blinkTick++%35)==0)){this.blinked=!this.blinked}if(this.focused&&this.blinked){l.strokeStyle="#000000";var m=l.measureText(this.text.substring(0,this.cursorPosition)).width;l.beginPath();l.moveTo(this.parent.x+this.x+8+m,this.parent.y+this.y+3);l.lineTo(this.parent.x+this.x+8+m,this.parent.y+this.y+(this.height-7));l.lineWidth=2;l.stroke()}};return this}function ColorEditingArea(b,c,a){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.lastPosition=null;this.x=b;this.y=c;this.showHurtMap=false;this.showCollideMap=false;this.editable=true;this.visible=true;this.scale=a;this.clicking=false;this.paletteEditor=null;this.parent=null;this.click=undefined;this.init=function(d){d.width;this.frame=d;this.width=this.scale.x*d.width;this.height=this.scale.y*d.height;this.editor=new Editor(d)};this.onClick=function(d){if(!this.visible){return}if(!this.editor){return}this.clicking=true;this.clickHandled=false;var f={x:_H.floor(d.x/this.scale.x),y:_H.floor(d.y/this.scale.y)};if(!this.editable){if(this.click){this.click(f)}}else{this.lastPosition=f;if(this.paletteEditor){this.editor.currentColor=this.paletteEditor.selectedIndex}this.editor.drawPixel(f)}};this.onKeyDown=function(d){};this.onMouseUp=function(d){if(!this.visible){return}this.lastPosition=null;this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(d){if(!this.editor){return}var f={x:_H.floor(d.x/this.scale.x),y:_H.floor(d.y/this.scale.y)};if(this.clicking){if(!this.editable){if(this.click){this.click(f)}}else{this.clickHandled=true;this.editor.drawLine(f,this.lastPosition);this.lastPosition=f}}};this.draw=function(d){if(!this.visible){return}if(!this.editor){return}var e={x:this.parent.x+this.x,y:this.parent.y+this.y};this.editor.draw(d,e,this.scale,this.showCollideMap,this.showHurtMap)};return this}function Panel(d,e,c,b,a){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=d;this.y=e;this.area=a;this.width=c;this.height=b;this.parent=null;this.visible=true;this.controls=[];this.addControl=function(f){f.parent=this;this.controls.push(f);return f};this.outline=true;this.empty=function(){for(var g=0;g<this.controls.length;g++){var f=this.controls[g];f.parent=null}this.controls=[]};this.onClick=function(g){if(!this.visible){return}for(var h=0;h<this.controls.length;h++){var f=this.controls[h];f.focused=false;if(f.visible&&f.y<=g.y&&f.y+f.height>g.y&&f.x<=g.x&&f.x+f.width>g.x){g.x-=f.x;g.y-=f.y;f.onClick(g);return false}}};this.onKeyDown=function(g){if(!this.visible){return}for(var h=0;h<this.controls.length;h++){var f=this.controls[h];f.onKeyDown(g)}};this.onMouseOver=function(g){if(!this.visible){return}for(var h=0;h<this.controls.length;h++){var f=this.controls[h];if(f.visible&&f.y<=g.y&&f.y+f.height>g.y&&f.x<=g.x&&f.x+f.width>g.x){g.x-=f.x;g.y-=f.y;f.onMouseOver(g)}}};this.onMouseUp=function(g){if(!this.visible){return}for(var h=0;h<this.controls.length;h++){var f=this.controls[h];f.onMouseUp({x:g.x-f.x,y:g.y-f.y})}};this.onScroll=function(g){if(!this.visible){return}for(var h=0;h<this.controls.length;h++){var f=this.controls[h];if(f.visible&&f.y<=g.y&&f.y+f.height>g.y&&f.x<=g.x&&f.x+f.width>g.x){if(f.onScroll){g.x-=f.x;g.y-=f.y;f.onScroll(g);return false}}}};this.cachedDrawing=null;this.draw=function(h){if(!this.visible){return}var n;var k;var f=this.x;var g=this.y;this.x+=this.parent.x;this.y+=this.parent.y;if(this.outline){var l=h.createLinearGradient(0,0,0,this.height);l.addColorStop(0,"rgba(220,220,220,0.85)");l.addColorStop(1,"rgba(142,142,142,0.85)");h.fillStyle=l;h.strokeStyle="#333";var m=5;roundRect(h,this.x,this.y,this.width,this.height,m,true,true)}for(k=0;k<this.controls.length;k++){n=this.controls[k];n.draw(h)}this.x=f;this.y=g};return this}function PaletteArea(c,d,a,b){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.showCurrent=b;this.x=c;this.y=d;this.visible=true;this.scale=a;this.clicking=false;this.selectedIndex=0;this.parent=null;this.wide=false;this.init=function(e,f){this.wide=f;if(!f){this.width=this.scale.x*2;this.height=this.scale.y*e.length/2}else{this.width=this.scale.x*e.length/2;this.height=this.scale.y*2}this.palette=e};this.onClick=function(h){if(!this.visible){return}this.clicking=true;this.clickHandled=false;var f=_H.floor(h.x/a.x);var g=_H.floor(h.y/a.y);if(this.wide){this.selectedIndex=g*palette.length/2+f}else{this.selectedIndex=g*2+f}};this.onKeyDown=function(f){};this.onMouseUp=function(f){if(!this.visible){return}this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(h){if(this.clicking){var f=_H.floor(h.x/a.x);var g=_H.floor(h.y/a.y);if(this.wide){this.selectedIndex=g*palette.length/2+f}else{this.selectedIndex=g*2+f}}};this.draw=function(e){if(!this.visible){return}if(!this.palette){return}e.strokeStyle="#000";e.lineWidth=1;var k={x:this.parent.x+this.x,y:this.parent.y+this.y};if(this.wide){var g=_H.floor(this.palette.length/2);for(var j=0;j<2;j++){for(var l=0;l<g;l++){e.fillStyle=this.palette[l+j*g];e.fillRect(k.x+l*this.scale.x,k.y+j*this.scale.y,this.scale.x,this.scale.y);e.strokeRect(k.x+l*this.scale.x,k.y+j*this.scale.y,this.scale.x,this.scale.y)}}if(this.showCurrent){e.fillStyle=this.palette[this.selectedIndex];e.fillRect(k.x,k.y+g*this.scale.y,this.scale.x*2,this.scale.y*2);e.strokeRect(k.x,k.y+g*this.scale.y,this.scale.x*2,this.scale.y*2)}}else{var g=_H.floor(this.palette.length/2);for(var j=0;j<g;j++){for(var l=0;l<2;l++){e.fillStyle=this.palette[l+j*2];e.fillRect(k.x+l*this.scale.x,k.y+j*this.scale.y,this.scale.x,this.scale.y);e.strokeRect(k.x+l*this.scale.x,k.y+j*this.scale.y,this.scale.x,this.scale.y)}}if(this.showCurrent){e.fillStyle=this.palette[this.selectedIndex];e.fillRect(k.x,k.y+g*this.scale.y,this.scale.x*2,this.scale.y*2);e.strokeRect(k.x,k.y+g*this.scale.y,this.scale.x*2,this.scale.y*2)}}};return this}function TilePieceArea(d,e,a,c,b){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=d;this.y=e;this.visible=true;this.scale=a;this.width=a.x*16;this.height=a.y*17;this.clicking=false;this.tilePiece=c;this.parent=null;this.state=b;this.onClick=function(f){if(!this.visible){return}this.clicking=true;this.clickHandled=false};this.onKeyDown=function(f){};this.onMouseUp=function(f){if(!this.visible){return}if(this.tilePiece&&this.clicking&&!this.clickHandled){this.tilePiece.click(_H.floor(f.x/a.x),_H.floor(f.y/a.y),this.state)}this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(f){if(!this.tilePiece){return}if(this.clicking){this.clickHandled=true;this.tilePiece.click(_H.floor(f.x/a.x),_H.floor(f.y/a.y),this.state)}else{this.tilePiece.mouseOver(_H.floor(f.x/a.x),_H.floor(f.y/a.y))}};this.draw=function(f){if(!this.visible){return}if(!this.tilePiece){return}this.tilePiece.tag=true;if(!this.tpc){return}var j={x:this.parent.x+this.x,y:this.parent.y+this.y};this.tilePiece.drawUI(f,j,this.scale,this.tpc.XFlip,this.tpc.YFlip);if(sonicManager.showHeightMap){var h=(sonicManager.SonicLevel.curHeightMap?sonicManager.SonicLevel.CollisionIndexes1:sonicManager.SonicLevel.CollisionIndexes2);var g=sonicManager.SonicLevel.HeightMaps[h[this.tpc.Block]];if(g!=0&&g!=1){g.drawUI(f,j,this.scale,0,this.tpc.XFlip,this.tpc.YFlip,sonicManager.SonicLevel.curHeightMap?this.tpc.Solid1:this.tpc.Solid2,sonicManager.SonicLevel.Angles[h[this.tpc.Block]])}}this.tilePiece.tag=false};return this}function TileBGEditArea(b,c,a){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=b;this.y=c;this.visible=true;this.clicking=false;this.parallaxBG=a;this.parent=null;this.lowestClickedY=-1;this.highestClickedY=-1;this.onClick=function(f){if(!this.visible){return}this.clicking=true;this.parallaxBG=sonicManager.background;if(f.x>0&&f.y>0&&f.y<this.parallaxBG.height&&f.x<this.parallaxBG.width){var d;if((d=this.parallaxBG.onBar(f.x,f.y))){this.lowestClickedY=d.top;this.highestClickedY=d.bottom}else{this.lowestClickedY=f.y;this.highestClickedY=f.y}}this.clickHandled=false};this.onKeyDown=function(d){};this.onMouseUp=function(d){if(!this.visible){return}this.parallaxBG=sonicManager.background;this.highestClickedY=-1;this.lowestClickedY=-1;this.clickHandled=false;this.clicking=false};this.clickHandled=false;this.onMouseOver=function(d){if(!this.clicking){return}this.parallaxBG=sonicManager.background;if(d.x>0&&d.y>0&&d.y<this.parallaxBG.height&&d.x<this.parallaxBG.width){if(d.y>this.highestClickedY){this.highestClickedY=d.y}if(d.y<this.lowestClickedY){this.lowestClickedY=d.y}for(var f=this.lowestClickedY;f<this.highestClickedY;f++){this.parallaxBG.click(d.x,f)}}return false};this.draw=function(d){if(!this.visible){return}this.parallaxBG=sonicManager.background;if(!this.parallaxBG){return}this.width=this.parallaxBG.width;this.height=this.parallaxBG.height;this.parent.width=this.width+70;this.parent.height=this.height+50;var e={x:1,y:1};this.parallaxBG.drawUI(d,{x:this.parent.x+this.x,y:this.parent.y+this.y},e)};return this}function TileChunkArea(d,e,a,c,b){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=d;this.y=e;this.visible=true;this.scale=a;this.width=a.x*128;this.height=a.y*128;this.clicking=false;this.tileChunk=c;this.parent=null;this.state=b;this.setToTile=null;this.onClick=function(f){if(!this.visible){return}this.clicking=true};this.onMouseUp=function(f){if(!this.visible){return}if(this.clicking){if(this.setToTile!=null){this.tileChunk.tilePieces[((_H.floor(f.x/this.scale.x/16)))][(_H.floor(f.y/this.scale.y/16))]=sonicManager.SonicLevel.Blocks.indexOf(this.setToTile);this.tileChunk.sprites=[]}}this.clickHandled=false;this.clicking=false};this.onKeyDown=function(f){};this.clickHandled=false;this.onMouseOver=function(f){if(this.clicking){}};this.draw=function(f){if(!this.visible){return}if(!this.tileChunk){return}this.tileChunk.draw(f,{x:this.parent.x+this.x,y:this.parent.y+this.y},this.scale,true)};return this}function ScrollBox(h,j,c,g,d,a,b){this.forceDrawing=function(){return{redraw:false,clearCache:false}};this.x=h;this.y=j;this.itemWidth=d;this.visible=true;var f=14;this.width=d+f;this.visibleItems=g;this.itemHeight=c;this.backColor=a;var e=5;this.height=g*(c+e);this.parent=null;this.scrollOffset=0;this.scrollPosition=0;this.dragging=false;if(b){this.controls=b}else{this.controls=[]}this.scrolling=false;this.addControl=function(k){k.parent=this;this.controls.push(k);return k};this.onClick=function(l){if(!this.visible){return}for(var n=this.scrollOffset;n<this.controls.length;n++){var k=this.controls[n];if(k.y<=l.y&&k.y+k.height>l.y&&k.x<=l.x&&k.x+k.width>l.x){l.x-=k.x;l.y-=k.y;k.onClick(l);return false}}if(l.x>this.itemWidth&&l.x<this.itemWidth+f){var m=this.visibleItems*(this.itemHeight+e)-2;this.scrollOffset=_H.floor((l.y/m)*(this.controls.length-this.visibleItems));this.scrollOffset=Math.min(Math.max(this.scrollOffset,0),this.controls.length)}this.dragging=true;return false};this.onKeyDown=function(k){};this.onMouseUp=function(l){if(!this.visible){return}this.dragging=false;for(var m=this.scrollOffset;m<this.controls.length;m++){var k=this.controls[m];if(k.y<=l.y&&k.y+k.height>l.y&&k.x<=l.x&&k.x+k.width>l.x){l.x-=k.x;l.y-=k.y;k.onMouseUp(l);return false}}if(this.mouseUp){this.mouseUp()}};this.onMouseOver=function(l){if(!this.visible){return}for(var n=0;n<this.controls.length;n++){var k=this.controls[n];if(k.y<=l.y&&k.y+k.height>l.y&&k.x<=l.x&&k.x+k.width>l.x){l.x-=k.x;l.y-=k.y;k.onMouseOver(l);break}}if(this.dragging&&l.x>this.itemWidth&&l.x<this.itemWidth+f){var m=this.visibleItems*(this.itemHeight+e)-2;this.scrollOffset=_H.floor((l.y/m)*(this.controls.length-this.visibleItems));this.scrollOffset=Math.min(Math.max(this.scrollOffset,0),this.controls.length)}if(this.mouseOver){this.mouseOver()}};this.onScroll=function(l){if(!this.visible){return}if(l.delta>0){if(this.scrollOffset>0){this.scrollOffset--}}else{if(this.scrollOffset<this.controls.length-this.visibleItems){this.scrollOffset++}}for(var m=0;m<this.controls.length;m++){var k=this.controls[m];if(k.y<=l.y&&k.y+k.height>l.y&&k.x<=l.x&&k.x+k.width>l.x){l.x-=k.x;l.y-=k.y;if(k.onScroll){k.onScroll(l)}return false}}if(this.scroll){this.scroll()}};this.draw=function(k){if(!this.visible){return}k.fillStyle=this.backColor;var n;var m=this.visibleItems*(this.itemHeight+e)-2;k.fillStyle=this.backColor;k.lineWidth=1;k.strokeStyle="#333";roundRect(k,this.parent.x+this.x,this.parent.y+this.y,this.itemWidth+f+6,this.visibleItems*(this.itemHeight+e),3,true,true);k.fillStyle="grey";k.lineWidth=1;k.strokeStyle="#444";k.fillRect(this.parent.x+this.x+this.itemWidth+2+2,this.parent.y+this.y+2,f,m);k.fillStyle="FFDDFF";k.lineWidth=1;k.strokeStyle="#FFDDFF";this.scrollPosition=m*this.scrollOffset/(this.controls.length-this.visibleItems);k.fillRect(this.parent.x+this.x+this.itemWidth+2+2+2,this.parent.y+this.y+2+(this.scrollPosition),f-2,5);var l=3;for(n=this.scrollOffset;n<Math.min(this.controls.length,this.scrollOffset+this.visibleItems);n++){this.controls[n].parent={x:this.parent.x+this.x,y:this.parent.y+this.y};this.controls[n].x=2;this.controls[n].y=l;this.controls[n].height=this.itemHeight;this.controls[n].width=this.itemWidth;l+=this.itemHeight+e;this.controls[n].draw(k)}};return this}function roundRect(a,g,h,f,c,d,b,e){if(typeof e=="undefined"){e=true}if(typeof d==="undefined"){d=5}a.lineWidth=3;a.beginPath();a.moveTo(g+d,h);a.lineTo(g+f,h);a.lineTo(g+f,h+c);a.lineTo(g,h+c);a.lineTo(g,h+d);a.quadraticCurveTo(g,h,g+d,h);a.closePath();if(e){a.stroke()}if(b){a.fill()}}function UIManager(D,p,y){this.UIAreas=[];this.messages=[];function x(){l.visible=false;C.visible=false;k.visible=false;r.visible=false;s.visible=false;C.visible=false;h.visible=true;if(D.background){D.background.cache(D.scale)}D.windowLocation=_H.defaultWindowLocation(0,p,y);D.sonicToon=new Sonic(D.SonicLevel,D.scale);D.sonicToon.obtainedRing=[]}var F=this.textFont="18pt Calibri ";var B=this.smallTextFont="12pt Calibri ";var c=this.buttonFont="13pt Arial bold";var A=this.smallButtonFont="11pt Arial bold";p.font=F;var j=this.indexes={tpIndex:0,modifyIndex:0,modifyTPIndex:0};this.dragger=new Dragger(function(H,I){D.windowLocation.x+=H;D.windowLocation.y+=I});this.draw=function(I){this.dragger.tick();_H.save(I);var J=JSLINQ(this.UIAreas).OrderBy(function(M){return M.depth});for(var L=0;L<J.items.length;L++){var H=J.items[L];H.draw(I)}if(DEBUGs){for(var K=0;K<this.messages.length;K++){I.fillText(this.messages[K],10,25+K*30)}}_H.restore(I)};this.onMouseScroll=function(J){var I=J.wheelDelta?J.wheelDelta/40:J.detail?-J.detail:0;for(var K=0;K<this.UIAreas.length;K++){var H=this.UIAreas[K];if(H.visible&&H.y<=J.y&&H.y+H.height>J.y&&H.x<=J.x&&H.x+H.width>J.x){J={x:J.x-H.x-10,y:J.y-H.y-10,delta:I};return H.scroll(J)}}return false};this.onClick=function(K){var I=_H.getCursorPosition(K);I.x-=10;I.y-=10;var M=null;var H;var N;var J=JSLINQ(this.UIAreas).OrderBy(function(O){return -O.depth});for(var N=0;N<J.items.length;N++){var H=J.items[N];if(H.visible&&H.y<=I.y&&H.y+H.height>I.y&&H.x<=I.x&&H.x+H.width>I.x){M=H;var L={x:I.x-H.x,y:I.y-H.y};H.click(L);break}}if(M){for(N=0;N<this.UIAreas.length;N++){H=this.UIAreas[N];if(M==H){H.depth=1}else{H.depth=0}}return true}return false};this.onMouseMove=function(K){if(this.dragger.isDragging()){this.dragger.mouseMove(K);return false}var I=_H.getCursorPosition(K);I.x-=10;I.y-=10;var J=JSLINQ(this.UIAreas).OrderBy(function(M){return -M.depth});for(var L=0;L<J.items.length;L++){var H=J.items[L];if(H.dragging||(H.visible&&H.y<=I.y&&H.y+H.height>I.y&&H.x<=I.x&&H.x+H.width>I.x)){I={x:I.x-H.x,y:I.y-H.y};return H.mouseMove(I)}}this.dragger.mouseMove(K);return false};this.onMouseUp=function(J){var I=_H.getCursorPosition(J,true);I.x-=10;I.y-=10;for(var L=0;L<this.UIAreas.length;L++){var H=this.UIAreas[L];var K={x:I.x-H.x,y:I.y-H.y};H.mouseUp(K)}this.dragger.mouseUp(J)};this.onKeyDown=function(I){for(var J=0;J<this.UIAreas.length;J++){var H=this.UIAreas[J];H.onKeyDown(I)}};var G=function(H){document.title=H+" | Our Sonic";g=H};var z=40*4;var v=this.objectFrameworkArea=new UiArea(540,75,850,690,this,true);v.visible=true;this.UIAreas.push(v);v.addControl(new TextArea(30,25,"Object Framework",F,"blue"));v.addControl(new TextArea(45,60,"Assets",F,"black"));v.addControl(new Button(160,38,140,25,"Add Asset",c,"rgb(50,150,50)",function(){v.objectFramework.assets.push(new LevelObjectAsset("Asset "+(v.objectFramework.assets.length+1)));v.populate(v.objectFramework)}));v.addControl(v.assets=new ScrollBox(30,60+10,25,4,250,"rgb(50,60,127)"));v.addControl(new TextArea(45,60+(z*1),"Pieces",F,"black"));v.addControl(new Button(160,38+(z*1),140,25,"Add Piece",c,"rgb(50,150,50)",function(){v.objectFramework.pieces.push(new LevelObjectPiece("Piece "+(v.objectFramework.pieces.length+1)));v.populate(v.objectFramework)}));v.addControl(v.pieces=new ScrollBox(30,60+(z*1)+10,25,4,250,"rgb(50,60,127)"));v.addControl(new TextArea(45,60+(z*2),"Projectiles",F,"black"));v.addControl(new Button(160,38+(z*2),140,25,"Add Projectile",c,"rgb(50,150,50)",function(){v.objectFramework.projectiles.push(new LevelProjectile("Projectile "+(v.objectFramework.projectiles.length+1)));v.populate(v.objectFramework)}));v.addControl(v.projectiles=new ScrollBox(30,60+(z*2)+10,25,4,250,"rgb(50,60,127)"));v.addControl(new TextArea(45,60+(z*3),"Paths",F,"black"));v.addControl(new Button(160,38+(z*3),140,25,"Add Path",c,"rgb(50,150,50)",function(){v.objectFramework.paths.push(new LevelObjectPath("Path "+(v.objectFramework.paths.length+1)));v.populate(v.objectFramework)}));v.addControl(v.paths=new ScrollBox(30,60+(z*3)+10,25,4,250,"rgb(50,60,127)"));v.addControl(new TextArea(320,80-20,"Key: ",F,"black"));v.addControl(v.key=new TextBox(370,60-20,459,25,"",c,"rgb(50,150,50)",function(){v.objectFramework.key=this.text}));v.onMove=function(){if(!d){return}d.style.left=(this.x+320+20)+"px";d.style.top=(this.y+150+20)+"px"};var d;v.addControl(new Button(320,95-20,250,25,"onInit",c,"rgb(50,150,50)",function(){v.clearMainArea();$(document.body).append('<textarea id="code" name="code" style="position:absolute;width:485px;height:485px;"></textarea>');d=document.getElementById("code");d.value=v.objectFramework.initScript;v.onMove()}));v.clearMainArea=function(){v.mainPanel.controls=[];d=document.getElementById("code");if(d){d.parentNode.removeChild(d)}};v.addControl(new Button(580,95-20,250,25,"onTick",c,"rgb(50,150,50)",function(){}));v.addControl(new Button(320,130-20,250,25,"onCollide",c,"rgb(50,150,50)",function(){}));v.addControl(new Button(580,130-20,250,25,"onHurtSonic",c,"rgb(50,150,50)",function(){}));v.addControl(new Button(580,130-20,250,25,"onHurtSonic",c,"rgb(50,150,50)",function(){}));v.addControl(v.mainPanel=new Panel(320,150,510,510,v));v.loadAsset=function(H){v.clearMainArea();v.mainPanel.addControl(new TextArea(25,25,"Name: ",F,"black"));v.mainPanel.addControl(new TextBox(100,5,290,25,H.name,c,"rgb(50,150,50)",function(){H.name=this.text}));v.mainPanel.addControl(new Button(400,5,100,25,"Add Frame",c,"rgb(50,150,50)",function(){var L;H.frames.push(L=new LevelObjectAssetFrame("Frame "+(H.frames.length+1)));L.palette=["000","111","222","333","444","555","666","777","888","999","AAA","BBB","CCC","DDD","EEE","FFF"];L.width=Math.floor(Math.random()*40)+20;L.height=Math.floor(Math.random()*40)+20;for(var J=0;J<L.width;J++){L.colorMap[J]=[];for(var K=0;K<L.height;K++){L.colorMap[J][K]=Math.floor(Math.random()*L.palette.length)}}v.mainPanel.populate(H)}));var I;v.mainPanel.addControl(I=new ScrollBox(20,35,25,3,460,"rgb(50,60,127)"));v.mainPanel.populate=function(J){I.controls=[];for(var K=0;K<J.frames.length;K++){I.addControl(bd=new Button(0,0,0,0,function(){return this.state.name},"10pt Arial","rgb(50,190,90)",function(){v.mainPanel.loadFrame(this.state)}));bd.state=J.frames[K]}};v.mainPanel.populate(H);v.mainPanel.addControl(v.mainPanel.frameArea=new Panel(7,155,480,350,v));v.mainPanel.frameArea.outline=false;v.mainPanel.loadFrame=function(L){v.mainPanel.frameArea.controls=[];var K;v.mainPanel.frameArea.addControl(new TextArea(15,15,"Name: ",F,"black"));v.mainPanel.frameArea.addControl(new TextBox(90,0,395,25,L.name,c,"rgb(50,150,50)",function(){L.name=this.text}));v.mainPanel.frameArea.addControl(new TextArea(0,275,function(){return"Width:  "+L.width},B,"Black"));v.mainPanel.frameArea.addControl(new Button(75,275-25,14,17,"^",c,"rgb(50,150,50)",function(){L.width=Math.min(L.width+1,100)}));v.mainPanel.frameArea.addControl(new Button(75,275-5,14,20,"v",c,"rgb(50,150,50)",function(){L.width=Math.max(L.width-1,1)}));v.mainPanel.frameArea.addControl(new TextArea(0,320,function(){return"Height: "+L.height},B,"Black"));v.mainPanel.frameArea.addControl(new Button(75,320-25,14,17,"^",c,"rgb(50,150,50)",function(){L.height=Math.min(L.height+1,100)}));v.mainPanel.frameArea.addControl(new Button(75,320-5,14,20,"v",c,"rgb(50,150,50)",function(){L.height=Math.max(L.height-1,1)}));var J;v.mainPanel.frameArea.addControl(J=new Button(230-55,35,150,25,"Collide Map",c,"rgb(50,150,50)",function(){K.showCollideMap=this.toggled}));J.toggle=true;v.mainPanel.frameArea.addControl(J=new Button(390-55,35,150,25,"Hurt Map",c,"rgb(50,150,50)",function(){K.showHurtMap=this.toggled}));J.toggle=true;v.mainPanel.frameArea.addControl(K=new ColorEditingArea(230-55,65,{x:(310/L.width),y:(225/L.height)}));K.init(L);K.editor.showOutline=false;K.editable=false;K.click=function(N){L.offsetX=N.x;L.offsetY=N.y};var M;v.mainPanel.frameArea.addControl(M=new PaletteArea(230-55,300,{x:39,y:11},false));M.init(L.palette,true);v.mainPanel.frameArea.addControl(new Button(230-55,305+11*2,310,25,"Edit Map",c,"rgb(50,150,50)",function(){e.init(L);e.visible=true;e.depth=v.depth+1}))}};v.populate=function(J){this.objectFramework=J;this.key.text=J.key;this.assets.controls=[];var H;for(var I=0;I<J.assets.length;I++){this.assets.addControl(H=new Button(0,0,0,0,function(){return this.state.name},"10pt Arial","rgb(50,190,90)",function(){v.loadAsset(this.state)}));H.state=J.assets[I]}this.pieces.controls=[];for(var I=0;I<J.pieces.length;I++){this.pieces.addControl(H=new Button(0,0,0,0,function(){return this.state.name},"10pt Arial","rgb(50,190,90)",function(){v.loadPiece(this.state)}));H.state=J.assets[I]}this.paths.controls=[];for(var I=0;I<J.paths.length;I++){this.paths.addControl(H=new Button(0,0,0,0,function(){return this.state.name},"10pt Arial","rgb(50,190,90)",function(){v.loadPath(this.state)}));H.state=J.assets[I]}this.projectiles.controls=[];for(var I=0;I<J.projectiles.length;I++){this.projectiles.addControl(H=new Button(0,0,0,0,function(){return this.state.name},"10pt Arial","rgb(50,190,90)",function(){v.loadPiece(this.state)}));H.state=J.assets[I]}};var e=this.colorEditorArea=new UiArea(650,30,960,800,this,true);e.visible=false;this.UIAreas.push(e);e.addControl(e.colorEditor=new ColorEditingArea(30,45,{x:11,y:11}));e.addControl(new Button(770,70,150,22,"Show Outline",c,"rgb(50,150,50)",function(){e.colorEditor.editor.showOutline=!e.colorEditor.editor.showOutline}));e.addControl(new TextArea(750,150,function(){return"Line Width:"+e.colorEditor.editor.lineWidth},F,"Black"));e.addControl(new Button(900,120,14,20,"^",c,"rgb(50,150,50)",function(){e.colorEditor.editor.lineWidth=Math.max(e.colorEditor.editor.lineWidth+1,1)}));e.addControl(new Button(900,145,14,20,"v",c,"rgb(50,150,50)",function(){e.colorEditor.editor.lineWidth=Math.min(e.colorEditor.editor.lineWidth-1,10)}));e.addControl(e.paletteArea=new PaletteArea(770,250,{x:45,y:45},true));e.colorEditor.paletteEditor=e.paletteArea;e.init=function(H){e.colorEditor.scale={x:700/H.width,y:700/H.height};e.colorEditor.init(H);e.paletteArea.init(H.palette,false)};var w=this.objectInfoArea=new UiArea(1347,95,250,240,this,true);w.visible=false;this.UIAreas.push(w);w.addControl(new TextArea(30,25,"Object Information",F,"blue"));w.addControl(new Button(40,190,60,22,"Framework",c,"rgb(50,150,50)",function(){objectArea.visible=true;objectArea.objectFramework=objectArea.object.Framwork}));var h=this.debuggerArea=new UiArea(1347,95,250,240,this,true);h.visible=false;this.UIAreas.push(h);h.addControl(new TextArea(30,25,"Debugger",F,"blue"));h.addControl(new Button(40,60,60,22,"Stop",c,"rgb(50,150,50)",function(){D.windowLocation=_H.defaultWindowLocation(1,p,y);h.visible=false;C.visible=false;k.visible=true;l.visible=true;D.sonicToon.empty();D.sonicToon=null}));h.addControl(new Button(40,95,90,22,"Hit Sonic",c,"rgb(50,150,50)",function(){D.sonicToon.hit()}));h.addControl(new Button(40,130,160,22,"Show Height Map",c,"rgb(50,150,50)",function(){if(this.text=="Show Height Map"){D.showHeightMap=true;this.text="Hide Height Map"}else{D.showHeightMap=false;this.text="Show Height Map"}}));h.addControl(new Button(40,160,160,22,"Switch Height Map",c,"rgb(50,150,50)",function(){D.SonicLevel.curHeightMap=!D.SonicLevel.curHeightMap}));h.addControl(new Button(40,190,160,22,"Debug Sonic",c,"rgb(50,150,50)",function(){if(this.text=="Debug Sonic"){D.sonicToon.debugging=true;this.text="Normal Sonic"}else{D.sonicToon.debugging=false;this.text="Debug Sonic"}}));var C=this.solidTileArea=new UiArea(40,450,430,400,this,true);C.visible=false;this.UIAreas.push(C);C.addControl(new TextArea(30,25,"Modify Solid Tile",F,"blue"));C.addControl(new Button(50,35,25,22,"<<",c,"rgb(50,150,50)",function(){if(j.tpIndex>0){t.tilePiece=D.SonicLevel.Blocks[--j.tpIndex]}}));C.addControl(new Button(75,35,25,22,">>",c,"rgb(50,150,50)",function(){if(j.tpIndex<D.SonicLevel.Blocks.length){t.tilePiece=D.SonicLevel.Blocks[++j.tpIndex]}}));C.addControl(new Button(360,80,45,22,"Full",c,"rgb(50,150,50)",function(){for(var H=0;H<16;H++){t.tilePiece.heightMask.items[H]=16}this.sprites=[]}));C.addControl(new Button(360,130,45,22,"XFlip",c,function(){if(t.tpc.XFlip){return"rgb(190,120,65)"}else{return"rgb(50,150,50)"}},function(){t.tpc.XFlip=!t.tpc.XFlip}));C.addControl(new Button(360,160,45,22,"YFlip",c,function(){if(t.tpc.YFlip){return"rgb(190,120,65)"}else{return"rgb(50,150,50)"}},function(){t.tpc.YFlip=!t.tpc.YFlip}));C.addControl(new Button(200,35,180,22,"Modify Height Map",c,"rgb(50,150,50)",function(){t.state=(t.state+1)%3;switch(t.state){case 0:this.text="Modify Height Map";break;case 1:this.text="Modify Tile Direction";break;case 2:this.text="Modify Tile Colors";break}}));var t=this.modifyTilePieceArea=new TilePieceArea(30,70,{x:4*5,y:4*5},null,0);C.addControl(t);var b=this.bgEditor=new UiArea(100,440,420,360,this,true);b.visible=false;this.UIAreas.push(b);b.addControl(new TextArea(30,25,"BG Editor",F,"blue"));b.addControl(new TileBGEditArea(60,35));var k=this.levelInformation=new UiArea(70,70,460,420,this);k.visible=true;this.UIAreas.push(k);k.addControl(new TextArea(30,25,"Level Selector",F,"blue"));k.addControl(new TextArea(30,52,function(){return !g?"Level Not Saved":(g)},F,"black"));k.addControl(new Button(320,70,100,22,"Save Level",c,"rgb(50,150,50)",function(){if(g){OurSonic.SonicLevels.SaveLevelInformation(g,Base64.encode(_H.stringify(D.SonicLevel)),function(H){},function(H){alert("Failure: "+_H.stringify(H))})}else{OurSonic.SonicLevels.saveLevel(Base64.encode(_H.stringify(D.SonicLevel)),function(H){a(g)})}}));var E;k.addControl(E=new Button(320,105,160,22,"Load Empty Level",c,"rgb(50,150,50)",function(){l.visible=true;n.visible=true;var H=0;var I=function(){var J=188;if(H==J){setTimeout(function(){alert(_H.stringify(D.SonicLevel));m(_H.stringify(D.SonicLevel),p);n.visible=false},500);return}setTimeout(I,100);_H.loadSprite("assets/Chunks/Tile"+H+++".png",function(K){n.text="Loading "+H+"/"+J;D.importChunkFromImage(K);if(H==J){D.inds={done:true}}})};setTimeout(I,100)}));E.visible=false;var f;k.addControl(f=new ScrollBox(30,70,25,11,250,"rgb(50,60,127)"));var g;OurSonic.SonicLevels.getLevels(function(K){for(var I=0;I<K.length;I++){var J=K[I];a(J)}var H=_H.getQueryString();if(H.level){o(H.level)}});function a(I){var H;f.addControl(H=new Button(0,0,0,0,I,"10pt Arial","rgb(50,190,90)",function(){o(I)}))}function o(H){G("Downloading "+H);OurSonic.SonicLevels.getLevel(H,function(I){G("Loading: "+H);m(I,p)})}var l=this.levelManagerArea=new UiArea(500,25,400,400,this);l.visible=false;this.UIAreas.push(l);l.addControl(new TextArea(30,25,"Level Manager",F,"blue"));var n;l.addControl(n=new TextArea(270,25,"Loading",F,"green"));n.visible=false;l.addControl(new Button(35,100,160,22,"Show Height Map",c,"rgb(50,150,50)",function(){if(this.text=="Show Height Map"){D.showHeightMap=true;this.text="Hide Height Map"}else{D.showHeightMap=false;this.text="Show Height Map"}}));l.addControl(new Button(200,150,160,22,"Dragging",c,"rgb(50,150,50)",function(){D.clickState=(D.clickState+1)%4;switch(D.clickState){case ClickState.PlaceChunk:this.text="Modify Chunks";break;case ClickState.Dragging:this.text="Dragging";break;case ClickState.PlaceRing:this.text="Place Rings";break;case ClickState.PlaceObject:this.text="Place Object";break}}));l.addControl(new Button(200,180,160,22,"Switch Height Map",c,"rgb(50,150,50)",function(){D.SonicLevel.curHeightMap=!D.SonicLevel.curHeightMap}));l.addControl(new Button(35,150,160,22,"Modify Chunks",c,"rgb(50,150,50)",function(){s.visible=true}));l.addControl(new Button(35,150,160,22,"Modify Chunks",c,"rgb(50,150,50)",function(){s.visible=true}));l.addControl(new Button(35,175,160,22,"Modify Tile Pieces",c,"rgb(50,150,50)",function(){C.visible=true}));l.addControl(new Button(35,200,160,22,"Modify Tiles",c,"rgb(50,150,50)",function(){r.visible=true}));l.addControl(new Button(35,240,160,22,"Modify Background",c,"rgb(50,150,50)",function(){b.visible=true}));l.addControl(new Button(200,35,60,22,"Run",c,"rgb(50,150,50)",x));var s=this.modifyTileChunkArea=new UiArea(900,450,400,400,this,true);s.visible=false;this.UIAreas.push(s);s.addControl(new TextArea(30,25,"Modify Tile Chunk",F,"blue"));var q=this.modifyTC=new TileChunkArea(30,70,{x:2,y:2},null,1);s.addControl(q);s.addControl(new Button(50,35,25,22,"<<",c,"rgb(50,150,50)",function(){if(j.modifyIndex>0){q.tileChunk=D.SonicLevel.Chunks[--j.modifyIndex]}}));s.addControl(new Button(80,35,25,22,">>",c,"rgb(50,150,50)",function(){if(j.modifyIndex<D.SonicLevel.Chunks.length){q.tileChunk=D.SonicLevel.Chunks[++j.modifyIndex]}}));var u=this.modifyTP=new TilePieceArea(300,160,{x:2*3,y:2*3},null,3);s.addControl(u);s.addControl(new Button(300,100,25,22,"<<",c,"rgb(50,150,50)",function(){if(j.modifyTPIndex>0){u.tilePiece=q.setToTile=D.SonicLevel.Blocks[--j.modifyTPIndex]}}));s.addControl(new Button(330,100,25,22,">>",c,"rgb(50,150,50)",function(){if(j.modifyTPIndex<D.SonicLevel.Blocks.length){u.tilePiece=q.setToTile=D.SonicLevel.Blocks[++j.modifyTPIndex]}}));var r=this.modifyTileArea=new UiArea(900,25,400,400,this,true);r.visible=false;this.UIAreas.push(r);r.addControl(new TextArea(30,25,"Modify Tile",F,"blue"));function m(V,X){D.loading=true;G("Decoding");D.SonicLevel=jQuery.parseJSON(_H.decodeString(V));G("Determining Level Information");var M;var R;if(!D.SonicLevel.Chunks){D.SonicLevel.Chunks=[]}if(!D.SonicLevel.Blocks){D.SonicLevel.Blocks=[]}if(!D.SonicLevel.Tiles){D.SonicLevel.Tiles=[]}if(!D.SonicLevel.Rings){D.SonicLevel.Rings=[]}D.SonicLevel.LevelWidth=D.SonicLevel.ForegroundWidth;D.SonicLevel.LevelHeight=D.SonicLevel.ForegroundHeight;var Y=decodeNumeric(D.SonicLevel.Foreground);D.SonicLevel.ChunkMap=[];for(var af=0;af<D.SonicLevel.ForegroundWidth;af++){D.SonicLevel.ChunkMap[af]=[];for(var ag=0;ag<D.SonicLevel.ForegroundHeight;ag++){D.SonicLevel.ChunkMap[af][ag]=Y[af+ag*D.SonicLevel.ForegroundWidth]}}var Y=decodeNumeric(D.SonicLevel.Background);D.SonicLevel.BGChunkMap=[];for(var af=0;af<D.SonicLevel.BackgroundWidth;af++){D.SonicLevel.BGChunkMap[af]=[];for(var ag=0;ag<D.SonicLevel.BackgroundHeight;ag++){D.SonicLevel.BGChunkMap[af][ag]=Y[af+ag*D.SonicLevel.BackgroundWidth]}}for(var U=0;U<D.SonicLevel.Objects.length;U++){var ac=D.SonicLevel.Objects[U];D.SonicLevel.Objects[U]=_H.ObjectParse(ac)}D.SonicLevel.curHeightMap=true;for(R=0;R<D.SonicLevel.Tiles.length;R++){M=D.SonicLevel.Tiles[R];D.SonicLevel.Tiles[R]=decodeNumeric(M);var Z=[];for(var U=0;U<D.SonicLevel.Tiles[R].length;U++){var ai=D.SonicLevel.Tiles[R][U];Z.push(ai>>4);Z.push(ai&15)}D.SonicLevel.Tiles[R]={colors:Z};var ah=D.SonicLevel.Tiles[R];var Y=[];for(var ac=0;ac<8;ac++){Y[ac]=[]}for(var ab=0;ab<ah.colors.length;ab++){Y[ab%8][_H.floor(ab/8)]=ah.colors[ab]}ah.colors=Y;ah.index=R;D.SonicLevel.Tiles[R]=_H.extend(new Tile(),ah)}var H=D.SonicLevel.AnimatedChunks=[];if(D.SonicLevel.AnimatedFiles){for(S=0;S<D.SonicLevel.AnimatedFiles.length;S++){var N=D.SonicLevel.AnimatedFiles[S];for(R=0;R<N.length;R++){M=N[R];N[R]=decodeNumeric(M);var Z=[];for(var U=0;U<N[R].length;U++){var ai=N[R][U];Z.push(ai>>4);Z.push(ai&15)}N[R]={colors:Z};var ah=N[R];var Y=[];for(var ac=0;ac<8;ac++){Y[ac]=[]}for(var ab=0;ab<ah.colors.length;ab++){Y[ab%8][_H.floor(ab/8)]=ah.colors[ab]}ah.colors=Y;ah.index="A"+R+"_"+S;N[R]=_H.extend(new Tile(),ah)}}}for(R=0;R<D.SonicLevel.Blocks.length;R++){M=D.SonicLevel.Blocks[R];var Z=new TilePiece();Z.index=R;Z.tiles=[];for(var ad=0;ad<M.length;ad++){Z.tiles.push(M[ad])}D.SonicLevel.Blocks[R]=Z}var T;D.SonicLevel.Angles=decodeNumeric(D.SonicLevel.Angles);D.SonicLevel.CollisionIndexes1=decodeNumeric(D.SonicLevel.CollisionIndexes1);D.SonicLevel.CollisionIndexes2=decodeNumeric(D.SonicLevel.CollisionIndexes2);for(var P=0;P<D.SonicLevel.HeightMaps.length;P++){var I=true;var J=true;for(var W=0;W<D.SonicLevel.HeightMaps[P].length;W++){if(I&&D.SonicLevel.HeightMaps[P][W]!=0){I=false}if(J&&D.SonicLevel.HeightMaps[P][W]!=16){J=false}}if(I){D.SonicLevel.HeightMaps[P]=0}else{if(J){D.SonicLevel.HeightMaps[P]=1}else{D.SonicLevel.HeightMaps[P]=new HeightMask(D.SonicLevel.HeightMaps[P])}}}var S;for(R=0;R<D.SonicLevel.Chunks.length;R++){M=D.SonicLevel.Chunks[R];var Z=new TileChunk();Z.index=R;Z.tilePieces=[];for(var P=0;P<8;P++){Z.tilePieces[P]=[]}for(var ad=0;ad<M.length;ad++){Z.tilePieces[ad%8][_H.floor(ad/8)]=(M[ad])}D.SonicLevel.Chunks[R]=Z;Z.animated=undefined;for(var Q=0;Q<Z.tilePieces.length;Q++){for(var S=0;S<Z.tilePieces[Q].length;S++){var ag=Z.tilePieces[Q][S];var ae=D.SonicLevel.Blocks[ag.Block];if(ae){for(var K=0;K<ae.tiles.length;K++){var aa=ae.tiles[K];if(D.SonicLevel.Tiles[aa.Tile]){var L=D.containsAnimatedTile(aa.Tile);if(L!=undefined){Z.animated=L;H.push(Z);break}}}if(Z.animated){break}}if(Z.animated){break}}}}var O=function(){l.visible=true;D.loading=false;q.tileChunk=D.SonicLevel.Chunks[0];t.tilePiece=u.tilePiece=D.SonicLevel.Blocks[0]};G("preloading sprites");D.CACHING=true;D.preLoadSprites(y,function(){D.CACHING=false;O();G("Level Loaded");D.forceResize();var aj=_H.getQueryString();if(aj.run){setTimeout(x,1000)}},G)}}function Dragger(a){this.lastPos=null;this.xsp=0;this.ysp=0;this.lag=0.925;this.click=function(b){this.lastPos={x:b.x,y:b.y}};this.isDragging=function(b){return this.lastPos};this.mouseUp=function(b){this.lastPos=null};this.mouseMove=function(b){if(!this.lastPos){return}this.xsp+=(this.lastPos.x-b.x)*2.7;this.ysp+=(this.lastPos.y-b.y)*2.7;this.xsp=(this.xsp>0?1:-1)*Math.min(Math.abs(this.xsp),60);this.ysp=(this.ysp>0?1:-1)*Math.min(Math.abs(this.ysp),60);this.lastPos={x:b.x,y:b.y}};this.tick=function(){a(this.xsp,this.ysp);if(this.xsp>0){this.xsp*=this.lag}else{this.xsp*=this.lag}if(this.ysp>0){this.ysp*=this.lag}else{this.ysp*=this.lag}if(Math.abs(this.xsp)<=2){this.xsp=0}if(Math.abs(this.ysp)<=2){this.ysp=0}}};