function Color(d, c, a) { this.r = d; this.g = c; this.b = a; if (d != undefined) { this._style = "#" + (d.toString(16).length == 1 ? "0" + d.toString(16) : d.toString(16)) + (c.toString(16).length == 1 ? "0" + c.toString(16) : c.toString(16)) + (a.toString(16).length == 1 ? "0" + a.toString(16) : a.toString(16)) } Color.prototype.style = function () { return this._style }; Color.prototype.setData = function (e, b) { e[b] = this.r; e[b + 1] = this.g; e[b + 2] = this.b; e[b + 3] = 255 }; Color.prototype.equals = function (b) { return b.r == this.r && b.g == this.g && b.b == this.b } } function HeightMask(c, d, a) { this.width = 16; this.height = 16; this.angle = d; this.items = a ? a : []; this.rotationMode = c; for (var b = 0; b < 16; b++) { this.items[b] = 0 } HeightMask.prototype.setItem = function (e, h) { var g = 0, f = 0; switch (this.rotationMode) { case RotationMode.Ground: g = e; f = h; break; case RotationMode.Right: g = h; f = e; break; case RotationMode.Ceiling: g = e; f = 15 - h; break; case RotationMode.Left: g = h; f = 15 - e; break; default: } this.items[g] = 16 - f }; HeightMask.prototype.draw = function (f, j, g, e) { if (e == 3) { return } for (var l = 0; l < 16; l++) { for (var k = 0; k < 16; k++) { var n = 0, m = 0; switch (this.rotationMode) { case RotationMode.Ground: n = l; m = k; break; case RotationMode.Right: n = k; m = l; break; case RotationMode.Ceiling: n = l; m = 15 - k; break; case RotationMode.Left: n = 15 - k; m = l; break; default: } var i = j.x + (n * g.x); var h = j.y + (m * g.y); f.lineWidth = 1; if (e <= 0 && this.items[l] >= 16 - k) { f.fillStyle = "rgba(24,98,235,0.6)"; f.fillRect(i, h, g.x, g.y) } else { if (e != -1) { f.strokeStyle = "#0C3146"; f.strokeRect(i, h, g.x, g.y) } } } } } } window._H = { loadSprite: function (b, a) { var c = new Image(); c.onload = function () { c.loaded = true; if (a) { a(c) } }; c.src = b; return c }, defaultCanvas: function () { var b = document.createElement("canvas"); var a = b.getContext("2d"); return { canvas: b, context: a} }, scaleSprite: function (c, i, b) { var g = _H.getImageData(c); var a = []; for (var e = 0; e < g.length; e += 4) { a.push(new Color(g[e], g[e + 1], g[e + 2])) } var h = this.defaultCanvas().context.createImageData(c.width * i.x, c.height * i.y); _H.setDataFromColors(h.data, a, i, c.width, new Color(0, 0, 0)); return _H.loadSprite(_H.getBase64Image(h), b) }, getCursorPosition: function (b, a) { if (b.targetTouches && b.targetTouches.length > 0) { b = b.targetTouches[0] } if (b.pageX != null && b.pageY != null) { return { x: b.pageX, y: b.pageY} } if (b.x != null && b.y != null) { return { x: b.x, y: b.y} } return { x: b.clientX, y: b.clientY} }, setDataFromColors: function (l, a, f, d, q) { for (var m = 0; m < a.length; m++) { var e = (m % d); var b = Math.floor(m / d); for (var h = 0; h < f.x; h++) { for (var g = 0; g < f.y; g++) { var p = (e * f.x + h); var o = (b * f.y + g); var n = (p + o * (f.x * d)) * 4; a[m].setData(l, n); if (q) { if (a[m].equals(q)) { l[n + 3] = 0 } } } } } }, getImageData: function (b) { var c = document.createElement("canvas"); c.width = b.width; c.height = b.height; var a = c.getContext("2d"); a.drawImage(b, 0, 0); var d = a.getImageData(0, 0, b.width, b.height); return d.data }, getBase64Image: function (c) { var b = document.createElement("canvas"); b.width = c.width; b.height = c.height; var a = b.getContext("2d"); a.putImageData(c, 0, 0); var d = b.toDataURL("image/png"); return d }, isFunction: function (a) { var b = {}; return a && b.toString.call(a) == "[object Function]" }, detect: function (c, a) { for (var b in c) { if (typeof (c[b]) == "object") { if (a[c[b]]) { alert("circ") } a[c[b]] = true; this.detect(c[b], a) } } }, stringify: function (e, g) { return JSON.stringify(e, function (h, i) { if (h == "imageData") { return undefined } if (h == "oldScale") { return undefined } if (h == "sprite") { return undefined } if (h == "sprites") { return undefined } else { return i } }); if (g > 0) { return "" } if (!g) { g = 0 } var d = typeof (e); if (d != "object" || e === null) { if (d == "string") { e = '"' + e + '"' } return String(e) } else { var f, b, c = [], a = (e && e.constructor == Array); for (f in e) { b = e[f]; d = typeof (b); if (d == "string") { b = '"' + b + '"' } else { if (d == "object" && b !== null) { b = stringify(b, g + 1) } } c.push((a ? "" : '"' + f + '":') + String(b)) } return (a ? "[" : "{") + String(c) + (a ? "]" : "}") } }, compareTiles: function (c, a, b) { var d; for (d = 0; d < c.length; d++) { if (c[d].equals(b)) { return d } } for (d = 0; d < a.length; d++) { if (a[d].equals(b)) { return c.length + d } } return -1 }, compareTilePieces: function (c, b, d) { var a; for (a = 0; a < c.length; a++) { if (c[a].equals(d)) { return a } } for (a = 0; a < b.length; a++) { if (b[a].equals(d)) { return c.length + a } } return -1 } }; window.Base64 = { _keyStr: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=", encode: function (c) { var a = ""; var k, h, f, j, g, e, d; var b = 0; c = Base64._utf8_encode(c); while (b < c.length) { k = c.charCodeAt(b++); h = c.charCodeAt(b++); f = c.charCodeAt(b++); j = k >> 2; g = ((k & 3) << 4) | (h >> 4); e = ((h & 15) << 2) | (f >> 6); d = f & 63; if (isNaN(h)) { e = d = 64 } else { if (isNaN(f)) { d = 64 } } a = a + this._keyStr.charAt(j) + this._keyStr.charAt(g) + this._keyStr.charAt(e) + this._keyStr.charAt(d) } return a }, decode: function (c) { var a = ""; var k, h, f; var j, g, e, d; var b = 0; c = c.replace(/[^A-Za-z0-9\+\/\=]/g, ""); while (b < c.length) { j = this._keyStr.indexOf(c.charAt(b++)); g = this._keyStr.indexOf(c.charAt(b++)); e = this._keyStr.indexOf(c.charAt(b++)); d = this._keyStr.indexOf(c.charAt(b++)); k = (j << 2) | (g >> 4); h = ((g & 15) << 4) | (e >> 2); f = ((e & 3) << 6) | d; a = a + String.fromCharCode(k); if (e != 64) { a = a + String.fromCharCode(h) } if (d != 64) { a = a + String.fromCharCode(f) } } a = Base64._utf8_decode(a); return a }, _utf8_encode: function (b) { b = b.replace(/\r\n/g, "\n"); var a = ""; for (var e = 0; e < b.length; e++) { var d = b.charCodeAt(e); if (d < 128) { a += String.fromCharCode(d) } else { if ((d > 127) && (d < 2048)) { a += String.fromCharCode((d >> 6) | 192); a += String.fromCharCode((d & 63) | 128) } else { a += String.fromCharCode((d >> 12) | 224); a += String.fromCharCode(((d >> 6) & 63) | 128); a += String.fromCharCode((d & 63) | 128) } } } return a }, _utf8_decode: function (a) { var b = ""; var d = 0; var e = c1 = c2 = 0; while (d < a.length) { e = a.charCodeAt(d); if (e < 128) { b += String.fromCharCode(e); d++ } else { if ((e > 191) && (e < 224)) { c2 = a.charCodeAt(d + 1); b += String.fromCharCode(((e & 31) << 6) | (c2 & 63)); d += 2 } else { c2 = a.charCodeAt(d + 1); c3 = a.charCodeAt(d + 2); b += String.fromCharCode(((e & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63)); d += 3 } } } return b } }; function Sonic(e, g) { this.x = 20; this.y = 0; this.jumping = false; this.crouching = false; this.holdingLeft = false; this.holdingRight = false; this.levelWidth = 0; this.xsp = 0; this.ysp = 0; this.acc = 0.046875; this.dec = 0.5; this.frc = 0.046875; this.rdec = 0.125; this.rfrc = 0.0234375; this.jmp = -6.5; this.grv = 0.21875; this.air = 0.09375; this.standStill = true; this.sonicLevel = e; this.state = SonicState.Ground; this.tickCount = 0; this.facing = true; this.ticking = false; this.breaking = 0; this.wasJumping = false; this.ducking = false; this.spinDash = false; this.tick = function () { this.ticking = true; switch (this.state) { case SonicState.Ground: if (this.wasJumping && !this.jumping) { this.wasJumping = false } this.ducking = false; if (this.crouching) { if (this.xsp != 0) { this.rolling = true; this.currentlyBall = true } else { this.ducking = true } } else { this.spinDash = false } if (this.wasJumping && this.jumping) { } else { if (this.jumping) { if (this.ducking) { this.spinDash = true } else { this.wasJumping = true; this.state = SonicState.Air; this.currentlyBall = true; this.ysp = this.jmp } } } if (this.holdingLeft && this.standStill) { this.facing = false; this.standStill = false; this.xsp -= this.acc; this.runningDir = -1; break } if (this.holdingRight && this.standStill) { this.facing = true; this.standStill = false; this.xsp += this.acc; this.runningDir = 1; break } if (this.holdingRight) { this.facing = true; if (this.runningDir == 1) { if (this.rolling) { } else { this.xsp += this.acc } } else { if (Math.abs(this.xsp) > 4.5) { this.facing = false; this.breaking = 1; this.runningTick = 0 } if (this.rolling) { this.xsp += this.rdec } else { this.xsp += this.dec } this.runningDir = 1 } } else { if (this.holdingLeft) { this.facing = false; if (this.runningDir == -1) { if (this.rolling) { } else { this.xsp -= this.acc } } else { if (Math.abs(this.xsp) > 4.5) { this.facing = true; this.breaking = -1; this.runningTick = 0 } if (this.rolling) { this.xsp -= this.rdec } else { this.xsp -= this.dec } this.runningDir = -1 } } else { if (!this.rolling) { this.xsp -= Math.min(Math.abs(this.xsp), this.frc) * (this.xsp > 0 ? 1 : -1) } } } if (this.rolling) { this.xsp -= Math.min(Math.abs(this.xsp), this.rfrc) * (this.xsp > 0 ? 1 : -1) } break; case SonicState.Air: if (this.wasJumping) { if (this.jumping) { } else { if (this.ysp < 0) { if (this.ysp < -4) { this.ysp = -4 } } } } this.ysp += this.grv; if (this.ysp < 0 && this.ysp > -4) { if (Math.abs(this.xsp) > 0.125) { this.xsp *= 0.96875 } } if (this.ysp > 16) { this.ysp = 16 } break } var h = 6; if (this.holdingLeft) { if (this.xsp > 0) { this.xsp -= this.dec } else { if (this.xsp > -h) { this.xsp -= this.acc; if (this.xsp < -h) { this.xsp = -h } } } } else { if (this.holdingRight) { if (this.xsp < 0) { this.xsp += this.dec } else { if (this.xsp < h) { this.xsp += this.acc; if (this.xsp > h) { this.xsp = h } } } } } var l = Math.abs(this.xsp); b = parseInt(this.spriteState.substring(this.spriteState.length - 1, this.spriteState.length)); if (this.breaking > 0) { if (this.xsp > 0 || this.xsp == 0 || this.spriteState == "breaking3") { this.facing = false; this.breaking = 0 } } else { if (this.breaking < 0) { if (this.xsp < 0 || this.xsp == 0 || this.spriteState == "breaking3") { this.breaking = 0; this.facing = true } } } if (l == 0 && this.state == SonicState.Ground) { this.runningDir = 0; if (this.ducking) { if (this.spinDash) { this.spriteState = "duck0"; this.runningTick = 1 } else { if (this.spriteState.substring(0, this.spriteState.length - 1) != "duck") { this.spriteState = "duck0"; this.runningTick = 1 } else { if ((this.runningTick++) % (Math.floor(8 - l)) == 0) { this.spriteState = "duck1" } } } } else { this.spriteState = "normal"; this.standStill = true; this.currentlyBall = false; this.rolling = false; this.runningTick = 0 } } else { if (this.breaking != 0) { if (this.spriteState.substring(0, this.spriteState.length - 1) != "breaking") { this.spriteState = "breaking0"; this.runningTick = 1 } else { if ((this.runningTick++) % (7) == 0) { this.spriteState = "breaking" + ((b + 1) % 4) } } } else { if (this.currentlyBall) { if (this.spriteState.substring(0, this.spriteState.length - 1) != "balls") { this.spriteState = "balls0"; this.runningTick = 1 } else { if ((this.runningTick++) % (Math.floor(8 - l)) == 0) { this.spriteState = "balls" + ((b + 1) % 5) } } } else { if (l < 6) { if (this.spriteState.substring(0, this.spriteState.length - 1) != "running") { this.spriteState = "running0"; this.runningTick = 1 } else { if ((this.runningTick++) % (Math.floor(8 - l)) == 0 || (Math.floor(8 - l) == 0)) { this.spriteState = "running" + ((b + 1) % 8) } } } else { if (l >= 6) { if (this.spriteState.substring(0, this.spriteState.length - 1) != "fastrunning") { this.spriteState = "fastrunning0"; this.runningTick = 1 } else { if ((this.runningTick++) % (Math.ceil(8 - l)) == 0 || (Math.floor(8 - l) == 0)) { this.spriteState = "fastrunning" + ((b + 1) % 4) } } } } } } } this.x += this.xsp; this.y += this.ysp; var m = Math.floor(this.x); var k = Math.floor(this.y); var j, i; if ((j = this.checkCollisionLine(m - 9, k + 4, 20, 0)) != -1) { if (j < m) { this.x = m = j + 11; this.xsp = 0 } else { this.x = m = j - 11; this.xsp = 0 } } switch (this.state) { case SonicState.Ground: if ((j = this.checkCollisionLine(m - 9, k, 20, 1)) == -1 && (i = this.checkCollisionLine(m + 9, k, 20, 1)) == -1) { this.state = SonicState.Air } else { if (j > -1) { this.y = k = j - 19 } else { if (i > -1) { this.y = k = i - 19 } } } break; case SonicState.Air: if ((j = this.checkCollisionLine(m - 9, k, 20, 1)) == -1 && (i = this.checkCollisionLine(m + 9, k, 20, 1)) == -1) { this.state = SonicState.Air } else { if (j > -1) { if (this.y + (20) >= j) { this.y = k = j - 19; this.rolling = this.currentlyBall = false; this.state = SonicState.Ground; this.ysp = 0 } } else { if (i > -1) { if (this.y + (20) >= i) { this.y = k = i - 19; this.rolling = this.currentlyBall = false; this.state = SonicState.Ground; this.ysp = 0 } } } } break } }; this.sensorA = 0; this.checkCollisionLine = function (j, q, l, o) { var p = q * this.levelWidth + j; var n = this.levelWidth; var k; var h; switch (o) { case 0: for (k = 0; k < l; k++) { if (j + k < 0 || this.heightInformation[q * this.levelWidth + (j + k)]) { return j + k } } break; case 1: for (k = 0, h = l * n; k < h; k += n) { if (this.heightInformation[p + k]) { return q + (k / n) } } break; case 2: for (k = 0; k < l; k++) { if (j - k < 0 || this.heightInformation[this.heightInformation[q * this.levelWidth + (j - k)]]) { return j - k } } break; case 3: for (k = 0, h = l * n; k < h; k += n) { if (this.heightInformation[p - k]) { return q - (k / n) } } break } return -1 }; this.cachedImages = []; this.spriteState = "normal"; this.spriteLocations = []; this.imageLength = 0; this.spriteLocations.normal = "assets/Sprites/sonic.png"; this.imageLength++; var b; for (b = 0; b < 4; b++) { this.spriteLocations["fastrunning" + b] = "assets/Sprites/fastrunning" + b + ".png"; this.imageLength++ } for (b = 0; b < 8; b++) { this.spriteLocations["running" + b] = "assets/Sprites/running" + b + ".png"; this.imageLength++ } for (b = 0; b < 4; b++) { this.spriteLocations["breaking" + b] = "assets/Sprites/breaking" + b + ".png"; this.imageLength++ } for (b = 0; b < 5; b++) { this.spriteLocations["balls" + b] = "assets/Sprites/balls" + b + ".png"; this.imageLength++ } for (b = 0; b < 2; b++) { this.spriteLocations["duck" + b] = "assets/Sprites/duck" + b + ".png"; this.imageLength++ } var c = this.cachedImages; var d = _H.defaultCanvas().context; var a = this.imageLoaded = [0]; for (var f in this.spriteLocations) { c[f] = _H.loadSprite(this.spriteLocations[f], function (h) { c[h.tag + g.x + g.y] = _H.scaleSprite(h, g, function (i) { d.drawImage(i, 0, 0, i.width, i.height); d.drawImage(h, 0, 0, h.width, h.height); a[0]++ }) }); c[f].tag = f } this.isLoading = function () { return this.imageLoaded[0] < this.imageLength }; this.draw = function (h, m) { var j = Math.floor(this.x); var i = Math.floor(this.y); var l; if (l = this.cachedImages[this.spriteState + m.x + m.y]) { if (l.loaded) { h.save(); var k = 0; if (this.spinDash || this.ducking) { k = 6 } else { if (this.currentlyBall) { k = 10 } } if (!this.facing) { h.translate(((j - 15 - sonicManager.windowLocation.x) * m.x) + l.width, ((i - 20 - sonicManager.windowLocation.y + k) * m.y)); h.scale(-1, 1); h.drawImage(l, 0, 0, l.width, l.height) } else { h.drawImage(l, ((j - 15 - sonicManager.windowLocation.x) * m.x), ((i - 20 - sonicManager.windowLocation.y + k) * m.y), l.width, l.height) } h.restore(); h.fillStyle = "#CF3"; h.fillRect(((j - sonicManager.windowLocation.x) * m.x) - 5, ((i - sonicManager.windowLocation.y + k) * m.y) - 5, 10, 10) } } else { if (l = this.cachedImages[this.spriteState]) { if (l.loaded) { this.cachedImages[this.spriteState + m.x + m.y] = _H.scaleSprite(l, m) } } else { this.cachedImages[this.spriteState] = _H.loadSprite(this.spriteLocations[this.spriteState]) } } }; this.runningDir = 0; this.kill = function () { }; this.pressJump = function () { this.jumping = true }; this.pressCrouch = function () { this.crouching = true }; this.pressLeft = function () { this.holdingLeft = true }; this.pressRight = function () { this.holdingRight = true }; this.releaseJump = function () { this.jumping = false }; this.releaseCrouch = function () { this.crouching = false }; this.releaseLeft = function () { this.holdingLeft = false }; this.releaseRight = function () { this.holdingRight = false }; this.buildHeightInfo = function () { var p = []; p.length = e.ChunkMap.length * 128 * 128; var q = Math.sqrt(e.ChunkMap.length); this.levelWidth = q * 128; for (var k = 0; k < q; k++) { for (var o = 0; o < q; o++) { var n = e.TileChunks[e.ChunkMap[k * q + o]]; for (var j = 0; j < 8; j++) { for (var l = 0; l < 8; l++) { var m = e.TilePieces[n.tilesPieces[j * 8 + l]]; for (var h = 0; h < 16; h++) { for (var i = 0; i < 16; i++) { p[(o * 128 + l * 16 + i) + (k * 128 + j * 16 + h) * (this.levelWidth)] = (m.heightMask.items[i]) > 16 - h } } } } } } return p }; this.heightInformation = this.buildHeightInfo(e) } SonicState = { Air: 0, Ground: 1 }; DEBUGs = true; window.requestAnimFrame = (function (a) { if (window.requestAnimationFrame) { return window.requestAnimationFrame(a) } if (window.webkitRequestAnimationFrame) { return window.webkitRequestAnimationFrame(a) } if (window.mozRequestAnimationFrame) { return window.mozRequestAnimationFrame(a) } if (window.oRequestAnimationFrame) { return window.oRequestAnimationFrame(a) } if (window.msRequestAnimationFrame) { return window.msRequestAnimationFrame(a) } window.setTimeout(a, 1000 / 60) }); function SonicEngine(a) { var g = this; this.canvas = $("#" + a); this.canvasItem = document.getElementById(a).getContext("2d"); var h = window.sonicManager = new SonicManager(this.canvasItem); this.canvasWidth = 0; this.canvasHeight = 0; document.getElementById(a).addEventListener("DOMMouseScroll", f, false); document.getElementById(a).addEventListener("mousewheel", f, false); document.getElementById(a).addEventListener("touchmove", d); document.getElementById(a).addEventListener("touchstart", b); document.getElementById(a).addEventListener("touchend", j); document.getElementById(a).addEventListener("mousedown", b); document.getElementById(a).addEventListener("mouseup", j); document.getElementById(a).addEventListener("mousemove", d); $(document).keydown(i); $(document).keyup(c); function b(k) { k.preventDefault(); if (h.uiManager.onClick(k)) { return false } if (h.onClick(k)) { return false } return false } function d(k) { k.preventDefault(); if (h.uiManager.onMouseMove(k)) { return false } return false } function j(k) { k.preventDefault(); h.uiManager.onMouseUp(k) } function f(k) { k.preventDefault(); if (h.uiManager.onMouseScroll(k)) { return false } return k.preventDefault() && false } function i(k) { switch (k.keyCode) { case 38: case 87: if (h.sonicToon) { h.sonicToon.pressJump() } break; case 40: case 83: if (h.sonicToon) { h.sonicToon.pressCrouch() } break; case 37: case 65: if (h.sonicToon) { h.sonicToon.pressLeft() } break; case 39: case 68: if (h.sonicToon) { h.sonicToon.pressRight() } break } } function c(k) { switch (k.keyCode) { case 38: case 87: if (h.sonicToon) { h.sonicToon.releaseJump() } break; case 40: case 83: if (h.sonicToon) { h.sonicToon.releaseCrouch() } break; case 37: case 65: if (h.sonicToon) { h.sonicToon.releaseLeft() } break; case 39: case 68: if (h.sonicToon) { h.sonicToon.releaseRight() } break } } g.resizeCanvas = function () { g.canvasWidth = $(window).width(); g.canvasHeight = $(window).height(); g.canvas.attr("width", g.canvasWidth); g.canvas.attr("height", g.canvasHeight) }; function e(k) { k.clearRect(0, 0, g.canvasWidth, g.canvasHeight) } g.draw = function () { requestAnimFrame(g.draw); e(g.canvasItem); h.draw(g.canvasItem); h.uiManager.draw(g.canvasItem) }; $(window).resize(this.resizeCanvas); this.resizeCanvas(); requestAnimFrame(g.draw); window.setInterval(h.tick, 1000 / 60, h) } function SonicManager(d) { this.windowLocation = { x: 0, y: 0, width: 320, height: 240 }; var e = this.scale = { x: 2, y: 2 }; this.uiManager = new UIManager(this, d, this.scale); this.SonicLevel = { Tiles: [], TilePieces: [], TileChunks: [], ChunkMap: [] }; var c = new TileChunk() + new TilePiece() + new Tile() + new HeightMask() + new Color(); for (var a = 0; a < 10; a++) { for (var b = 0; b < 10; b++) { this.SonicLevel.ChunkMap[b * 10 + a] = 0 } } this.onClick = function (g) { if (g.shiftKey) { var f = this.SonicLevel.TileChunks[this.SonicLevel.ChunkMap[Math.floor(g.x / (128 * e.x)) + Math.floor(g.y / (128 * e.y)) * 10]]; var h = f.getTilePiece((g.x - Math.floor(g.x / (128 * e.x)) * (128 * e.x)), (g.y - Math.floor(g.y / (128 * e.y)) * (128 * e.y)), e); if (h) { this.uiManager.indexes.tpIndex = this.SonicLevel.TilePieces.indexOf(h); this.uiManager.modifyTilePieceArea.tilePiece = h; this.uiManager.solidTileArea.visible = true } } else { if (!g.button || g.button == 0) { this.SonicLevel.ChunkMap[Math.floor(g.x / (128 * e.x)) + Math.floor(g.y / (128 * e.y)) * 10] = this.uiManager.indexes.modifyIndex } } }; this.tick = function (f) { if (f.sonicToon) { if (f.loading) { if (!f.sonicToon.isLoading()) { f.loading = false } } else { f.sonicToon.tick(f.SonicLevel, e); if (f.sonicToon.y > 128 * 10) { f.sonicToon.y = 0 } if (f.sonicToon.x > 128 * 10) { f.sonicToon.x = 0 } } } }; this.loading = true; this.showHeightMap = false; this.draw = function (h) { h.save(); if (!this.inds || !this.inds.done) { if (!this.inds) { return } h.fillStyle = "white"; h.fillText("Loading...   " + (this.inds.tc + this.inds.tp + this.inds.t) + " / " + (this.inds.total), 95, 95); h.restore(); return } if (this.sonicToon) { if (this.loading) { h.fillStyle = "white"; h.fillText("Loading...", 60, 60); h.restore(); return } h.beginPath(); h.rect(0, 0, this.windowLocation.width * e.x, this.windowLocation.height * e.x); h.clip(); this.windowLocation.x = Math.floor(this.sonicToon.x - 160); this.windowLocation.y = Math.floor(this.sonicToon.y - 180); if (this.windowLocation.x < 0) { this.windowLocation.x = 0 } if (this.windowLocation.y < 0) { this.windowLocation.y = 0 } if (this.windowLocation.x > 128 * 10 - this.windowLocation.width) { this.windowLocation.x = 128 * 10 - this.windowLocation.width } if (this.windowLocation.y > 128 * 10 - this.windowLocation.height) { this.windowLocation.y = 128 * 10 - this.windowLocation.height } } for (var g = 0; g < this.SonicLevel.ChunkMap.length; g++) { if (!this.SonicLevel.TileChunks[this.SonicLevel.ChunkMap[g]]) { continue } var k = { x: (g % 10) * 128 * e.x, y: Math.floor(g / 10) * 128 * e.y }; if (!this.sonicToon || (k.x >= (this.windowLocation.x - 128) * e.x && k.y >= (this.windowLocation.y - 128) * e.y && k.x <= (this.windowLocation.x + 128) * e.x + this.windowLocation.width * e.x && k.y <= (this.windowLocation.y + 128) * e.y + this.windowLocation.height * e.y)) { var f = { x: k.x - this.windowLocation.x * e.x, y: k.y - this.windowLocation.y * e.x }; var i = this.showHeightMap ? 2 : this.sonicToon ? 0 : 1; this.SonicLevel.TileChunks[this.SonicLevel.ChunkMap[g]].draw(h, f, e, i); if (!this.sonicToon) { h.strokeStyle = "#DD0033"; h.lineWidth = 3; h.strokeRect(f.x, f.y, 128 * e.x, 128 * e.y) } } } if (this.sonicToon) { this.sonicToon.draw(h, e); if (this.windowLocation.x < 0) { this.windowLocation.x = 0 } if (this.windowLocation.y < 0) { this.windowLocation.y = 0 } if (this.windowLocation.x > 128 * 10 - this.windowLocation.width) { this.windowLocation.x = 128 * 10 - this.windowLocation.width } if (this.windowLocation.y > 128 * 10 - this.windowLocation.height) { this.windowLocation.y = 128 * 10 - this.windowLocation.height } } h.restore() }; this.importChunkFromImage = function (s) { var A = _H.getImageData(s); if (A.length != 128 * 128 * 4) { alert("Chunk size incorrect") } var j = this.SonicLevel.Tiles.length; var z = []; var p; var n; var l = []; var q = []; var m; for (var r = 0; r < 16; r++) { for (var t = 0; t < 16; t++) { var o = []; for (n = 0; n < 8; n++) { for (p = 0; p < 8; p++) { var w = ((r * 8 + n) * 128) * 4 + (t * 8 + p) * 4; o.push(new Color(A[w], A[w + 1], A[w + 2])) } } m = _H.compareTiles(this.SonicLevel.Tiles, z, o); if (m == -1) { l.push(j + z.length); z.push(new Tile(o)) } else { l.push(m) } } } var v; for (v = 0; v < z.length; v++) { this.SonicLevel.Tiles.push(z[v]) } var g = []; var u = this.SonicLevel.TilePieces.length; for (n = 0; n < 8; n++) { for (p = 0; p < 8; p++) { var h = [l[((n * 2) * 16 + (p * 2))], l[((n * 2) * 16 + (p * 2 + 1))], l[((n * 2 + 1) * 16 + (p * 2))], l[((n * 2 + 1) * 16 + (p * 2 + 1))]]; m = _H.compareTilePieces(this.SonicLevel.TilePieces, g, h); if (m == -1) { q.push(u + g.length); g.push(new TilePiece(new HeightMask(RotationMode.Ground, 45), h)) } else { q.push(m) } } } for (v = 0; v < g.length; v++) { this.SonicLevel.TilePieces.push(g[v]) } var k = []; for (n = 0; n < 8; n++) { for (p = 0; p < 8; p++) { k.push(q[n * 8 + p]) } } this.SonicLevel.TileChunks.push(new TileChunk(k)) } } var Stats = function () { var I, P, y = 0, x = 0, H = Date.now(), v = H, w = H, E = 0, C = 1000, B = 0, L, G, K, O = [[16, 16, 48], [0, 255, 255]], D = 0, A = 1000, z = 0, M, F, J, N = [[16, 48, 16], [0, 255, 0]]; I = document.createElement("div"); I.style.cursor = "pointer"; I.style.width = "80px"; I.style.opacity = "0.9"; I.style.zIndex = "10001"; I.addEventListener("mousedown", function (b) { b.preventDefault(); y = (y + 1) % 2; 0 == y ? (L.style.display = "block", M.style.display = "none") : (L.style.display = "none", M.style.display = "block") }, !1); L = document.createElement("div"); L.style.textAlign = "left"; L.style.lineHeight = "1.2em"; L.style.backgroundColor = "rgb(" + Math.floor(O[0][0] / 2) + "," + Math.floor(O[0][1] / 2) + "," + Math.floor(O[0][2] / 2) + ")"; L.style.padding = "0 0 3px 3px"; I.appendChild(L); G = document.createElement("div"); G.style.fontFamily = "Helvetica, Arial, sans-serif"; G.style.fontSize = "9px"; G.style.color = "rgb(" + O[1][0] + "," + O[1][1] + "," + O[1][2] + ")"; G.style.fontWeight = "bold"; G.innerHTML = "FPS"; L.appendChild(G); K = document.createElement("div"); K.style.position = "relative"; K.style.width = "74px"; K.style.height = "30px"; K.style.backgroundColor = "rgb(" + O[1][0] + "," + O[1][1] + "," + O[1][2] + ")"; for (L.appendChild(K); 74 > K.children.length; ) { P = document.createElement("span"), P.style.width = "1px", P.style.height = "30px", P.style.cssFloat = "left", P.style.backgroundColor = "rgb(" + O[0][0] + "," + O[0][1] + "," + O[0][2] + ")", K.appendChild(P) } M = document.createElement("div"); M.style.textAlign = "left"; M.style.lineHeight = "1.2em"; M.style.backgroundColor = "rgb(" + Math.floor(N[0][0] / 2) + "," + Math.floor(N[0][1] / 2) + "," + Math.floor(N[0][2] / 2) + ")"; M.style.padding = "0 0 3px 3px"; M.style.display = "none"; I.appendChild(M); F = document.createElement("div"); F.style.fontFamily = "Helvetica, Arial, sans-serif"; F.style.fontSize = "9px"; F.style.color = "rgb(" + N[1][0] + "," + N[1][1] + "," + N[1][2] + ")"; F.style.fontWeight = "bold"; F.innerHTML = "MS"; M.appendChild(F); J = document.createElement("div"); J.style.position = "relative"; J.style.width = "74px"; J.style.height = "30px"; J.style.backgroundColor = "rgb(" + N[1][0] + "," + N[1][1] + "," + N[1][2] + ")"; for (M.appendChild(J); 74 > J.children.length; ) { P = document.createElement("span"), P.style.width = "1px", P.style.height = 30 * Math.random() + "px", P.style.cssFloat = "left", P.style.backgroundColor = "rgb(" + N[0][0] + "," + N[0][1] + "," + N[0][2] + ")", J.appendChild(P) } return { getDomElement: function () { return I }, getFps: function () { return E }, getFpsMin: function () { return C }, getFpsMax: function () { return B }, getMs: function () { return D }, getMsMin: function () { return A }, getMsMax: function () { return z }, update: function () { H = Date.now(); D = H - v; A = Math.min(A, D); z = Math.max(z, D); F.textContent = D + " MS (" + A + "-" + z + ")"; var b = Math.min(30, 30 - 30 * (D / 200)); J.appendChild(J.firstChild).style.height = b + "px"; v = H; x++; if (H > w + 1000) { E = Math.round(1000 * x / (H - w)), C = Math.min(C, E), B = Math.max(B, E), G.textContent = E + " FPS (" + C + "-" + B + ")", b = Math.min(30, 30 - 30 * (E / 100)), K.appendChild(K.firstChild).style.height = b + "px", w = H, x = 0 } } } }; function Tile(a) { this.colors = a; this.sprites = []; Tile.prototype.changeColor = function (b, d, c) { this.colors[d * 8 + b] = c; this.sprites = [] }; Tile.prototype.cacheImage = function (c, g, e) { if (!this.sprites) { this.sprites = [] } var b = this.sprites[g.y * 100 + g.x]; if (!b) { var f = c.createImageData(8 * g.x, 8 * g.y); _H.setDataFromColors(f.data, this.colors, g, 8); this.sprites[g.y * 100 + g.x] = _H.loadSprite(_H.getBase64Image(f), e) } }; Tile.prototype.draw = function (c, f, e, d) { if (!this.sprites) { this.sprites = [] } var b = this.sprites[e.y * 100 + e.x]; if (!b) { this.cacheImage(c, e); b = this.sprites[e.y * 100 + e.x] } if (b.loaded) { c.drawImage(b, Math.floor(f.x), Math.floor(f.y)) } else { return false } if (d) { c.strokeStyle = "#DD0033"; c.lineWidth = 3; c.strokeRect(f.x, f.y, 8 * e.x, 8 * e.y) } return true }; Tile.prototype.equals = function (c) { for (var b = 0; b < this.colors.length; b++) { if (c[b]._style != this.colors[b]._style) { return false } } return true } } function TileChunk(a) { this.tilesPieces = a; this.sprites = []; TileChunk.prototype.getTilePiece = function (b, d, c) { return sonicManager.SonicLevel.TilePieces[this.tilesPieces[Math.floor((b / c.x / 16)) + Math.floor((d / c.y / 16)) * 8]] }; TileChunk.prototype.cacheImage = function (c, j, g, e) { if (!this.sprites) { this.sprites = [] } var d; var h = g * 200 + j.y * 50 + j.x; if (!this.sprites[h]) { var f = document.createElement("canvas"); f.width = 128 * j.x; f.height = 128 * j.y; var b = f.getContext("2d"); for (d = 0; d < this.tilesPieces.length; d++) { if (!sonicManager.SonicLevel.TilePieces[this.tilesPieces[d]].draw(b, { x: (d % 8) * 16 * j.x, y: Math.floor(d / 8) * 16 * j.y }, j, g == 2 ? 4 : 3)) { return false } if (g == 1) { b.lineWidth = 1; b.strokeStyle = "#FFFFFF"; b.strokeRect((d % 8) * 16 * j.x, Math.floor(d / 8) * 16 * j.y, 16 * j.x, 16 * j.y) } } this.sprites[h] = _H.loadSprite(f.toDataURL("image/png"), e) } return true }; TileChunk.prototype.draw = function (d, k, e, b) { if (!this.sprites) { this.sprites = [] } var h; for (h = 0; h < this.tilesPieces.length; h++) { var f = sonicManager.SonicLevel.TilePieces[this.tilesPieces[h]].sprites; if (!f || f.length == 0) { this.sprites = []; break } } var l = b * 200 + e.y * 50 + e.x; if (!this.sprites[l]) { var c = document.createElement("canvas"); c.width = 128 * e.x; c.height = 128 * e.y; var g = c.getContext("2d"); for (h = 0; h < this.tilesPieces.length; h++) { if (!sonicManager.SonicLevel.TilePieces[this.tilesPieces[h]].draw(g, { x: (h % 8) * 16 * e.x, y: Math.floor(h / 8) * 16 * e.y }, e, b == 2 ? 4 : 3)) { return false } if (b == 1) { g.lineWidth = 1; g.strokeStyle = "#FFFFFF"; g.strokeRect((h % 8) * 16 * e.x, Math.floor(h / 8) * 16 * e.y, 16 * e.x, 16 * e.y) } } this.sprites[l] = _H.loadSprite(c.toDataURL("image/png")) } if (this.sprites[l].loaded) { d.drawImage(this.sprites[l], Math.floor(k.x), Math.floor(k.y)) } return true } } function TilePiece(a, b) { this.heightMask = a; this.tiles = b; this.sprites = []; TilePiece.prototype.click = function (c, e, d) { switch (d) { case 0: this.heightMask.setItem(c, e); this.sprites = []; break; case 1: break; case 2: sonicManager.SonicLevel.Tiles[this.tiles[Math.floor(c / 8) + Math.floor(e / 8) * 2]].changeColor(c % 8, e % 8, new Color(122, 122, 122)); break } }; TilePiece.prototype.mouseOver = function (c, d) { }; TilePiece.prototype.cacheImage = function (d, k, h, f) { if (!this.sprites) { this.sprites = [] } var e; var j = h * 200 + k.y * 50 + k.x; if (!this.sprites[j]) { var g = document.createElement("canvas"); g.width = 2 * 8 * k.x; g.height = 2 * 8 * k.y; var c = g.getContext("2d"); for (e = 0; e < this.tiles.length; e++) { if (!sonicManager.SonicLevel.Tiles[this.tiles[e]].draw(c, { x: (e % 2) * 8 * k.x, y: Math.floor(e / 2) * 8 * k.y }, k, h < 3)) { return false } } if (h == 4) { this.heightMask.draw(c, { x: 0, y: 0 }, k, -1) } this.sprites[j] = _H.loadSprite(g.toDataURL("image/png"), f) } return true }; TilePiece.prototype.draw = function (e, l, f, c) { if (!this.sprites) { this.sprites = [] } var k; for (k = 0; k < this.tiles.length; k++) { var g = sonicManager.SonicLevel.Tiles[this.tiles[k]].sprites; if (!g || g.length == 0) { this.sprites = []; break } } if (c < 3) { for (k = 0; k < this.tiles.length; k++) { if (!sonicManager.SonicLevel.Tiles[this.tiles[k]].draw(e, { x: Math.floor(l.x) + (k % 2) * 8 * f.x, y: Math.floor(l.y) + Math.floor(k / 2) * 8 * f.y }, f, c != 3)) { return false } } this.heightMask.draw(e, l, f, c); return true } var m = c * 200 + f.y * 50 + f.x; if (!this.sprites[m]) { var d = document.createElement("canvas"); d.width = 2 * 8 * f.x; d.height = 2 * 8 * f.y; var h = d.getContext("2d"); for (k = 0; k < this.tiles.length; k++) { if (!sonicManager.SonicLevel.Tiles[this.tiles[k]].draw(h, { x: (k % 2) * 8 * f.x, y: Math.floor(k / 2) * 8 * f.y }, f, c < 3)) { return false } } if (c == 4) { this.heightMask.draw(h, { x: 0, y: 0 }, f, -1) } this.sprites[m] = _H.loadSprite(d.toDataURL("image/png")) } if (this.sprites[m].loaded) { e.drawImage(this.sprites[m], Math.floor(l.x), Math.floor(l.y)) } else { return false } return true }; TilePiece.prototype.equals = function (d) { for (var c = 0; c < this.tiles.length; c++) { if (d[c] != this.tiles[c]) { return false } } return true } } RotationMode = { Ground: 134, Right: 224, Ceiling: 314, Left: 44 }; function UiArea(a, g, b, e, c, d) { this.x = a; this.y = g; this.manager = c; this.closable = d; this.width = b; this.height = e; this.depth = 0; this.visible = true; this.dragging = false; this.controls = []; this.addControl = function (h) { h.parent = this; this.controls.push(h); return h }; var f = this; if (d) { this.addControl(new Button(this.width - 30, 4, 26, 26, "X", this.manager.buttonFont, "Green", function () { f.visible = false })) } this.click = function (j) { if (!this.visible) { return } for (var h = 0; h < this.controls.length; h++) { var i = this.controls[h]; if (i.visible && i.y <= j.y && i.y + i.height > j.y && i.x <= j.x && i.x + i.width > j.x) { j.x -= i.x; j.y -= i.y; i.onClick(j); return false } } this.dragging = { x: j.x, y: j.y} }; this.mouseMove = function (j) { if (!this.visible) { return } if (!this.dragging) { for (var h = 0; h < this.controls.length; h++) { var i = this.controls[h]; if (i.visible && i.y <= j.y && i.y + i.height > j.y && i.x <= j.x && i.x + i.width > j.x) { j.x -= i.x; j.y -= i.y; i.onMouseOver(j) } } return } this.x += j.x - this.dragging.x; this.y += j.y - this.dragging.y }; this.mouseUp = function (j) { if (!this.visible) { return } for (var h = 0; h < this.controls.length; h++) { var i = this.controls[h]; i.onMouseUp({ x: j.x - i.x, y: j.y - i.y }) } this.dragging = false }; this.scroll = function (j) { if (!this.visible) { return } for (var h = 0; h < this.controls.length; h++) { var i = this.controls[h]; if (i.visible && i.y <= j.y && i.y + i.height > j.y && i.x <= j.x && i.x + i.width > j.x) { if (i.onScroll) { j.x -= i.x; j.y -= i.y; i.onScroll(j); return false } } } }; this.cachedDrawing = null; this.draw = function (p) { if (!this.visible) { return } var o; var m; var l; if (!this.cachedDrawing) { var n = document.createElement("canvas"); n.width = this.width + 20; n.height = this.height + 20; var i = n.getContext("2d"); i.fillStyle = "rgba(133,133,133,0.6)"; i.lineWidth = 9; i.strokeStyle = "#333"; var k = this.x; var h = this.y; this.x = 10; this.y = 10; roundRect(i, this.x, this.y, this.width, this.height, 5, true, true); for (l = 0; l < this.controls.length; l++) { m = this.controls[l]; o = m.forceDrawing(); if (o.redraw) { m.draw(i) } } this.x = k; this.y = h; this.cachedDrawing = _H.loadSprite(n.toDataURL("image/png")) } if (this.cachedDrawing.loaded) { p.drawImage(this.cachedDrawing, Math.floor(this.x), Math.floor(this.y)); for (l = 0; l < this.controls.length; l++) { m = this.controls[l]; o = m.forceDrawing(); if (!o.redraw) { m.draw(p) } if (o.clearCache) { this.cachedDrawing = null } } } else { p.fillStyle = "rgba(133,133,133,0.6)"; p.lineWidth = 9; p.strokeStyle = "#333"; roundRect(p, this.x + 10, this.y + 10, this.width, this.height, 5, true, true); for (l = 0; l < this.controls.length; l++) { m = this.controls[l]; m.draw(p) } } }; return this } function TextArea(a, e, d, c, b) { this.forceDrawing = function () { if (this.text == this.oldText) { return { redraw: false, clearCache: false} } this.oldText = this.text; return { redraw: false, clearCache: true} }; this.x = a; this.oldText = d; this.y = e; this.visible = true; this.text = d; this.font = c; this.color = b; this.parent = null; this.onClick = function (f) { return false }; this.onMouseUp = function (f) { if (this.mouseUp) { this.mouseUp() } }; this.onMouseOver = function (f) { if (this.mouseOver) { this.mouseOver() } }; this.draw = function (k) { if (!this.visible) { return } var j = _H.isFunction(this.text) ? this.text() : this.text; if (k.font != this.font) { k.font = this.font } var f = k.measureText(j).width; var g = parseInt(k.font.split("pt")[0]); var i = 3; k.strokeStyle = this.color; k.shadowColor = "#FFF"; k.shadowBlur = 20; k.lineWidth = 1.5; k.strokeText(j, this.parent.x + this.x, this.parent.y + this.y); k.strokeText(j, this.parent.x + this.x, this.parent.y + this.y); k.strokeText(j, this.parent.x + this.x, this.parent.y + this.y); k.strokeText(j, this.parent.x + this.x, this.parent.y + this.y); k.strokeText(j, this.parent.x + this.x, this.parent.y + this.y); k.shadowBlur = 0 }; return this } function Button(g, f, a, i, h, c, d, j, e, b) { this.forceDrawing = function () { return { redraw: false, clearCache: false} }; this.x = g; this.y = f; this.visible = true; this.width = a; this.height = i; this.text = h; this.font = c; this.clicking = false; this.click = j; this.mouseUp = e; this.mouseOver = b; this.color = d; this.parent = null; this.onClick = function (k) { if (!this.visible) { return } this.clicking = true }; this.onMouseUp = function (k) { if (!this.visible) { return } if (this.clicking) { if (this.click) { this.click() } } this.clicking = false; if (this.mouseUp) { this.mouseUp() } }; this.onMouseOver = function (k) { if (!this.visible) { return } if (this.mouseOver) { this.mouseOver() } }; this.draw = function (k) { if (!this.visible) { return } k.fillStyle = this.color; k.strokeStyle = "#DAC333"; roundRect(k, this.parent.x + this.x, this.parent.y + this.y, this.width, this.height, 5, true, true); k.fillStyle = this.clicking ? "#FCA" : "#334"; if (k.font != this.font) { k.font = this.font } k.fillText(this.text, this.parent.x + this.x + ((this.width / 2) - (k.measureText(this.text).width / 2)), this.parent.y + this.y + (this.height / 3) * 2) }; return this } function TilePieceArea(a, e, c, d, b) { this.forceDrawing = function () { return { redraw: false, clearCache: false} }; this.x = a; this.y = e; this.visible = true; this.scale = c; this.width = c.x * 16; this.height = c.y * 17; this.clicking = false; this.tilePiece = d; this.parent = null; this.state = b; this.onClick = function (f) { if (!this.visible) { return } this.clicking = true; this.clickHandled = false }; this.onMouseUp = function (f) { if (!this.visible) { return } if (this.tilePiece && this.clicking && !this.clickHandled) { this.tilePiece.click(Math.floor(f.x / c.x), Math.floor(f.y / c.y), this.state) } this.clickHandled = false; this.clicking = false }; this.clickHandled = false; this.onMouseOver = function (f) { if (!this.tilePiece) { return } if (this.clicking) { this.clickHandled = true; this.tilePiece.click(Math.floor(f.x / c.x), Math.floor(f.y / c.y), this.state) } else { this.tilePiece.mouseOver(Math.floor(f.x / c.x), Math.floor(f.y / c.y)) } }; this.draw = function (f) { if (!this.visible) { return } if (!this.tilePiece) { return } this.tilePiece.tag = true; this.tilePiece.draw(f, { x: this.parent.x + this.x, y: this.parent.y + this.y }, this.scale, this.state); this.tilePiece.tag = false }; return this } function TileChunkArea(a, e, d, c, b) { this.forceDrawing = function () { return { redraw: false, clearCache: false} }; this.x = a; this.y = e; this.visible = true; this.scale = d; this.width = d.x * 128; this.height = d.y * 128; this.clicking = false; this.tileChunk = c; this.parent = null; this.state = b; this.setToTile = null; this.onClick = function (f) { if (!this.visible) { return } this.clicking = true }; this.onMouseUp = function (f) { if (!this.visible) { return } if (this.clicking) { if (this.setToTile != null) { this.tileChunk.tilesPieces[((Math.floor(f.x / this.scale.x / 16))) + (Math.floor(f.y / this.scale.y / 16)) * 8] = sonicManager.SonicLevel.TilePieces.indexOf(this.setToTile); this.tileChunk.sprites = [] } } this.clickHandled = false; this.clicking = false }; this.clickHandled = false; this.onMouseOver = function (f) { if (this.clicking) { } }; this.draw = function (f) { if (!this.visible) { return } if (!this.tileChunk) { return } this.tileChunk.draw(f, { x: this.parent.x + this.x, y: this.parent.y + this.y }, this.scale, true) }; return this } function ScrollBox(b, h, g, a, f, d, c) { this.forceDrawing = function () { return { redraw: false, clearCache: false} }; this.x = b; this.y = h; this.itemWidth = f; this.visible = true; var e = 14; this.width = f + e; this.visibleItems = a; this.itemHeight = g; this.backColor = d; this.height = a * g; this.parent = null; this.scrollOffset = 0; this.scrollPosition = 0; this.dragging = false; if (c) { this.controls = c } else { this.controls = [] } this.scrolling = false; this.addControl = function (i) { i.parent = this; this.controls.push(i); return i }; this.onClick = function (k) { if (!this.visible) { return } for (var i = this.scrollOffset; i < this.controls.length; i++) { var j = this.controls[i]; if (j.y <= k.y && j.y + j.height > k.y && j.x <= k.x && j.x + j.width > k.x) { k.x -= j.x; k.y -= j.y; j.onClick(k); return false } } if (k.x > this.itemWidth && k.x < this.itemWidth + e) { if (this.scrollPosition > k.y) { if (this.scrollOffset > 0) { this.scrollOffset-- } } else { if (this.scrollOffset < this.controls.length - this.visibleItems) { this.scrollOffset++ } } } this.dragging = true; return false }; this.onMouseUp = function (k) { if (!this.visible) { return } this.dragging = false; for (var i = this.scrollOffset; i < this.controls.length; i++) { var j = this.controls[i]; if (j.y <= k.y && j.y + j.height > k.y && j.x <= k.x && j.x + j.width > k.x) { k.x -= j.x; k.y -= j.y; j.onMouseUp(k); return false } } if (this.mouseUp) { this.mouseUp() } }; this.onMouseOver = function (k) { if (!this.visible) { return } for (var i = 0; i < this.controls.length; i++) { var j = this.controls[i]; if (j.y <= k.y && j.y + j.height > k.y && j.x <= k.x && j.x + j.width > k.x) { k.x -= j.x; k.y -= j.y; j.onMouseOver(k); break } } if (this.dragging && k.x > this.itemWidth && k.x < this.itemWidth + e) { if (this.scrollPosition > k.y) { if (this.scrollOffset > 0) { this.scrollOffset-- } } else { if (this.scrollOffset < this.controls.length - this.visibleItems) { this.scrollOffset++ } } } if (this.mouseOver) { this.mouseOver() } }; this.onScroll = function (k) { if (!this.visible) { return } if (k.delta > 0) { if (this.scrollOffset > 0) { this.scrollOffset-- } } else { if (this.scrollOffset < this.controls.length - this.visibleItems) { this.scrollOffset++ } } for (var i = 0; i < this.controls.length; i++) { var j = this.controls[i]; if (j.y <= k.y && j.y + j.height > k.y && j.x <= k.x && j.x + j.width > k.x) { k.x -= j.x; k.y -= j.y; if (j.onScroll) { j.onScroll(k) } return false } } if (this.scroll) { this.scroll() } }; this.draw = function (l) { if (!this.visible) { return } l.fillStyle = this.backColor; var k; l.fillStyle = this.backColor; l.lineWidth = 1; l.strokeStyle = "#333"; roundRect(l, this.parent.x + this.x, this.parent.y + this.y, this.itemWidth + e + 6, this.visibleItems * this.itemHeight, 3, true, true); l.fillStyle = "grey"; l.lineWidth = 1; l.strokeStyle = "#444"; l.fillRect(this.parent.x + this.x + this.itemWidth + 2 + 2, this.parent.y + this.y + 2, e, this.visibleItems * this.itemHeight - 2); l.fillStyle = "red"; l.lineWidth = 1; l.strokeStyle = "#444"; this.scrollPosition = (this.visibleItems * this.itemHeight - 2) * this.scrollOffset / this.controls.length; l.fillRect(this.parent.x + this.x + this.itemWidth + 2 + 2 + 2, this.parent.y + this.y + 2 + (this.scrollPosition), e - 2, 5); var j = 1; for (k = this.scrollOffset; k < Math.min(this.controls.length, this.scrollOffset + this.visibleItems); k++) { this.controls[k].parent = { x: this.parent.x + this.x, y: this.parent.y + this.y }; this.controls[k].x = 2; this.controls[k].y = j; this.controls[k].height = this.itemHeight; this.controls[k].width = this.itemWidth; j += this.itemHeight; this.controls[k].draw(l) } }; return this } function roundRect(d, c, h, e, b, a, g, f) { if (typeof f == "undefined") { f = true } if (typeof a === "undefined") { a = 5 } d.beginPath(); d.moveTo(c + a, h); d.lineTo(c + e - a, h); d.quadraticCurveTo(c + e, h, c + e, h + a); d.lineTo(c + e, h + b - a); d.quadraticCurveTo(c + e, h + b, c + e - a, h + b); d.lineTo(c + a, h + b); d.quadraticCurveTo(c, h + b, c, h + b - a); d.lineTo(c, h + a); d.quadraticCurveTo(c, h, c + a, h); d.closePath(); if (f) { d.stroke() } if (g) { d.fill() } } function UIManager(b, n, s) { this.UIAreas = []; this.messages = []; var k = this.textFont = "18pt sans-serrif "; var e = this.buttonFont = "13pt Arial bold"; n.font = k; var h = this.indexes = { tpIndex: 0, modifyIndex: 0, modifyTPIndex: 0 }; this.draw = function (w) { w.save(); var u = JSLINQ(this.UIAreas).OrderBy(function (z) { return z.depth }); for (var y = 0; y < u.items.length; y++) { var v = u.items[y]; v.draw(w) } if (DEBUGs) { for (var x = 0; x < this.messages.length; x++) { w.fillText(this.messages[x], 10, 25 + x * 30) } } w.restore() }; this.onMouseScroll = function (u) { var x = u.wheelDelta ? u.wheelDelta / 40 : u.detail ? -u.detail : 0; for (var w = 0; w < this.UIAreas.length; w++) { var v = this.UIAreas[w]; if (v.visible && v.y <= u.y && v.y + v.height > u.y && v.x <= u.x && v.x + v.width > u.x) { u = { x: u.x - v.x, y: u.y - v.y, delta: x }; return v.scroll(u) } } return false }; this.onClick = function (y) { var u = _H.getCursorPosition(y); var z = null; var v; var x; for (x = 0; x < this.UIAreas.length; x++) { v = this.UIAreas[x]; if (v.visible && v.y <= u.y && v.y + v.height > u.y && v.x <= u.x && v.x + v.width > u.x) { z = v; var w = { x: u.x - v.x, y: u.y - v.y }; v.click(w) } } if (z) { for (x = 0; x < this.UIAreas.length; x++) { v = this.UIAreas[x]; if (z == v) { v.depth = 1 } else { v.depth = 0 } } return true } return false }; this.onMouseMove = function (y) { var u = _H.getCursorPosition(y); var v = JSLINQ(this.UIAreas).OrderBy(function (z) { return -z.depth }); for (var x = 0; x < v.items.length; x++) { var w = v.items[x]; if (w.dragging || (w.visible && w.y <= u.y && w.y + w.height > u.y && w.x <= u.x && w.x + w.width > u.x)) { u = { x: u.x - w.x, y: u.y - w.y }; return w.mouseMove(u) } } return false }; this.onMouseUp = function (y) { var u = _H.getCursorPosition(y, true); for (var x = 0; x < this.UIAreas.length; x++) { var v = this.UIAreas[x]; var w = { x: u.x - v.x, y: u.y - v.y }; v.mouseUp(w) } }; var l = this.debuggerArea = new UiArea(650, 40, 200, 170, this, true); l.visible = false; this.UIAreas.push(l); l.addControl(new TextArea(30, 25, "Debugger", k, "blue")); l.addControl(new Button(40, 60, 60, 22, "Stop", e, "rgb(50,150,50)", function () { b.windowLocation.x = 0; b.windowLocation.y = 0; l.visible = false; j.visible = false; m.visible = true; q.visible = true; b.sonicToon = null })); var j = this.solidTileArea = new UiArea(40, 450, 430, 400, this, true); j.visible = false; this.UIAreas.push(j); j.addControl(new TextArea(30, 25, "Modify Solid Tile", k, "blue")); j.addControl(new Button(50, 35, 25, 22, "<<", e, "rgb(50,150,50)", function () { if (h.tpIndex > 0) { c.tilePiece = b.SonicLevel.TilePieces[--h.tpIndex] } })); j.addControl(new Button(75, 35, 25, 22, ">>", e, "rgb(50,150,50)", function () { if (h.tpIndex < b.SonicLevel.TilePieces.length) { c.tilePiece = b.SonicLevel.TilePieces[++h.tpIndex] } })); j.addControl(new Button(360, 80, 45, 22, "Full", e, "rgb(50,150,50)", function () { for (var u = 0; u < 16; u++) { c.tilePiece.heightMask.items[u] = 16 } this.sprites = [] })); j.addControl(new Button(200, 35, 180, 22, "Modify Height Map", e, "rgb(50,150,50)", function () { c.state = (c.state + 1) % 3; switch (c.state) { case 0: this.text = "Modify Height Map"; break; case 1: this.text = "Modify Tile Direction"; break; case 2: this.text = "Modify Tile Colors"; break } })); var c = this.modifyTilePieceArea = new TilePieceArea(30, 70, { x: 4 * 5, y: 4 * 5 }, null, 0); j.addControl(c); var m = this.levelInformation = new UiArea(500, 440, 420, 360, this); m.visible = true; this.UIAreas.push(m); m.addControl(new TextArea(30, 25, "Level Selector", k, "blue")); m.addControl(new TextArea(30, 52, function () { return !f ? "Level Not Saved" : ("Current Level: " + f) }, k, "black")); m.addControl(new Button(190, 70, 100, 22, "Save Level", e, "rgb(50,150,50)", function () { if (f) { OurSonic.SonicLevels.SaveLevelInformation(f, _H.stringify(b.SonicLevel), function (u) { }, function (u) { alert("Failure: " + _H.stringify(u)) }) } else { OurSonic.SonicLevels.saveLevel((_H.stringify(b.SonicLevel)), function (u) { p(f) }) } })); m.addControl(new Button(190, 105, 160, 22, "Load Empty Level", e, "rgb(50,150,50)", function () { q.visible = true; i.visible = true; var u = 1; var v = function () { var w = 86; if (u == w) { setTimeout(function () { a(_H.stringify(b.SonicLevel), n); i.visible = false }, 500); return } setTimeout(v, 100); _H.loadSprite("assets/TileChunks/HiPlane" + u++ + ".png", function (x) { i.text = "Loading " + u + "/" + w; b.importChunkFromImage(x); if (u == w) { b.inds = { done: true} } }) }; setTimeout(v, 100) })); var g; m.addControl(g = new ScrollBox(30, 70, 25, 11, 130, "rgb(50,60,127)")); var f; OurSonic.SonicLevels.getLevels(function (w) { for (var v = 0; v < w.length; v++) { var u = w[v]; p(u) } }); function p(u) { var v; g.addControl(v = new Button(0, 0, 0, 0, u, "10pt Arial", "rgb(50,190,90)", function () { f = "Downloading"; OurSonic.SonicLevels.openLevel(u, function (w) { f = u; a(w, n) }) })) } var q = this.levelManagerArea = new UiArea(500, 25, 400, 400, this); q.visible = false; this.UIAreas.push(q); q.addControl(new TextArea(30, 25, "Level Manager", k, "blue")); var i; q.addControl(i = new TextArea(270, 25, "Loading", k, "green")); i.visible = false; q.addControl(new Button(35, 100, 160, 22, "Show Height Map", e, "rgb(50,150,50)", function () { if (this.text == "Show Height Map") { b.showHeightMap = true; this.text = "Hide Height Map" } else { b.showHeightMap = false; this.text = "Show Height Map" } })); q.addControl(new Button(35, 150, 160, 22, "Modify Chunks", e, "rgb(50,150,50)", function () { r.visible = true })); q.addControl(new Button(35, 175, 160, 22, "Modify Tile Pieces", e, "rgb(50,150,50)", function () { j.visible = true })); q.addControl(new Button(35, 200, 160, 22, "Modify Tiles", e, "rgb(50,150,50)", function () { t.visible = true })); q.addControl(new Button(200, 35, 60, 22, "Run", e, "rgb(50,150,50)", function () { q.visible = false; j.visible = false; m.visible = false; t.visible = false; r.visible = false; j.visible = false; l.visible = true; b.loading = true; b.sonicToon = new Sonic(b.SonicLevel, b.scale) })); var r = this.modifyTileChunkArea = new UiArea(900, 450, 400, 400, this, true); r.visible = false; this.UIAreas.push(r); r.addControl(new TextArea(30, 25, "Modify Tile Chunk", k, "blue")); var d = this.modifyTC = new TileChunkArea(30, 70, { x: 2, y: 2 }, null, 1); r.addControl(d); r.addControl(new Button(50, 35, 25, 22, "<<", e, "rgb(50,150,50)", function () { if (h.modifyIndex > 0) { d.tileChunk = b.SonicLevel.TileChunks[--h.modifyIndex] } })); r.addControl(new Button(80, 35, 25, 22, ">>", e, "rgb(50,150,50)", function () { if (h.modifyIndex < b.SonicLevel.TileChunks.length) { d.tileChunk = b.SonicLevel.TileChunks[++h.modifyIndex] } })); var o = this.modifyTP = new TilePieceArea(300, 160, { x: 2 * 3, y: 2 * 3 }, null, 3); r.addControl(o); r.addControl(new Button(300, 100, 25, 22, "<<", e, "rgb(50,150,50)", function () { if (h.modifyTPIndex > 0) { o.tilePiece = d.setToTile = b.SonicLevel.TilePieces[--h.modifyTPIndex] } })); r.addControl(new Button(330, 100, 25, 22, ">>", e, "rgb(50,150,50)", function () { if (h.modifyTPIndex < b.SonicLevel.TilePieces.length) { o.tilePiece = d.setToTile = b.SonicLevel.TilePieces[++h.modifyTPIndex] } })); var t = this.modifyTileArea = new UiArea(900, 25, 400, 400, this, true); t.visible = false; this.UIAreas.push(t); t.addControl(new TextArea(30, 25, "Modify Tile", k, "blue")); function a(w, z) { q.visible = true; b.SonicLevel = jQuery.parseJSON((w)); var y; var v; for (v = 0; v < b.SonicLevel.TileChunks.length; v++) { y = b.SonicLevel.TileChunks[v]; y.__proto__ = TileChunk.prototype } for (v = 0; v < b.SonicLevel.TilePieces.length; v++) { y = b.SonicLevel.TilePieces[v]; y.__proto__ = TilePiece.prototype; y.heightMask.__proto__ = HeightMask.prototype } for (v = 0; v < b.SonicLevel.Tiles.length; v++) { y = b.SonicLevel.Tiles[v]; y.__proto__ = Tile.prototype; for (var A = 0; A < y.colors.length; A++) { y.colors[A].__proto__ = Color.prototype } } var u = b.inds = { t: 0, tp: 0, tc: 0, total: (b.SonicLevel.TileChunks.length * 2 + b.SonicLevel.TilePieces.length * 5 + b.SonicLevel.Tiles.length), done: false }; var x = s; for (v = 0; v < b.SonicLevel.Tiles.length; v++) { y = b.SonicLevel.Tiles[v]; y.cacheImage(z, x, function (C) { u.t++; var B = function (E) { u.tp++; if (u.tp == b.SonicLevel.TilePieces.length * 5) { var D = function (F) { u.tc++; if (u.tc == b.SonicLevel.TileChunks.length * 2) { u.done = true; d.tileChunk = b.SonicLevel.TileChunks[0]; c.tilePiece = o.tilePiece = b.SonicLevel.TilePieces[0] } }; for (C = 0; C < b.SonicLevel.TileChunks.length; C++) { y = b.SonicLevel.TileChunks[C]; y.cacheImage(z, x, 1, D); y.cacheImage(z, x, 2, D) } } }; if (u.t == b.SonicLevel.Tiles.length) { for (C = 0; C < b.SonicLevel.TilePieces.length; C++) { y = b.SonicLevel.TilePieces[C]; y.cacheImage(z, x, 0, B); y.cacheImage(z, x, 1, B); y.cacheImage(z, x, 2, B); y.cacheImage(z, x, 3, B); y.cacheImage(z, x, 4, B) } } }) } } };